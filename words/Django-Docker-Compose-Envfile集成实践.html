<html>
    <head>
        <meta charset="utf-8">
        
    
        <title> Django学习笔记19_Django+Docker+ansible+env </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">


        <style type="text/css"> 
        </style>
    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: #fff;">主题选择</span></h3>
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr class="sk-mo" onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">墨</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-green" onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">绿</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-default" onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">青</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-orange" onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">橘</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">波妞</div>
                                <div class="time">2017年2月21号</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">三三</div>
                                <div class="time">2017年4月10号</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        微信
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        支付宝
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:1426409836@qq.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/willdx">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>





            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
              <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="linkify icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    🐱
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="heart icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <h2 class="name">Will Dx</h2>

                <span class="sign">人世一身霜雪, 归来仍是少年.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        主页
                    </a>
                    <a href="/tweet.html" class="item">
                        推特
                    </a>
                    <a href="/about.html" class="item">
                        关于我
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        联系
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1>Django学习笔记19_Django+Docker+ansible+env</h1>
        <h4>Posted April 07, 2017</h4>
        <h1>1. Django环境变量设定最佳实践</h1>

<h2>1.1 默认的设置 global_settings</h2>

<p>Django 的设置文件不需要定义所有的设置。每个设置都有一个合理的默认值。这些默认值位于django/conf/global<em>settings.py 模块中; Django先从global</em>settings.py 中加载设置, 然后从<code>指定的设置文件</code>中加载设置，如有必要则覆盖全局的设置;  </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 显示当前的设置文件和Django 默认设置之间的差异</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">diffsettings</span>
</pre></div>
</div>
<h2>1.2 configure() 或 DJANGO<em>SETTINGS</em>MODULE</h2>

<p><code>指定的设置文件</code>: 可以通过configure() 或 DJANGO<em>SETTINGS</em>MODULE两种方式来设定, 只使用configure() 或 DJANGO<em>SETTINGS</em>MODULE 中的一个, 不可以两个都用和都不用;</p>

<p>如图: (默认状态下, 在manage.py和wsgi.py入口处指定了<code>指定的设置文件</code>)</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15024344469151.jpg"></p>
</p>

<p>Django会从<code>指定的设置文件</code>中读取系统启动所需的所有设置, 如果你有兴趣可以研究一下Django如果使用该环境变量的, 入口如下:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">daixiang</span><span class="o">/.</span><span class="n">virtualenvs</span><span class="o">/</span><span class="n">accouting_server</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">django</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<h2>1.3 为不同环境设定不同的设定文件</h2>

<p>在生产环境中, 我们必定会有 <code>local(本地测试环境)</code> , <code>ci(集成测试环境)</code>, <code>pre-release(预发布环境)</code>, <code>online(线上环境)</code> 的区别, 所以我们需要为项目设定不同环境下的<code>设置文件</code>;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">├──</span> <span class="n">settings</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="n">base</span><span class="o">.</span><span class="n">py</span>   <span class="c1"># 基础配置文件, 默认的settings.py文件重命令而来</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="n">ci</span><span class="o">.</span><span class="n">py</span>     <span class="c1"># 集成测试配置文件</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="n">local</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># 本地测试配置文件</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="n">online</span><span class="o">.</span><span class="n">py</span> <span class="c1"># 线上环境配置文件</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">pre</span><span class="o">-</span><span class="n">release</span><span class="o">.</span><span class="n">py</span> <span class="c1"># 预发布环境配置文件</span>
</pre></div>
</div>
<p>将base.py的内容都导入到每个特定环境变量的文件中去; 以local.py为例:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># -*-coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">IS_ENV_ONLINE</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">IS_ENV_PRE_RELEASE</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">IS_ENV_CI</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">IS_ENV_LOCAL</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>这里我们引入<a href="https://pypi.python.org/pypi/django-environ">Django-environ</a>库, 他帮组我们管理好环境变量;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">pip3</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="n">environ</span>
</pre></div>
</div>
<p>更改base.py文件, 通过DOT<em>ENV</em>FILE环境变量控制不同环境下, <code>环境变量文件</code>的导入, 默认为local.env文件</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">environ</span>

<span class="c1"># 根目录, 参考: https://pypi.python.org/pypi/django-environ</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span>
<span class="n">APP_DIR</span> <span class="o">=</span> <span class="n">BASE_DIR</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;accouting_app&quot;</span><span class="p">)</span>

<span class="c1"># 环境变量, 默认local.env</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">Env</span><span class="p">()</span>
<span class="n">DOT_ENV_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOT_ENV_FILE&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;local.env&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">DOT_ENV_FILE</span><span class="p">:</span>
    <span class="n">env_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;accouting_project&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">DOT_ENV_FILE</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">env_file</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Loading : {} ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_file</span><span class="p">))</span>
        <span class="n">env</span><span class="o">.</span><span class="n">read_env</span><span class="p">(</span><span class="n">env_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loading Finished!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>这样在local.env 文件定义的变量都可以用env参数获取, 例如: </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># DEBUG</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="n">TEMPLATE_DEBUG</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="s1">&#39;DJANGO_DEBUG&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ELK</span>
<span class="n">ELK_URL</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s1">&#39;ELK_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;http://elk:9200&#39;</span><span class="p">)</span>
<span class="n">ELK_DOMAIN</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s1">&#39;ELK_DOMAIN&#39;</span><span class="p">,</span> <span class="s1">&#39;elk&#39;</span><span class="p">)</span>
<span class="n">ELK_PORT</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s1">&#39;ELK_PORT&#39;</span><span class="p">,</span> <span class="s1">&#39;9200&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>添加到配置文件中之后, 可以方便项目其他模块使用</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="k">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ELK_URL</span><span class="p">)</span>
</pre></div>
</div>
<h1>2.Ansible自动化基础</h1>

<p><a href="http://breezey.blog.51cto.com/2400275/1555530">文档来源</a></p>

<ul>
<li>架构图</li>
</ul>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15025194799130.jpg"></p>
</p>

<ul>
<li>流程图</li>
</ul>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15025196098962.jpg"></p>
</p>

<h2>2.1 Ansible简介与Inventory</h2>

<p>Ansible是一个综合的强大的管理工具,他可以对多台主机安装操作系统,并为这些主机安装不同的应用程序,也可以通知指挥这些主机完成不同的任务.查看多台主机的各种信息的状态等,ansible都可以通过模块的方式来完成</p>

<ul>
<li>Ansible特性</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">No</span> <span class="n">agents</span><span class="err">：不需要再被管理节点上安装客户端，只要有</span><span class="n">sshd</span><span class="err">即可</span>
<span class="n">No</span> <span class="n">server</span><span class="err">：在服务端不需要启动任何服务，只需要执行命令就行</span>
<span class="n">No</span> <span class="n">additional</span> <span class="n">PKI</span><span class="err">：由于不基于</span><span class="n">ssl</span><span class="err">，所以也不基于</span><span class="n">PKI</span><span class="err">工作</span>
<span class="n">Modules</span> <span class="ow">in</span> <span class="nb">any</span> <span class="n">language</span><span class="err">：基于模块工作，</span><span class="n">ansible</span><span class="err">拥有众多的模块</span>
<span class="n">YAML</span><span class="err">：支持</span><span class="n">YAML</span><span class="err">语法</span>
<span class="n">SSH</span> <span class="n">by</span> <span class="n">default</span><span class="err">：默认使用</span><span class="n">ssh</span><span class="err">控制各节点</span>
</pre></div>
</div>
<ul>
<li>ansible基本组成</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">核心：</span><span class="n">ansible</span>
<span class="err">核心模块（</span><span class="n">Core</span> <span class="n">Modules</span><span class="err">）：这些都是</span><span class="n">ansible</span><span class="err">自带的模块</span> 
<span class="err">扩展模块（</span><span class="n">Custom</span> <span class="n">Modules</span><span class="err">）：如果核心模块不足以完成某种功能，可以添加扩展模块</span>
<span class="err">插件（</span><span class="n">Plugins</span><span class="err">）：完成模块功能的补充</span>
<span class="err">剧本（</span><span class="n">Playbooks</span><span class="err">）：</span><span class="n">ansible</span><span class="err">的任务配置文件，将多个任务定义在剧本中，由</span><span class="n">ansible</span><span class="err">自动执行</span>
<span class="err">连接插件（</span><span class="n">Connectior</span> <span class="n">Plugins</span><span class="err">）：</span><span class="n">ansible</span><span class="err">基于连接插件连接到各个主机上，虽然</span><span class="n">ansible</span><span class="err">是使用</span><span class="n">ssh</span><span class="err">连接到各个主机的，但是它还支持其他的连接方法，所以需要有连接插件</span>
<span class="err">主机群（</span><span class="n">Host</span> <span class="n">Inventory</span><span class="err">）：定义</span><span class="n">ansible</span><span class="err">管理的主机</span>
</pre></div>
</div>
<h2>2.2 ansible 环境配置</h2>

<h3>2.2.1 配置文件查找顺序</h3>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>1. ANSIBLE_CONFIG: 首先，ansible命令会检查环境变量，及这个环境变量将指向的配置文件。可以通过导入环境变量的方式来做修改，例如：export ANSIBLE_CONFIG=/directory_path
2. ./ansible.cfg：其次，将会检查当前目录下的ansible.cfg配置文件
3. ~/.ansible.cfg：再次，将会检查当前用户home目录下的.ansible.cfg配置文件
4. /etc/ansible/ansible.cfg：最后，将会检查在用软件包管理工具安装ansible时自动产生的配置文件</pre></div></div>

<p>如果是yum安装, 默认配置文件应该在/etc/ansible/ansible.cfg; 
我在mac上通过pip安装找了半天没有找到ansible.cfg在哪里, 我是直接去GitHub上找到ansible项目, 复制ansible/examples/ansible.cfg到当前目录,做了一些需要的更改:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">➜</span>  <span class="n">ansible</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;^[\[a-z]&#39;</span> <span class="n">ansible</span><span class="o">.</span><span class="n">cfg</span>
<span class="p">[</span><span class="n">defaults</span><span class="p">]</span>
<span class="n">inventory</span>      <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">hosts</span>  <span class="c1"># 默认的主机文件</span>
<span class="n">remote_tmp</span>     <span class="o">=</span> <span class="o">~/.</span><span class="n">ansible</span><span class="o">/</span><span class="n">tmp</span>
<span class="n">local_tmp</span>      <span class="o">=</span> <span class="o">~/.</span><span class="n">ansible</span><span class="o">/</span><span class="n">tmp</span>
<span class="n">sudo_user</span>      <span class="o">=</span> <span class="n">root</span>
<span class="n">transport</span>      <span class="o">=</span> <span class="n">smart</span>
<span class="n">remote_port</span>    <span class="o">=</span> <span class="mi">22</span>  <span class="c1"># 默认ssh端口</span>
<span class="n">host_key_checking</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1"># 关闭ssh连接提示yes/no</span>
<span class="n">log_path</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">ansible</span><span class="o">.</span><span class="n">log</span>  <span class="c1"># 开启日志记录</span>
<span class="n">system_warnings</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># 关闭系统升级等提示信息</span>
<span class="n">action_plugins</span>     <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">action</span>
<span class="n">cache_plugins</span>      <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">cache</span>
<span class="n">callback_plugins</span>   <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">callback</span>
<span class="n">connection_plugins</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">connection</span>
<span class="n">lookup_plugins</span>     <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">lookup</span>
<span class="n">inventory_plugins</span>  <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">inventory</span>
<span class="n">vars_plugins</span>       <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="nb">vars</span>
<span class="n">filter_plugins</span>     <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="nb">filter</span>
<span class="n">test_plugins</span>       <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">test</span>
<span class="n">terminal_plugins</span>   <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">terminal</span>
<span class="n">strategy_plugins</span>   <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">strategy</span>
<span class="n">fact_caching</span> <span class="o">=</span> <span class="n">memory</span>
<span class="p">[</span><span class="n">accelerate</span><span class="p">]</span>
<span class="n">accelerate_port</span> <span class="o">=</span> <span class="mi">5099</span>
<span class="n">accelerate_timeout</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">accelerate_connect_timeout</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">accelerate_daemon_timeout</span> <span class="o">=</span> <span class="mi">30</span>
</pre></div>
</div>
<h2>2.3 ansible 简单使用</h2>

<ul>
<li><p>项目目录: /Users/daixiang/ansible</p></li>
<li><p>管理主机: Inventory</p></li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># vim hosts
[local]
127.0.0.1 ansible_ssh_user=daixiang

[rundeck]
120.43.103.126:2222 ansible_ssh_user=will</pre></div></div>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>➜  ansible ansible -i hosts local -m ping -k
SSH password:
127.0.0.1 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
➜  ansible ansible -i hosts rundeck -m ping -k
SSH password:
120.43.103.126 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
# SSH免密登录后不需要输入密码即可执行命令
➜  ansible ssh-copy-id -i ~/.ssh/id_rsa.pub "-p 2233 xxx@120.43.103.126" 
➜  ansible ansible -i hosts rundeck -m ping
120.43.103.126 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}</pre></div></div>

<h2>2.4 ansible Inventory配置</h2>

<h3>2.4.1 简单的主机和组</h3>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>mail.willdx.me
[webservers]
web1.willdx.me
web2.willdx.me
[dbservers]
db1.willdx.me
db2.willdx.me</pre></div></div>

<h3>2.4.2 端口与别名</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1">#  web1设定为真实IP: 192.168.1.2的别名</span>
<span class="n">web1</span> <span class="n">ansible_ssh_port</span> <span class="o">=</span> <span class="mi">3333</span> <span class="n">ansible_ssh_host</span> <span class="o">=</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.2</span>
</pre></div>
</div>
<h3>2.4.3 指定主机范围</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">webservers</span><span class="p">]</span>
<span class="n">www</span><span class="p">[</span><span class="mo">01</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">willdx</span><span class="o">.</span><span class="n">me</span>
<span class="p">[</span><span class="n">databases</span><span class="p">]</span>
<span class="n">db</span><span class="o">-</span><span class="p">[</span><span class="n">a</span><span class="p">:</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">willdx</span><span class="o">.</span><span class="n">me</span>
</pre></div>
</div>
<h3>2.4.4 使用主机变量</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">ansible_ssh_host</span>     <span class="c1">#用于指定被管理的主机的真实IP</span>
<span class="n">ansible_ssh_port</span>     <span class="c1">#用于指定连接到被管理主机的ssh端口号，默认是22</span>
<span class="n">ansible_ssh_user</span>     <span class="c1">#ssh连接时默认使用的用户名</span>
<span class="n">ansible_ssh_pass</span>     <span class="c1">#ssh连接时的密码</span>
<span class="n">ansible_sudo_pass</span>     <span class="c1">#使用sudo连接用户时的密码</span>
<span class="n">ansible_sudo_exec</span>     <span class="c1">#如果sudo命令不在默认路径，需要指定sudo命令路径</span>
<span class="n">ansible_ssh_private_key_file</span>     <span class="c1">#秘钥文件路径，秘钥文件如果不想使用ssh-agent管理时可以使用此选项</span>
<span class="n">ansible_shell_type</span>     <span class="c1">#目标系统的shell的类型，默认sh</span>
<span class="n">ansible_connection</span>     <span class="c1">#SSH 连接的类型： local , ssh , paramiko，在 ansible 1.2 之前默认是 paramiko ，后来智能选择，优先使用基于 ControlPersist 的 ssh （支持的前提）</span>
<span class="n">ansible_python_interpreter</span>     <span class="c1">#用来指定python解释器的路径，默认为/usr/bin/python 同样可以指定ruby 、perl 的路径</span>
<span class="n">ansible_</span><span class="o">*</span><span class="n">_interpreter</span>     <span class="c1">#其他解释器路径，用法与ansible_python_interpreter类似，这里&quot;*&quot;可以是ruby或才perl等其他语言</span>


<span class="err">示例如下：</span>
<span class="p">[</span><span class="n">test</span><span class="p">]</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span> <span class="n">ansible_ssh_user</span><span class="o">=</span><span class="n">root</span> <span class="n">ansible_ssh_pass</span><span class="o">=</span><span class="s1">&#39;P@ssw0rd&#39;</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">1.2</span> <span class="n">ansible_ssh_user</span><span class="o">=</span><span class="n">breeze</span> <span class="n">ansible_ssh_pass</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">1.3</span> <span class="n">ansible_ssh_user</span><span class="o">=</span><span class="n">bernie</span> <span class="n">ansible_ssh_port</span><span class="o">=</span><span class="mi">3055</span> <span class="n">ansible_ssh_pass</span><span class="o">=</span><span class="s1">&#39;456789&#39;</span>
</pre></div>
</div>
<h3>2.4.5 组的包含与组内变量</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">wuhan</span><span class="p">]</span>
<span class="n">web1</span>
<span class="n">web2</span>

<span class="p">[</span><span class="n">jingzhou</span><span class="p">]</span>
<span class="n">web4</span>
<span class="n">web3</span>

<span class="p">[</span><span class="n">hubei</span><span class="p">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">wuhan</span>
<span class="n">jingzhou</span>

<span class="p">[</span><span class="n">hubei</span><span class="p">:</span><span class="nb">vars</span><span class="p">]</span>
<span class="n">ntp_server</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.10</span>
<span class="n">zabbix_server</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.10</span>

<span class="err">注：</span><span class="nb">vars</span><span class="err">变量在</span><span class="n">ansible</span> <span class="n">ad</span><span class="o">-</span><span class="n">hoc</span><span class="err">部分中基本用不到，主要用在</span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="err">中</span>
</pre></div>
</div>
<h3>2.4.6 主机与组正则匹配</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">把</span><span class="n">Patterns</span> <span class="err">直接理解为正则实际是不完全准确的，正常的理解为</span><span class="n">patterns</span><span class="err">意味着在</span><span class="n">ansible</span><span class="err">中管理哪些主机，也可以理解为，要与哪台主机进行通信。在探讨这个问题之前我们先看下</span><span class="n">ansible</span><span class="err">的用法：</span>
<span class="n">ansible</span> <span class="o">&lt;</span><span class="n">pattern_goes_here</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="o">&lt;</span><span class="n">module_name</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">a</span> <span class="o">&lt;</span><span class="n">arguments</span><span class="o">&gt;</span>
<span class="err">直接上一个示例：</span>
<span class="n">ansible</span> <span class="n">webservers</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;name=httpd state=restarted&quot;</span>
<span class="err">这里是对</span><span class="n">webservers</span> <span class="err">组或主机重启</span><span class="n">httpd</span><span class="err">服务</span> <span class="err">，其中</span><span class="n">webservers</span> <span class="err">就是</span><span class="n">Pattern</span><span class="err">部分。而之所以上面说</span><span class="n">Pattern</span><span class="err">（模式）可以理解为正则，主要针对下面经常用到的用法而言的。</span>
<span class="mi">1</span><span class="err">、表示所有的主机可以使用</span><span class="nb">all</span> <span class="err">或</span> <span class="o">*</span> 
<span class="mi">2</span><span class="err">、通配符与逻辑或</span>
<span class="err">利用通配符还可以指定一组具有规则特征的主机或主机名，冒号表示</span><span class="ow">or</span><span class="err">－－－逻辑或</span>
    <span class="n">web1</span><span class="o">.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span>
    <span class="n">web1</span><span class="o">.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">web2</span><span class="o">.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span>
    <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span>
    <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.</span><span class="o">*</span>
<span class="err">当然，这里的</span><span class="o">*</span><span class="err">通配符也可以用在前面，如：</span>
    <span class="o">*.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span>
    <span class="o">*.</span><span class="n">com</span>    
    <span class="n">webservers1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>     <span class="c1">#表示匹配 webservers1 组的第 1 个主机    webservers1[0:25]  #表示匹配 webservers1 组的第 1 个到第 25 个主机（官网文档是&quot;:&quot;表示范围，测试发现应该使用&quot;-&quot;,注意不要和匹配多个主机组混淆）</span>
<span class="err">上面的用法，在多个组之间同样适用</span> <span class="err">，如：</span>
    <span class="n">webservers</span>
    <span class="n">webservers</span><span class="p">:</span><span class="n">dbservers</span>  <span class="c1">#表示两个组中所有的主机</span>
<span class="mi">3</span><span class="err">、逻辑非与逻辑</span><span class="ow">and</span>
<span class="err">非的表达式，如，目标主机必须在组</span><span class="n">webservers</span><span class="err">但不在</span><span class="n">phoenix</span><span class="err">组中</span>
    <span class="n">webserver</span><span class="p">:</span><span class="err">!</span><span class="n">phoenix</span>
<span class="err">交集的表达式，如，目标主机必须即在组</span><span class="n">webservers</span><span class="err">中又在组</span><span class="n">staging</span><span class="err">中</span>
    <span class="n">webservers</span><span class="p">:</span><span class="o">&amp;</span><span class="n">staging</span>
<span class="err">一个更复杂的示例：</span>
    <span class="n">webserver</span><span class="p">:</span><span class="n">dbservers</span><span class="p">:</span><span class="o">&amp;</span><span class="n">staging</span><span class="p">:</span><span class="err">!</span><span class="n">phoenix</span>
<span class="err">上面这个复杂的表达式最后表示的目标主机必须满足：在</span><span class="n">webservers</span><span class="err">或者</span><span class="n">dbservers</span><span class="err">组中，必须还存在于</span><span class="n">staging</span><span class="err">组中，但是不在</span><span class="n">phoenix</span><span class="err">组中</span> <span class="err">。</span>
<span class="mi">4</span><span class="err">、混合高级用法</span>
    <span class="o">*.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="o">*.</span><span class="n">org</span>
<span class="err">还可以在开头的地方使用”</span><span class="o">~</span><span class="err">”，用来表示这是一个正则表达式</span><span class="p">:</span>
    <span class="o">~</span><span class="p">(</span><span class="n">web</span><span class="o">|</span><span class="n">db</span><span class="p">)</span><span class="o">.*</span>\<span class="o">.</span><span class="n">yanruogu</span>\<span class="o">.</span><span class="n">com</span>
<span class="err">给两个</span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="err">中具体可能用的用法：</span>
<span class="n">a</span><span class="err">、在</span><span class="n">ansible</span><span class="o">-</span><span class="n">palybook</span><span class="err">命令中，你也可以使用变量来组成这样的表达式，但是你必须使用“</span><span class="o">-</span><span class="n">e</span><span class="err">”的选项来指定这个表达式（通常我们不这样用）：</span>
    <span class="n">ansible</span><span class="o">-</span><span class="n">palybook</span> <span class="o">-</span><span class="n">e</span> <span class="n">webservers</span><span class="p">:</span><span class="err">!</span><span class="p">{{</span><span class="n">excluded</span><span class="p">}}:</span><span class="o">&amp;</span><span class="p">{{</span><span class="n">required</span><span class="p">}}</span>
<span class="n">b</span><span class="err">、在</span><span class="n">ansible</span><span class="err">和</span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="err">中，还可以通过一个参数”</span><span class="o">--</span><span class="n">limit</span><span class="err">”来明确指定排除某些主机或组：</span>
    <span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">site</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">limit</span> <span class="n">datacenter2</span>
<span class="n">c</span><span class="err">、从</span><span class="n">Ansible1</span><span class="o">.</span><span class="mi">2</span><span class="err">开始，如果想排除一个文件中的主机可以使用</span><span class="s2">&quot;@&quot;</span><span class="err">：</span>
    <span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">site</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">limit</span> <span class="nd">@retry_hosts.txt</span>
</pre></div>
</div>
<h2>2.4 ansible Galaxy 角色共享平台</h2>

<p>ansible的galaxy是ansible官方一个分享role的功能平台, 网址是<a href="https://galaxy.ansible.com/list#/roles?page=1&amp;page_size=10">galaxy.ansible.com</a></p>

<p>可以把你编写的role通过ansible-galaxy上传到galaxy网站供其他人下载和使用。也可以通过ansible-galaxy命令很简单地实现role的分享和安装，当然ansible也支持直接从github上下载role</p>

<p>在我们使用ansible-galaxy命令下载role的时候需要了解role的运行平台和ansible依赖版本以及相关依赖。日常工作中我们使用<code>ansible-galaxy install</code>就可以，默认会安装到<code>/etc/ansible/roles/</code>目录下，其引用跟我们自己写的role的方式一样;</p>

<h2>2.5 ansible ad-hoc与命令执行模块</h2>

<p><a href="http://breezey.blog.51cto.com/2400275/1555530">文档来源</a></p>

<h3>2.5.1 Ad-Hoc</h3>

<p>Ad-Hoc 是指ansible下临时执行的一条命令，并且不需要保存的命令，对于复杂的命令会使用playbook。Ad-hoc的执行依赖于模块，ansible官方提供了大量的模块。 如：command、raw、shell、file、cron等，具体可以通过ansible-doc -l 进行查看 。可以使用ansible-doc -s module来查看某个模块的参数，也可以使用ansible-doc help module来查看该模块更详细的信息; </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 命令模式</span>
<span class="n">ansible</span> <span class="o">-</span><span class="n">i</span> <span class="err">主机文件</span> <span class="err">主机或组</span> <span class="o">-</span><span class="n">m</span> <span class="err">模块名</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;模块参数&#39;</span>  <span class="n">ansible</span><span class="err">参数</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 后台执行</span>

<span class="c1">#后台执行命令3600s，-B 表示后台执行的时间</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">B</span> <span class="mi">3600</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
 
<span class="c1">#检查任务的状态</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">async_status</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;jid=123456789&quot;</span> 

<span class="c1">#后台执行命令最大时间是1800s即30分钟，-P 每60s检查下状态，默认15s</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">B</span> <span class="mi">1800</span> <span class="o">-</span><span class="n">P</span> <span class="mi">60</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</pre></div>
</div>
<h3>2.5.2 命令行执行模块</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="n">command</span><span class="err">模块：该模块通过</span><span class="o">-</span><span class="n">a</span><span class="err">跟上要执行的命令可以直接执行，不过命令里如果有带有如下字符部分则执行不成功</span> <span class="err">“</span>  <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span>  <span class="s2">&quot;&amp;&quot;</span> <span class="err">；</span>
<span class="mf">2.</span> <span class="n">shell</span> <span class="err">模块：用法基本和</span><span class="n">command</span><span class="err">一样，不过其是通过</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">进行执行，所以</span><span class="n">shell</span> <span class="err">模块可以执行任何命令，就像在本机执行一样；</span>
<span class="mf">3.</span> <span class="n">raw</span><span class="err">模块：用法和</span><span class="n">shell</span> <span class="err">模块一样</span> <span class="err">，其也可以执行任意命令，就像在本机执行一样；</span>
<span class="mf">4.</span> <span class="n">script</span><span class="err">模块：其是将管理端的</span><span class="n">shell</span> <span class="err">在被管理主机上执行，其原理是先将</span><span class="n">shell</span> <span class="err">复制到远程主机，再在远程主机上执行，原理类似于</span><span class="n">raw</span><span class="err">模块</span><span class="p">;</span>

<span class="err">注：</span><span class="n">raw</span><span class="err">模块和</span><span class="n">comand</span><span class="err">、</span><span class="n">shell</span> <span class="err">模块不同的是其没有</span><span class="n">chdir</span><span class="err">、</span><span class="n">creates</span><span class="err">、</span><span class="n">removes</span><span class="err">参数，</span><span class="n">chdir</span><span class="err">参数的作用就是先切到</span><span class="n">chdir</span><span class="err">指定的目录后，再执行后面的命令，这在后面很多模块里都会有该参数</span><span class="p">;</span>

<span class="n">command</span><span class="err">模块包含如下选项：</span> 
    <span class="n">creates</span><span class="err">：一个文件名，当该文件存在，则该命令不执行</span> 
    <span class="n">free_form</span><span class="err">：要执行的</span><span class="n">linux</span><span class="err">指令</span> 
    <span class="n">chdir</span><span class="err">：在执行指令之前，先切换到该指定的目录</span> 
    <span class="n">removes</span><span class="err">：一个文件名，当该文件不存在，则该选项不执行</span>
    <span class="n">executable</span><span class="err">：切换</span><span class="n">shell</span><span class="err">来执行指令，该执行路径必须是一个绝对路径</span>
</pre></div>
</div>
<h2>2.6 常用模块</h2>

<p>模块按功能分类为：云模块、命令模块、数据库模块、文件模块、资产模块、消息模块、监控模块、网络模块、通知模块、包管理模块、源码控制模块、系统模块、单元模块、web设施模块、windows模块;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="nb">file</span><span class="p">:</span><span class="err">用于配置文件属性</span>
<span class="n">yum</span><span class="err">：用于安装软件包</span>
<span class="n">cron</span><span class="err">：配置计划任务</span>
<span class="n">copy</span><span class="err">：复制文件到远程主机</span>
<span class="n">command</span><span class="err">：在远程主机上执行命令</span>
<span class="n">raw</span><span class="err">：类似于</span><span class="n">command</span><span class="err">模块，支持管道</span>
<span class="n">user</span><span class="err">：配置用户</span>
<span class="n">group</span><span class="err">：配置用户组</span>
<span class="n">service</span><span class="err">：用于管理服务</span>
<span class="n">ping</span><span class="err">：用于检测远程主机是否存活</span>
<span class="n">setup</span><span class="err">：查看远程主机的基本信息</span>
<span class="n">mount</span><span class="err">：配置挂载点</span>
</pre></div>
</div>
<h3>2.6.1 file模块</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">group</span><span class="err">：定义文件</span><span class="o">/</span><span class="err">目录的属组</span>
<span class="n">owner</span><span class="err">：定义文件</span><span class="o">/</span><span class="err">目录的属主</span>
<span class="n">mode</span><span class="err">：定义文件</span><span class="o">/</span><span class="err">目录的权限</span>
<span class="n">path</span><span class="err">：必选项，定义文件</span><span class="o">/</span><span class="err">目录的路径</span>
<span class="n">recurse</span><span class="err">：递归设置文件的属性，只对目录有效</span>
<span class="n">state</span><span class="p">:</span><span class="err">定义文件状态</span>
<span class="n">directory</span><span class="err">：如果目录不存在，创建目录</span>
<span class="n">touch</span><span class="err">：如果文件不存在，创建一个新文件</span>
<span class="n">absent</span><span class="p">:</span><span class="err">删除文件或目录</span>
<span class="err">示例：</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="nb">file</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;src=/etc/fstab dest=/tmp/fstab state=link&quot;</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="nb">file</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;path=/tmp/fstab state=absent&quot;</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="nb">file</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;path=/tmp/test state=touch&quot;</span>
</pre></div>
</div>
<h3>2.6.2 yum模块</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">enablerepo</span><span class="p">:</span><span class="err">启用某个源</span>
<span class="n">name</span><span class="p">:</span><span class="err">要进行操作的软件包的名字，也可以传递一个</span><span class="n">url</span><span class="err">或者一个本地的</span><span class="n">rpm</span><span class="err">包的路径</span>
<span class="n">state</span><span class="p">:</span><span class="err">定义软件包状态</span>
<span class="n">present</span><span class="p">:</span><span class="err">安装</span>
<span class="n">absent</span><span class="err">：删除</span>
<span class="n">latest</span><span class="err">：安装最新的</span>
<span class="err">示例：</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">yum</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=httpd state=latest&#39;</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">yum</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=&quot;@Development tools&quot; state=present&#39;</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">yum</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm state=present&#39;</span>
</pre></div>
</div>
<h3>2.6.3 cron模块</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">backup</span><span class="err">：对远程主机上的原任务计划内容修改之前做备份</span>
<span class="n">day</span><span class="err">：日（</span><span class="mi">1</span><span class="o">-</span><span class="mi">31</span><span class="err">，</span><span class="o">*</span><span class="err">，</span><span class="o">*/</span><span class="mi">2</span><span class="p">,</span><span class="err">……）</span>
<span class="n">hour</span><span class="err">：小时（</span><span class="mi">0</span><span class="o">-</span><span class="mi">23</span><span class="err">，</span><span class="o">*</span><span class="err">，</span><span class="o">*/</span><span class="mi">2</span><span class="err">，……）</span>
<span class="n">minute</span><span class="err">：分钟（</span><span class="mi">0</span><span class="o">-</span><span class="mi">59</span><span class="err">，</span><span class="o">*</span><span class="err">，</span><span class="o">*/</span><span class="mi">2</span><span class="err">，……）</span>
<span class="n">month</span><span class="err">：月（</span><span class="mi">1</span><span class="o">-</span><span class="mi">12</span><span class="err">，</span><span class="o">*</span><span class="err">，</span><span class="o">*/</span><span class="mi">2</span><span class="err">，……）</span>
<span class="n">weekday</span><span class="err">：周（</span><span class="mi">0</span><span class="o">-</span><span class="mi">7</span><span class="err">，</span><span class="o">*</span><span class="err">，……）</span>
<span class="n">job</span><span class="err">：要执行的任务，依赖于</span><span class="n">state</span><span class="o">=</span><span class="n">present</span>
<span class="n">name</span><span class="err">：该任务的描述</span>
<span class="n">special_time</span><span class="err">：指定什么时候执行，参数：</span><span class="n">reboot</span><span class="p">,</span><span class="n">yearly</span><span class="p">,</span><span class="n">annually</span><span class="p">,</span><span class="n">monthly</span><span class="p">,</span><span class="n">weekly</span><span class="p">,</span><span class="n">daily</span><span class="p">,</span><span class="n">hourly</span>
<span class="n">state</span><span class="err">：确认该任务计划是创建还是删除</span>
<span class="n">user</span><span class="err">：以哪个用户的身份执行</span>
<span class="err">示例：</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">cron</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=&quot;check dirs&quot; hour=&quot;5,2&quot; job=&quot;ls -alh &gt; /dev/null&quot;&#39;</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">cron</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=&quot;a job for reboot&quot; special_time=reboot job=&quot;/some/job.sh&quot;&#39;</span>
</pre></div>
</div>
<h3>2.6.4 copy模块</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">src</span><span class="p">:</span><span class="err">源文件</span>
<span class="n">dest</span><span class="p">:</span><span class="err">目标路径</span>
<span class="n">backup</span><span class="p">:</span><span class="err">覆盖之前，是否备份原文件</span>
<span class="n">owner</span><span class="p">:</span><span class="err">设定文件</span><span class="o">/</span><span class="err">目录的属主</span>
<span class="n">group</span><span class="p">:</span><span class="err">设定文件</span><span class="o">/</span><span class="err">目录的属组</span>
<span class="n">mode</span><span class="p">:</span><span class="err">设定文件</span><span class="o">/</span><span class="err">目录的权限</span>
<span class="err">示例：</span>
 <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">copy</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;src=/srv/myfiles/foo.conf dest=/etc/foo.conf owner=foo group=foo mode=0644&quot;</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">copy</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;src=/mine/ntp.conf dest=/etc/ntp.conf owner=root group=root mode=644 backup=yes&quot;</span>
</pre></div>
</div>
<h3>2.6.5 command 模块</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">creates</span><span class="err">：一个文件名，当该文件存在，则该命令不执行</span>
<span class="n">free_form</span><span class="err">：要执行的</span><span class="n">linux</span><span class="err">指令</span>
<span class="n">chdir</span><span class="err">：在执行指令之前，先切换到该指定的目录</span>
<span class="n">removes</span><span class="err">：一个文件名，当该文件不存在，则该选项不执行</span>
<span class="err">示例：</span>
 <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;/sbin/reboot&quot;</span>
</pre></div>
</div>
<h3>2.6.6 service模块</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">arguments</span><span class="err">：给命令行提供一些选项</span>
<span class="n">enabled</span><span class="err">：是否开机启动</span>  <span class="n">yes</span><span class="o">|</span><span class="n">no</span>
<span class="n">name</span><span class="err">：必选项，服务名称</span>
<span class="n">runlevel</span><span class="err">：运行级别</span>
<span class="n">sleep</span><span class="err">：如果执行了</span><span class="n">restarted</span><span class="err">，在则</span><span class="n">stop</span><span class="err">和</span><span class="n">start</span><span class="err">之间沉睡几秒钟</span>
<span class="n">state</span><span class="err">：对当前服务执行启动，停止、重启、重新加载等操作（</span><span class="n">started</span><span class="p">,</span><span class="n">stopped</span><span class="p">,</span><span class="n">restarted</span><span class="p">,</span><span class="n">reloaded</span><span class="err">）</span>
<span class="err">示例：</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;name=httpd state=started enabled=yes&quot;</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;name=foo pattern=/usr/bin/foo state=started&quot;</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;name=network state=restarted args=eth0&quot;</span>
</pre></div>
</div>
<h3>2.6.7 user模块</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">home</span><span class="p">:</span><span class="err">指定家目录，需要</span><span class="n">createhome</span><span class="err">为</span><span class="n">yes</span>
<span class="n">groups</span><span class="p">:</span><span class="err">用户组</span>
<span class="n">uid</span><span class="err">：用户</span><span class="n">UID</span>
<span class="n">password</span><span class="p">:</span><span class="err">指定用户密码</span>
<span class="n">name</span><span class="p">:</span><span class="err">用户名</span>
<span class="n">createhome</span><span class="p">:</span><span class="err">是否创建家目录</span>
<span class="n">system</span><span class="p">:</span><span class="err">是否创建为系统用户</span>
<span class="n">remove</span><span class="p">:</span><span class="err">但</span><span class="n">state</span><span class="o">=</span><span class="n">absent</span><span class="err">时，删除家目录</span>
<span class="n">state</span><span class="p">:</span><span class="err">创建或者删除</span>
<span class="n">shell</span><span class="p">:</span><span class="err">指定用户</span><span class="n">shell</span><span class="err">环境</span>
</pre></div>
</div>
<h3>2.6.8 模块帮助</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">doc</span> <span class="o">-</span><span class="n">l</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">doc</span> <span class="o">-</span><span class="n">s</span> <span class="n">module_name</span>
</pre></div>
</div>
<h3>2.6.9 setup模块</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># Inventory主机配置</span>
<span class="p">[</span><span class="n">local</span><span class="p">]</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>

<span class="p">[</span><span class="n">rundeck</span><span class="p">]</span>
<span class="mf">120.43</span><span class="o">.</span><span class="mf">103.126</span>

<span class="c1"># 获取本地主机信息</span>
<span class="n">ansible</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span> <span class="n">local</span> <span class="o">-</span><span class="n">u</span> <span class="n">daixiang</span> <span class="o">-</span><span class="n">m</span> <span class="n">setup</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;filter=ansible_all_ipv4_addresses&#39;</span>
<span class="c1"># 获取远程主机信息</span>
<span class="n">ansible</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span> <span class="n">rundeck</span> <span class="o">-</span><span class="n">u</span> <span class="n">will</span> <span class="o">-</span><span class="n">m</span> <span class="n">setup</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;filter=ansible_all_ipv4_addresses&#39;</span>

<span class="c1"># 注释:</span>
<span class="o">-</span><span class="n">i</span> <span class="n">Inventory</span><span class="err">主机配置</span>
<span class="o">-</span><span class="n">u</span> <span class="err">用户名</span>
<span class="o">-</span><span class="n">m</span> <span class="err">模块</span>
<span class="o">-</span><span class="n">k</span> <span class="err">输入密码</span>
</pre></div>
</div>
<h2>2.7 PlayBook简介</h2>

<p>ansbile-playbook是一系列ansible命令的集合，利用yaml 语言编写。playbook命令根据自上而下的顺序依次执行。同时，playbook开创了很多特性,它可以允许你传输某个命令的状态到后面的指令,如你可以从一台机器的文件中抓取内容并附为变量,然后在另一台机器中使用,这使得你可以实现一些复杂的部署机制,这是ansible命令无法实现的;</p>

<p>playbook通过ansible-playbook命令使用,它的参数和ansible命令类似,如参数-k(–ask-pass) 和 -K (–ask-sudo) 来询问ssh密码和sudo密码,-u指定用户,这些指令也可以通过规定的单元写在playbook;</p>

<p>ansible-playbook的简单使用方法: ansible-playbook example-play.yml;</p>

<h3>2.7.1 简单Playbook实例</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># cat user.yml</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">create</span> <span class="n">user</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>  <span class="c1"># 指定主机</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">root</span>  <span class="c1"># 指定用户</span>
  <span class="n">gather_facts</span><span class="p">:</span> <span class="n">false</span> <span class="c1"># 是否执行setup模块获取主机相关信息,以便于task使用到setup获取的信息</span>
  <span class="nb">vars</span><span class="p">:</span> <span class="c1"># 指定变量</span>
    <span class="n">user</span><span class="p">:</span><span class="s2">&quot;test&quot;</span>
  <span class="n">tasks</span><span class="p">:</span> <span class="c1"># 设定任务</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">create</span>  <span class="n">user</span>  <span class="c1"># 任务名称</span>
      <span class="n">user</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;{{ user }}&quot;</span> <span class="c1"># 调用user模块, name是user模块里的一个参数，而增加的用户名字调用了上面user变量的值</span>
      
<span class="err">注释</span><span class="p">:</span> <span class="err">若是删除用户可改为</span>
<span class="n">user</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;{{ user }}&quot;</span> <span class="n">state</span><span class="o">=</span><span class="n">absent</span> <span class="n">remove</span><span class="o">=</span><span class="n">yes</span>
</pre></div>
</div>
<h3>2.7.2 通过Playbook安装apache</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># cat install_apache.yml</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
  <span class="n">gather_facts</span><span class="p">:</span><span class="bp">True</span>
  <span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">apache</span> <span class="n">on</span> <span class="n">CentOS</span>
    <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">httpd</span> <span class="n">state</span><span class="o">=</span><span class="n">present</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;CentOS&quot;</span> 
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">apache</span> <span class="n">on</span> <span class="n">Debian</span>
    <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">apache2</span> <span class="n">state</span><span class="o">=</span><span class="n">present</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;Debian&quot;</span>
</pre></div>
</div>
<h3>2.7.3 Playbook的构成</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">hosts</span>    <span class="err">主机层</span>
<span class="nb">vars</span>     <span class="err">变量层</span>
    <span class="n">tasks</span>    <span class="err">任务层</span>
<span class="n">handlers</span> <span class="err">触发条件</span>
<span class="n">files</span>    <span class="err">文件</span>
<span class="n">template</span> <span class="err">模板</span>
</pre></div>
</div>
<ul>
<li>Hosts和users</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="n">hosts</span><span class="err">：用于指定要执行指定任务的主机其可以是一个或多个由冒号分隔主机组。</span>
<span class="mf">2.</span> <span class="n">remote_user</span> <span class="err">：用于指定远程主机上的执行任务的用户。不过</span><span class="n">remote_user</span><span class="err">也可用于各</span><span class="n">task</span><span class="err">中。也可以通过指定其通过</span><span class="n">sudo</span><span class="err">的方式在远程主机上执行任务其可用于</span><span class="n">play</span><span class="err">全局或某任务。此外甚至可以在</span><span class="n">sudo</span><span class="err">时使用</span><span class="n">sudo_user</span><span class="err">指定</span><span class="n">sudo</span><span class="err">时切换的用户。</span>
<span class="mf">3.</span> <span class="n">user</span><span class="err">：于</span><span class="n">remote_user</span><span class="err">相同</span>
<span class="mf">4.</span> <span class="n">sudo</span><span class="err">：如果设置为</span><span class="n">yes</span><span class="err">，执行该任务组的用户在执行任务的时候，获取</span><span class="n">root</span><span class="err">权限</span>
<span class="mf">5.</span> <span class="n">sudo_user</span><span class="err">：如果设置</span><span class="n">user</span><span class="err">为</span><span class="n">breeze</span><span class="err">，</span><span class="n">sudo</span><span class="err">为</span><span class="n">yes</span><span class="err">，</span><span class="n">sudo_user</span><span class="err">为</span><span class="n">bernie</span><span class="err">时，则</span><span class="n">breeze</span><span class="err">用户在执行任务时会获得</span><span class="n">bernie</span><span class="err">用户的权限</span>
<span class="mf">6.</span> <span class="n">connection</span><span class="err">：通过什么方式连接到远程主机，默认为</span><span class="n">ssh</span>
<span class="mf">7.</span> <span class="n">gather_facts</span><span class="err">：除非明确说明不需要在远程主机上执行</span><span class="n">setup</span><span class="err">模块，否则默认自动执行。如果确实不需要</span><span class="n">setup</span><span class="err">模块传递过来的变量，则可以将该选项设置为</span><span class="bp">False</span>
</pre></div>
</div>
<ul>
<li>任务列表和Action</li>
</ul>

<p>任务列表中的各任务按次序逐个在hosts中指定的所有主机上执行即在所有主机上完成第一个任务后再开始第二个。在自上而下运行某playbook时如果中途发生错误，所有已执行任务都将回滚因此在更正playbook后重新执行一次即可;</p>

<p>task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。<code>模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</code>。每个task都应该有其name用于playbook的执行结果输出，建议其内容尽可能清晰地描述任务执行步骤。如果未提供name则action的结果将用于输出;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1">#如果命令或脚本的退出码不为零可以使用如下方式替代</span>
<span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">run</span> <span class="n">this</span> <span class="n">command</span> <span class="ow">and</span> <span class="n">ignore</span> <span class="n">the</span> <span class="n">result</span>
    <span class="n">shell</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">somecommand</span> <span class="o">||</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">true</span>

<span class="c1">#使用ignore_errors来忽略错误信息</span>
<span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">run</span> <span class="n">this</span> <span class="n">command</span> <span class="ow">and</span> <span class="n">ignore</span> <span class="n">the</span> <span class="n">result</span>
    <span class="n">shell</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">somecommand</span>
    <span class="n">ignore_errors</span><span class="p">:</span> <span class="bp">True</span>
</pre></div>
</div>
<ul>
<li>触发任务handlers: 用于当关注的资源发生变化时采取一定的操作</li>
</ul>

<p><q>notify</q>这个action可用于在每个play的最后被触发，这样可以避免多次有改变发生时每次都执行指定的操作，取而代之仅在所有的变化发生完成后一次性地执行指定操作;</p>

<p>在notify中列出的操作称为handler也即notify中调用handler中定义的操作;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">template</span> <span class="n">configuration</span> <span class="nb">file</span>
  <span class="n">template</span><span class="p">:</span> <span class="n">src</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">j2</span> <span class="n">dest</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">foo</span><span class="o">.</span><span class="n">conf</span>
  <span class="n">notify</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">restart</span> <span class="n">memcached</span>
  <span class="o">-</span> <span class="n">restart</span> <span class="n">apache</span>

<span class="c1">#handler是task列表这些task与前述的task并没有本质上的不同。</span>
<span class="n">handlers</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">restart</span> <span class="n">memcached</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">memcached</span> <span class="n">state</span><span class="o">=</span><span class="n">restarted</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">restart</span> <span class="n">apache</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">apache</span> <span class="n">state</span><span class="o">=</span><span class="n">restarted</span>
</pre></div>
</div>
<h2>2.8 PlayBook常用模块</h2>

<p>playbook的模块与在ansible命令行下使用的模块有一些不同。这主要是因为在playbook中会使用到一些<code>set_fact</code>和<code>通过setup模块</code>从远程主机上获取到的变量。有些模块没法在命令行下运行，就是因为它们需要这些变量。而且即使那些可以在命令行下工作的模块也可以通过playbook的模块获取一些更高级的功能;</p>

<h3>2.8.1 template模板</h3>

<ul>
<li>常用参数</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>backup：如果原目标文件存在，则先备份目标文件
dest：目标文件路径
force：是否强制覆盖，默认为yes
group：目标文件属组
mode：目标文件的权限
owner：目标文件属主
src：源模板文件路径
validate：在复制之前通过命令验证目标文件，如果验证通过则复制</pre></div></div>

<ul>
<li>官方简单示例：</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>- template: src=/mytemplates/foo.j2 dest=/etc/file.conf owner=bin group=wheel mode=0644
- template: src=/mytemplates/foo.j2 dest=/etc/file.conf owner=bin group=wheel mode="u=rw,g=r,o=r"
- template: src=/mine/sudoers dest=/etc/sudoers validate='visudo -cf %s'</pre></div></div>

<ul>
<li>我的一个简单例子</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>- name: named 

  #vars_prompt:
  #  - name: 'hosts'
  #    prompt: '请输入主机名称'
  #    private: no
  #    default: 'localhost'

  #hosts: "{{ hosts }}"
  hosts: "localhost"

  tasks:
    - name: named
      template: src=templates/named.conf.j2 dest=named.conf owner=daixiang group=staff mode=0640</pre></div></div>

<h3>2.8.2 set_fact 自定义facts</h3>

<p>set_fact模块可以自定义facts，这些自定义的facts可以通过template或者变量的方式在playbook中使用;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">下面是一个配置</span><span class="n">mysql</span> <span class="n">innodb</span> <span class="nb">buffer</span> <span class="n">size</span><span class="err">的示例：</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Configure</span> <span class="n">MySQL</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="n">mysqlservers</span>
  <span class="n">tasks</span><span class="p">:</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">MySql</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">mysql</span><span class="o">-</span><span class="n">server</span> <span class="n">state</span><span class="o">=</span><span class="n">installed</span>

    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Calculate</span> <span class="n">InnoDB</span> <span class="nb">buffer</span> <span class="n">pool</span> <span class="n">size</span>
      <span class="n">set_fact</span><span class="p">:</span> <span class="n">innodb_buffer_pool_size_mb</span><span class="o">=</span><span class="s2">&quot;{{ ansible_memtotal_mb / 2 }}&quot;</span>

    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Configure</span> <span class="n">MySQL</span> 
      <span class="n">template</span><span class="p">:</span> <span class="n">src</span><span class="o">=</span><span class="n">templates</span><span class="o">/</span><span class="n">my</span><span class="o">.</span><span class="n">cnf</span> <span class="n">dest</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="o">.</span><span class="n">cnf</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0644</span> 
      <span class="n">notify</span><span class="p">:</span> <span class="n">restart</span> <span class="n">mysql</span> 

    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Start</span> <span class="n">MySQL</span> 
      <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">mysqld</span> <span class="n">state</span><span class="o">=</span><span class="n">started</span> <span class="n">enabled</span><span class="o">=</span><span class="n">yes</span> 
  <span class="n">handlers</span><span class="p">:</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">restart</span> <span class="n">mysql</span> 
      <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">mysqld</span> <span class="n">state</span><span class="o">=</span><span class="n">restarted</span>
</pre></div>
</div>
<h3>2.8.3 pause 暂停</h3>

<p>在playbook执行的过程中暂停一定时间或者提示用户进行某些操作
- 常用参数</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">minutes</span><span class="err">：暂停多少分钟</span>
<span class="n">seconds</span><span class="err">：暂停多少秒</span>
<span class="n">prompt</span><span class="err">：打印一串信息提示用户操作</span>
<span class="err">示例：</span>
 <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">wait</span> <span class="n">on</span> <span class="n">user</span> <span class="nb">input</span>
   <span class="n">pause</span><span class="p">:</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Warning! Detected slight issue. ENTER to continue CTRL-C a to quit&quot;</span> 
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">timed</span> <span class="n">wait</span>
  <span class="n">pause</span><span class="p">:</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">30</span>
</pre></div>
</div>
<h3>2.8.4 wait_for 等待某任务完成</h3>

<p>在playbook的执行过程中，等待某些操作完成以后再进行后续操作</p>

<ul>
<li>常用参数</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">connect_timeout</span><span class="err">：在下一个任务执行之前等待连接的超时时间</span>
<span class="n">delay</span><span class="err">：等待一个端口或者文件或者连接到指定的状态时，默认超时时间为</span><span class="mi">300</span><span class="err">秒，在这等待的</span><span class="mi">300</span><span class="n">s</span><span class="err">的时间里，</span><span class="n">wait_for</span><span class="err">模块会一直轮询指定的对象是否到达指定的状态，</span><span class="n">delay</span><span class="err">即为多长时间轮询一次状态。</span>
<span class="n">host</span><span class="err">：</span><span class="n">wait_for</span><span class="err">模块等待的主机的地址，默认为</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
<span class="n">port</span><span class="err">：</span><span class="n">wait_for</span><span class="err">模块待待的主机的端口</span>
<span class="n">path</span><span class="err">：文件路径，只有当这个文件存在时，下一任务才开始执行，即等待该文件创建完成</span>
<span class="n">state</span><span class="err">：等待的状态，即等待的文件或端口或者连接状态达到指定的状态时，下一个任务开始执行。当等的对象为端口时，状态有</span><span class="n">started</span><span class="err">，</span><span class="n">stoped</span><span class="err">，即端口已经监听或者端口已经关闭；当等待的对象为文件时，状态有</span><span class="n">present</span><span class="err">或者</span><span class="n">started</span><span class="err">，</span><span class="n">absent</span><span class="err">，即文件已创建或者删除；当等待的对象为一个连接时，状态有</span><span class="n">drained</span><span class="err">，即连接已建立。默认为</span><span class="n">started</span>
<span class="n">timeout</span><span class="err">：</span><span class="n">wait_for</span><span class="err">的等待的超时时间</span><span class="p">,</span><span class="err">默认为</span><span class="mi">300</span><span class="err">秒</span>
</pre></div>
</div>
<ul>
<li>示例</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span> <span class="n">state</span><span class="o">=</span><span class="n">started</span>     <span class="c1">#等待8080端口已正常监听，才开始下一个任务，直到超时</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span>    <span class="c1">#等待8000端口正常监听，每隔10s检查一次，直至等待超时</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">host</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span> <span class="n">state</span><span class="o">=</span><span class="n">drained</span>    <span class="c1">#等待8000端口直至有连接建立</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">host</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span> <span class="n">state</span><span class="o">=</span><span class="n">drained</span> <span class="n">exclude_hosts</span><span class="o">=</span><span class="mf">10.2</span><span class="o">.</span><span class="mf">1.2</span><span class="p">,</span><span class="mf">10.2</span><span class="o">.</span><span class="mf">1.3</span>    <span class="c1">#等待8000端口有连接建立，如果连接来自10.2.1.2或者10.2.1.3，则忽略。</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">foo</span>    <span class="c1">#等待/tmp/foo文件已创建</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">foo</span> <span class="n">search_regex</span><span class="o">=</span><span class="n">completed</span>    <span class="c1">#等待/tmp/foo文件已创建，而且该文件中需要包含completed字符串</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lock</span><span class="o">/</span><span class="nb">file</span><span class="o">.</span><span class="n">lock</span> <span class="n">state</span><span class="o">=</span><span class="n">absent</span>    <span class="c1">#等待/var/lock/file.lock被删除</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">proc</span><span class="o">/</span><span class="mi">3466</span><span class="o">/</span><span class="n">status</span> <span class="n">state</span><span class="o">=</span><span class="n">absent</span>        <span class="c1">#等待指定的进程被销毁</span>
<span class="o">-</span> <span class="n">local_action</span><span class="p">:</span> <span class="n">wait_for</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;{{ ansible_ssh_host | default(inventory_hostname) }}&quot;</span> <span class="n">search_regex</span><span class="o">=</span><span class="n">OpenSSH</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span>    <span class="c1">#等待openssh启动，10s检查一次</span>
</pre></div>
</div>
<h3>2.8.5 assemble 合并文件</h3>

<p>用于组装文件，即将多个零散的文件，合并一个大文件</p>

<ul>
<li>常用参数</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">src</span><span class="err">：原文件</span><span class="p">(</span><span class="err">即零散文件</span><span class="p">)</span><span class="err">的路径</span>
<span class="n">dest</span><span class="err">：合并后的大文件路径</span>
<span class="n">group</span><span class="err">：合并后的大文件的属组</span>
<span class="n">owner</span><span class="err">：合并后的大文件的属主</span>
<span class="n">mode</span><span class="err">：合并后的大文件的权限</span>
<span class="n">validate</span><span class="err">：与</span><span class="n">template</span><span class="err">的</span><span class="n">validate</span><span class="err">相同，指定命令验证文件</span>
<span class="n">ignore_hidden</span><span class="err">：组装时，是否忽略隐藏文件，默认为</span><span class="n">no</span><span class="err">，该参数在</span><span class="mf">2.0</span><span class="err">版本中新增</span>
</pre></div>
</div>
<ul>
<li>示例</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span> 
  <span class="n">tasks</span><span class="p">:</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Make</span> <span class="n">a</span> <span class="n">Directory</span> <span class="ow">in</span> <span class="o">/</span><span class="n">opt</span>
      <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">sshkeys</span> <span class="n">state</span><span class="o">=</span><span class="n">directory</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0700</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Copy</span> <span class="n">SSH</span> <span class="n">keys</span> <span class="n">over</span> 
      <span class="n">copy</span><span class="p">:</span> <span class="n">src</span><span class="o">=</span><span class="n">keys</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span><span class="o">.</span><span class="n">pub</span> <span class="n">dest</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">sshkeys</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span><span class="o">.</span><span class="n">pub</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0600</span> 
      <span class="n">with_items</span><span class="p">:</span> 
        <span class="o">-</span> <span class="n">dan</span> 
        <span class="o">-</span> <span class="n">kate</span> 
        <span class="o">-</span> <span class="n">mal</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Make</span> <span class="n">the</span> <span class="n">root</span> <span class="n">users</span> <span class="n">SSH</span> <span class="n">config</span> <span class="n">directory</span> 
      <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">ssh</span> <span class="n">state</span><span class="o">=</span><span class="n">directory</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0700</span> 

    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Build</span> <span class="n">the</span> <span class="n">authorized_keys</span> <span class="nb">file</span> 
      <span class="n">assemble</span><span class="p">:</span> <span class="n">src</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">sshkeys</span><span class="o">/</span> <span class="n">dest</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0700</span>   <span class="c1">#将/opt/sshkeys目录里所有的文件合并到/root/.ssh/authorized_keys一个文件中</span>
</pre></div>
</div>
<h3>2.8.6 add_host 动态添加主机</h3>

<p>在playbook执行的过程中，动态的添加主机到指定的主机组中</p>

<ul>
<li>常用参数</li>
</ul>

<p>groups：添加主机至指定的组
name：要添加的主机名或IP地址</p>

<ul>
<li>示例</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">add</span> <span class="n">a</span> <span class="n">host</span> <span class="n">to</span> <span class="n">group</span> <span class="n">webservers</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">add_host</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">ip_from_ec2</span> <span class="p">}}</span> <span class="n">group</span><span class="o">=</span><span class="n">webservers</span> <span class="n">foo</span><span class="o">=</span><span class="mi">42</span>    <span class="c1">#添加主机到webservers组中，主机的变量foo的值为42</span>
</pre></div>
</div>
<h3>2.8.7 group_by 动态创建主机组</h3>

<p>在playbook执行的过程中，动态的创建主机组</p>

<ul>
<li>示例</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Create</span> <span class="n">operating</span> <span class="n">system</span> <span class="n">group</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">group_by</span><span class="p">:</span> <span class="n">key</span><span class="o">=</span><span class="n">os_</span><span class="p">{{</span> <span class="n">ansible_distribution</span> <span class="p">}}</span>           <span class="c1">#在playbook中设置一个新的主机组</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Run</span> <span class="n">on</span> <span class="n">CentOS</span> <span class="n">hosts</span> <span class="n">only</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="n">os_CentOS</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Install</span> <span class="n">Apache</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">httpd</span> <span class="n">state</span><span class="o">=</span><span class="n">latest</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Run</span> <span class="n">on</span> <span class="n">Ubuntu</span> <span class="n">hosts</span> <span class="n">only</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="n">os_Ubuntu</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Install</span> <span class="n">Apache</span>
      <span class="n">apt</span><span class="p">:</span> <span class="n">pkg</span><span class="o">=</span><span class="n">apache2</span> <span class="n">state</span><span class="o">=</span><span class="n">latest</span>
</pre></div>
</div>
<h3>2.8.8 debug调试</h3>

<p>调试模块，用于在调试中输出信息</p>

<ul>
<li>常用参数</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">msg</span><span class="err">：调试输出的消息</span>
<span class="n">var</span><span class="err">：将某个任务执行的输出作为变量传递给</span><span class="n">debug</span><span class="err">模块，</span><span class="n">debug</span><span class="err">会直接将其打印输出</span>
<span class="n">verbosity</span><span class="err">：</span><span class="n">debug</span><span class="err">的级别</span>
</pre></div>
</div>
<ul>
<li>示例</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># Example that prints the loopback address and gateway for each host- debug: msg=&quot;System {{ inventory_hostname }} has uuid {{ ansible_product_uuid }}&quot;</span>

<span class="o">-</span> <span class="n">debug</span><span class="p">:</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;System {{ inventory_hostname }} has gateway {{ ansible_default_ipv4.gateway }}&quot;</span>
  <span class="n">when</span><span class="p">:</span> <span class="n">ansible_default_ipv4</span><span class="o">.</span><span class="n">gateway</span> <span class="ow">is</span> <span class="n">defined</span>

<span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">uptime</span>
  <span class="n">register</span><span class="p">:</span> <span class="n">result</span>

<span class="o">-</span> <span class="n">debug</span><span class="p">:</span> <span class="n">var</span><span class="o">=</span><span class="n">result</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span>    <span class="c1">#直接将上一条指令的结果作为变量传递给var，由debug打印出result的值</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Display</span> <span class="nb">all</span> <span class="n">variables</span><span class="o">/</span><span class="n">facts</span> <span class="n">known</span> <span class="k">for</span> <span class="n">a</span> <span class="n">host</span>
  <span class="n">debug</span><span class="p">:</span> <span class="n">var</span><span class="o">=</span><span class="n">hostvars</span><span class="p">[</span><span class="n">inventory_hostname</span><span class="p">]</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">4</span>
</pre></div>
</div>
<h3>2.8.9 fail终止当前playbook的执行</h3>

<p>用于终止当前playbook的执行，通常与条件语句组合使用，当满足条件时，终止当前play的运行。可以直接由failed_when取代。</p>

<p>选项只有一个：
msg：终止前打印出信息</p>

<ul>
<li>示例</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">fail</span><span class="p">:</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;The system may not be provisioned according to the CMDB status.&quot;</span>
  <span class="n">when</span><span class="p">:</span> <span class="n">cmdb_status</span> <span class="o">!=</span> <span class="s2">&quot;to-be-staged&quot;</span>
</pre></div>
</div>
<h2>2.9 PlayBook的循环</h2>

<h3>2.9.1 with_items 最基本也是最常用的循环语句</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 简单例子</span>

<span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Secure</span> <span class="n">config</span> <span class="n">files</span>
    <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0600</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span>
    <span class="n">with_items</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">my</span><span class="o">.</span><span class="n">cnf</span>
        <span class="o">-</span> <span class="n">shadow</span>
        <span class="o">-</span> <span class="n">fstab</span>

<span class="c1"># 也可以将循环内容提前传入一个变量</span>
<span class="n">with_items</span><span class="p">:</span> <span class="s2">&quot;{{ somelist }}&quot;</span>

<span class="c1"># 字典类型</span>
<span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">add</span> <span class="n">several</span> <span class="n">users</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="p">}}</span> <span class="n">state</span><span class="o">=</span><span class="n">present</span> <span class="n">groups</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span><span class="o">.</span><span class="n">groups</span> <span class="p">}}</span>
  <span class="n">with_items</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;testuser1&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="p">:</span> <span class="s1">&#39;wheel&#39;</span> <span class="p">}</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;testuser2&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span> <span class="p">}</span>
</pre></div>
</div>
<h3>2.9.2 with_nested嵌套循环, 排列组合</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">give</span> <span class="n">users</span> <span class="n">access</span> <span class="n">to</span> <span class="n">multiple</span> <span class="n">databases</span>
  <span class="n">mysql_user</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">}}</span> <span class="n">priv</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">}}</span><span class="o">.*</span><span class="p">:</span><span class="n">ALL</span> <span class="n">append_privs</span><span class="o">=</span><span class="n">yes</span> <span class="n">password</span><span class="o">=</span><span class="n">foo</span>
  <span class="n">with_nested</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">[</span> <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;bob&#39;</span> <span class="p">]</span>
    <span class="o">-</span> <span class="p">[</span> <span class="s1">&#39;clientdb&#39;</span><span class="p">,</span> <span class="s1">&#39;employeedb&#39;</span><span class="p">,</span> <span class="s1">&#39;providerdb&#39;</span> <span class="p">]</span>
</pre></div>
</div>
<h3>2.9.3 with_dict遍历更复杂的数据结构</h3>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>假如有如下变量内容：
users:
  alice:
    name: Alice Appleworth
    telephone: 123-456-7890
  bob:
    name: Bob Bananarama
    telephone: 987-654-3210

现在需要输出每个用户的用户名和手机号：
tasks:
  - name: Print phone records
    debug: msg="User {{ item.key }} is {{ item.value.name }} ({{ item.value.telephone }})"
    with_dict: "{{ users }}"</pre></div></div>

<h3>2.9.4 with_fileglob文件匹配遍历</h3>

<p>可以指定一个目录，使用with_fileglob可以循环这个目录中的所有文件</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Make</span> <span class="n">key</span> <span class="n">directory</span>     
      <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">sshkeys</span> <span class="n">ensure</span><span class="o">=</span><span class="n">directory</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0700</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span>     
<span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Upload</span> <span class="n">public</span> <span class="n">keys</span>     
      <span class="n">copy</span><span class="p">:</span> <span class="n">src</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span> <span class="n">dest</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">sshkeys</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0600</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span>     
      <span class="n">with_fileglob</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">keys</span><span class="o">/*.</span><span class="n">pub</span>     
<span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Assemble</span> <span class="n">keys</span> <span class="n">into</span> <span class="n">authorized_keys</span> <span class="nb">file</span>     
      <span class="n">assemble</span><span class="p">:</span> <span class="n">src</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">sshkeys</span> <span class="n">dest</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keysmode</span><span class="o">=</span><span class="mo">0600</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span>
</pre></div>
</div>
<p><a href="http://breezey.blog.51cto.com/2400275/1757636">详情请参考</a></p>

<h2>2.10 Ansible条件语句</h2>

<p>在有的时候play的结果依赖于变量、fact或者是前一个任务的执行结果，从而需要使用到条件语句</p>

<h3>2.10.1 基本使用</h3>

<ul>
<li>when</li>
</ul>

<p>有的时候在特定的主机需要跳过特定的步骤，例如在安装包的时候，需要指定主机的操作系统类型，或者是当操作系统的硬盘满了之后，需要清空文件等,可以使用when语句来做判断 。when关键字后面跟着的是python的表达式,在表达式中你能够使用任何的变量或者fact,当表达式的结果返回的是false,便会跳过本次的任务;</p>

<ul>
<li>基本用法，示例</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Install</span> <span class="n">VIM</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Install</span> <span class="n">VIM</span> <span class="n">via</span> <span class="n">yum</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">vim</span><span class="o">-</span><span class="n">enhanced</span> <span class="n">state</span><span class="o">=</span><span class="n">installed</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;RedHat&quot;</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Install</span> <span class="n">VIM</span> <span class="n">via</span> <span class="n">apt</span>
      <span class="n">apt</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">vim</span> <span class="n">state</span><span class="o">=</span><span class="n">installed</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;Debian&quot;</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Unexpected</span> <span class="n">OS</span> <span class="n">family</span>
      <span class="n">debug</span><span class="p">:</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;OS Family {{ ansible_os_family }} is not supported&quot;</span> <span class="n">fail</span><span class="o">=</span><span class="n">yes</span>
      <span class="n">when</span><span class="p">:</span> <span class="ow">not</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;RedHat&quot;</span> <span class="ow">or</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;Debian&quot;</span>
</pre></div>
</div>
<ul>
<li>等待输入确认</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">pause</span> <span class="k">for</span> <span class="n">unexpected</span> <span class="n">conditions</span>
  <span class="n">pause</span><span class="p">:</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Unexpected OS&quot;</span>
  <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">!=</span><span class="s2">&quot;RedHat&quot;</span>
</pre></div>
</div>
<ul>
<li>when中使用jinja2</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">false</span>
    <span class="n">register</span><span class="p">:</span> <span class="n">result</span>        <span class="c1">#将命令执行的结果传递给result变量</span>
    <span class="n">ignore_errors</span><span class="p">:</span> <span class="bp">True</span>    <span class="c1">#忽略错误</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">something</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">result</span><span class="o">|</span><span class="n">failed</span>    <span class="c1">#如果注册变量的值 是任务failed则返回true</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">something_else</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">result</span><span class="o">|</span><span class="n">success</span>    <span class="c1">#如果注册变量的值是任务success则返回true</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">still</span><span class="o">/</span><span class="n">something_else</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">result</span><span class="o">|</span><span class="n">skipped</span>    <span class="c1">#如果注册变量的值是任务skipped则返回true</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">foo</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">result</span><span class="o">|</span><span class="n">changed</span>    <span class="c1">#如果注册变量的值是任务changed则返回true</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">root</span>
  <span class="nb">vars</span><span class="p">:</span>
    <span class="n">epic</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">tasks</span><span class="p">:</span>    <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;This certainly is epic!&quot;</span>      <span class="n">when</span><span class="p">:</span> <span class="n">epic</span>
    <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;This certainly is not epic!&quot;</span>
      <span class="n">when</span><span class="p">:</span> <span class="ow">not</span> <span class="n">epic</span>
</pre></div>
</div>
<ul>
<li>如果变量不存在，则可以通过jinja2的&#39;defined&#39;命令跳过，示例：</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;I&#39;ve got &#39;{{ foo }}&#39; and am not afraid to use it!&quot;</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">foo</span> <span class="ow">is</span> <span class="n">defined</span>
    <span class="o">-</span> <span class="n">fail</span><span class="p">:</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Bailing out. this play requires &#39;bar&#39;&quot;</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
</pre></div>
</div>
<ul>
<li>when在循环语句中的使用方法，示例：</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="n">echo</span> <span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span>
      <span class="n">with_items</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span> <span class="p">]</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">item</span> <span class="o">&gt;</span> <span class="mi">56</span><span class="err">、在</span><span class="n">include</span><span class="err">和</span><span class="n">roles</span><span class="err">中使用</span><span class="n">when</span><span class="err">：</span>
<span class="err">在</span><span class="n">include</span><span class="err">中使用的示例：</span><span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">tasks</span><span class="o">/</span><span class="n">sometasks</span><span class="o">.</span><span class="n">yml</span>
  <span class="n">when</span><span class="p">:</span> <span class="s2">&quot;&#39;reticulating splines&#39; in output&quot;</span>
<span class="err">在</span><span class="n">roles</span><span class="err">中使用的示例：</span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
     <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">debian_stock_config</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span> <span class="s1">&#39;Debian&#39;</span> <span class="p">}</span>
</pre></div>
</div>
<p><a href="http://breezey.blog.51cto.com/2400275/1757593">详情请参考</a></p>

<h2>2.10 PlayBook的roles和include</h2>

<p><a href="http://breezey.blog.51cto.com/2400275/1757832">详情请参考</a></p>

<p>当单个playbook文件越来越大的时候，我们就需要重新来组织Playbooks了。我们可以将一个大的playbook拆成若干个小的playbook文件，然后通过include的方式，在主配置文件中将这些零碎的小文件包含进来，这叫做playbook的包含。我们也可以按照一定的规则将执行的某一类型任务放在一个目录里，并在这个目录中再次对这个playbook按照tasks,handlers，files,templates,vars等类型划分成若干文件，将对应文件存放在对应的目录中，这种组织方式就叫做playbook的roles。</p>

<h3>2.10.1 PlayBook的包含: include</h3>

<h4>tasks包含</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 一个task文件foo.yml示例如下</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">placeholder</span> <span class="n">foo</span>
  <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">foo</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">placeholder</span> <span class="n">bar</span>
  <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bar</span>
  
<span class="c1"># 在另一个task文件bar.yml中包含foo.yml</span>
<span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">tasks</span><span class="o">/</span><span class="n">foo</span><span class="o">.</span><span class="n">yml</span>

<span class="c1"># 也可以在include的时候，带入变量</span>
<span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">wordpress</span><span class="o">.</span><span class="n">yml</span> <span class="n">user</span><span class="o">=</span><span class="n">timmy</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">wordpress</span><span class="o">.</span><span class="n">yml</span> <span class="n">user</span><span class="o">=</span><span class="n">alice</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">wordpress</span><span class="o">.</span><span class="n">yml</span> <span class="n">user</span><span class="o">=</span><span class="n">bob</span>

<span class="n">tasks</span><span class="p">:</span>
 <span class="o">-</span> <span class="p">{</span> <span class="n">include</span><span class="p">:</span> <span class="n">wordpress</span><span class="o">.</span><span class="n">yml</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">timmy</span><span class="p">,</span> <span class="n">ssh_keys</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;keys/one.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;keys/two.txt&#39;</span> <span class="p">]</span> <span class="p">}</span>
</pre></div>
</div>
<h4>handlers包含</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># handlers1.yml内容如下：</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">restart</span> <span class="n">apache</span>
  <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">apache</span> <span class="n">state</span><span class="o">=</span><span class="n">restarted</span>
<span class="c1"># handlers.yml包含handlers1.yml示例</span>
<span class="n">handlers</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">handlers</span><span class="o">/</span><span class="n">handlers</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<h4>混合包含</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># include也可以用于将一个playbook导入到另一个playbook中：</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">play</span> <span class="n">at</span> <span class="n">the</span> <span class="n">top</span> <span class="n">level</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">file</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
  <span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">say</span> <span class="n">hi</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">foo</span>
    <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;hi...&quot;</span>
<span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">load_balancers</span><span class="o">.</span><span class="n">yml</span>
<span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span>
<span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">dbservers</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<h3>2.10.2 PlayBook的角色: roles</h3>

<h4>创建role</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">)</span><span class="err">创建以</span><span class="n">roles</span><span class="err">命令的目录</span>
<span class="mi">2</span><span class="p">)</span><span class="err">在</span><span class="n">roles</span><span class="err">目录中分别创建角色名称命名的目录，如</span><span class="n">websrvs</span><span class="err">等</span>
<span class="mi">3</span><span class="p">)</span><span class="err">在每个角色命名的目录中分别创建</span><span class="n">files</span><span class="err">、</span><span class="n">handlers</span><span class="err">、</span><span class="n">meta</span><span class="err">、</span><span class="n">tasks</span><span class="err">、</span><span class="n">teamplates</span><span class="err">和</span><span class="nb">vars</span><span class="err">目录，用不到的目录可以创建为空目录，也可以不创建。</span>
<span class="mi">4</span><span class="p">)</span><span class="err">在</span><span class="n">playbook</span><span class="err">文件中，调用各角色</span>

<span class="n">roles</span><span class="err">各目录的作用及可用的文件：</span>
    <span class="n">files</span><span class="err">：存放由</span><span class="n">copy</span><span class="err">或</span><span class="n">script</span><span class="err">等模块调用的文件</span>
    <span class="n">tempaltes</span><span class="err">：</span><span class="n">Jinja2</span><span class="err">模板文件</span>
    <span class="n">tasks</span><span class="err">：至少应该包含一个名为</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">的文件，其定义了此角色的任务列表，些文件可以使用</span><span class="n">include</span><span class="err">包含其它的位于此目录中的</span><span class="n">task</span><span class="err">文件</span>
    <span class="n">handlers</span><span class="err">：至少包含一个</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">文件，用于定义此角色用到的各</span><span class="n">handler</span><span class="err">，在</span><span class="n">handler</span><span class="err">中使用</span><span class="n">include</span><span class="err">包含的其他</span><span class="n">handler</span><span class="err">文件也应该位于此目录</span>
    <span class="nb">vars</span><span class="err">：应当包含一个</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">文件，用于定义此角色用到的变量</span>
    <span class="n">meta</span><span class="err">：应当包含一个</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">文件，用于定义此角色的特殊设定及依赖关系等</span>
    <span class="n">default</span><span class="err">：为当前角色设定默认变量时使用些目录，包含一个</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">文件</span>
</pre></div>
</div>
<h4>引用role</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">基本引用的方法：</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
     <span class="o">-</span> <span class="n">common</span>
     <span class="o">-</span> <span class="n">webserver</span>

<span class="err">也可以通过如下方法引用时带入变量：</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">common</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">foo_app_instance</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="s1">&#39;/opt/a&#39;</span><span class="p">,</span>  <span class="n">port</span><span class="p">:</span> <span class="mi">5000</span> <span class="p">}</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">foo_app_instance</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="s1">&#39;/opt/b&#39;</span><span class="p">,</span>  <span class="n">port</span><span class="p">:</span> <span class="mi">5001</span> <span class="p">}</span>

<span class="err">还可以在引用时使用条件语句：</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">some_role</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="s2">&quot;ansible_os_family == &#39;RedHat&#39;&quot;</span> <span class="p">}</span>

<span class="err">下面也是一个带入变量的示例：</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">role</span><span class="p">:</span> <span class="n">database</span>
      <span class="n">database_name</span><span class="p">:</span> <span class="p">{{</span> <span class="n">db_name</span> <span class="p">}}</span>
      <span class="n">database_user</span><span class="p">:</span> <span class="p">{{</span> <span class="n">db_pass</span> <span class="p">}}</span>
    <span class="o">-</span> <span class="n">role</span><span class="p">:</span> <span class="n">webserver</span>
      <span class="n">live_hostname</span><span class="p">:</span> <span class="n">web1</span>
      <span class="n">domains</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>
        <span class="o">-</span> <span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<h4>pre<em>tasks和post</em>tasks</h4>

<ul>
<li>任务之前或者之后执行</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">如果在执行一个</span><span class="n">role</span><span class="err">时，需要在其前或其后依然要执行某些任务，我们可以使用</span><span class="n">pre_tasks</span><span class="err">及</span><span class="n">post_tasks</span><span class="err">来声明。</span><span class="n">pre_tasks</span><span class="err">是在</span><span class="n">role</span><span class="err">之前执行，而</span><span class="n">post_tasks</span><span class="err">则在</span><span class="n">role</span><span class="err">之后执行：</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">deply</span> <span class="n">webservers</span>
  <span class="n">host</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">vars_files</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">secrets</span><span class="o">.</span><span class="n">yml</span>
  <span class="n">pre_tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">update</span> <span class="n">yum</span> <span class="n">cache</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">update_cache</span><span class="o">=</span><span class="n">yes</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">role</span><span class="p">:</span> <span class="n">apache</span>
      <span class="n">database_host</span><span class="p">:</span> <span class="p">{{</span> <span class="n">hostvars</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ansible_eth0</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">address</span> <span class="p">}}</span>
      <span class="n">domains</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">exampel</span><span class="o">.</span><span class="n">com</span>
        <span class="o">-</span> <span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
  <span class="n">post_tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="k">print</span> <span class="n">something</span>
      <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;The roles have been updated!&quot;</span>
</pre></div>
</div>
<h4>role的依赖</h4>

<p>如果当前role在执行前需要依赖另一个role，我们可以在roles的meta目录中的main.yml中定义role的依赖关系;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">示例</span><span class="mi">1</span><span class="err">：</span>
<span class="c1">#roles/webservers/meta/main.yml</span>
<span class="n">dependencies</span><span class="p">:</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">common</span><span class="p">,</span> <span class="n">some_parameter</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">apache</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="mi">80</span> <span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">postgres</span><span class="p">,</span> <span class="n">dbname</span><span class="p">:</span> <span class="n">blarg</span><span class="p">,</span> <span class="n">other_parameter</span><span class="p">:</span> <span class="mi">12</span> <span class="p">}</span>

<span class="err">示例</span><span class="mi">2</span><span class="err">：</span>
<span class="n">dependencies</span><span class="p">:</span>
  <span class="o">-</span> <span class="p">{</span><span class="n">role</span><span class="p">:</span> <span class="n">ntp</span><span class="p">,</span> <span class="n">ntp_server</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="n">role</span><span class="p">:</span> <span class="n">web</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="n">role</span><span class="p">:</span> <span class="n">memcached</span><span class="p">}</span>
</pre></div>
</div>
<h4>Ansible Galaxy</h4>

<p>ansible-galaxy是一个工具，我们可以利用它快速的创建一个标准的roles目录结构，还可以通过它在https:/galaxy.ansible.com上下载别人写好的roles，直接拿来用;</p>

<p>通过ansible-galaxy初始化一个roles的目录结构，方法如下：</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy init /etc/ansible/roles/websrvs</pre></div></div>

<p>安装别人写好的roles：</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy install -p /etc/ansible/roles bennojoy.mysql</pre></div></div>

<p>列出已安装的roles：</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy list</pre></div></div>

<p>查看已安装的roles信息：</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy info bennojoy.mysql</pre></div></div>

<p>卸载roles：</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy remove bennojoy.mysql</pre></div></div>

<h2>2.11 Ansible的变量详解</h2>

<p><a href="http://breezey.blog.51cto.com/2400275/1757832">详情请参考</a></p>

<h3>2.11.1 在Inventory中定义变量</h3>

<p>参考2.4</p>

<h3>2.11.2 在Playbook中定义变量</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mi">1</span><span class="err">、通过</span><span class="nb">vars</span><span class="err">关键字定义：</span>
<span class="nb">vars</span><span class="p">:</span> 
  <span class="n">http_port</span><span class="p">:</span> <span class="mi">80</span>
  <span class="n">server_name</span><span class="p">:</span> <span class="n">localhost</span>
  <span class="n">cert_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">crt</span>
  <span class="n">key_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">key</span>
  <span class="n">conf_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">conf</span>

<span class="mi">2</span><span class="err">、通过</span><span class="n">vars_files</span><span class="err">关键字引入变量文件：</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
  <span class="nb">vars</span><span class="p">:</span>
    <span class="n">favcolor</span><span class="p">:</span> <span class="n">blue</span>
  <span class="n">vars_files</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">external_vars</span><span class="o">.</span><span class="n">yml</span>
    <span class="o">-</span> <span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">nginx_vars</span><span class="o">.</span><span class="n">yml</span>

<span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">nginx_vars</span><span class="o">.</span><span class="n">yml</span><span class="err">示例：</span>
<span class="n">http_port</span><span class="p">:</span> <span class="mi">80</span>
<span class="n">server_name</span><span class="p">:</span> <span class="n">localhost</span>
<span class="n">cert_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">crt</span>
<span class="n">key_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">key</span>
<span class="n">conf_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">conf</span>

<span class="mi">3</span><span class="err">、通过</span><span class="n">vars_prompt</span><span class="err">来实现人机交互：</span>
<span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
<span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
<span class="n">vars_prompt</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;https_passphrase&#39;</span>          <span class="c1">#存储数据的变量名</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="s1">&#39;Key Passphrase&#39;</span>          <span class="c1">#手工输入数据</span>
    <span class="n">private</span><span class="p">:</span> <span class="n">yes</span>                      <span class="c1">#当该值为yes，则用户的输入不会被打印</span>

<span class="mi">4</span><span class="err">、通过</span><span class="n">playbook</span><span class="err">的</span><span class="n">roles</span><span class="err">定义变量</span>
<span class="err">详见《</span><span class="n">ansible10</span><span class="err">：</span><span class="n">Playbook</span><span class="err">的角色与包含》</span>
</pre></div>
</div>
<h3>2.11.3 register注册变量</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">在有些时候，我们希望把某一条任务执行的结果保存下来，可以在接下的任务中调用或者做些判断，可以通过</span><span class="n">register</span><span class="err">关键字来实现：下面是个简单的例子，如果</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">motd</span><span class="err">文件中包含有</span><span class="s1">&#39;hi&#39;</span><span class="err">字符串时，则输出</span><span class="s2">&quot;mothd contains ther word hi&quot;</span><span class="err">：</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">test</span> <span class="n">play</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">tasks</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">motd</span>
        <span class="n">register</span><span class="p">:</span> <span class="n">motd_contents</span>
      <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;motd contains the word hi&quot;</span>
        <span class="n">when</span><span class="p">:</span> <span class="n">motd_contents</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
        
<span class="err">下面是一个</span><span class="n">register</span><span class="err">的变量在循环中使用的例子：</span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">registered</span> <span class="n">variable</span> <span class="n">usage</span> <span class="k">as</span> <span class="n">a</span> <span class="n">with_items</span> <span class="nb">list</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">tasks</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">retrieve</span> <span class="n">the</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">home</span> <span class="n">directories</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">ls</span> <span class="o">/</span><span class="n">home</span>
        <span class="n">register</span><span class="p">:</span> <span class="n">home_dirs</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">add</span> <span class="n">home</span> <span class="n">dirs</span> <span class="n">to</span> <span class="n">the</span> <span class="n">backup</span> <span class="n">spooler</span>
        <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">mnt</span><span class="o">/</span><span class="n">bkspool</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span> <span class="n">src</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span> <span class="n">state</span><span class="o">=</span><span class="n">link</span>
        <span class="n">with_items</span><span class="p">:</span> <span class="n">home_dirs</span><span class="o">.</span><span class="n">stdout_lines</span>
        <span class="c1"># same as with_items: home_dirs.stdout.split()</span>
</pre></div>
</div>
<h3>2.11.4 通过fact获取远程主机变量</h3>

<p>我们在之前讲ad-hoc常用模块的时候提到setup模块，用于获取远程主机的相关信息，并可以将这些信息作为变量在playbook里进行调用。而setup模块获取这些信息的方法就是依赖于fact。在这里，我们不再详细说明获取到的默认fact的内容。ansible除了能获取到预定义的fact的内容,还支持手动为某个主机定制fact。称之为本地fact。本地fact默认存放于目标主机的/etc/ansible/facts.d目录下，如果文件为.ini格式或者json格式，ansible会自动识别。以这种形式加载的fact是key为ansible_local的特殊变量。</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">下面是一个简单的示例，一个</span><span class="o">.</span><span class="n">ini</span><span class="err">格式的</span><span class="n">example</span><span class="o">.</span><span class="n">fact</span><span class="err">文件内容如下：</span>
<span class="p">[</span><span class="n">book</span><span class="p">]</span>
<span class="n">title</span><span class="o">=</span><span class="n">Ansible</span> <span class="n">Book</span>
<span class="n">author</span><span class="o">=</span><span class="n">Breeze</span> <span class="n">Yan</span>
<span class="err">将其复制到目标主机的</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">facts</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="err">目录，通过</span><span class="n">debug</span><span class="err">模块打印输出：</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="k">print</span> <span class="n">ansible_local</span>
  <span class="n">debug</span><span class="p">:</span> <span class="n">var</span><span class="o">=</span><span class="n">ansibl_local</span>
<span class="err">会打印出如下内容：</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">localhost</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ansible_local&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;Breeze Yan&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Ansible Book&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">如果不想从</span><span class="n">fact</span><span class="err">中获取变量，可以通过如下方法关闭</span><span class="n">fact</span><span class="err">：</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">whatever</span>
  <span class="n">gather_facts</span><span class="p">:</span> <span class="n">no</span>
</pre></div>
</div>
<h3>2.11.5 使用set_fact模块定义新的变量</h3>

<p>参见: Playbook常用模块 set_fact部分</p>

<h3>2.11.6 内置变量</h3>

<ul>
<li>hostvars</li>
</ul>

<p>获取某台指定的主机的相关变量。如果有一台web服务器的配置文件中需要指定db服务器的ip地址，我们假定这台db服务器的hostname为db.exmaple.com,ip地址绑定在eth0网卡上，我们可以通过如下方法在web服务器上调用db服务器的ip地址：
<code>{{ hostvars[&#39;db.example.com&#39;].ansible_eth0.ipv4.address }}</code>
需要注意的是db.example.com不能使用ip地址来取代，只能使用主机名或别名</p>

<ul>
<li>inventory<em>hostname与inventory</em>hostname_short</li>
</ul>

<p>inventory<em>hostname是Ansible所识别的当前正在运行task的主机的主机名。如果在inventory里定义过别名，那么这里就是那个别名，如果inentory包含如下一行：
<code>server1 ansible_ssh_host=192.168.1.1</code>
则inventory</em>hostname即为server1;</p>

<p>利用hostvars和inventory_hostname变量，可以输出与当前主机相关联的所有变量：
<code>- debug: var=hostvars[inventory_hostname]</code></p>

<p>与inventory<em>hostname相近的还有一个inventory</em>hostname<em>short，如果一台主机的inventory</em>hostname为server1.exmaple.com，则inventory<em>hostname</em>short的值为server1</p>

<ul>
<li>group_names</li>
</ul>

<p>用于标识当前正在执行task的目标主机位于的主机组。假如我们有三台主机，用来配置成一主二从的mysql服务器。</p>

<ul>
<li>groups</li>
</ul>

<p>当你想要访问一组主机的变量时，groups变量会很有用。假如我们有一个inventory文件定义如下：</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">web</span><span class="p">]</span>
<span class="n">server1</span>
<span class="n">server2</span>
</pre></div>
</div>
<p>在配置一台HAproxy的负载均衡器时，我们的配置文件肯定需要web群组的所有服务器的IP，配置文件包含如下片段：</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>backend web-backend
{% for host in groups.web%}
    server {{host.inventory_hostname}} {{ host.ansible_default_ipv4.address }}:80
{% endfor %}</pre></div></div>

<p>最终生成的文件如下：</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">backend</span> <span class="n">web</span><span class="o">-</span><span class="n">backend</span>
    <span class="n">server</span> <span class="n">server1</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span>
    <span class="n">server</span> <span class="n">server2</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.2</span>
</pre></div>
</div>
<ul>
<li>play_hosts    #当前playbook会在哪些hosts上运行</li>
<li>ansible_version    #当前ansible的版本</li>
<li>inventory_dir    #主机清单所在目录</li>
<li>inventory_file    #主机清单文件</li>
</ul>

<h3>2.11.7 通过命令行设置变量</h3>

<ul>
<li>示例</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="s1">&#39;{{ hosts }}&#39;</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="s1">&#39;{{ user }}&#39;</span>
  <span class="n">tasks</span><span class="p">:</span>
     <span class="o">-</span> <span class="o">...</span>

<span class="c1"># 执行</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">release</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="nb">vars</span> <span class="s2">&quot;hosts=vipers user=starbuck&quot;</span>
</pre></div>
</div>
<p>也可以写成类似如下方式：</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="nb">vars</span> <span class="s1">&#39;{&quot;pacman&quot;:&quot;mrs&quot;,&quot;ghosts&quot;:[&quot;inky&quot;,&quot;pinky&quot;,&quot;clyde&quot;,&quot;sue&quot;]}&#39;</span>
</pre></div>
</div>
<ul>
<li>变量优先级</li>
</ul>

<p>注：<code>子组会覆盖父组，主机总是覆盖组定义的变量</code></p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mi">1</span><span class="err">、</span><span class="n">extra</span> <span class="nb">vars</span><span class="p">(</span><span class="err">命令中</span><span class="o">-</span><span class="n">e</span><span class="p">)</span><span class="err">最优先</span>
<span class="mi">2</span><span class="err">、</span><span class="n">inventory</span> <span class="err">主机清单中连接变量</span><span class="p">(</span><span class="n">ansible_ssh_user</span> <span class="err">等</span><span class="p">)</span>
<span class="mi">3</span><span class="err">、</span><span class="n">play</span> <span class="err">中</span> <span class="nb">vars</span><span class="err">、</span><span class="n">vars_files</span> <span class="err">等</span>
<span class="mi">4</span><span class="err">、剩余的在</span> <span class="n">inventory</span> <span class="err">中定义的变量</span>
<span class="mi">5</span><span class="err">、系统的</span> <span class="n">facts</span> <span class="err">变量</span>
<span class="mi">6</span><span class="err">、角色定义的默认变量</span><span class="p">(</span><span class="n">roles</span><span class="o">/</span><span class="n">rolesname</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">)</span>
</pre></div>
</div>
<h1>3.使用ansible管理不同环境下的docker-compose文件</h1>

<p>模板配置在项目内部, 入口为compose文件, 通过提示用户输入, 并根据用户输入导入不同的环境变量, 以便于生成不同环境下的docker-compose启动文件; 最终通过启动文件启动特定环境下的服务;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># compose文件</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Build</span> <span class="n">Docker</span> <span class="n">Compose</span> <span class="n">File</span>
  <span class="n">vars_prompt</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;hosts&#39;</span>
      <span class="n">prompt</span><span class="p">:</span> <span class="s1">&#39;launch to host&#39;</span>
      <span class="n">private</span><span class="p">:</span> <span class="n">no</span>
      <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;localhost&#39;</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;env_type&#39;</span>
      <span class="n">prompt</span><span class="p">:</span> <span class="s1">&#39;docker-compose default env type [test_ci,test,dev,prod]&#39;</span>
      <span class="n">private</span><span class="p">:</span> <span class="n">no</span>
      <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;test_ci&#39;</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="s2">&quot;{{ hosts }}&quot;</span>
  <span class="c1">#become: yes</span>
  <span class="c1">#become_user: root</span>

  <span class="n">pre_tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">include_vars</span><span class="p">:</span> <span class="s1">&#39;./vars/main.yml&#39;</span>

  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">template</span><span class="p">:</span>
        <span class="n">src</span><span class="p">:</span> <span class="s2">&quot;{{item.src}}&quot;</span>
        <span class="n">dest</span><span class="p">:</span> <span class="s2">&quot;../{{item.dest}}&quot;</span>
        <span class="n">force</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">when</span><span class="p">:</span> <span class="s2">&quot;&#39;composefiles&#39; in item.src&quot;</span>
      <span class="n">with_items</span><span class="p">:</span> <span class="s2">&quot;{{project_templates}}&quot;</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">setup</span> <span class="n">compose</span> <span class="n">environment</span> <span class="nb">file</span>
      <span class="n">copy</span><span class="p">:</span>
        <span class="n">dest</span><span class="p">:</span> <span class="s2">&quot;../.env&quot;</span>
        <span class="n">content</span><span class="p">:</span> <span class="o">|</span>
          <span class="n">COMPOSE_FILE</span><span class="o">=</span><span class="n">dc</span><span class="o">-</span><span class="p">{{</span><span class="n">env_type</span><span class="p">}}</span><span class="o">.</span><span class="n">yml</span>
          <span class="n">COMPOSE_PROJECT_NAME</span><span class="o">=</span><span class="p">{{</span><span class="n">system_project_slug</span><span class="p">}}</span>
</pre></div>
</div>
<h1>4. 虚拟环境搭建,IDE基本配置,IDE配置debug环境</h1>
<blockquote class="blockquote-normal">
                <p>这样做的好处是不需要每次都docker-compose down &amp;&amp; docker-compose up测试;  最终达到的效果是, 在IDE上进行测试;</p></blockquote>
<h2>4.1 虚拟环境搭建</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">在</span><span class="n">root</span><span class="err">用户下：</span>
    <span class="n">pip</span> <span class="n">install</span> <span class="n">virtualenv</span> <span class="n">virtualenvwrapper</span>
    <span class="n">find</span> <span class="o">/</span> <span class="o">|</span><span class="n">grep</span> <span class="n">virtualenvwrapper</span><span class="o">.</span><span class="n">sh</span> 
    <span class="err">例如结果是：</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">virtualenvwrapper</span><span class="o">.</span><span class="n">sh</span>

    <span class="err">在普通用户下：</span>
    <span class="n">vim</span>  <span class="o">~/.</span><span class="n">zshrc</span>
    <span class="err">在末尾添加：</span> <span class="n">source</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">virtualenvwrapper</span><span class="o">.</span><span class="n">sh</span>
    <span class="err">运行命令使配置生效：</span> <span class="n">source</span> <span class="o">~/.</span><span class="n">zshrc</span>
    <span class="err">运行命令：</span><span class="n">mkvirtualenv</span>  <span class="err">可以知道虚拟环境配置已生效</span>
    <span class="p">(</span><span class="n">PS</span><span class="err">：默认的虚拟环境被创建在</span><span class="o">~/.</span><span class="n">virtualenvs</span><span class="o">/</span><span class="err">下</span><span class="p">,</span><span class="err">并且默认是</span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="err">的不依赖系统中已经安装好的第三方包</span><span class="p">)</span>
</pre></div>
</div>
<h2>4.2 IDE基本配置</h2>

<p><a href="http://wiki.jikexueyuan.com/project/intellij-idea-tutorial/introduce.html">极客学院</a>, 内容是极好的, 只是后面看不到图片了, 希望官方尽早修复;</p>

<h3>4.2.1 安装(省略)</h3>

<h3>4.2.2 使用License server激活</h3>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038894391460.jpg"></p>
</p>

<h3>4.2.3 必须知道的几个快捷键</h3>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th style="text-align: center">快捷键</th>
<th style="text-align: left">描述</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: center">Command+;</td>
<td style="text-align: left">Project Structure(项目结构): 用与设定一个项目的环境,例如,虚拟环境</td>
</tr>
<tr>
<td style="text-align: center">Command+,</td>
<td style="text-align: left">Preferences(首选项): IDE的环境设定, 例如,安装插件,插件配置,配置主题</td>
</tr>
<tr>
<td style="text-align: center">Command+b或者Command+鼠标左键点击</td>
<td style="text-align: left">跳转到引用的地方, 相对的: Command+[ 返回上一步; Command+] 返回下一步, 这样就可以来回跳转了;</td>
</tr>
<tr>
<td style="text-align: center">Command+1</td>
<td style="text-align: left">打开Project</td>
</tr>
<tr>
<td style="text-align: center">Command+2</td>
<td style="text-align: left">打开Favarite</td>
</tr>
<tr>
<td style="text-align: center">Command+3</td>
<td style="text-align: left">打开Favarite</td>
</tr>
<tr>
<td style="text-align: center">Command+6</td>
<td style="text-align: left">打开TODO</td>
</tr>
<tr>
<td style="text-align: center">Command+7</td>
<td style="text-align: left">打开Structure</td>
</tr>
<tr>
<td style="text-align: center">Option+Command+l</td>
<td style="text-align: left">格式化代码</td>
</tr>
<tr>
<td style="text-align: center">Ctrl+Option+r</td>
<td style="text-align: left">选择内容Run, 若Ctrl+r则是run当前的测试</td>
</tr>
<tr>
<td style="text-align: center">Ctrl+Option+d</td>
<td style="text-align: left">选择内容Debug, 若Ctrl+d则是debug当前的测试</td>
</tr>
<tr>
<td style="text-align: center">Shift+F1</td>
<td style="text-align: left">查看函数或者类的文档</td>
</tr>
<tr>
<td style="text-align: center">Shift+F6</td>
<td style="text-align: left">重命名文件</td>
</tr>
</tbody>
</table></div>
<h2>4.3 IDE配置Django项目</h2>

<p>打开Project Structure, 配置虚拟环境Project</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038923813468.jpg"></p>
</p>

<p>配置Modules</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038924901816.jpg"></p>
</p>

<h2>4.4 IDE配置Django项目的本地测试环境</h2>

<p>点击Edit Configurations配置测试</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038925740827.jpg"></p>
</p>

<p>配置详情(测试和本地环境变量有很大的关系)</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038927744659.jpg"></p>
</p>

<h1>5. Django使用Jekins做持续集成</h1>

<h2>5.1 Jekins环境搭建</h2>

<p>~未完待续~</p>

<h2>5.2 Jekins测试报告</h2>

<p>~未完待续~</p>

<h2>5.3 测试报告扩展</h2>

<p>~未完待续~</p>

<h1>6. Django项目120.43.103.126的管理命令全部迁移到Rundeck做集中管理</h1>

<p>~未完待续~</p>

    </div>
    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic green button">打赏 <i class="red heart icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">MORE WORDS</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer code">
            <span>© 1994 - 2018 willdx</span><b>@</b><a class="code" href="https://willdx.github.io">willdx.github.io</a>
            <br/>
            <span class="notprint">
                <span id="busuanzi_container_site_pv">
                    <i class="eye icon"></i><span id="busuanzi_value_site_pv" class="orange text"></span> pv
                </span>
                <b> | </b>
                <span id="busuanzi_container_site_uv">
                    <i class="user icon"></i><span id="busuanzi_value_site_uv" class="orange text"></span> uv
                </span>
                <br/>
            </span>
            <span>Power by <i class="github alternate icon"></i><a href="https://github.com/willdx/willdx.github.io">Github Page</a></span>
            <br/>
            <i class="green superpowers icon"></i>
        </div>
    </body>
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="/assets/js/web.js"></script>
    <script>
        // 统计代码
        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68394485-1', 'auto');
        ga('send', 'pageview');

        var wrappers = ["cats-wrapper", "donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper"]

        window.onload = function () {
            useWechat();
        }
    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: '177af99888a292531873',
        clientSecret: '7c0927c7cdf0d94eed7dad0b238552c10ec6f53c',
        repo: 'willdx.github.io',
        owner: 'willdx',
        admin: ['willdx'],
        id: 'Django-Docker-Compose-Envfile集成实践',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: ['gitment'],
        pagerDirection: "last",
    })
      
    gitalk.render('comments')
    </script>


</html>