<html>
    <head>
        <meta charset="utf-8">
        
    
        <title> python web开发测试驱动开发方法 </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">


        <style type="text/css"> 
        </style>
    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: #fff;">主题选择</span></h3>
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr class="sk-mo" onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">墨</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-green" onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">绿</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-default" onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">青</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-orange" onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">橘</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">波妞</div>
                                <div class="time">2017年2月21号</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">三三</div>
                                <div class="time">2017年4月10号</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        微信
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        支付宝
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:1426409836@qq.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/willdx">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>
            <a href="https://twitter.com/willdx">
                <button class="ui mini circular twitter icon button">
                  <i class="twitter icon"></i>
                </button>
            </a>
            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
              <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="linkify icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    🐱
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="heart icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <h2 class="name">Will Dx</h2>

                <span class="sign">人世一身霜雪, 归来仍是少年.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        主页
                    </a>
                    <a href="/tweet.html" class="item">
                        推特
                    </a>
                    <a href="/about.html" class="item">
                        关于我
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        联系
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1>python web开发测试驱动开发方法</h1>
        <h4>Posted April 07, 2017</h4>
        <h1>1. 一个 selenium 功能测试简单小例子</h1>

<h2>1.1 环境准备</h2>

<ul>
<li>Firefox 浏览器</li>
<li>Python3 开发环境</li>
<li>安装 selenium</li>
</ul>

<h2>1.2 安装 selenium</h2>
<div class="code-wrapper"><div class="lang-label">Bash</div><div class="highlight"><pre><span></span>pip install selenium
vim functinal_tests.py
</pre></div>
</div>
<h2>1.3 编写 selenium 测试用例</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># -*-coding:utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">selenium 简单测试</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
<span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://localhost:8000&#39;</span><span class="p">)</span>

<span class="k">assert</span> <span class="s1">&#39;Django&#39;</span> <span class="ow">in</span> <span class="n">browser</span><span class="o">.</span><span class="n">title</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Bash</div><div class="highlight"><pre><span></span>python3 functinal_tests.py
</pre></div>
</div>
<h2>1.4 报错与解决</h2>

<ul>
<li>报错内容如下</li>
</ul>
<div class="code-wrapper"><div class="lang-label">log</div><div class="highlight"><pre><span></span>(accounting_server) ➜  accouting_project git:(master) ✗ python3 functinal_tests.py 
Traceback (most recent call last):
  File &quot;/Users/willdx/.virtualenvs/accounting_server/lib/python3.5/site-packages/selenium/webdriver/common/service.py&quot;, line 74, in start
    stdout=self.log_file, stderr=self.log_file)
  File &quot;/usr/local/Cellar/python3/3.5.0/Frameworks/Python.framework/Versions/3.5/lib/python3.5/subprocess.py&quot;, line 950, in __init__
    restore_signals, start_new_session)
  File &quot;/usr/local/Cellar/python3/3.5.0/Frameworks/Python.framework/Versions/3.5/lib/python3.5/subprocess.py&quot;, line 1540, in _execute_child
    raise child_exception_type(errno_num, err_msg)
FileNotFoundError: [Errno 2] No such file or directory: &#39;geckodriver&#39;

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File &quot;functinal_tests.py&quot;, line 8, in &lt;module&gt;
    browser = webdriver.Firefox()
  File &quot;/Users/willdx/.virtualenvs/accounting_server/lib/python3.5/site-packages/selenium/webdriver/firefox/webdriver.py&quot;, line 142, in __init__
    self.service.start()
  File &quot;/Users/willdx/.virtualenvs/accounting_server/lib/python3.5/site-packages/selenium/webdriver/common/service.py&quot;, line 81, in start
    os.path.basename(self.path), self.start_error_message)
selenium.common.exceptions.WebDriverException: Message: &#39;geckodriver&#39; executable needs to be in PATH.
</pre></div>
</div>
<ul>
<li>解决方法:  安装geckodriver</li>
</ul>

<p><a href="https://github.com/mozilla/geckodriver/releases">github地址</a></p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 由于我是在mac 上实验所以直接 brew 安装即可</span>
<span class="n">brew</span> <span class="n">install</span> <span class="n">geckodriver</span>
</pre></div>
</div>
<ul>
<li>再次执行: python3 functinal_tests.py</li>
</ul>

<p><p class="hassubimage"><img src="http://7xj7fg.com1.z0.glb.clouddn.com/2017-07-31-15010399692097.jpg"></p>
</p>

<p>将启动 Firefox 浏览器, 连接失败是由于我们还没有启动 web服务;</p>

<p>启动Django web服务:  python manage.py runserver</p>

<ul>
<li>再次测试: python3 functinal_tests.py</li>
</ul>

<p><p class="hassubimage"><img src="http://7xj7fg.com1.z0.glb.clouddn.com/2017-07-31-15010401553823.jpg"></p>
</p>

<p>测试启动了 web 浏览器, 接下来我们查看验证结果:</p>

<p><p class="hassubimage"><img src="http://7xj7fg.com1.z0.glb.clouddn.com/2017-07-31-15010402045192.jpg"></p>
</p>

<p>抛出了异常, 说明条件没有通过, 由于我的测试环境是我自己的项目, 启动的服务主页 title不包含 Django 所以测试失败;</p>

<p>到此为止, 是一个 Selenium 测试 Django 的简单小实例的全部过程; 后续我们会用 selenium 做更多,更全面的功能测试;</p>
<blockquote class="blockquote-normal">
                <p>术语1: TDD(Test-Driven-Development): 测试驱动开发<br/>术语2: 功能测试=验收测试(Acceptance)=端到端测试(End<em>to</em>End测试), 这类测试最重要的作用是从外部宏观的角度观察整个应用是如何运作的; 另一个术语: <code>黑箱测试(Black Box Test)</code>, 因为这种测试对所要测试的系统内部一无所知;</p></blockquote>
<p>功能测试应该有一个人类可读, 容易理解的故事; 这里就引申出另一个敏捷开发的学说, <code>BDD(Behaviour Driven Development)用户故事</code>, 我们用规范的语言描述故事, 然后生成功能测试代码的基础部分, 我们完成每一个点的单元测试, 最终形成一个完备的功能测试集合; BDD 通常和 <code>DSL(Domain Specific Languag一起使用</code>); </p>

<p>假设我们简单的采用给测试代码加注释的方式描述用户故事, 此时测试代码和用户故事在同一个文件; 无意义的注释, 或者注释更新不及时会带来很多问题; 更好的方式是 BDD, 使用 DSL方式描述用户故事, 这样故事和测试代码分开; </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 一个使用注释的例子</span>

<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>

<span class="c1"># Will 听说有一个很酷的网站</span>
<span class="c1"># 她去看了应用的首页</span>
<span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://localhost:8000&#39;</span><span class="p">)</span>

<span class="c1"># 她注意到网页的标题包含有&quot;众财星云&quot;字样</span>
<span class="c1"># assert &#39;众财星云&#39; in browser.title</span>

<span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>
</div>
<h1>2. 使用 Python 标准库 unitest 模块编写单元测试</h1>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">VisitorTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;测试前执行&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
        <span class="c1"># 设定隐式等待3s, 是留给浏览器完全加载的时间</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;测试后执行&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_web_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;测试代码: 测试主页代码&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://127.0.0.1:8000&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;众财星云&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;Finish the test!&#39;</span><span class="p">)</span>  <span class="c1"># 输出一个测试失败的消息, 这里这是为了提醒测试结束</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">warnings</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="c1"># 禁止抛出 ResourceWarning 异常</span>
</pre></div>
</div>
<p>注释:  <a href="http://code.google.com/p/selenium/issues/detail?id=5923">warnings 在 Python2和 Python3的用法不一样</a></p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># python3</span>
<span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">warnings</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># python2</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
     <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>测试结果:</p>
<div class="code-wrapper"><div class="lang-label">log</div><div class="highlight"><pre><span></span>(accounting_server) ➜  accouting_project git:(master) ✗ python3 functinal_tests.py
======================================================================
FAIL: test_web_title (__main__.VisitorTest)
测试代码: 测试主页代码
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;functinal_tests.py&quot;, line 36, in test_web_title
    self.assertIn(&#39;众财星云&#39;, self.browser.title)
AssertionError: &#39;众财星云&#39; not found in &#39;&#39;

----------------------------------------------------------------------
Ran 1 test in 5.994s

FAILED (failures=1)
</pre></div>
</div>
<hr>

<p><strong>从第三章开始使用书上的代码进行试验</strong></p>

<h1>3. 第三章: 简单测试首页</h1>

<h2>3.1 Django 中的单元测试入口</h2>

<ul>
<li>代码结构</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">➜</span>  <span class="n">mycode</span> <span class="n">tree</span> <span class="o">-</span><span class="n">L</span> <span class="mi">2</span> <span class="n">book</span><span class="o">-</span><span class="n">example</span>
<span class="n">book</span><span class="o">-</span><span class="n">example</span>
<span class="err">├──</span> <span class="n">functional_tests</span><span class="o">.</span><span class="n">py</span>
<span class="err">├──</span> <span class="n">lists</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="n">admin</span><span class="o">.</span><span class="n">py</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="n">apps</span><span class="o">.</span><span class="n">py</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="n">migrations</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="n">models</span><span class="o">.</span><span class="n">py</span>
<span class="err">│  </span> <span class="err">├──</span> <span class="n">tests</span><span class="o">.</span><span class="n">py</span> <span class="c1"># 测试文件</span>
<span class="err">│  </span> <span class="err">└──</span> <span class="n">views</span><span class="o">.</span><span class="n">py</span>
<span class="err">├──</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span>
<span class="err">└──</span> <span class="n">superlists</span>
    <span class="err">├──</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
    <span class="err">├──</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">pyc</span>
    <span class="err">├──</span> <span class="n">settings</span><span class="o">.</span><span class="n">py</span>
    <span class="err">├──</span> <span class="n">settings</span><span class="o">.</span><span class="n">pyc</span>
    <span class="err">├──</span> <span class="n">urls</span><span class="o">.</span><span class="n">py</span>
    <span class="err">└──</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">py</span>

<span class="mi">3</span> <span class="n">directories</span><span class="p">,</span> <span class="mi">14</span> <span class="n">files</span>
</pre></div>
</div>
<ul>
<li>在 Django 项目中创建 APP 时会自动创建一个测试文件 tests.py</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 写一个必定无法通过的单元测试</span>
<span class="c1"># vim tests.py</span>

<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="c1"># Create your tests here.</span>

<span class="k">class</span> <span class="nc">SmokeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_bad_maths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<ul>
<li>执行测试</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span>

<span class="c1"># 结果</span>
<span class="n">Creating</span> <span class="n">test</span> <span class="n">database</span> <span class="k">for</span> <span class="n">alias</span> <span class="s1">&#39;default&#39;</span><span class="o">...</span>
<span class="n">System</span> <span class="n">check</span> <span class="n">identified</span> <span class="n">some</span> <span class="n">issues</span><span class="p">:</span>

<span class="n">System</span> <span class="n">check</span> <span class="n">identified</span> <span class="mi">1</span> <span class="n">issue</span> <span class="p">(</span><span class="mi">0</span> <span class="n">silenced</span><span class="p">)</span><span class="o">.</span>
<span class="n">F</span>
<span class="o">======================================================================</span>
<span class="n">FAIL</span><span class="p">:</span> <span class="n">test_bad_maths</span> <span class="p">(</span><span class="n">accouting_app</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">SmokeTest</span><span class="p">)</span>
<span class="o">----------------------------------------------------------------------</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;/Users/willdx/mycode/accouting_server/accouting_app/tests.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">8</span><span class="p">,</span> <span class="ow">in</span> <span class="n">test_bad_maths</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span> <span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="ne">AssertionError</span><span class="p">:</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">3</span>

<span class="o">----------------------------------------------------------------------</span>
<span class="n">Ran</span> <span class="mi">1</span> <span class="n">test</span> <span class="ow">in</span> <span class="mf">0.002</span><span class="n">s</span>

<span class="n">FAILED</span> <span class="p">(</span><span class="n">failures</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Destroying</span> <span class="n">test</span> <span class="n">database</span> <span class="k">for</span> <span class="n">alias</span> <span class="s1">&#39;default&#39;</span><span class="o">...</span>
</pre></div>
</div>
<h2>3.2 Django 中的 MVC</h2>

<p>这个问题困扰有有很长一段时间了, Django 是 MTV 还是 MVC 模型?</p>

<p>其实, Django 是遵守经典的 MVC 架构的, 只是实现上不太一样(哈哈, 至少书上是这么说的), Django 的视图更像是控制器, 模板相当于视图; </p>

<h3>3.2.1 在 Django 中写一个测试首页的单元测试</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">resolve</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpRequest</span>
<span class="kn">from</span> <span class="nn">lists.views</span> <span class="kn">import</span> <span class="n">home_page</span>

<span class="k">class</span> <span class="nc">HomePageTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_root_url_resolves_to_home_page_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">home_page</span><span class="p">)</span>
</pre></div>
</div>
<p>此时, 运行测试不会通过, 在 TDD中这被称为<code>预期失败</code>; 我们尽量按照 TDD 的规则, <code>每次更改尽量少的代码, 来让代码通过测试</code>; 但是在这篇 BLog 中就不赘述了;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 写 views.home_page 函数</span>
<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;&lt;html&gt;&lt;title&gt;To-Do lists&lt;/title&gt;&lt;/html&gt;&#39;</span><span class="p">)</span>

<span class="c1"># 写对应的 url</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">lists</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">home_page</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">),</span>
<span class="p">]</span>
<span class="c1"># 再次测试通过</span>
</pre></div>
</div>
<h3>3.2.2 为视图编写单元测试</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">resolve</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpRequest</span>

<span class="kn">from</span> <span class="nn">lists.views</span> <span class="kn">import</span> <span class="n">home_page</span>


<span class="k">class</span> <span class="nc">HomePageTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_root_url_resolves_to_home_page_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="n">found</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">home_page</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_home_page_returns_correct_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
       <span class="n">response</span> <span class="o">=</span> <span class="n">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
       <span class="n">html</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;html&gt;&#39;</span><span class="p">))</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;&lt;title&gt;To-Do lists&lt;/title&gt;&#39;</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&lt;/html&gt;&#39;</span><span class="p">))</span>
</pre></div>
</div>
<h1>4. 第四章: 为什么TDD以及TDD的几个场景</h1>

<h2>4.1 为什么需要 TDD?</h2>

<ol>
<li>TDD 就是一个套路, 这个套路来帮开发者细化每一个功能, 并测试之, 用于保证代码稳定性;</li>
<li>TDD 应该尽量用简单的函数编写细化的简单测试;</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">NewVisitorTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_can_start_a_list_and_retrieve_it_later</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Edith has heard about a cool new online to-do app. She goes</span>
        <span class="c1"># to check out its homepage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://localhost:8000&#39;</span><span class="p">)</span>

        <span class="c1"># She notices the page title and header mention to-do lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;To-Do&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">header_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;To-Do&#39;</span><span class="p">,</span> <span class="n">header_text</span><span class="p">)</span>

        <span class="c1"># She is invited to enter a to-do item straight away</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_new_item&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">inputbox</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;placeholder&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Enter a to-do item&#39;</span>
        <span class="p">)</span>

        <span class="c1"># She types &quot;Buy peacock feathers&quot; into a text box (Edith&#39;s hobby</span>
        <span class="c1"># is tying fly-fishing lures)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># When she hits enter, the page updates, and now the page lists</span>
        <span class="c1"># &quot;1: Buy peacock feathers&quot; as an item in a to-do list table</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_list_table&#39;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find_elements_by_tag_name</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;1: Buy peacock feathers&#39;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span>
            <span class="s2">&quot;New to-do item did not appear in table&quot;</span>
        <span class="p">)</span>

        <span class="c1"># There is still a text box inviting her to add another item. She</span>
        <span class="c1"># enters &quot;Use peacock feathers to make a fly&quot; (Edith is very</span>
        <span class="c1"># methodical)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;Finish the test!&#39;</span><span class="p">)</span>

        <span class="c1"># The page updates again, and now shows both items on her list</span>

        <span class="c1"># Edith wonders whether the site will remember her list. Then she sees</span>
        <span class="c1"># that the site has generated a unique URL for her -- there is some</span>
        <span class="c1"># explanatory text to that effect.</span>

        <span class="c1"># She visits that URL - her to-do list is still there.</span>

        <span class="c1"># Satisfied, she goes back to sleep</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">warnings</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>注释: <code>any</code>
如果可迭代的对象中任何一个元素为 true 的话返回 True; 如果可迭代的对象为空则返回 False;
<a href="http://pycoders-weekly-chinese.readthedocs.io/en/latest/issue15/python-built-in-functions-are-awesome-use-them.html">Python 内置的那些牛逼闪亮的函数</a> </p>

<h2>4.2 不测试常量规则</h2>

<ul>
<li>不多说</li>
</ul>

<h2>4.3 关于重构</h2>

<ol>
<li>重构的前提是有测试</li>
<li>重构时, 修改代码或者测试, 但不要在一次提交中同时修改;</li>
</ol>

<h3>4.3.1 使用 Django 模板重构 response</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># vim superlists/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lists&#39;</span><span class="p">,</span> <span class="c1"># 添加 APP</span>
<span class="p">]</span>

<span class="c1"># vim lists/views.py</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="c1"># Create your views here.</span>
<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;home.html&#39;</span><span class="p">)</span>
    
<span class="c1"># vim lists/templates/home.html</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">To</span><span class="o">-</span><span class="n">Do</span> <span class="n">lists</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Your</span> <span class="n">To</span><span class="o">-</span><span class="n">Do</span> <span class="nb">list</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;id_new_item&quot;</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Enter a to-do item&quot;</span> <span class="o">/&gt;</span>
       <span class="o">&lt;</span><span class="n">table</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;id_list_table&quot;</span><span class="o">&gt;</span>
       <span class="o">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</pre></div>
</div>
<h2>4.4 TDD 流程总结</h2>

<ul>
<li>TDD 流程: 先写功能测试(看着他失败)-编写代码让测试通过(这一步是多个单元测试)-所有单元测试通过后回到功能测试; 如果要更改功能测试的逻辑, 那么功能测试,单元测试都要跟着改, 所以产品经理改需求的代价特别大;</li>
<li>功能测试时应用是否能正常运行的最终评判, 单元测试是开发过程中的辅助工具</li>
<li>功能测试可以由很多单元测试组成, 单元测试部分也遵从 TDD流程</li>
</ul>

<p><p class="hassubimage"><img src="http://7xj7fg.com1.z0.glb.clouddn.com/2017-07-31-15010595168051.jpg"></p>
</p>

<h1>5. 第5章: 保存用户输入</h1>
<blockquote class="blockquote-normal">
                <p>TODO: 了解CSRF(跨站请求伪造原理)</p></blockquote><div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>术语: 遇红, 变绿, 重构 和 三角法

1. 先写一个会失败的测试(遇红)
2. 编写尽可能简单的代码让测试通过, 即使是业务代码是作弊代码(变绿)
3. 重构, 改进代码, 让其更合理

三角法
专门为某些现有的代码编写测试用例, 以此推断出普遍的实现方式, 使作弊代码无法通过测试(例如, 多写一个测试, 测试多个输入操作之后的状态,这样通过常规的写常量通过测试的方法是无法通过测试的), 然后促使你去(删除作弊代码)编写更合理的业务代码;


术语: 代码异味, 代表一段代码需要重写;

编程原则: Don't repeat youself! (拒绝重复)
编程原则: 一个测试只测试一件事情

术语: 
(1)回归
新添加的代码破坏了应用原本可以正常使用的功能;

(2)意外失败
测试在意料之外失败了, 这意味着测试中有错误, 或者测试帮我们发现了一个回归, 因此要在代码中修正;</pre></div></div>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># vim functional_tests.py</span>

<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">NewVisitorTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">check_for_row_in_list_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_text</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_list_table&#39;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find_elements_by_tag_name</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">row_text</span><span class="p">,</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">test_can_start_a_list_and_retrieve_it_later</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Edith has heard about a cool new online to-do app. She goes</span>
        <span class="c1"># to check out its homepage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://localhost:8000&#39;</span><span class="p">)</span>

        <span class="c1"># She notices the page title and header mention to-do lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;To-Do&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">header_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;To-Do&#39;</span><span class="p">,</span> <span class="n">header_text</span><span class="p">)</span>

        <span class="c1"># She is invited to enter a to-do item straight away</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_new_item&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">inputbox</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;placeholder&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Enter a to-do item&#39;</span>
        <span class="p">)</span>

        <span class="c1"># She types &quot;Buy peacock feathers&quot; into a text box (Edith&#39;s hobby</span>
        <span class="c1"># is tying fly-fishing lures)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># When she hits enter, the page updates, and now the page lists</span>
        <span class="c1"># &quot;1: Buy peacock feathers&quot; as an item in a to-do list table</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;1: Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># There is still a text box inviting her to add another item. She</span>
        <span class="c1"># enters &quot;Use peacock feathers to make a fly&quot; (Edith is very</span>
        <span class="c1"># methodical)</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_new_item&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;Use peacock feathers to make a fly&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># The page updates again, and now shows both items on her list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;2: Use peacock feathers to make a fly&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;1: Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># Edith wonders whether the site will remember her list. Then she sees</span>
        <span class="c1"># that the site has generated a unique URL for her -- there is some</span>
        <span class="c1"># explanatory text to that effect.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;Finish the test!&#39;</span><span class="p">)</span>

        <span class="c1"># She visits that URL - her to-do list is still there.</span>

        <span class="c1"># Satisfied, she goes back to sleep</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">warnings</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="sb">``</span><span class="err">`</span>
    
<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="c1"># 代码部分</span>
<span class="c1"># URL</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">lists</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">home_page</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="err">$</span> <span class="n">views</span><span class="o">.</span><span class="n">py</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">lists.models</span> <span class="kn">import</span> <span class="n">Item</span>

<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;item_text&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;home.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="n">items</span><span class="p">})</span>

<span class="c1"># model</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<h1>6. 第6章: 完成最简可用网站</h1>

<ul>
<li><p>问题1: 如何隔离测试环境?</p>

<p>每次测试完成后, 还原测试环境; </p></li>
<li><p>问题2: 如何还原测试环境呢?</p>

<p>方法1: 在单元测试 tearDown 代码中完成测试环境的还原操作</p>

<p>方法2: Django 从1.4开始提供 LiveServerTestCase, 他会自动创建一个测试数据库, 并启动一个开发服务器, 让功能测试在其中运行; Django 会查找所有名字以 test开头的文件;  我们可以把测试放到文件夹中分类管理, 但是要求需要有__ init__.py文件, 也就是说测试文件夹其实可以看做一个 Python 模块;</p>

<h2>(1)基本功能</h2></li>
</ul>

<h3>6.1 环境准备</h3>

<h3>6.2 配置虚拟环境</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">mkvirtualenv</span> <span class="o">-</span><span class="n">p</span> <span class="sb">`which python3`</span> <span class="n">book</span><span class="o">-</span><span class="n">example</span>  <span class="o">--</span><span class="n">system</span><span class="o">-</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span>
</pre></div>
</div>
<h3>6.3 安装 Django</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">workon</span>  <span class="n">book</span><span class="o">-</span><span class="n">example</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">Django</span> <span class="n">selenium</span>
</pre></div>
</div>
<h2>6.4 创建项目</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">workon</span>  <span class="n">book</span><span class="o">-</span><span class="n">example</span>
<span class="n">django</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">py</span> <span class="n">startproject</span> <span class="n">superlists</span>
</pre></div>
</div>
<h3>6.5 创建 app</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">django</span><span class="o">-</span><span class="n">admin</span> <span class="n">startapp</span> <span class="n">lists</span>

<span class="c1"># 将 APP 加入 settings.py</span>
<span class="n">vim</span> <span class="n">superlists</span><span class="o">/</span><span class="n">settings</span><span class="o">.</span><span class="n">py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lists&#39;</span> <span class="c1"># add</span>
<span class="p">]</span>
</pre></div>
</div>
<h3>6.6 编写基础代码</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># URL</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">lists</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">home_page</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">),</span>
<span class="p">]</span>
<span class="c1"># views</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">lists.models</span> <span class="kn">import</span> <span class="n">Item</span>

<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
       <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;item_text&#39;</span><span class="p">])</span>
       <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;home.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="n">items</span><span class="p">})</span>

<span class="c1"># models</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
<span class="c1"># vim lists/templates/home.html</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">To</span><span class="o">-</span><span class="n">Do</span> <span class="n">lists</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Your</span> <span class="n">To</span><span class="o">-</span><span class="n">Do</span> <span class="nb">list</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">form</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nb">input</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;item_text&quot;</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;id_new_item&quot;</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Enter a to-do item&quot;</span> <span class="o">/&gt;</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">csrf_token</span> <span class="o">%</span><span class="p">}</span>
        <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>

        <span class="o">&lt;</span><span class="n">table</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;id_list_table&quot;</span><span class="o">&gt;</span>
            <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> <span class="o">%</span><span class="p">}</span>
                <span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">forloop</span><span class="o">.</span><span class="n">counter</span> <span class="p">}}:</span> <span class="p">{{</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
        <span class="o">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</pre></div>
</div>
<h3>6.7 单元测试</h3>
<blockquote class="blockquote-normal">
                <p>单元测试通过函数和接口模拟用户请求; </p></blockquote><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># vim lists/tests.py</span>

<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">lists.models</span> <span class="kn">import</span> <span class="n">Item</span>


<span class="k">class</span> <span class="nc">HomePageTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_uses_home_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;测试使用主页模板&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTemplateUsed</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;home.html&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_displays_all_list_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;创建项目并测试返回&quot;&quot;&quot;</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;itemey 1&#39;</span><span class="p">)</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;itemey 2&#39;</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;itemey 1&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;itemey 2&#39;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">test_can_save_a_POST_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;测试保存用户请求&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;item_text&#39;</span><span class="p">:</span> <span class="s1">&#39;A new list item&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;A new list item&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_redirects_after_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;测试 POST 请求之后的重定向, 通过判断状态吗&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;item_text&#39;</span><span class="p">:</span> <span class="s1">&#39;A new list item&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_only_saves_items_when_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;测试正常请求的时候不会保存数据&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># **注意:**</span>

    <span class="err">每一个以</span> <span class="n">test</span> <span class="err">开头的函数都有一个生命周期</span><span class="p">,</span> <span class="err">测试操作互不影响</span><span class="p">;</span> <span class="err">例如</span><span class="p">,</span> <span class="err">上面前</span><span class="mi">5</span><span class="err">个测试有一些写入数据的操作</span><span class="p">,</span> <span class="err">但是第</span><span class="mi">6</span><span class="err">个测试</span><span class="p">:</span> <span class="n">test_only_saves_items_when_necessary</span> <span class="err">去</span> <span class="n">Count</span> <span class="err">的时候依旧为</span><span class="mi">0</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">ItemModelTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_saving_and_retrieving_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;测试更新模型字段&quot;&quot;&quot;</span>
        <span class="n">first_item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
        <span class="n">first_item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;The first (ever) list item&#39;</span>
        <span class="n">first_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">second_item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
        <span class="n">second_item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Item the second&#39;</span>
        <span class="n">second_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">saved_items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">saved_items</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">first_saved_item</span> <span class="o">=</span> <span class="n">saved_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">second_saved_item</span> <span class="o">=</span> <span class="n">saved_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_saved_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;The first (ever) list item&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">second_saved_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;Item the second&#39;</span><span class="p">)</span>
</pre></div>
</div>
<h3>6.8 创建功能测试</h3>
<blockquote class="blockquote-normal">
                <p>功能测试通过模拟用户从浏览器请求来测试;</p></blockquote><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">functional_tests</span>
<span class="n">touch</span> <span class="n">functional_tests</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># vim functional_tests/tests.py</span>

<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">LiveServerTestCase</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.common.exceptions</span> <span class="kn">import</span> <span class="n">WebDriverException</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">MAX_WAIT</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">class</span> <span class="nc">NewVisitorTest</span><span class="p">(</span><span class="n">LiveServerTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">wait_for_row_in_list_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_text</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_list_table&#39;</span><span class="p">)</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find_elements_by_tag_name</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">row_text</span><span class="p">,</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="n">WebDriverException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">MAX_WAIT</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_can_start_a_list_and_retrieve_it_later</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Edith has heard about a cool new online to-do app. She goes</span>
        <span class="c1"># to check out its homepage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live_server_url</span><span class="p">)</span>

        <span class="c1"># She notices the page title and header mention to-do lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;To-Do&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">header_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;To-Do&#39;</span><span class="p">,</span> <span class="n">header_text</span><span class="p">)</span>

        <span class="c1"># She is invited to enter a to-do item straight away</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_new_item&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">inputbox</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;placeholder&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Enter a to-do item&#39;</span>
        <span class="p">)</span>

        <span class="c1"># She types &quot;Buy peacock feathers&quot; into a text box (Edith&#39;s hobby</span>
        <span class="c1"># is tying fly-fishing lures)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># When she hits enter, the page updates, and now the page lists</span>
        <span class="c1"># &quot;1: Buy peacock feathers&quot; as an item in a to-do list table</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;1: Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># There is still a text box inviting her to add another item. She</span>
        <span class="c1"># enters &quot;Use peacock feathers to make a fly&quot; (Edith is very</span>
        <span class="c1"># methodical)</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_new_item&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;Use peacock feathers to make a fly&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>

        <span class="c1"># The page updates again, and now shows both items on her list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;2: Use peacock feathers to make a fly&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;1: Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># Edith wonders whether the site will remember her list. Then she sees</span>
        <span class="c1"># that the site has generated a unique URL for her -- there is some</span>
        <span class="c1"># explanatory text to that effect.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;Finish the test!&#39;</span><span class="p">)</span>

        <span class="c1"># She visits that URL - her to-do list is still there.</span>

        <span class="c1"># Satisfied, she goes back to sleep</span>
</pre></div>
</div>
<h3>6.9 运行测试</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 通常所有单元测试都通过后才会运行功能测试</span>
<span class="n">python3</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="c1"># 同时运行功能测试和单元测试</span>
<span class="n">python3</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="n">functional_tests</span> <span class="c1"># 运行功能测试</span>
<span class="n">python3</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="n">lists</span> <span class="c1"># 运行单元测试</span>
</pre></div>
</div>
<h2>(2)使用 Django client 简化测试步骤: 测试视图, 模板, URL</h2>

<h3>6.10 新功能代码</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># url</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">lists</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^new$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">new_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;new_list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">view_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;view_list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d+)/add_item$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">add_item</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;add_item&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># view</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">lists.models</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">List</span>

<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;home.html&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">new_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;item_text&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="o">=</span><span class="n">list_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;/lists/{list_.id}/&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">list_id</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">list_id</span><span class="p">)</span>
    <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;item_text&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="o">=</span><span class="n">list_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;/lists/{list_.id}/&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">view_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">list_id</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">list_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;list.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;list&#39;</span><span class="p">:</span> <span class="n">list_</span><span class="p">})</span>

<span class="c1"># model</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">List</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>


<span class="c1"># template home</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">To</span><span class="o">-</span><span class="n">Do</span> <span class="n">lists</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Start</span> <span class="n">a</span> <span class="n">new</span> <span class="n">To</span><span class="o">-</span><span class="n">Do</span> <span class="nb">list</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">form</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/lists/new&quot;</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nb">input</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;item_text&quot;</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;id_new_item&quot;</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Enter a to-do item&quot;</span> <span class="o">/&gt;</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">csrf_token</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>

<span class="c1"># template list</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">To</span><span class="o">-</span><span class="n">Do</span> <span class="n">lists</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Your</span> <span class="n">To</span><span class="o">-</span><span class="n">Do</span> <span class="nb">list</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">form</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;/lists/{{ list.id }}/add_item&quot;</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nb">input</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;item_text&quot;</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;id_new_item&quot;</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;Enter a to-do item&quot;</span> <span class="o">/&gt;</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">csrf_token</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">table</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;id_list_table&quot;</span><span class="o">&gt;</span>
      <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="o">.</span><span class="n">item_set</span><span class="o">.</span><span class="n">all</span> <span class="o">%</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">forloop</span><span class="o">.</span><span class="n">counter</span> <span class="p">}}:</span> <span class="p">{{</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</pre></div>
</div>
<h3>6.11 新功能单元测试</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">lists.models</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">List</span>


<span class="k">class</span> <span class="nc">HomePageTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_uses_home_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTemplateUsed</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;home.html&#39;</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">NewListTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_can_save_a_POST_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/lists/new&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;item_text&#39;</span><span class="p">:</span> <span class="s1">&#39;A new list item&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;A new list item&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_redirects_after_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/lists/new&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;item_text&#39;</span><span class="p">:</span> <span class="s1">&#39;A new list item&#39;</span><span class="p">})</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;/lists/{new_list.id}/&#39;</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">NewItemTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_can_save_a_POST_request_to_an_existing_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">other_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">correct_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;/lists/{correct_list.id}/add_item&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;item_text&#39;</span><span class="p">:</span> <span class="s1">&#39;A new item for an existing list&#39;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;A new item for an existing list&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">list</span><span class="p">,</span> <span class="n">correct_list</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_redirects_to_list_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">other_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">correct_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;/lists/{correct_list.id}/add_item&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;item_text&#39;</span><span class="p">:</span> <span class="s1">&#39;A new item for an existing list&#39;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;/lists/{correct_list.id}/&#39;</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">ListViewTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_uses_list_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;/lists/{list_.id}/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTemplateUsed</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;list.html&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_passes_correct_list_to_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">other_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">correct_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;/lists/{correct_list.id}/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;list&#39;</span><span class="p">],</span> <span class="n">correct_list</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_displays_only_items_for_that_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">correct_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;itemey 1&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">correct_list</span><span class="p">)</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;itemey 2&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">correct_list</span><span class="p">)</span>
        <span class="n">other_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;other list item 1&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">other_list</span><span class="p">)</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;other list item 2&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">other_list</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;/lists/{correct_list.id}/&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;itemey 1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;itemey 2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;other list item 1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;other list item 2&#39;</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">ListAndItemModelsTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_saving_and_retrieving_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="n">list_</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">first_item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
        <span class="n">first_item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;The first (ever) list item&#39;</span>
        <span class="n">first_item</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">list_</span>
        <span class="n">first_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">second_item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
        <span class="n">second_item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Item the second&#39;</span>
        <span class="n">second_item</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">list_</span>
        <span class="n">second_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">saved_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">saved_list</span><span class="p">,</span> <span class="n">list_</span><span class="p">)</span>

        <span class="n">saved_items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">saved_items</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">first_saved_item</span> <span class="o">=</span> <span class="n">saved_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">second_saved_item</span> <span class="o">=</span> <span class="n">saved_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_saved_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;The first (ever) list item&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_saved_item</span><span class="o">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">second_saved_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;Item the second&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">second_saved_item</span><span class="o">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list_</span><span class="p">)</span>
</pre></div>
</div>
<h3>6.12 新功能功能测试</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">LiveServerTestCase</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.common.exceptions</span> <span class="kn">import</span> <span class="n">WebDriverException</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">MAX_WAIT</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">class</span> <span class="nc">NewVisitorTest</span><span class="p">(</span><span class="n">LiveServerTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">wait_for_row_in_list_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_text</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_list_table&#39;</span><span class="p">)</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find_elements_by_tag_name</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">row_text</span><span class="p">,</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="n">WebDriverException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">MAX_WAIT</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_can_start_a_list_for_one_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Edith has heard about a cool new online to-do app. She goes</span>
        <span class="c1"># to check out its homepage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live_server_url</span><span class="p">)</span>

        <span class="c1"># She notices the page title and header mention to-do lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;To-Do&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">header_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;To-Do&#39;</span><span class="p">,</span> <span class="n">header_text</span><span class="p">)</span>

        <span class="c1"># She is invited to enter a to-do item straight away</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_new_item&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">inputbox</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;placeholder&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Enter a to-do item&#39;</span>
        <span class="p">)</span>

        <span class="c1"># She types &quot;Buy peacock feathers&quot; into a text box (Edith&#39;s hobby</span>
        <span class="c1"># is tying fly-fishing lures)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># When she hits enter, the page updates, and now the page lists</span>
        <span class="c1"># &quot;1: Buy peacock feathers&quot; as an item in a to-do list table</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;1: Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># There is still a text box inviting her to add another item. She</span>
        <span class="c1"># enters &quot;Use peacock feathers to make a fly&quot; (Edith is very</span>
        <span class="c1"># methodical)</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_new_item&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;Use peacock feathers to make a fly&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>

        <span class="c1"># The page updates again, and now shows both items on her list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;2: Use peacock feathers to make a fly&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;1: Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># Satisfied, she goes back to sleep</span>


    <span class="k">def</span> <span class="nf">test_multiple_users_can_start_lists_at_different_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Edith starts a new to-do list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live_server_url</span><span class="p">)</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_new_item&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;Buy peacock feathers&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;1: Buy peacock feathers&#39;</span><span class="p">)</span>

        <span class="c1"># She notices that her list has a unique URL</span>
        <span class="n">edith_list_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">current_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">edith_list_url</span><span class="p">,</span> <span class="s1">&#39;/lists/.+&#39;</span><span class="p">)</span>

        <span class="c1"># Now a new user, Francis, comes along to the site.</span>

        <span class="c1">## We use a new browser session to make sure that no information</span>
        <span class="c1">## of Edith&#39;s is coming through from cookies etc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>

        <span class="c1"># Francis visits the home page.  There is no sign of Edith&#39;s</span>
        <span class="c1"># list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live_server_url</span><span class="p">)</span>
        <span class="n">page_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;Buy peacock feathers&#39;</span><span class="p">,</span> <span class="n">page_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;make a fly&#39;</span><span class="p">,</span> <span class="n">page_text</span><span class="p">)</span>

        <span class="c1"># Francis starts a new list by entering a new item. He</span>
        <span class="c1"># is less interesting than Edith...</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s1">&#39;id_new_item&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s1">&#39;Buy milk&#39;</span><span class="p">)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_row_in_list_table</span><span class="p">(</span><span class="s1">&#39;1: Buy milk&#39;</span><span class="p">)</span>

        <span class="c1"># Francis gets his own unique URL</span>
        <span class="n">francis_list_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">current_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">francis_list_url</span><span class="p">,</span> <span class="s1">&#39;/lists/.+&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">francis_list_url</span><span class="p">,</span> <span class="n">edith_list_url</span><span class="p">)</span>

        <span class="c1"># Again, there is no trace of Edith&#39;s list</span>
        <span class="n">page_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;Buy peacock feathers&#39;</span><span class="p">,</span> <span class="n">page_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;Buy milk&#39;</span><span class="p">,</span> <span class="n">page_text</span><span class="p">)</span>

        <span class="c1"># Satisfied, they both go back to sleep</span>
</pre></div>
</div>
<p>http://7xj7fg.com1.z0.glb.clouddn.com/15146512145459.jpg</p>

    </div>
    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic green button">打赏 <i class="red heart icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">MORE WORDS</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer code">
            <span>© 1994 - 2018 willdx</span><b>@</b><a class="code" href="https://willdx.github.io">willdx.github.io</a>
            <br/>
            <span class="notprint">
                <span id="busuanzi_container_site_pv">
                    <i class="eye icon"></i><span id="busuanzi_value_site_pv" class="orange text"></span> pv
                </span>
                <b> | </b>
                <span id="busuanzi_container_site_uv">
                    <i class="user icon"></i><span id="busuanzi_value_site_uv" class="orange text"></span> uv
                </span>
                <br/>
            </span>
            <span>Power by <i class="github alternate icon"></i><a href="https://github.com/willdx/willdx.github.io">Github Page</a></span>
            <br/>
            <i class="green superpowers icon"></i>
        </div>
    </body>
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="/assets/js/web.js"></script>
    <script>
        // 统计代码
        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-93231524-1', 'auto');
        ga('send', 'pageview');

        var wrappers = ["cats-wrapper", "donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper"]

        window.onload = function () {
            useWechat();
        }
    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: '177af99888a292531873',
        clientSecret: '7c0927c7cdf0d94eed7dad0b238552c10ec6f53c',
        repo: 'willdx.github.io',
        owner: 'willdx',
        admin: ['willdx'],
        id: 'python web开发测试驱动开发方法',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: ['gitment'],
        pagerDirection: "last",
    })
      
    gitalk.render('comments')
    </script>


</html>