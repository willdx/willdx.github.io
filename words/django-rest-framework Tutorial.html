<html>
    <head>
        <meta charset="utf-8">
        
    
        <title> django-rest-framework Tutorial笔记 </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">


        <style type="text/css"> 
        </style>
    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: #fff;">主题选择</span></h3>
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr class="sk-mo" onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">墨</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-green" onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">绿</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-default" onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">青</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-orange" onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">橘</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">波妞</div>
                                <div class="time">2017年2月21号</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">三三</div>
                                <div class="time">2017年4月10号</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        微信
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        支付宝
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:1426409836@qq.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/willdx">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>





            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
              <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="linkify icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    🐱
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="heart icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <h2 class="name">Will Dx</h2>

                <span class="sign">人世一身霜雪, 归来仍是少年.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        主页
                    </a>
                    <a href="/tweet.html" class="item">
                        推特
                    </a>
                    <a href="/about.html" class="item">
                        关于我
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        联系
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1>django-rest-framework Tutorial笔记</h1>
        <h4>Posted April 07, 2017</h4>
        <h1>0. Quikstart</h1>

<p>创建一个简单的项目, 允许管理员查看和编辑用户和组; 以此来大致了解Django REST framwork的使用方式;</p>

<h2>0.1 创建项目</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 创建项目目录</span>
<span class="n">mkdir</span> <span class="n">tutorial</span>
<span class="n">cd</span> <span class="n">tutorial</span>

<span class="c1"># 创建一个虚拟环境</span>
<span class="n">mkvirtualenv</span> <span class="n">env</span>

<span class="c1"># 进入虚拟环境</span>
<span class="n">workon</span> <span class="n">env</span> <span class="err">或者</span> <span class="n">source</span> <span class="n">env</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>

<span class="c1"># 安装Django和framwork在虚拟环境</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">django</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">djangorestframework</span>

<span class="c1"># 启动一个项目</span>
<span class="n">django</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">py</span> <span class="n">startproject</span> <span class="n">tutorial</span> <span class="o">.</span>
 
<span class="c1"># 并创建一个APP </span>
<span class="n">django</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">py</span> <span class="n">startapp</span> <span class="n">quickstart</span>

<span class="c1"># 同步数据库</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>

<span class="c1"># 创建一个管理员账号(admin/password123)</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">createsuperuser</span>
</pre></div>
</div>
<h2>0.2 序列化</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># quickstart/serializers.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>


<span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GroupSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Group</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>

<span class="c1"># HyperlinkedModelSerializer类文档</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">A type of `ModelSerializer` that uses hyperlinked relationships instead</span>
<span class="sd">    of primary key relationships. Specifically:</span>

<span class="sd">    * A &#39;url&#39; field is included instead of the &#39;id&#39; field.</span>
<span class="sd">    * Relationships to other instances are hyperlinks, instead of primary keys.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># 说明: 上述代码中我们使用了`HyperlinkedModelSerializer`, </span>

<span class="c1"># 尽管我们可以使用主键或者其他关系, 也不能否认`hyperlinking`是一个`很RESTful设计`的事实;</span>
<span class="p">(</span><span class="n">PS</span><span class="p">:</span> <span class="err">使用中发现</span><span class="p">,</span> <span class="n">hyperlinking</span><span class="err">就是把数据的关系表示为一个接口</span><span class="p">,</span> <span class="err">客户端获取数据就直接调用接口即可</span><span class="p">,</span> <span class="err">而不需要拼接</span><span class="p">)</span>
</pre></div>
</div>
<h2>0.2 视图</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># quickstart/views.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">quickstart.serializers</span> <span class="kn">import</span> <span class="n">UserSerializer</span><span class="p">,</span> <span class="n">GroupSerializer</span>


<span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows users to be viewed or edited.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-date_joined&#39;</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>


<span class="k">class</span> <span class="nc">GroupViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows groups to be viewed or edited.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">GroupSerializer</span>
</pre></div>
</div>
<ul>
<li>ViewSets</li>
</ul>

<p>Rather than write multiple views we&#39;re grouping together all the common behavior into classes called ViewSets;(意译: 我们将一组相同规则的view组合在一起, 而不用去为每一个动作都写一个view)</p>

<p>We can easily break these down into individual views if we need to, but using viewsets keeps the view logic nicely organized as well as being very concise.(意译: 尽管我们能很容易将一个功能拆分为多个view, 但是更推荐使用viewsets的方式, 因为它更直观,简洁;)</p>

<h2>0.3 URLs</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># tutorial/urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
<span class="kn">from</span> <span class="nn">quickstart</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserViewSet</span><span class="p">)</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">GroupViewSet</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^api-auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;rest_framework.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;rest_framework&#39;</span><span class="p">))</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Because we&#39;re using viewsets instead of views, we can automatically generate the URL conf for our API, by simply registering the viewsets with a router class.(意译: 由于我们使用viewsets的方式编写views, 使得我们在编写urls的时候只需要通过router.register的方式就可以自动生成URL配置)</p>

<p>Again, if we need more control over the API URLs we can simply drop down to using regular class-based views, and writing the URL conf explicitly.(意译: 当我们需要对接口有更多的控制的时候也可以转为写常规的基于类的views, 这样的话就需要将URL配置写的很明确)</p>

<p>Finally, we&#39;re including default login and logout views for use with the browsable API. That&#39;s optional, but useful if your API requires authentication and you want to use the browsable API.(意译: 最后, 我们添加了默认的 登录/注销 视图, 这是可选的; 不过当你想在浏览器上调试需要认证的接口时这个配置就排上用场了)</p>

<h2>0.4 Settings</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># tutorial/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="o">...</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;rest_framework.permissions.IsAdminUser&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;PAGE_SIZE&#39;</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>0.5 测试API</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 启动服务器</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">runserver</span>
</pre></div>
</div>
<ul>
<li>命令行测试</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># curl</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Accept: application/json; indent=4&#39;</span> <span class="o">-</span><span class="n">u</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">users</span><span class="o">/</span>

<span class="c1"># httpie</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">users</span><span class="o">/</span>
</pre></div>
</div>
<ul>
<li>浏览器测试</li>
</ul>

<p>登录前:</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15039124608135.jpg"></p>
</p>

<p>登录后:</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15039124923087.jpg"></p>
</p>

<h1>1. 序列化-Serialization</h1>

<h2>1.1 介绍</h2>

<p>本章将通过写一个<code>code highlighting Web API</code>项目来介绍RESTframwork的各个部分;</p>

<h2>1.2 例子</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 使用quikstart部分的虚拟环境</span>
<span class="n">workon</span> <span class="n">virtualenv</span> 
<span class="n">pip</span> <span class="n">install</span> <span class="n">pygments</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">tutorial</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">startapp</span> <span class="n">snippets</span>

<span class="c1"># 配置settings.py</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
    <span class="s1">&#39;snippets.apps.SnippetsConfig&#39;</span><span class="p">,</span> <span class="c1"># 添加app</span>
<span class="p">]</span>

<span class="err">说明</span><span class="p">:</span> <span class="err">若</span><span class="n">Django</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mf">1.9</span><span class="p">,</span> <span class="err">应该直接写</span><span class="n">snippets</span>

<span class="c1"># 配置模型</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">get_all_lexers</span>
<span class="kn">from</span> <span class="nn">pygments.styles</span> <span class="kn">import</span> <span class="n">get_all_styles</span>

<span class="n">LEXERS</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_all_lexers</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">LANGUAGE_CHOICES</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">LEXERS</span><span class="p">])</span>
<span class="n">STYLE_CHOICES</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_all_styles</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">Snippet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">linenos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STYLE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;friendly&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,)</span>
        
<span class="c1"># 同步数据库</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">makemigrations</span> <span class="n">snippets</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>

<span class="c1"># 创建序列化文件</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span><span class="p">,</span> <span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">STYLE_CHOICES</span>


<span class="k">class</span> <span class="nc">SnippetSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;textarea.html&#39;</span><span class="p">})</span>
    <span class="n">linenos</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ChoiceField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ChoiceField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STYLE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;friendly&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and return a new `Snippet` instance, given the validated data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update and return an existing `Snippet` instance, given the validated data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">linenos</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linenos&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">linenos</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instance</span>
<span class="c1"># 说明: serializers.Serializer和forms的表现形式差不多, 用来保证提交数据的有效性</span>
</pre></div>
</div>
<p>序列化/反序列化流程(如图):</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15039716904071.jpg"></p>
</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># python manage.py shell</span>

<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="kn">from</span> <span class="nn">rest_framework.renderers</span> <span class="kn">import</span> <span class="n">JSONRenderer</span>
<span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">JSONParser</span>

<span class="n">snippet</span> <span class="o">=</span> <span class="n">Snippet</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">&#39;foo = &quot;bar&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">snippet</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="n">snippet</span> <span class="o">=</span> <span class="n">Snippet</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">&#39;print &quot;hello, world&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">snippet</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># model instance: 返回python原生数据格式(dict)</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># render: 返回json</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">JSONRenderer</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">content</span>

<span class="c1"># 反序列化: 先转为stream, 在parse为python原生数据格式(dict)</span>
<span class="kn">from</span> <span class="nn">django.utils.six</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">JSONParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

<span class="c1"># 反序列化之后的python原生数据格式, 转为model instance</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>

<span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># querysets也可以被序列化, 添加一个参数many=true</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<h2>1.3 模型序列化-Model Serializers</h2>

<p>我们的<code>SnippetSerializer</code>类复制了很多代码, 这些代码在<code>Snippet</code>模型中已经定义过了, 如果能让代码更简洁一些就好了啊!</p>

<p>用类似Django的 <code>Form</code>和<code>ModelForm</code>方法, 我们重新定义snippets/serializers.py文件, 代码如下:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SnippetSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Snippet</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;linenos&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">)</span>
        
<span class="c1"># serializers有一个很好的特性, 可以查看序列化实例的详情</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">serializer</span><span class="p">))</span>
<span class="c1"># SnippetSerializer():</span>
<span class="c1">#    id = IntegerField(label=&#39;ID&#39;, read_only=True)</span>
<span class="c1">#    title = CharField(allow_blank=True, max_length=100, required=False)</span>
<span class="c1">#    code = CharField(style={&#39;base_template&#39;: &#39;textarea.html&#39;})</span>
<span class="c1">#    linenos = BooleanField(required=False)</span>
<span class="c1">#    language = ChoiceField(choices=[(&#39;Clipper&#39;, &#39;FoxPro&#39;), (&#39;Cucumber&#39;, &#39;Gherkin&#39;), (&#39;RobotFramework&#39;, &#39;RobotFramework&#39;), (&#39;abap&#39;, &#39;ABAP&#39;), (&#39;ada&#39;, &#39;Ada&#39;)...</span>
<span class="c1">#    style = ChoiceField(choices=[(&#39;autumn&#39;, &#39;autumn&#39;), (&#39;borland&#39;, &#39;borland&#39;), (&#39;bw&#39;, &#39;bw&#39;), (&#39;colorful&#39;, &#39;colorful&#39;)...</span>

<span class="err">从返回中我们可以看到</span><span class="p">,</span> <span class="n">Model</span> <span class="n">Serializers</span><span class="err">帮我们把</span><span class="n">Model</span><span class="err">部分的代码转化为了</span><span class="n">Serializers</span><span class="err">所需要的语法</span><span class="p">;</span> <span class="err">大致可以概括为</span><span class="p">:</span> 
<span class="mf">1.</span> <span class="err">根据输入确定字段集</span>
<span class="mf">2.</span> <span class="n">create</span><span class="p">()</span> <span class="ow">and</span> <span class="n">update</span><span class="p">()</span> <span class="err">的默认实现</span>
<span class="err">如果有特殊需要我们可以重写字段定义和默认实现的方法</span><span class="p">;</span>
</pre></div>
</div>
<h2>1.4 在Django视图中使用Serializer</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># snippets/views.py</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span> <span class="nn">rest_framework.renderers</span> <span class="kn">import</span> <span class="n">JSONRenderer</span>
<span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">JSONParser</span>
<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>

<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">snippet_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all code snippets, or create a new snippet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">snippets</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippets</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">JSONParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        
<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">snippet_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve, update or delete a code snippet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">JSONParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
        <span class="n">snippet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">)</span>
        
<span class="c1"># snippets/urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">snippet_list</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">snippet_detail</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># tutorial/urls.py</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;snippets.urls&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>测试</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># http http://127.0.0.1:8000/snippets/</span>

<span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="err">➜</span>  <span class="n">tutorial</span> <span class="n">http</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">466</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">29</span> <span class="n">Aug</span> <span class="mi">2017</span> <span class="mo">03</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">52</span> <span class="n">GMT</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">WSGIServer</span><span class="o">/</span><span class="mf">0.1</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">11</span>
<span class="n">X</span><span class="o">-</span><span class="n">Frame</span><span class="o">-</span><span class="n">Options</span><span class="p">:</span> <span class="n">SAMEORIGIN</span>

<span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;foo = </span><span class="se">\&quot;</span><span class="s2">bar</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print </span><span class="se">\&quot;</span><span class="s2">hello, world</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;foo = </span><span class="se">\&quot;</span><span class="s2">bar</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print </span><span class="se">\&quot;</span><span class="s2">hello, world</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># (env) ➜  tutorial http http://127.0.0.1:8000/snippets/1/</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">110</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">29</span> <span class="n">Aug</span> <span class="mi">2017</span> <span class="mo">03</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">42</span> <span class="n">GMT</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">WSGIServer</span><span class="o">/</span><span class="mf">0.1</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">11</span>
<span class="n">X</span><span class="o">-</span><span class="n">Frame</span><span class="o">-</span><span class="n">Options</span><span class="p">:</span> <span class="n">SAMEORIGIN</span>

<span class="p">{</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;foo = </span><span class="se">\&quot;</span><span class="s2">bar</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>注释: @csrf<em>exempt
Note that because we want to be able to POST to this view from clients that won&#39;t have a CSRF token we need to mark the view as csrf</em>exempt. This isn&#39;t something that you&#39;d normally want to do, and REST framework views actually use more sensible behavior than this, but it&#39;ll do for our purposes right now.(意译: 大概的意思是: 我们需要使用clients进行接口测试, 而clients不会携带csrf的token,所以我们在view视图上添加@csrf_exempt确保测试能通过; 但是, 在生产环境下使用Django默认的CSRF规则是更安全的.)</p>

<h2>1.5 小结</h2>

<p>目前为止, 我们编写了几个基于Django REST framwork的serialization API;
我们的API视图目前没有做任何特别的事情，除了服务JSON响应，还有一些错误处理边缘情况，我们仍然想清理，但是它是一个功能强大的Web API;</p>

<h1>2.请求和响应-Requests and responses</h1>

<p>从这一节开始, 我们将进入REST framework的核心, 我们需要了解几个必要的构建块.</p>

<h2>2.1 请求对象-Request objects</h2>

<p>REST framework introduces a Request object that extends the regular HttpRequest, and provides more flexible request parsing. The core functionality of the Request object is the request.data attribute, which is similar to request.POST, but more useful for working with Web APIs.(意译: <code>REST framework Request object</code>扩展自标准的<code>HttpRequest</code>, 与此同时添加了更灵活的请求解析, 也就是<code>request.data</code>属性)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">POST</span>  <span class="c1"># Only handles form data.  Only works for &#39;POST&#39; method.</span>
<span class="n">request</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># Handles arbitrary data.  Works for &#39;POST&#39;, &#39;PUT&#39; and &#39;PATCH&#39; methods.</span>
</pre></div>
</div>
<h2>2.2 响应对象-Response objects</h2>

<p>REST framework also introduces a Response object, which is a type of TemplateResponse that takes unrendered(未渲染的) content and uses content negotiation to determine the correct content type to return to the client.(意译: <code>REST framework Response object</code>是一种<code>TemplateResponse</code>, 它将未渲染的内容转化为正确的格式<code>content type</code>然后返回给client)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Renders to content type as requested by the client.</span>
</pre></div>
</div>
<h2>2.3 返回状态码-Status codes</h2>

<p>Using numeric HTTP status codes in your views doesn&#39;t always make for obvious reading, and it&#39;s easy to not notice if you get an error code wrong. REST framework provides more explicit identifiers for each status code, such as HTTP<em>400</em>BAD_REQUEST in the status module. It&#39;s a good idea to use these throughout rather than using numeric identifiers.(意译: Django返回状态码默认是用数字标识的, 这样的方式很难清晰的描述具体的错误, RESTframwork使用类似<code>HTTP_400_BAD_REQUEST</code>(大写字符串+状态码)的方式来标识状态码)</p>

<h2>2.4 包装API视图-Wrapping API views</h2>

<p>REST框架提供两个包装可以用来写API视图:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="sb">`@api_view`</span><span class="err">装饰器可以使用在函数方式的</span><span class="n">view</span><span class="err">视图</span><span class="o">.</span>
<span class="mf">2.</span> <span class="sb">`APIView`</span><span class="err">类使用在基于类的视图</span><span class="o">.</span>
</pre></div>
</div>
<p>These wrappers provide a few bits of functionality such as making sure you receive Request instances in your view, and adding context to Response objects so that content negotiation can be performed.(意译: 这些包装提供了一些功能，比如,确保你收到请求，并增加上下文响应对象，可以进行内容协商;)</p>

<p>The wrappers also provide behaviour such as returning 405 Method Not Allowed responses when appropriate, and handling any ParseError exception that occurs when accessing request.data with malformed input.(意译: 该包装还提供,如返回405响应方法，以及解析request.data数据得到一个错误输入的响应;)</p>

<h2>2.5 例子: 将上述组件应用到视图</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 本例中不使用`JSONResponse`, 而使用Response</span>
<span class="c1"># 使用 request.data 获取POST请求参数</span>
<span class="c1"># 使用 @api_view([&#39;GET&#39;, &#39;POST&#39;]) 控制视图函数支持的方法类型</span>
<span class="c1"># 使用 restframwork Response 返回正确或者错误的响应, 并使用其status模块, 用以抛出特定含义的异常</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>


<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">snippet_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all snippets, or create a new snippet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">snippets</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippets</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">snippet_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve, update or delete a snippet instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
        <span class="n">snippet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
</pre></div>
</div>
<h2>2.6 让API可以支持可选的格式后缀</h2>

<p>例子</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># views添加format参数</span>

<span class="k">def</span> <span class="nf">snippet_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">pass</span>
    
<span class="k">def</span> <span class="nf">snippet_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">pass</span>
    
<span class="c1"># format_suffix_patterns, URL添加format参数支持</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">rest_framework.urlpatterns</span> <span class="kn">import</span> <span class="n">format_suffix_patterns</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">snippet_list</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">snippet_detail</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">(</span><span class="n">urlpatterns</span><span class="p">)</span>
</pre></div>
</div>
<p>测试get</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 返回HTML</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">.</span><span class="n">api</span> 

<span class="c1"># 返回JSON</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>测试POST</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">通过使用Content-Type header,我们可以控制使用什么格式的数据发起POST请求</span>
<span class="sd">使用httpie库更简洁</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># POST using form data</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="o">--</span><span class="n">form</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;print 123&quot;</span>

<span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print 123&quot;</span><span class="p">,</span>
  <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
  <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span>
<span class="p">}</span>

<span class="c1"># POST using JSON</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="o">--</span><span class="n">json</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;print 456&quot;</span>

<span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print 456&quot;</span><span class="p">,</span>
    <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>我们不一定要加上这些额外的URL模式，但它为我们提供了一个简单的，指特定格式的清洁方式;</p>

<h2>2.7 小结</h2>

<p>到此为止,我们学习了<code>RESTframwork</code> 如何在 <code>基于函数的视图</code>中使用方法, 学习了RESTframwork下的请求和响应如何使用, 学习了如何使用更具意义的<code>Status code</code>, 学习了如何包装API让其仅仅支持部分方法, 学习了如何给API添加格式后缀去轻便的获取不同返回格式的API接口;</p>

<h1>3. 基于类的视图-Class based views</h1>

<p>我们可以写基于Class的API视图。这是一个强大的模式，使我们能够重用的功能，并有助于我们保持代码干净, 整洁;</p>

<h2>3.1 重写我们的视图函数为基于类的方式</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># views.py</span>

<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>


<span class="k">class</span> <span class="nc">SnippetList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all snippets, or create a new snippet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">snippets</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippets</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve, update or delete a snippet instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">snippet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
 
<span class="c1"># urls</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">rest_framework.urlpatterns</span> <span class="kn">import</span> <span class="n">format_suffix_patterns</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">(</span><span class="n">urlpatterns</span><span class="p">)</span> 

<span class="c1"># 此时就和上一部分的API一样了</span>
</pre></div>
</div>
<h2>3.2 使用混合类的方式来代替<code>@api_view</code>装饰器功能</h2>

<p>Using mixins</p>

<p>One of the big wins of using class-based views is that it allows us to easily compose reusable bits of behaviour.(意译: 混合类的方式使代码有更好的重用性)</p>

<p>The create/retrieve/update/delete operations that we&#39;ve been using so far are going to be pretty similar for any model-backed API views we create. Those bits of common behaviour are implemented in REST framework&#39;s mixin classes.(意译: 常见的 创建/获取/更新/删除 操作都可以用混合类的方式实现, 需要什么功能就添加对应的混合类)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 重构views</span>

<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">mixins</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>

<span class="k">class</span> <span class="nc">SnippetList</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
                  <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
                  <span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span>
                    <span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
                    <span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
                    <span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The base class provides the core functionality, and the mixin classes provide the .list() and .create() actions. We&#39;re then explicitly binding the get and post methods to the appropriate actions. Simple enough stuff so far.(意译: 基类提供了核心功能，混合类提供list()和create()行动, 我们通过继承对应action的混合类, 添加对应action的支持, 到目前为止, 已经足够简单了)</p>

<h2>3.3 使用通用类视图-Using generic class-based views</h2>

<p>通用类视图是对混合类视图的简单封装, 功能进行了一些合并重组操作;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 基于类的通用视图</span>

<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>

<span class="k">class</span> <span class="nc">SnippetList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>

<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>
    
<span class="c1"># ListCreateAPIView源代码</span>
<span class="k">class</span> <span class="nc">ListCreateAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
                        <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
                        <span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concrete view for listing a queryset or creating a model instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="err">可以看出</span><span class="p">,</span> <span class="err">通用类视图其实就是继承响应的</span><span class="n">mixins</span><span class="err">类</span><span class="p">,</span> <span class="err">然后内容实现了对应类需要的</span><span class="n">action</span><span class="err">方法</span>
</pre></div>
</div>
<h2>3.4 小结</h2>

<p>哇，那是相当的简洁。我们已经得到了大量的自由，我们的代码看起来是好的，干净的，地道的Django。接下来我们将进入本教程的4部分，我们将看看我们如何处理我们的API认证和权限;</p>

<h1>4. 认证和权限-Authentication and permissions</h1>

<p>目前我们的API没有限制谁可以编辑或删除代码片段</p>

<ol>
<li>snippets总关联一个创建者; (Authentication)</li>
<li>只有通过认证的用户可以创建片段; (Authentication)</li>
<li>匿名账户或者未认证的请求拥有部分API的只读权限; (Authentication) </li>
<li>只有代码段的创建者可以更新和删除它; (permissions)</li>
</ol>

<h2>4.1 还是之前代码段的例子-Adding information to our model</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 模型添加字段</span>
<span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;auth.User&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
<span class="n">highlighted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="c1"># 实例保存, 高亮显示代码片段</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">导入模块, 重写save函数</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">get_all_lexers</span>
<span class="kn">from</span> <span class="nn">pygments.styles</span> <span class="kn">import</span> <span class="n">get_all_styles</span>
<span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">get_lexer_by_name</span>
<span class="kn">from</span> <span class="nn">pygments.formatters.html</span> <span class="kn">import</span> <span class="n">HtmlFormatter</span>
<span class="kn">from</span> <span class="nn">pygments</span> <span class="kn">import</span> <span class="n">highlight</span>

<span class="n">LEXERS</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_all_lexers</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">LANGUAGE_CHOICES</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">LEXERS</span><span class="p">])</span>
<span class="n">STYLE_CHOICES</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_all_styles</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">Snippet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">linenos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STYLE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;friendly&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;auth.User&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">highlighted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the `pygments` library to create a highlighted HTML</span>
<span class="sd">        representation of the code snippet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">get_lexer_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">linenos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linenos</span> <span class="ow">and</span> <span class="s1">&#39;table&#39;</span> <span class="ow">or</span> <span class="bp">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">}</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">HtmlFormatter</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="n">linenos</span><span class="p">,</span>
                                  <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlighted</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Snippet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,)</span>
    
<span class="c1"># 删除之前的Sqlite数据和migrations文件, 重新生成数据库, 创建超级用户</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="n">tmp</span><span class="o">.</span><span class="n">db</span> <span class="n">db</span><span class="o">.</span><span class="n">sqlite3</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">r</span> <span class="n">snippets</span><span class="o">/</span><span class="n">migrations</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">makemigrations</span> <span class="n">snippets</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">createsuperuser</span>

<span class="c1"># 添加用户序列化代码, serializers.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">因为 &#39;snippets&#39; 和用户model是反向关联（reverse relationship，即多对一），所以在使用 ModelSerializer时并不会缺省加入，所以我们需要显式的来实现</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">snippets</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">PrimaryKeyRelatedField</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;snippets&#39;</span><span class="p">)</span>
        
<span class="err">说明</span><span class="p">:</span> <span class="n">snippets</span><span class="err">也可以这样写</span><span class="p">(</span><span class="n">PS</span><span class="p">:</span> <span class="err">暂时还不知道两种不同的实现方式有什么区别</span><span class="p">)</span>
    <span class="n">snippets</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">PrimaryKeyRelatedField</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<span class="c1"># Users视图实现</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">我们还需要创建一些views，对用户呈现而言，我们最好使用只读的view，所以使用 ListAPIView 和 RetrieveAPIView 泛型类Views</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">UserList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>

<span class="k">class</span> <span class="nc">UserDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    
<span class="c1"># 修改URL(PS: 注意排除其他users的URL的干扰, 我就犯过这么SB的错误, 浪费了很多时间.)</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</pre></div>
</div>
<h2>4.2 用户相关片段-Associating Snippets with Users</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 把Snippets与Users关联</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">此时POST代码片段会报错:</span>
<span class="sd">Exception Type: IntegrityError</span>
<span class="sd">Exception Value:    </span>
<span class="sd">NOT NULL constraint failed: snippets_snippet.owner_id</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">The</span> <span class="n">way</span> <span class="n">we</span> <span class="n">deal</span> <span class="k">with</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">by</span> <span class="n">overriding</span> <span class="n">a</span> <span class="o">.</span><span class="n">perform_create</span><span class="p">()</span> <span class="n">method</span> <span class="n">on</span> <span class="n">our</span> <span class="n">snippet</span> <span class="n">views</span><span class="p">,</span> <span class="n">that</span> <span class="n">allows</span> <span class="n">us</span> <span class="n">to</span> <span class="n">modify</span> <span class="n">how</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">save</span> <span class="ow">is</span> <span class="n">managed</span><span class="p">,</span> <span class="ow">and</span> <span class="n">handle</span> <span class="nb">any</span> <span class="n">information</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">implicit</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">incoming</span> <span class="n">request</span> <span class="ow">or</span> <span class="n">requested</span> <span class="n">URL</span><span class="o">.</span>
<span class="p">(</span><span class="err">意译</span><span class="p">:</span> <span class="err">可以在</span><span class="n">views</span><span class="err">类中</span><span class="p">,</span> <span class="err">重写</span><span class="o">.</span><span class="n">perform_create</span><span class="p">()</span><span class="err">方法来处理</span><span class="n">request</span><span class="err">请求中的隐式信息</span><span class="p">,</span> <span class="err">例如</span><span class="p">:</span> <span class="err">在此例中我们</span><span class="sb">`owner=self.request.user`</span><span class="err">将请求携带的用户实例传递给</span><span class="n">owner</span><span class="err">属性</span><span class="p">)</span>

<span class="err">在</span> <span class="n">SnippetList</span> <span class="err">和</span> <span class="n">SnippetDetail</span> <span class="err">的</span><span class="n">view</span><span class="err">类中，都需要添加如下的方法</span><span class="p">:</span>
<span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;保存数据时添加一个owner&quot;&quot;&quot;</span>
    <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="sb">``</span><span class="err">`</span>

<span class="c1">## 4.3 更新序列化文件-Updating our serializer</span>

<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="c1"># 更新 serializer</span>
<span class="k">class</span> <span class="nc">SnippetSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ReadOnlyField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;owner.username&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Snippet</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;linenos&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">)</span>

<span class="n">source</span> <span class="err">参数表明增加一个新字段，可以指定序列化实例任何属性。它可以采用如上的点式表示（</span><span class="n">dotted</span> <span class="n">notation</span><span class="err">），这时他可以直接遍历到指定的属性。在</span><span class="n">Django</span><span class="s1">&#39;s template中使用时，也可以采用类似的方式;</span>

<span class="err">我们增加字段是一个</span><span class="n">ReadOnlyField</span> <span class="err">类，而我们之前的字段都是有类型的，例如</span> <span class="n">CharField</span><span class="p">,</span> <span class="n">BooleanField</span> <span class="n">etc</span><span class="o">...</span> <span class="err">无类型字段总是只读的，它们只用在序列化表示中，而在反序列化时（修改</span><span class="n">model</span><span class="err">）不被使用</span><span class="p">;</span>
</pre></div>
</div>
<h2>4.4 添加需要的权限给视图-Adding required permissions to views</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 给view增加权限控制</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">现在代码片段 snippets 已经关联了用户，我们需要确保只有认证用户才能增、删、改snippets;</span>

<span class="sd">REST framework 包括许多权限类可用于view的控制。这里我们使用 IsAuthenticatedOrReadOnly, 它可确保认证的request获取read-write权限，而非认证的request只有read-only权限.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="err">现需要在</span><span class="n">views</span><span class="err">模块中增加</span> <span class="n">import</span><span class="p">:</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>
<span class="err">然后需要在</span> <span class="n">SnippetList</span> <span class="err">和</span> <span class="n">SnippetDetail</span> <span class="n">view</span><span class="err">类中都增加如下属性</span><span class="p">:</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,)</span>
</pre></div>
</div>
<h2>4.5 添加浏览器登录-Adding login to the Browsable API</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 为可浏览API（Browseable API）增加login</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">如果你打开浏览器，访问可浏览API，你会发现只有登录后才能创建新的snippet了</span>

<span class="sd">r&#39;^api-auth/&#39; 部分可以用任何你想用的URL来替代。这里唯一的限制就是 urls 必须使用&#39;rest_framework&#39; 命名空间;</span>

<span class="sd">打开浏览器，刷新页面会看到页面右上方的 &#39;Login&#39; 链接。如果你用之前的用户登录后，你就又可以创建 snippets了;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">include</span>
<span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^api-auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;rest_framework.urls&#39;</span><span class="p">,</span>
                               <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;rest_framework&#39;</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<h2>4.6 对象级别的权限-Object level permissions</h2>

<p>我们希望任何人都可以浏览snippets，但只有创建snippet的用户才能编辑或删除它;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 在 snippets 应用中，创建一个新文件： permissions.py</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>


<span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom permission to only allow owners of an object to edit it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># Read permissions are allowed to any request,</span>
        <span class="c1"># so we&#39;ll always allow GET, HEAD or OPTIONS requests.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="c1"># Write permissions are only allowed to the owner of the snippet.</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</pre></div>
</div>
<p>现在打开浏览器，你可以看见 &#39;DELETE&#39; 和 &#39;PUT&#39; 动作只会出现在那些你的登录用户创建的snippet页面上了</p>

<p>注销状态: 只读</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15040671453007.jpg"></p>
</p>

<p>登录状态: 增/删/改/查
<p class="hassubimage"><img src="http://iwillb.imdancer.com/15040671889236.jpg"></p>
</p>

<h2>4.7 通过API验证-Authenticating with the API</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 未认证</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;print 123&quot;</span>

<span class="p">{</span>
    <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentication credentials were not provided.&quot;</span>
<span class="p">}</span>

<span class="c1"># 认证后</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">tom</span><span class="p">:</span><span class="n">password123</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;print 789&quot;</span>

<span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="s2">&quot;tom&quot;</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print 789&quot;</span><span class="p">,</span>
    <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>4.8 工作用一些常用权限应用场景的补充</h2>

<h3>1. 是否需要登录才能访问  (Authentication)</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 登录的人才有读写权限</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticated</span><span class="p">)</span>
<span class="c1"># 登录的人才有读写权限, 未登录的用户只读</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span>
</pre></div>
</div>
<h3>2. 是否需要拥有人才能变更 (permissions)</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># Django RESTframwork 没有提供默认的权限, 需要我们自定义</span>
<span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom permission to only allow owners of an object to edit it.</span>
<span class="sd">    自定义权限: 匿名用户有读权限, 拥有者才有写权限</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># # Read permissions are allowed to any request,</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
             <span class="k">return</span> <span class="bp">True</span>
        <span class="c1"># Write permissions are only allowed to the owner of the snippet</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        
<span class="err">如何判断请求者是否是拥有者?</span>
<span class="err">请求者</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
<span class="err">拥有者</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span>

<span class="err">拥有者属性是如何来的呢?</span> 
<span class="err">在本教程的</span><span class="sb">`Snippets`</span><span class="err">例子的模型代码中添加了</span><span class="n">owner</span><span class="err">外键关联字段</span>
<span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;auth.User&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</pre></div>
</div>
<h3>3. 后台管理员是否能变更  (permissions)</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 管理员用户才有权限访问, 如何判断请求者是管理员呢?</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticated</span><span class="p">)</span>
<span class="c1"># 源代码: RESTframwork默认是通过用户模型中的is_staff字段来判断的</span>
<span class="k">class</span> <span class="nc">IsAdminUser</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows access only to admin users.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span>

<span class="c1"># 若是接口的数据一定要拥有者才能访问, 无论是读还是写</span>
<span class="k">class</span> <span class="nc">IsOwner</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</pre></div>
</div>
<h3>4. 给除了拥有者和管理员之外的用户添加特定变更action的权限 (permissions)</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 可以给用户分组,分角色,根据不同分组内的不同角色有不同的权限设定</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">在admin后台管理中可以进行用户组管理, 我们可以按功能模块添加组, 然后将不同的用户添加到对应的组中;</span>
<span class="sd">在permissions.py文件中定义组中的各种action的排列组合类以实现各种权限要求;</span>

<span class="sd">例如: </span>
<span class="sd">添加一个赛事组competition_admin, 将user1加入到competition_admin组, 要求赛事管理员组的内的用户才能更改数据, 其他的用户只能查看数据;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">class</span> <span class="nc">IsCompetitionAdmin</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;注意: 此段代码没有经过测试, 只是写了一种实现方式&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="n">AuthGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;competition_admin&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Groups</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<h3>5. 不允许用户删除数据, 仅保留更改权限</h3>

<p>场景: 写权限(PUT, PATCH, POST, DELETE), 由于数据的敏感性, 我们把删除数据都改为<code>隐藏数据</code>(即使用PUT, PATCH方法, 传递deleted=1), 然后在读取数据的地方都<code>过滤未隐藏</code>的(deleted!=1), 这种方式减少数据误删的可能. 另外添加一个字段hidden用来标识<code>用户的隐藏操作</code>;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 一棒子打死: 接口改为只支持UPDATE方法</span>
<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
<span class="err">更改为</span><span class="p">:</span>
<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateAPIView</span><span class="p">):</span>
</pre></div>
</div>
<p>现在打开浏览器，&#39;DELETE&#39; 按钮没有了</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15040740975415.jpg"></p>
</p>

<ul>
<li><a href="https://segmentfault.com/q/1010000005685904">知识补充1: Patch方法和PUT的区别</a></li>
</ul>

<p>PATCH方法是新引入的，是对PUT方法的补充，用来对已知资源进行局部更新, 这句话我们该如何理解？</p>

<p>场景: 假设我们有一个UserInfo，里面有userId， userName， userGender等10个字段。可你的编辑功能因为需求，在某个特别的页面里只能修改userName，这时候的更新怎么做？</p>

<p>使用patch方法, 只传一个userName到指定资源去，表示该请求是一个局部更新，后端仅更新接收到的字段;
使用put方法,要求前端提供的一定是一个完整的资源对象，如果没有提供完整的UserInfo, 接口会抛出异常;</p>

<p>测试:
<p class="hassubimage"><img src="http://iwillb.imdancer.com/15040760497071.jpg"></p>
</p>

<p>不出所料:
<p class="hassubimage"><img src="http://iwillb.imdancer.com/15040760706408.jpg"></p>
</p>

<ul>
<li><a href="http://www.cnblogs.com/machao/p/5788425.html">知识补充2: HEAD方法和OPTIIONS方法的区别</a></li>
</ul>

<p>HEAD方法和GET方法一致，除了服务器不能在响应里返回消息主体。HEAD请求响应里HTTP头域里的元信息应该和GET请求响应里的元信息一致。此方法被用来获取请求实体的元信息而不需要传输实体主体（entity-body）。此方法经常被用来测试超文本链接的有效性，可访问性，和最近的改变;</p>

<p>OPTIONS方法表明请求想得到请求/响应链上关于此请求里的URI（Request-URI）指定资源的通信选项信息。此方法允许客户端去判定请求资源的选项和/或需求，或者服务器的能力，而不需要利用一个资源动作（译注：使用POST，PUT，DELETE方法）或一个资源获取（译注：用GET方法）方法; 比如, 有一个字段choices, 使用OPTIONS方法可以返回choices的详细信息, 如果用GET的话只能看到简介信息;   </p>

<h2>4.9 小结</h2>

<p>我们已经为我们的Web API创建了相当细粒度的权限控制和相应的系统用户</p>

<h1>5. 关系和超链接-Relationsships and hyperlinked APIS</h1>

<p>本教程到目前为止，API 中各实体的关联都是通过主键处理的。为提高易用性，实现用超链接来表示关联;</p>

<h2>5.1 创建一个api_root视图</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># snippets/views.py</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.reverse</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">api_root</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
        <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;user-list&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">),</span>
        <span class="s1">&#39;snippets&#39;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;snippet-list&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>
    <span class="p">})</span>

<span class="c1"># snippets/urls.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">使用reverse根据url名称反向解析出完成的URL, 在urls.py文件中写明URL patterns的name后才可以这么使用</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">rest_framework.urlpatterns</span> <span class="kn">import</span> <span class="n">format_suffix_patterns</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-list&#39;</span><span class="p">),</span> <span class="c1"># 命名</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">),</span> <span class="c1"># 命名</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-list&#39;</span><span class="p">),</span> <span class="c1"># 命名 </span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-detail&#39;</span><span class="p">),</span> <span class="c1"># 命名</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">api_root</span><span class="p">),</span>  <span class="c1"># add</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/highlight/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetHighlight</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>  <span class="c1"># add</span>
<span class="p">]</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">(</span><span class="n">urlpatterns</span><span class="p">)</span>
</pre></div>
</div>
<h2>5.2 创建一个高亮代码段视图-Creating an endpoint for the highlighted snippets</h2>

<p>Snippet.highlighted 属性值是该代码段的高亮表示的 HTML 代码，因此我们不想让其 API 返回的是 JSON 格式，而要 HTML 格式;</p>

<p>REST 框架处理 HTML 格式有两种方式，一种是通过模板来呈现 HTML，另一种是处理预编码了的 HTML 代码。为方便测试, 本API采用第二种方式;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 回过头来查看models.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">我们重写了save方法, 将POST的数据提前转化为了HTML格式存储在highlighted字段</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">class</span> <span class="nc">Snippet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">linenos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STYLE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;friendly&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;auth.User&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">highlighted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the `pygments` library to create a highlighted HTML</span>
<span class="sd">        representation of the code snippet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">get_lexer_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">linenos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linenos</span> <span class="ow">and</span> <span class="s1">&#39;table&#39;</span> <span class="ow">or</span> <span class="bp">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">}</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">HtmlFormatter</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="n">linenos</span><span class="p">,</span>
                                  <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlighted</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Snippet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,)</span>
</pre></div>
</div>
<p>由于 Snippet.highlighted 是一个实例的属性，不是一个数据模型的实例，故没有现存的通用视图可以采用，只能使用 generics.GenericAPIView，然后实现 .get();    </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">我们重写get方法, 获取snippet对象, 并将snippet.highlighted内容经过renderer_classes模板渲染之后返回;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">renderers</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="k">class</span> <span class="nc">SnippetHighlight</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">renderer_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">renderers</span><span class="o">.</span><span class="n">StaticHTMLRenderer</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">snippet</span><span class="o">.</span><span class="n">highlighted</span><span class="p">)</span>
        
<span class="c1"># renderer_classes</span>
<span class="err">用来指明用那种方式返回数据</span><span class="p">,</span> <span class="n">renderers</span><span class="o">.</span><span class="n">StaticHTMLRenderer</span><span class="err">表明是用静态模板的方式返回给</span><span class="n">client</span><span class="p">;</span>
<span class="err">若注释这行代码</span><span class="p">,</span> <span class="err">则</span><span class="n">snippet</span><span class="o">.</span><span class="n">highlighted</span><span class="err">做为字符串返回到网页</span><span class="p">;</span>
</pre></div>
</div>
<p>添加 URL:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">api_root</span><span class="p">),</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/highlight/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetHighlight</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</pre></div>
</div>
<h2>5.3 超链接关联-Hyperlinking our API</h2>

<p>正确处理各实体间的关联性是 Web API 设计工作中的难点。一般可用以下几种方法来表示关联性：</p>

<ol>
<li>使用主键</li>
<li>实体间使用超链接</li>
<li>使用关联实体上的一个唯一标识的 slug 域</li>
<li>使用关联实体的默认字符串表示</li>
<li>将关联的实体放在父实体内</li>
<li>其它自定义方式</li>
</ol>

<p>REST 框架支持所有这些方法来表示关联。本例采用超链接来表示实体间的关联性。实现方法是将 SnippetSerializer 的基类从 ModelSerializer 改为 HyperlinkedModelSerializer;</p>

<p>HyperlinkedModelSerializer 与 ModelSerializer 的区别有：</p>

<ol>
<li>它默认不包含 id 项</li>
<li>它包含有 url 项，类型为 HyperlinkedIdentityField</li>
<li>关联性不使用 PrimaryKeyRelatedField，而用 HyperlinkedIdentityField 实现</li>
</ol>

<p>重构 Serializer 以实现超链接关联</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SnippetSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ReadOnlyField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;owner.username&#39;</span><span class="p">)</span>
    <span class="n">highlight</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedIdentityField</span><span class="p">(</span><span class="n">view_name</span><span class="o">=</span><span class="s1">&#39;snippet-highlight&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Snippet</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;highlight&#39;</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;linenos&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="n">snippets</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedRelatedField</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">view_name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;snippets&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul>
<li>How to Use HyperlinkedModelSerializer</li>
</ul>

<p>由于使用了 HyperlinkedModelSerializer，故默认不会包含 id 项，同时定义了一个新的 url 项;</p>

<p>HyperlinkedIdentityField 中的 view_name 参数指定了该超链接项的 URL，其值通过 reverse() 函数解析，因此这里用到的 snippet-detail, snippet-highlight 等 URL 名都必须在 urls.py 中定义;</p>

<p>对于数据模型的 Serializer，其默认的 url 项对应的 HyperlinkedIdentityField 的 view_name 值为 数据模型名-detail，例如 SnippetSerializer 对应 snippet-detail;</p>

<p>由上面的使用情况可看出，HyperlinkedIdentityField 的 view_name 参数对应的视图，都接收一个 pk 参数，以指出针对的是哪个具体的数据实例, 例如:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 注意: 若使用超链接, 需要为对应的URL提供一个name, 格式为, 数据模型名-detail</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>由于 URL 中都已加入了格式后缀，因此在 highlight 项定义中通过 format=&#39;html&#39; 限制该超链接返回的是 HTML 格式;</p>

<h2>5.4 命名 URL</h2>

<p>最终URL表现为</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">rest_framework.urlpatterns</span> <span class="kn">import</span> <span class="n">format_suffix_patterns</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="c1"># API endpoints</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">([</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">api_root</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">SnippetList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">SnippetDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/highlight/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">SnippetHighlight</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-highlight&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">UserList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">UserDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-detail&#39;</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Login and logout views for the browsable API</span>
<span class="n">urlpatterns</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^api-auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;rest_framework.urls&#39;</span><span class="p">,</span>
                               <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;rest_framework&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
<h2>5.5 添加分页</h2>

<p><a href="http://www.django-rest-framework.org/api-guide/pagination/">分页官方文档</a></p>

<h3>5.5.1 默认分页</h3>

<p>Django restframwork 的分页源代码结构如下:</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15041536935058.jpg"></p>
</p>

<p>我们可以看出, RF默认为我们提供了3中分页方式:</p>

<ol>
<li>PageNumberPagination</li>
<li>LimitOffsetPagination</li>
<li>CursorPagination</li>
</ol>

<p>默认情况下是<code>PageNumberPagination</code>的方式, 我们可以在settings.py文件中更改RF的默认分页方式:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;rest_framework.pagination.LimitOffsetPagination&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PAGE_SIZE&#39;</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</div>
<p>我么可以使用自定义的分页类代替默认的分页类: 实现动态分页数据大小限定</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 指明默认的分页大小, 并设定最大的分页大小</span>
<span class="k">class</span> <span class="nc">LargeResultsSetPagination</span><span class="p">(</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># 默认值</span>
    <span class="n">page_size_query_param</span> <span class="o">=</span> <span class="s1">&#39;page_size&#39;</span>
    <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">10000</span> <span class="c1"># 最大值</span>

<span class="k">class</span> <span class="nc">StandardResultsSetPagination</span><span class="p">(</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">page_size_query_param</span> <span class="o">=</span> <span class="s1">&#39;page_size&#39;</span>
    <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">1000</span>
    
<span class="c1"># 代替默认的分页类, For example:</span>
<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;apps.core.pagination.StandardResultsSetPagination&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>我们也可以在特定的views中添加pagination_class使用特定的分页类:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BillingRecordsView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Billing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BillingRecordsSerializer</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">LargeResultsSetPagination</span>
</pre></div>
</div>
<h3>5.5.2 DRF默认分页器详解</h3>

<ul>
<li>PageNumberPagination: 这种分页方式接受一个数字页码在请求查询参数</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 例子</span>
<span class="n">GET</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">api</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">accounts</span><span class="o">/</span><span class="err">?</span><span class="n">page</span><span class="o">=</span><span class="mi">4</span>
<span class="c1"># 结果</span>
<span class="n">HTTP</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="p">{</span>
    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1023</span>
    <span class="s2">&quot;next&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.example.org/accounts/?page=5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;previous&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.example.org/accounts/?page=3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
       <span class="err">…</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code>GenericAPIView子类</code>都可以设置<code>pagination_class属性</code>来设定分页器;</p>

<p><code>PageNumberPagination类</code>包含了一些属性，可以重写修改分页样式:</p>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th>属性名称</th>
<th>属性描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>django<em>paginator</em>class</td>
<td>Django页面类的使用。默认值是django.core.paginator.paginator这应该是好的，大多数情况下</td>
</tr>
<tr>
<td>page_size</td>
<td>一个数字值表示页面大小。如果设置，这将重写page<em>size设置默认设置为相同的值PAGE</em>SIZE设置键</td>
</tr>
<tr>
<td>page<em>query</em>param</td>
<td>一个字符串值，表示使用分页控件的查询参数的名称</td>
</tr>
<tr>
<td>page<em>size</em>query_param</td>
<td>如果设置，这是一个字符串值指示一个查询参数，允许客户端设置页面大小基于每个请求的名称。默认值为无，说明客户可能无法控制请求的页大小</td>
</tr>
<tr>
<td>max<em>page</em>size</td>
<td>如果设置，这是一个数字值表示的最大允许请求的页大小。这个属性只有如果page<em>size</em>query_param也是集</td>
</tr>
<tr>
<td>last<em>page</em>strings</td>
<td>一个列表的字符串值指示值可以用page<em>query</em>param集合中的最后一页的请求。默认值为(&#39;last&#39;,)</td>
</tr>
<tr>
<td>template</td>
<td>使用渲染时分页的控件在浏览器API模板的名称。可以重写修改渲染风格，或设置无禁用HTML分页的控件完全。默认值为<q>rest_framework/pagination/numbers.html</q></td>
</tr>
</tbody>
</table></div>
<p>默认<code>PageNumberPagination类</code>是使用settings.py文件中设定的默认值, 我们需要指定分页器, 然后在分页器中重写上述属性(PS: 不能直接写在视图类里面)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">ListRetrieveViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows users to be viewed or edited.</span>

<span class="sd">    User基本信息viewset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">(</span><span class="n">DjangoFilterBackend</span><span class="p">,)</span>
    <span class="n">filter_fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAdminUser</span><span class="p">]</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">LargeResultsSetPagination</span>
    <span class="c1"># page_size = 1</span>
    <span class="c1"># page_size_query_param = &#39;page_size&#39;</span>
    <span class="c1"># max_page_size = 2</span>
</pre></div>
</div>
<ul>
<li>LimitOffsetPagination</li>
</ul>

<p>这种分页方式常被用于获取数据的多条记录, client端请求中包含2个参数(offset和limit), offset指明位置, limit表示相对于offset位置向后获取的条目数量, 例如:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">api</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">accounts</span><span class="o">/</span><span class="err">?</span><span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="o">&amp;</span><span class="n">offset</span><span class="o">=</span><span class="mi">400</span>

<span class="c1"># return</span>
<span class="n">HTTP</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="p">{</span>
    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1023</span>
    <span class="s2">&quot;next&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.example.org/accounts/?limit=100&amp;offset=500&quot;</span><span class="p">,</span>
    <span class="s2">&quot;previous&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.example.org/accounts/?limit=100&amp;offset=300&quot;</span><span class="p">,</span>
    <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
       <span class="err">…</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>若全局开启LimitOffsetPagination</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;rest_framework.pagination.LimitOffsetPagination&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>LimitOffsetPagination属性</p>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th>属性名称</th>
<th>属性描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>default_limit</td>
<td>int, 默认获取条目数量</td>
</tr>
<tr>
<td>limit<em>query</em>param</td>
<td>str, 查询参数的名称, 默认为limit</td>
</tr>
<tr>
<td>offset<em>query</em>param</td>
<td>str, 查询参数的名称, 默认为offset</td>
</tr>
<tr>
<td>max_limit</td>
<td>int, 设定返回数据的最大值, 默认None</td>
</tr>
<tr>
<td>template</td>
<td>str, 渲染时分页控件的名称, 可以重写渲染风格, 或者设定为None禁用HTML分页的空间, 默认值为<q>rest_framework/pagination/numbers.html</q></td>
</tr>
</tbody>
</table></div>
<p>重写方式: (和PageNumberPagination类似)</p>

<ul>
<li>CursorPagination</li>
</ul>

<p>基于指针的分页, client可以使用浏览结果集; 这种分页方式提出了正向和反向控制, 而不允许用户导航到任意位置;</p>

<p><a href="http://www.django-rest-framework.org/api-guide/pagination/">详情请参考</a></p>

<h3>5.5.3 自定义分页器-Custom pagination styles</h3>

<p>创建一个自定义分页的序列化类, 应该继承pagination.BasePagination并重写paginate<em>queryset(self, queryset, request, view=None)和get</em>paginated_response(self, data)方法:</p>

<ul>
<li><p><code>paginate_queryset</code>方法是通过初始查询应该返回一个迭代器对象只包含在请求的页面数据</p></li>
<li><p><code>get_paginated_response</code>方法通过序列化的页面数据并返回一个响应实例</p></li>
</ul>

<p>注意，paginate_queryset方法可以在分页实例设置状态，以后可能被<code>get_paginated_response</code>方法使用;</p>

<ul>
<li>例子</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CustomPagination</span><span class="p">(</span><span class="n">pagination</span><span class="o">.</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_paginated_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
            <span class="s1">&#39;links&#39;</span><span class="p">:</span> <span class="p">{</span>
               <span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_link</span><span class="p">(),</span>
               <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_link</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">data</span>
        <span class="p">})</span>
</pre></div>
</div>
<p>若设置默认</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;my_project.apps.core.pagination.CustomPagination&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PAGE_SIZE&#39;</span><span class="p">:</span> <span class="mi">100</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>5.5.4 HTML分页控件-HTML pagination controls</h3>

<p>DRF浏览器API上的分页空间模板</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">rest_framework</span><span class="o">/</span><span class="n">pagination</span><span class="o">/</span><span class="n">numbers</span><span class="o">.</span><span class="n">html</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">rest_framework</span><span class="o">/</span><span class="n">pagination</span><span class="o">/</span><span class="n">previous_and_next</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>我们也可以重写这渲染的模板, 然后在自定义的分页器中指定<code>template =</code>, 最后在视图中使用该分页器;</p>

<h2>5.6 分页与置顶小结</h2>

<p>在工作中我们往往会有这种需求, 将搜索结果中的具有某些特性的结果置顶, 然后再根据结果分页; 在未使用RESTframwork前, 我要实现这个需求, 得先去获取需要置顶的数据条目数量, 然后根据limit和page去实现一个计算逻辑去匹配在每一页显示具体的内容, 真是****;</p>

<p>其实置顶功能就是order(排序)功能, 我先根据产品经理给的需求(例如: 认证的车店信息放到最前面显示checked=1), 那我只需要order<em>by(checked, -create</em>time), 默认是从小到大排序, 在参数面前加一个<code>-</code>符号, 表示反向, 也就是重大到小排序;</p>

<h2>5.7 小结</h2>

<p>此时,我们能通过超链接的地址在关联信息的接口中跳转; 并且能看到HTML格式的高亮代码段;</p>

<h1>6. 视图和路由-ViewSets and routers</h1>

<p>REST 框架中的 ViewSet 非常类似 View，它基于一些常用约定，实现了 list, create, retrieve, update, partial_update, destroy 等方法;</p>

<p>ViewSet 在最后的实例化时，才会将 list, create 等方法绑定到 get, post, put, patch, delete 等 REST 操作对应的处理函数（通常由 Router 创建 URL 定义时自动绑定），最后绑定到 model-list, model-create, model-detail 等 URL; (个人理解: 也就是说Router其实是用来将restful请求动作绑定到对应的处理函数, 例如: get请求绑定list方法)</p>

<h2>6.1 使用 ViewSet 进行重构</h2>

<h3>6.1.1 合并UserList 和 UserDetail</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ReadOnlyModelViewSet 实现了只读的操作，如 list, detail 等</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>

<span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ReadOnlyModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This viewset automatically provides `list` and `detail` actions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</pre></div>
</div>
<h3>6.1.2 合并SnippetList,SnippetDetail,SnippetHighlight</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">detail_route</span>

<span class="k">class</span> <span class="nc">SnippetViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This viewset automatically provides `list`, `create`, `retrieve`,</span>
<span class="sd">    `update` and `destroy` actions.</span>

<span class="sd">    Additionally we also provide an extra `highlight` action.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span>
                          <span class="n">IsOwnerOrReadOnly</span><span class="p">,)</span>

    <span class="nd">@detail_route</span><span class="p">(</span><span class="n">renderer_classes</span><span class="o">=</span><span class="p">[</span><span class="n">renderers</span><span class="o">.</span><span class="n">StaticHTMLRenderer</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">highlight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">snippet</span><span class="o">.</span><span class="n">highlighted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>这里使用了 ModelViewSet，从而实现了默认的读写操作方法;</p>

<p>要实现一个自定义的操作，比如 highlight，需要为其定义一个方法，并且加上装饰器 @detail_route。该装饰器可用在所有非标准 create/update/delete 风格的自定义 API 上;</p>

<p>使用了 @detail<em>route 的自定义方法的 API 默认只响应 GET 请求，如果要响应 POST 等请求，需要在装饰器的 methods 参数中指定。自定义方法的 API，其 URL 默认就是函数名本身，如 highlight，要想修改，需要在 @detail</em>route 装饰器的 url_path 参数中指定;</p>

<h2>6.2 手动绑定请求和响应方法</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 合并之后的视图, 例如: SnippetViewSet提供list和create方法, as_view的作用就是绑定`请求的方法`到`对应的视图处理方法`</span>

<span class="kn">from</span> <span class="nn">snippets.views</span> <span class="kn">import</span> <span class="n">SnippetViewSet</span><span class="p">,</span> <span class="n">UserViewSet</span><span class="p">,</span> <span class="n">api_root</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">renderers</span>

<span class="n">snippet_list</span> <span class="o">=</span> <span class="n">SnippetViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span>
    <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="s1">&#39;create&#39;</span>
<span class="p">})</span>
<span class="n">snippet_detail</span> <span class="o">=</span> <span class="n">SnippetViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;retrieve&#39;</span><span class="p">,</span>
    <span class="s1">&#39;put&#39;</span><span class="p">:</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
    <span class="s1">&#39;patch&#39;</span><span class="p">:</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span>
    <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="s1">&#39;destroy&#39;</span>
<span class="p">})</span>
<span class="n">snippet_highlight</span> <span class="o">=</span> <span class="n">SnippetViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;highlight&#39;</span>
<span class="p">},</span> <span class="n">renderer_classes</span><span class="o">=</span><span class="p">[</span><span class="n">renderers</span><span class="o">.</span><span class="n">StaticHTMLRenderer</span><span class="p">])</span>
<span class="n">user_list</span> <span class="o">=</span> <span class="n">UserViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;list&#39;</span>
<span class="p">})</span>
<span class="n">user_detail</span> <span class="o">=</span> <span class="n">UserViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;retrieve&#39;</span>
<span class="p">})</span>

<span class="c1"># 访问URL, 根据不同的request请求方法找到对应的视图方法</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">([</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">api_root</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">snippet_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">snippet_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/highlight/$&#39;</span><span class="p">,</span> <span class="n">snippet_highlight</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-highlight&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/$&#39;</span><span class="p">,</span> <span class="n">user_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">user_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-detail&#39;</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
<p>现在，系统应该能和之前一样正常运行;</p>

<h2>6.3 更进一步,使用ViewSet重构URL</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>
<span class="kn">from</span> <span class="nn">rest_framework.routers</span> <span class="kn">import</span> <span class="n">DefaultRouter</span>

<span class="c1"># Create a router and register our viewsets with it.</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetViewSet</span><span class="p">)</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserViewSet</span><span class="p">)</span>

<span class="c1"># The API URLs are now determined automatically by the router.</span>
<span class="c1"># Additionally, we include the login URLs for the browsable API.</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^api-auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;rest_framework.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;rest_framework&#39;</span><span class="p">))</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Router 还自动生成了 api<em>root，并为 URL 加上了后缀功能，从而无需定义 api</em>view 视图及使用 format<em>suffix</em>patterns 了;</p>

<h2>6.4 小结</h2>

<p>ViewSet将同一对象(例如: 用户)的多个动作(list/create/retrieve/update/partial_update/destroy)封装到一个视图函数中处理; Router则在URL层面对RESTful的method和视图提供的功能进行了绑定操作;</p>

<p>有什么好处呢?</p>

<p>这样做大大简化了代码实现. 加入我们需要提供一个用户接口, 提供对用户这个对象的(增/删/改/查/部分更新)支持, 那么我们得写5个views视图; 当我们使用ViewSet之后呢? 只需要为每一个操作对象写一个视图类, 我们需要提供的功能(增/删/改/查/部分更新)都被抽象成了类, 我们只需要mixin继承即可, 完美!</p>

<p>个人想法, 先用ViewSet和router实现接口-遇到个性化需求则重写父类方法-实在没有办法了才能放弃更通用的方式,把视图函数拆开来做(但是十分不建议, 这样会导致项目越来越高的复杂度, 最终无法控制...);</p>

<h1>7. 结构和客户端库-Schemas and client libraries</h1>

<p>一个 schema 就是一个机器可读的文档，它对可用的 API 端点进行描述，给出它们的 URL，以及支持的操作;</p>

<p>服务端可以生成 schema 文档，而客户端可以基于该 schema 文档，与服务端交互;</p>

<h2>7.1 接口结构-Core API</h2>

<p>REST 框架通过 Core API 提供 schema 支持</p>

<p>Core API 是一种用于描述 API 的文档标准。在服务端，通过 Core API 可以将 API 呈现成各种支持的 schema 或超媒体格式文件。而在客户端，在获取服务端生成的 schema 文件后，可以与服务端进行交互;</p>

<h2>7.2 为服务端提供 schema 支持</h2>

<p>REST 框架即支持手动定义 schema 视图，也支持自动生成 schema。因我们使用了 ViewSet 和 Router，故采用自动生成 schema 方式;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># snippets/urls.py</span>

<span class="kn">from</span> <span class="nn">rest_framework.schemas</span> <span class="kn">import</span> <span class="n">get_schema_view</span>

<span class="n">schema_view</span> <span class="o">=</span> <span class="n">get_schema_view</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Pastebin API&#39;</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^schema/$&#39;</span><span class="p">,</span> <span class="n">schema_view</span><span class="p">),</span>
    <span class="c1">#...</span>
<span class="p">]</span>
</pre></div>
</div>
<p>浏览器上查看</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15041707925906.jpg"></p>
</p>

<p>命令行查看</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">➜</span>  <span class="o">~</span> <span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">schema</span><span class="o">/</span> <span class="n">Accept</span><span class="p">:</span><span class="n">application</span><span class="o">/</span><span class="n">coreapi</span><span class="o">+</span><span class="n">json</span>

<span class="c1"># 返回</span>
<span class="p">{</span>
    <span class="s2">&quot;_meta&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Pastebin API&quot;</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:8000/schema/&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;document&quot;</span><span class="p">,</span>
   <span class="o">....</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>7.3 命令行客户端-coreapi-cli</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">coreapi</span><span class="o">-</span><span class="n">cli</span>
</pre></div>
</div>
<p><a href="http://www.django-rest-framework.org/tutorial/7-schemas-and-client-libraries/">详情请参考</a></p>

<p>测试了一波发现不是很好用, 另找了一个<a href="https://github.com/core-api/python-client">python版的coreapi-cli</a>有需要的可以试用下;</p>

<h1>8. Django REST framework最佳实践</h1>

<p><a href="https://segmentfault.com/a/1190000004399682">参考链接</a></p>

<p>作为基础架构设计者, 需要考虑那些问题呢?</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">*</span> <span class="mf">1.</span> <span class="err">统一的异常处理</span>
<span class="o">*</span> <span class="mf">2.</span> <span class="err">统一的权限系统</span>
<span class="o">*</span> <span class="mf">3.</span> <span class="err">统一的认证系统</span>
<span class="o">*</span> <span class="mf">3.</span> <span class="err">统一的参数校验</span>
<span class="o">*</span> <span class="mf">5.</span> <span class="err">认证</span>
<span class="o">*</span> <span class="mf">6.</span> <span class="err">统一的查询过滤</span>
<span class="o">*</span> <span class="mf">7.</span> <span class="err">代码分层</span><span class="p">,</span> <span class="err">例如</span><span class="p">:</span> <span class="err">常规的</span><span class="n">m</span> <span class="n">s</span> <span class="n">v</span> <span class="n">c</span><span class="err">模型下</span><span class="p">,</span> <span class="err">再按照功能模块去分</span>
<span class="o">*</span> <span class="mf">8.</span> <span class="err">统一好用的存储层</span>
<span class="o">*</span> <span class="mf">9.</span> <span class="err">缓存如何可以做的更简单统一</span>
</pre></div>
</div>
<h2>8.1 restfulAPI的基础套路</h2>

<ol>
<li>继承某个GenericView,重写里面的某个方法，最大的是get、post、put、patch、delete这些方法，然而并不推荐（应该重写mixin里面的方法）</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CoursesView</span><span class="p">(</span><span class="n">ListCreateAPIView</span><span class="p">):</span>

    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">(</span><span class="n">SchoolPermissionFilterBackend</span><span class="p">,</span> <span class="n">filters</span><span class="o">.</span><span class="n">DjangoFilterBackend</span><span class="p">,</span> <span class="n">filters</span><span class="o">.</span><span class="n">SearchFilter</span><span class="p">)</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticated</span><span class="p">,</span> <span class="n">ModulePermission</span><span class="p">)</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
    <span class="n">filter_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">,)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="s1">&#39;school__name&#39;</span><span class="p">)</span>
    <span class="n">module_perms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;course.course&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CourseFullMessageSerializer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CourseSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;school&#39;</span><span class="p">,</span> <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">school__is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">term__is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
              
    <span class="nd">@POST</span><span class="p">(</span><span class="s1">&#39;school&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="s1">&#39;required&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">school</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SchoolPermissionFilterBackend</span><span class="p">()</span><span class="o">.</span><span class="n">has_school_permission</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">school</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">PermissionDenied</span><span class="p">,</span> <span class="n">err_message</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;没有对应学校的权限&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;没有对应学校的权限&#39;</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perform_create</span><span class="p">(</span><span class="n">serializer</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_success_headers</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">CourseFullMessageSerializer</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</pre></div>
</div>
<ol>
<li>实现一个serilizer，json化response</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CourseSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Course</span>
        <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">CourseFullMessageSerializer</span><span class="p">(</span><span class="n">CourseSerializer</span><span class="p">):</span>

    <span class="n">school</span> <span class="o">=</span> <span class="n">SchoolLittleMessageSerializer</span><span class="p">()</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;term.name&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<ol>
<li>写一个url, 返回JSON数据或者渲染到模板</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^courses/$&#39;</span><span class="p">,</span> <span class="n">CoursesView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;course-list&#39;</span><span class="p">),</span>
</pre></div>
</div>
<h2>8.2 序列化的数据关联嵌套</h2>

<h3>8.2.1 获取外键关联数据</h3>

<p>产生效果:  在原有数据基础上, 添加外键关系表的属性数据, 每一条数据都会添加这些数据; </p>

<ol>
<li>外键直接可以引用其他的serializer, 例如: 课程表/课程目录表(1对多关系)</li>
</ol>

<p>序列化的正向关联:  课程-课程目录为例子</p>

<p>课程有多个目录,  那么目录表上建一个外键名称为course关联到课程表, 表示该目录唯一属于某课程;</p>

<p>默认情况下, 我们查看课程目录表就只能看到目录的简略信息 and 课程ID; 若我们想在目录的API的每一个元素中都显示课程的详情信息, 那么我们在课程目录的序列化类中, 添加一个course=CourseSerializer(many=True)类属性; 当我们的Model中存在外键, 我们想查看外键所代表的详情信息, 我们可以直接嵌套对应的序列化类;</p>

<p>另一种情况, 当我想在课程信息中获取课程的目录详细, 同样我们需要添加类属性, 不过写法不太一样,  例如: Course and CourseDirectory,   我们可以在Course模型的序列化类中添加类属性, coursedirectory_set = CourseDirectorySerializer(many=true)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MiniCourseDirectorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;课程目录&quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CourseDirectory</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;chapter_name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;knowledges&#39;</span><span class="p">,</span> <span class="s1">&#39;quiz&#39;</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">class</span> <span class="nc">CourseDetailSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;课程详情数据: 获取外键关联的课程目录信息&quot;&quot;&quot;</span>
    <span class="n">coursedirectory_set</span> <span class="o">=</span> <span class="n">MiniCourseDirectorySerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># 多对对字段</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Course</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<ol>
<li>外键的属性可以使用source，例如phone</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">课程模块-序列化</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">accouting_app.models</span> <span class="kn">import</span> <span class="n">Course</span><span class="p">,</span> <span class="n">CourseDirectory</span>


<span class="k">class</span> <span class="nc">CourseSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;课程基础数据序列化&quot;&quot;&quot;</span>

    <span class="c1"># directory = CourseDirectorySerializer(many=True)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Course</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
        <span class="c1"># depth = 0</span>


<span class="k">class</span> <span class="nc">CourseDirectorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;课程目录数据序列化</span>

<span class="sd">    1. 外键直接可以引用其他的serializer, 例如: 课程目录有一个外键course</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># coursen = CourseSerializer()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;course.title&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">course_desc</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;course.description&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CourseDirectory</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># exclude = (&#39;course&#39;,)</span>

    <span class="k">def</span> <span class="nf">get_other</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;xxxx&quot;</span>


<span class="k">class</span> <span class="nc">MiniCourseDirectorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CourseDirectory</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;chapter_name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;knowledges&#39;</span><span class="p">,</span> <span class="s1">&#39;quiz&#39;</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">CourseDetailSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;课程详情数据, 合并相关的表&quot;&quot;&quot;</span>
    <span class="n">coursedirectory_set</span> <span class="o">=</span> <span class="n">MiniCourseDirectorySerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Course</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<h3>8.2.2 get_xxx方法用于添加模型类中不存在的字段,或修改已有字段</h3>

<p>get_other方法用于在原有的序列化类里面添加额外的字段, 或者修改现有字段; 它需要与SerializerMethodField()配合使用;</p>

<p>一个很常见的使用场景: 用户页面需要获取用户的一些汇总信息(例如,各种聚合数据, 这些额外属性往往会被存储到缓存中), 如果我要通过模型序列化的方式返回数据, 那么我们就可以用 `get_字段()方法, 搭配SerializerMethodField()使用;</p>

<h3>8.2.3 使用ModelViewSet+TemplateHTMLRenderer服务端渲染模板</h3>

<p>ModelViewSet修改renderer_classes, 服务端渲染模板, 不推荐直接重写list方法, 推荐重写mixin中的方法:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CourseDirectoryPageViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ReadOnlyModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    课程目录Page: 服务端渲染</span>

<span class="sd">    课程目录页面, 包含课程描述,目录信息,知识点/测试题的ID和Name</span>
<span class="sd">    隐含规则: for循环每一个知识点, 获取知识点对应的测试放到知识点元素之后, 依次类推</span>
<span class="sd">    另外, 获取本章节的测试题信息放到末尾, 格式化为最终的列表, 并渲染到网页端</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticated</span><span class="p">,)</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">(</span><span class="n">DjangoFilterBackend</span><span class="p">,)</span>
    <span class="n">filter_fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">LargeResultsSetPagination</span>
    <span class="n">renderer_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">TemplateHTMLRenderer</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;自定义权限&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">permission</span><span class="p">()</span> <span class="k">for</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">permission_classes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;课程list页面使用: CourseSerializer; 渲染到: course_list_page.html&quot;&quot;&quot;</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CourseSerializer</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">serializer_class</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;course&#39;</span><span class="p">:</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;accouting_app/course/course_list_page.html&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;课程目录页面使用: CourseDirectoryContentSerializer; 渲染到: course_directory.html&quot;&quot;&quot;</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">CourseDirectoryContentSerializer</span><span class="p">(</span><span class="n">course</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;course&#39;</span><span class="p">:</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;accouting_app/course/course_directory_page.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<h3>8.2.4 如何写一个嵌套结构的序列化类</h3>

<p>在ModelSerializer中嵌套其他Serializer.Serializer的类实例</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GradeDataSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    坡度信息(上坡、下坡、平路、最大高程、平均高程)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">udis</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">udur</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">...</span>
    
<span class="k">class</span> <span class="nc">WorkoutUploadSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    轨迹上传序列化</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">equipment_data_source</span> <span class="o">=</span> <span class="n">EquipmentDataSourceSerializer</span><span class="p">()</span>
    <span class="n">grade_data</span> <span class="o">=</span> <span class="n">GradeDataSerializer</span><span class="p">()</span>
    <span class="o">....</span>
</pre></div>
</div>
<h2>8.3 Django REST framework的各种技巧——3.权限</h2>

<p><a href="https://segmentfault.com/a/1190000004400312#articleHeader5">参考文档</a></p>

<h3>8.3.0 权限基础</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">rest</span><span class="err">框架已经提供的权限类：</span>

<span class="n">AllowAny</span>

<span class="err">此权限将允许用户的任何访问，与没有设置的效果一样。</span>

<span class="n">IsAuthenticated</span>

<span class="err">如果你使用的是</span><span class="n">django</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="err">，或扩展自该类，那么这个还是很适合使用的。在</span><span class="n">views</span><span class="err">中使用</span><span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span><span class="err">就可以进行授权了。</span>

<span class="n">IsAdminUser</span>

<span class="err">如果</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="err">，那么用户的操作就会被允许，否则被拒绝。所以这个能够做到特定用户的访问权限控制。当然，也要使用</span><span class="n">django</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="err">类才行。</span>

<span class="n">IsAuthenticatedOrReadOnly</span>

<span class="err">如果已经授权，或只是执行只读操作，那么将会被允许。</span>

<span class="err">只读操作包括：</span><span class="n">GET</span><span class="p">,</span><span class="n">HEAD</span><span class="p">,</span><span class="n">OPTIONS</span>

<span class="n">DjangoModelPermissions</span>

<span class="n">DjangoModelPermissionsOrAnonReadOnly</span>

<span class="n">DjangoObjectPermissions</span>

<span class="err">自定义权限</span>

<span class="err">自定义权限类可以继承自上面的所有的类，但是最好还是继承自</span><span class="n">BasePermission</span><span class="p">,</span><span class="err">重写两个方法：</span>

<span class="n">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span><span class="err">：</span>

<span class="err">这个是</span><span class="n">views</span><span class="err">范围的权限</span>

<span class="n">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span><span class="err">：</span>

<span class="err">这个是对象范围的权限，通常用于验证对象是否属于提交的用户</span>

<span class="err">例如下面的例子：</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>

<span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># Read permissions are allowed to any request,</span>
        <span class="c1"># so we&#39;ll always allow GET, HEAD or OPTIONS requests.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
<span class="n">w</span>
<span class="err">在用户提交博客的时候，上面的</span><span class="n">has_permission</span><span class="err">方法就会起作用，如果没有登录，那么会返回</span><span class="bp">False</span><span class="err">，拒绝提交。</span>

<span class="err">而</span><span class="n">has_object_permission</span><span class="err">在用户修改，删除博客的时候会起作用，如果修改的博客不属于该用户，那么会被拒绝</span>
</pre></div>
</div>
<h3>8.3.1 用户是否有访问某个api的权限</h3>

<p>例如: 需要登录才能访问</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticated</span><span class="p">,)</span>
</pre></div>
</div>
<p>若需要自定义权限可以仿照IsAuthenticated重写API所需要的权限</p>

<h3>8.3.2 用户对于相同api的不同权限看到不同的数据（其实一个filter）</h3>

<p>这个需求很普遍, 例如: 后台管理员系统中, 普通管理员和超级管理员账号登录后看到不同的界面;</p>

<p>重写get<em>queryset 或者 filter</em>queryset;</p>

<h3>8.3.3 不同权限用户对于api的访问频次，其他限制等等</h3>

<p><a href="http://www.django-rest-framework.org/api-guide/throttling/">官方文档-节流</a></p>

<p>可以设定不同权限的用户有不同的访问频次;</p>

<p>可以支持: 
全局
API级别
自定义方式</p>

<h3>8.3.4 假删除，各种级联假删除</h3>

<p>需求是这样的：</p>

<ol>
<li>如果没有其他东西对他有外键，则直接可以删</li>
<li>如果其他东西对他有了外键，则需要给提示（用户确定后可以删除）</li>
<li>首先看实现 注意继承顺序一定不能错！！！</li>
</ol>

<p>注意继承顺序一定不能错:</p>

<ol>
<li>UnActiveModelMixin对应假删除</li>
<li>DeleteForeignObjectRelModelMixin对应外键检查</li>
<li>RetrieveUpdateDestroyAPIView是默认的rest的view，提供delete支持，主要是需要xxxDestroyAPIView</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UnActiveModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    删除一个对象，并不真删除，级联将对应外键对象的is_active设置为false，需要外键对象都有is_active字段.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">perform_destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">rel_fileds</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ForeignObjectRel</span><span class="p">)]</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">rel_fileds</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="n">manager</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">manager</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="n">ForeignObjectRelDeleteError</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;{} 上有关联数据&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">)</span>
                    <span class="n">manager</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FieldDoesNotExist</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> 
                    <span class="c1"># 理论上，级联删除的model上面应该也有is_active字段，否则代码逻辑应该有问题</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ModelDontHaveIsActiveFiled</span><span class="p">(</span>
                            <span class="s1">&#39;{}.{} 没有is_active字段, 请检查程序逻辑&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                                <span class="n">manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="p">))</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">DeleteForeignObjectRelModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;删除一个对象，如果他已有外键关联则抛出异常&#39;&#39;&#39;</span>
    <span class="nd">@POST_OR_GET</span><span class="p">(</span><span class="s1">&#39;force_delete&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">force_delete</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_delete</span><span class="p">:</span>
            <span class="n">rel_fileds</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ForeignObjectRel</span><span class="p">)]</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">rel_fileds</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="n">manager</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="p">:</span>
                    <span class="k">continue</span>      
                <span class="c1"># one to one</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ForeignObjectRelDeleteError</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;{} 上有关联数据&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">ForeignObjectRelDeleteError</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;{} 上有关联数据&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">FieldDoesNotExist</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">ForeignObjectRelDeleteError</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;{} 上有关联数据&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perform_destroy</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
</pre></div>
</div>
<h2>8.4 Django REST framework的各种技巧——4.Generic View</h2>

<p><a href="https://segmentfault.com/a/1190000004400540">4.Generic View</a></p>

<h2>8.5 Django REST framework的各种技巧——5.搜索</h2>

<p><a href="https://segmentfault.com/a/1190000004400863">5.搜索</a></p>

<h2>8.6 Django REST framework的各种技巧——6.异常处理</h2>

<p><a href="https://segmentfault.com/a/1190000004400960">6.异常处理</a></p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">six</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">PermissionDenied</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">exceptions</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.compat</span> <span class="kn">import</span> <span class="n">set_rollback</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">xingzhe_conf.constants</span> <span class="kn">import</span> <span class="n">WORKOUT_BUSINESS_STATE_CHOICES</span> <span class="k">as</span> <span class="n">BC</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">XResponseResult</span> <span class="k">as</span> <span class="n">XResult</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the response that should be used for any given exception.</span>

<span class="sd">    By default we handle the REST framework `APIException`, and also</span>
<span class="sd">    Django&#39;s built-in `Http404` and `PermissionDenied` exceptions.</span>

<span class="sd">    Any unhandled exceptions may return `None`, which will cause a 500 error</span>
<span class="sd">    to be raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#view = context.get(&#39;view&#39;)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">extra_data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;extra_data&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
    <span class="n">bcode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">extra_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="n">BC</span><span class="o">.</span><span class="n">failure</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">APIException</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;auth_header&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">auth_header</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;wait&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Retry-After&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exc</span><span class="o">.</span><span class="n">wait</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">XResult</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">bcode</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">default_detail</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">XResult</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">bcode</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">))</span>

        <span class="n">set_rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">Http404</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Not found.&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">XResult</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">bcode</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

        <span class="n">set_rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">PermissionDenied</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Permission denied.&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">XResult</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">bcode</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

        <span class="n">set_rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>
    
<span class="c1"># 在settings.py中加上 &#39;EXCEPTION_HANDLER&#39;: </span>
<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;api.exception_handler.custom_exception_handler&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>8.7 Django REST framework的各种技巧——7.导入导出</h2>

<p><a href="https://segmentfault.com/a/1190000004401099">7.导入导出</a></p>

<h1>9.工作中常用技巧</h1>

<h2>9.1 many=true</h2>

<p>场景: 有时候我们的数据结构是: [{}, {}, {}], 如何对这种数据格式进行序列化呢?</p>

<p>方法: 写其中单个{}的序列化器, 然后在使用的时候添加上many=true参数, 例如:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 序列化</span>
<span class="k">class</span> <span class="nc">SingleWorkoutDetailSegmentSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;轨迹详情时候需要的赛段信息格式为: [{}, {}], 此序列化表示{}里面部分&quot;&quot;&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">workout_id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>

<span class="c1"># 使用</span>
<span class="n">SingleWorkoutDetailSegmentSerializer</span><span class="p">(</span><span class="n">format_segments</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<h2>9.2 list<em>route 与 detail</em>route</h2>

<p>场景: 比如说get请求, 请求自己的数据与请求他人的数据(列表/详情)肯定是不一样的, 那么如何区分呢?</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">list_route</span><span class="p">,</span> <span class="n">detail_route</span>

<span class="n">my_serializer_class</span> <span class="o">=</span> <span class="n">MyWorkoutListSerialzier</span>
<span class="nd">@list_route</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">mine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; RESTFUL-API: 我的历史列表</span>

<span class="sd">        :param request:</span>
<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">())</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">backends</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_filter_backends</span><span class="p">)</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id</span><span class="p">(</span><span class="n">request</span><span class="p">),</span>
                                   <span class="n">deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span>
                                         <span class="n">klass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_serializer_class</span><span class="p">,</span>
                                         <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">XRes</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">BSC</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
<h2>9.3 filter_queryset</h2>

<p>场景: 请求我的历史记录,一些额外字段传递会对数据进行过滤, 例如, X年X月的历史记录; 内部还会有一些判断逻辑, 如果直接写判断逻辑到View里面, 就会显得很笨拙, 那么我们可以使用filter<em>queryset, 并且自己定义一个list</em>filter_backends过滤器, 将特定的判断逻辑放到参数过滤器中;</p>

<p>例子: 对上一个例子的补充</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">YYYYMMFilterBackend</span><span class="p">(</span><span class="n">BaseFilterBackend</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
            <span class="n">now_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">now_time</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span>
            <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span> <span class="k">if</span> <span class="n">month</span> <span class="k">else</span> <span class="n">month</span>

            <span class="c1"># 按年获取历史记录, 或者按某年的某月: 计算时间范围的时间戳格式</span>
            <span class="k">if</span> <span class="n">month</span> <span class="ow">and</span> <span class="n">year</span><span class="p">:</span>
                <span class="n">first_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">if</span> <span class="n">month</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">last_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="k">elif</span> <span class="n">year</span><span class="p">:</span>
                <span class="n">first_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">last_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>

            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">start_time__gte</span><span class="o">=</span><span class="n">first_day_unix</span><span class="p">,</span>
                <span class="n">start_time__lt</span><span class="o">=</span><span class="n">last_day_unix</span><span class="p">,</span>
            <span class="p">)</span>

<span class="n">list_filter_backends</span> <span class="o">=</span> <span class="p">(</span><span class="n">YYYYMMFilterBackend</span><span class="p">,</span> <span class="p">)</span>  <span class="c1"># 这里</span>
</pre></div>
</div>
<h2>9.4 get_serializer</h2>

<p>场景: 不同情境不同的序列化器, 有几种办法; 
    第一种, 根据不同的情况重写get<em>serializer</em>class方法;
    第二种, 使用get_serializer的kwargs扩展字段的方式;</p>

<p>方法1: 重写get<em>serializer</em>class</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;设定序列化器&quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span>
        <span class="n">session_user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">params_user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">session_user_id</span> <span class="ow">and</span> <span class="n">params_user_id</span> <span class="ow">and</span> <span class="n">session_user_id</span> <span class="o">==</span> <span class="n">params_user_id</span><span class="p">:</span>
                <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">OldSelfWorkoutListSerializer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">OldOtherUserWorkoutListSerializer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">WorkoutUploadSerializer</span>
        <span class="k">return</span> <span class="n">serializer_class</span>
</pre></div>
</div>
<p>方法2: 重写get_serializer</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Return the serializer instance that should be used for validating and</span>
<span class="sd">   deserializing input, and for serializing output.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">klass</span> <span class="o">=</span> <span class="bp">None</span>
   <span class="k">if</span> <span class="s1">&#39;klass&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
       <span class="n">klass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;klass&#39;</span><span class="p">)</span>
   <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">klass</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer_class</span><span class="p">()</span>
   <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer_context</span><span class="p">()</span>
   <span class="k">return</span> <span class="n">serializer_class</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
   
<span class="c1"># 在本文9.2的例子中, 获取序列化器的过程, 手动添加一个klass的参数</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span>
                                <span class="n">klass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_serializer_class</span><span class="p">,</span>
                                <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<h2>9.5 定义返回的数据结构</h2>

<p>包含3部分:</p>

<p>code
data
msg</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">XResponseResult</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
</pre></div>
</div>
<h2>9.6 序列化有效性判断</h2>

<p>场景: 我需要另外从外部系统中拿到数据, 多个系统之间, 或者第三方系统之间的数据传递, 如何判断有效性呢? 我们也可以使用序列化的方法: </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># 数据传递过来之后先进行有效性判断</span>
<span class="n">scs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UserStartCountSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span>
<span class="n">scs</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">scs</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<h1>10. 好用的第三方的包</h1>

<h2>10.1 复杂的权限控制</h2>

<p><a href="https://github.com/caxap/rest_condition">rest_condition</a></p>

    </div>
    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic green button">打赏 <i class="red heart icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">MORE WORDS</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer code">
            <span>© 1994 - 2018 willdx</span><b>@</b><a class="code" href="https://github.com/willdx/willdx.github.io">blog.willdx.me</a>
            <br/>
            <span class="notprint">
                <span id="busuanzi_container_site_pv">
                    <i class="eye icon"></i><span id="busuanzi_value_site_pv" class="orange text"></span> pv
                </span>
                <b> | </b>
                <span id="busuanzi_container_site_uv">
                    <i class="user icon"></i><span id="busuanzi_value_site_uv" class="orange text"></span> uv
                </span>
                <br/>
            </span>
            <span>Power by <i class="github alternate icon"></i><a href="https://github.com/willdx/willdx.github.io">Github Page</a></span>
            <br/>
            <i class="green superpowers icon"></i>
        </div>
    </body>
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="/assets/js/web.js"></script>
    <script>
        // 统计代码
        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68394485-1', 'auto');
        ga('send', 'pageview');

        var wrappers = ["cats-wrapper", "donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper"]

        window.onload = function () {
            useWechat();
        }
    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: 'de35601f0076c240632f',
        clientSecret: 'b44ba043a5af4818f53dc13d3b4e49b5a28a2a0c',
        repo: 'willdx.github.io',
        owner: 'willdx',
        admin: ['willdx'],
        id: 'django-rest-framework Tutorial',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: ['gitment'],
        pagerDirection: "last",
    })
      
    gitalk.render('comments')
    </script>


</html>