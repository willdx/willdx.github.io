<html>
    <head>
        <meta charset="utf-8">
        
    
        <title> HashiCorpå…¨å®¶æ¡¶-Nomad </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">


        <style type="text/css"> 
        </style>
    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: #fff;">ä¸»é¢˜é€‰æ‹©</span></h3>
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr class="sk-mo" onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">å¢¨</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-green" onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">ç»¿</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-default" onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">é’</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-orange" onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">æ©˜</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">æ³¢å¦</div>
                                <div class="time">2017å¹´2æœˆ21å·</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">ä¸‰ä¸‰</div>
                                <div class="time">2017å¹´4æœˆ10å·</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        å¾®ä¿¡
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        æ”¯ä»˜å®
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:1426409836@qq.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/willdx">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>





            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
              <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="linkify icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    ğŸ±
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="heart icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <h2 class="name">Will Dx</h2>

                <span class="sign">äººä¸–ä¸€èº«éœœé›ª, å½’æ¥ä»æ˜¯å°‘å¹´.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        ä¸»é¡µ
                    </a>
                    <a href="/tweet.html" class="item">
                        æ¨ç‰¹
                    </a>
                    <a href="/about.html" class="item">
                        å…³äºæˆ‘
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        è”ç³»
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1>HashiCorpå…¨å®¶æ¡¶-Nomad</h1>
        <h4>Posted April 07, 2017</h4>
        <p><a href="https://www.hashicorp.com/">HashiCorpå®˜ç½‘</a></p>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th>æ¨¡å—åç§°</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>

<tbody>
<tr>
<td><a href="https://www.terraform.io/">Terraform</a></td>
<td>åŸºç¡€è®¾æ–½å³ä»£ç , åˆ›å»ºï¼Œç»“åˆï¼Œå’Œç®¡ç†å¤šä¸ªæœåŠ¡æä¾›å•†çš„åŸºç¡€è®¾æ–½,ä¾‹å¦‚:ç®¡ç†é˜¿é‡Œäº‘æœåŠ¡</td>
</tr>
<tr>
<td><a href="https://www.vaultproject.io/docs/">Vault</a></td>
<td>é›†ä¸­å­˜å‚¨ï¼Œå®‰å…¨ï¼Œå’Œæ§åˆ¶åˆ†å¸ƒå¼ç§˜å¯†è®¿é—®</td>
</tr>
<tr>
<td><a href="https://www.consul.io/">Consul</a></td>
<td>åˆ†å¸ƒå¼çš„æœåŠ¡å‘ç°ã€é…ç½®é«˜å¯ç”¨çš„å·¥å…·å’Œæµç¨‹</td>
</tr>
<tr>
<td><a href="https://www.nomadproject.io/docs/">Nomad</a></td>
<td>é›†ç¾¤ç®¡ç†å’Œè°ƒåº¦åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨ä»»ä½•åŸºç¡€è®¾æ–½</td>
</tr>
<tr>
<td><a href="https://www.packer.io/">Packer</a></td>
<td>è‡ªåŠ¨æ„å»ºé•œåƒ</td>
</tr>
<tr>
<td><a href="https://www.vagrantup.com/docs/index.html">Vagrant</a></td>
<td>ç¯å¢ƒç®¡ç†ä½¿å¾—å¼€å‘ç¯å¢ƒä¸€è‡´</td>
</tr>
</tbody>
</table></div>
<h1>1. å®‰è£…æµ‹è¯•ç¯å¢ƒ</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># 1. åˆ›å»ºåˆé€‚çš„ç›®å½•
mkdir -p /Users/daixiang/hashicorp/vagrant
# 2. å®‰è£…vagrant
wget https://releases.hashicorp.com/vagrant/2.0.2/vagrant_2.0.2_x86_64.dmg å¹¶å®‰è£…
# 3. è·å–vagrantfile
wget https://raw.githubusercontent.com/hashicorp/nomad/master/demo/vagrant/Vagrantfile
# 4. vagrantæµ‹è¯•ç¯å¢ƒå¯åŠ¨
vagrant up
# 5. è¿æ¥åˆ°æµ‹è¯•ç¯å¢ƒ
vagrant ssh
(PS: æ­¤æ—¶ç¯å¢ƒä¸‹å·²ç»å®‰è£…å¥½äº†nomad)</pre></div></div>

<h1>2. nomad</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># 1. è¿è¡Œnomadå‘½ä»¤æˆ‘ä»¬èƒ½çœ‹åˆ°å¦‚ä¸‹é¡µé¢, å…³äºnomadçš„å‘½ä»¤è¡Œç®¡ç†
vagrant@nomad:~$ nomad
Usage: nomad [-version] [-help] [-autocomplete-(un)install] <command> [<args>]

Available commands are:
    acl                   Interact with ACL policies and tokens:ä¸ACLç­–ç•¥å’Œä»¤ç‰Œè¿›è¡Œäº¤äº’
    agent                 Runs a Nomad agent:è¿è¡Œä¸€ä¸ªnomadä»£ç†
    agent-info            Display status information about the local agent:æ˜¾ç¤ºæœ‰å…³æœ¬åœ°ä»£ç†çš„çŠ¶æ€ä¿¡æ¯
    alloc-status          Display allocation status information and metadata: æ˜¾ç¤ºåˆ†é…çŠ¶æ€ä¿¡æ¯å’Œå…ƒæ•°æ®
    client-config         View or modify client configuration details: æŸ¥çœ‹æˆ–ä¿®æ”¹å®¢æˆ·ç«¯é…ç½®ç»†èŠ‚ã€‚
    deployment            Interact with deployments: éƒ¨ç½²
    eval-status           Display evaluation status and placement failure reasons:æ˜¾ç¤ºè¯„ä¼°çŠ¶æ€å’Œæ”¾ç½®å¤±è´¥çš„åŸå› ã€‚
    fs                    Inspect the contents of an allocation directory:æ£€æŸ¥åˆ†é…ç›®å½•çš„å†…å®¹ã€‚
    init                  Create an example job file: åˆ›å»ºä¸€ä¸ªç¤ºä¾‹ä½œä¸šæ–‡ä»¶ã€‚
    inspect               Inspect a submitted job: æ£€æŸ¥æäº¤çš„å·¥ä½œ
    job                   Interact with jobs: å·¥ä½œ
    keygen                Generates a new encryption key: ç”Ÿæˆä¸€ä¸ªæ–°çš„åŠ å¯†å¯†é’¥ã€‚
    keyring               Manages gossip layer encryption keys:ç®¡ç†åŠ å¯†å¯†é’¥ã€‚
    logs                  Streams the logs of a task.:è®°å½•ä»»åŠ¡çš„æ—¥å¿—ã€‚
    namespace             Interact with namespaces: å‘½åç©ºé—´
    node-drain            Toggle drain mode on a given node: åœ¨ç»™å®šèŠ‚ç‚¹ä¸Šåˆ‡æ¢å¸å–æ¨¡å¼ã€‚
    node-status           Display status information about nodes: æ˜¾ç¤ºèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ã€‚
    operator              Provides cluster-level tools for Nomad operators: ä¸ºæ¸¸ç‰§æ°‘æä¾›é›†ç¾¤çº§çš„å·¥å…·ã€‚
    plan                  Dry-run a job update to determine its effects: è¿›è¡Œä¸€æ¬¡ä½œä¸šæ›´æ–°ä»¥ç¡®å®šå…¶æ•ˆæœã€‚
    quota                 Interact with quotas: é…é¢
    run                   Run a new job or update an existing job: è¿è¡Œæ–°å·¥ä½œæˆ–æ›´æ–°ç°æœ‰çš„å·¥ä½œã€‚
    sentinel              Interact with Sentinel policies: ä¸å“¨å…µæ”¿ç­–
    server-force-leave    Force a server into the 'left' state: å¼ºåˆ¶æœåŠ¡å™¨è¿›å…¥â€œå·¦â€çŠ¶æ€ã€‚
    server-join           Join server nodes together: ä¸€èµ·åŠ å…¥æœåŠ¡å™¨èŠ‚ç‚¹
    server-members        Display a list of known servers and their status: æ˜¾ç¤ºå·²çŸ¥æœåŠ¡å™¨çš„åˆ—è¡¨åŠå…¶çŠ¶æ€ã€‚
    status                Display the status output for a resource: æ˜¾ç¤ºèµ„æºçš„çŠ¶æ€è¾“å‡ºã€‚
    stop                  Stop a running job: åœæ­¢æ­£åœ¨è¿è¡Œçš„ä½œä¸š
    ui                    Open the Nomad Web UI: æ‰“å¼€Nomad Web UIã€‚
    validate              Checks if a given job specification is valid: æ£€æŸ¥ç»™å®šçš„ä½œä¸šè§„èŒƒæ˜¯å¦æœ‰æ•ˆã€‚
    version               Prints the Nomad version: æ‰“å°nomadç‰ˆæœ¬
    
# 2. å¯åŠ¨ä»£ç†
sudo nomad agent -dev

# 3. æ–°å¼€é¡µé¢æŸ¥çœ‹çŠ¶æ€
vagrant@nomad:~$ nomad node-status
ID        DC   Name   Class   Drain  Status
02e1535f  dc1  nomad  <none>  false  ready

vagrant@nomad:~$ nomad server-members
Name          Address    Port  Status  Leader  Protocol  Build  Datacenter  Region
nomad.global  127.0.0.1  4648  alive   true    2         0.7.0  dc1         global</pre></div></div>

<p><a href="https://www.nomadproject.io/docs/agent/configuration/index.html">ä»£ç†å¯ä»¥è¢«é…ç½®æ”¯æŒä¼˜é›…çš„ä¸­æ–­ä¿¡å·</a></p>

<h1>3. start job</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># 1.åˆå§‹åŒ–é…ç½®æ–‡ä»¶
$ nomad init
Example job file written to example.nomad

# 2.å¯åŠ¨é…ç½®æ–‡ä»¶
vagrant@nomad:~$ nomad run example.nomad
==> Monitoring evaluation "dad1b471"
    Evaluation triggered by job "example"
    Evaluation within deployment: "caab06ab"
    Allocation "041d0bd2" created: node "02e1535f", group "cache"
    Evaluation status changed: "pending" -> "complete"
==> Evaluation "dad1b471" finished with status "complete"

# 3.æ£€æŸ¥jobçš„çŠ¶æ€
vagrant@nomad:~$ nomad status example
ID            = example
Name          = example
Submit Date   = 02/06/18 08:35:08 UTC
Type          = service
Priority      = 50
Datacenters   = dc1
Status        = running
Periodic      = false
Parameterized = false

Summary
Task Group  Queued  Starting  Running  Failed  Complete  Lost
cache       0       0         1        0       0         0

Latest Deployment
ID          = caab06ab
Status      = running
Description = Deployment is running

Deployed
Task Group  Desired  Placed  Healthy  Unhealthy
cache       1        1       0        0

Allocations
ID        Node ID   Task Group  Version  Desired  Status   Created At
041d0bd2  02e1535f  cache       0        run      running  02/06/18 08:35:08 UTC

# 4. èµ„æºä½¿ç”¨æƒ…å†µ
vagrant@nomad:~$ nomad alloc-status 041d0bd2
ID                  = 041d0bd2
Eval ID             = dad1b471
Name                = example.cache[0]
Node ID             = 02e1535f
Job ID              = example
Job Version         = 0
Client Status       = running
Client Description  = <none>
Desired Status      = run
Desired Description = <none>
Created At          = 02/06/18 08:35:08 UTC
Deployment ID       = caab06ab
Deployment Health   = healthy

Task "redis" is "running"
Task Resources
CPU        Memory           Disk     IOPS  Addresses
3/500 MHz  6.3 MiB/256 MiB  300 MiB  0     db: 127.0.0.1:23912

Task Events:
Started At     = 02/06/18 08:36:05 UTC
Finished At    = N/A
Total Restarts = 0
Last Restart   = N/A

Recent Events:
Time                   Type        Description
02/06/18 08:36:05 UTC  Started     Task started by client
02/06/18 08:35:08 UTC  Driver      Downloading image redis:3.2
02/06/18 08:35:08 UTC  Task Setup  Building Task Directory
02/06/18 08:35:08 UTC  Received    Task received by client

# 5.æŸ¥çœ‹ä»»åŠ¡çš„æ—¥å¿—
vagrant@nomad:~$ nomad logs 041d0bd2
1:C 06 Feb 08:36:04.988 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
                _._
           _.-``__ ''-._
      _.-``    `.  `_.  ''-._           Redis 3.2.11 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ ''-._
 (    '      ,       .-`  | `,    )     Running in standalone mode
 |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379
 |    `-._   `._    /     _.-'    |     PID: 1
  `-._    `-._  `-./  _.-'    _.-'
 |`-._`-._    `-.__.-'    _.-'_.-'|
 |    `-._`-._        _.-'_.-'    |           http://redis.io
  `-._    `-._`-.__.-'_.-'    _.-'
 |`-._`-._    `-.__.-'    _.-'_.-'|
 |    `-._`-._        _.-'_.-'    |
  `-._    `-._`-.__.-'_.-'    _.-'
      `-._    `-.__.-'    _.-'
          `-._        _.-'
              `-.__.-'

1:M 06 Feb 08:36:04.994 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
1:M 06 Feb 08:36:04.994 # Server started, Redis version 3.2.11</pre></div></div>

<h1>4. update job</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># 1. ç¼–è¾‘example.nomadæ–‡ä»¶ä»¥æ›´æ–°è®°æ•°å¹¶å°†å…¶è®¾ç½®ä¸º3
count = 3

# 2. ä¿®æ”¹ä¹‹åä½¿ç”¨`plan`å‘½ä»¤æ¥æ›´æ–°
vagrant@nomad:~$ nomad plan example.nomad
+/- Job: "example"
+/- Task Group: "cache" (2 create, 1 in-place update)
  +/- Count: "1" => "3" (forces create)
      Task: "redis"

Scheduler dry-run:
- All tasks successfully allocated.

Job Modify Index: 15
To submit the job with version verification run:

nomad run -check-index 15 example.nomad

When running the job with the check-index flag, the job will only be run if the
server side version matches the job modify index returned. If the index has
changed, another user has modified the job and the plan's results are
potentially invalid.

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒåº¦æ£€æµ‹è®¡æ•°çš„å˜åŒ–ï¼Œå¹¶é€šçŸ¥æˆ‘ä»¬ï¼Œè¿™å°†å¯¼è‡´åˆ›å»º2ä¸ªæ–°çš„å®ä¾‹. 

# 3. check-indexç¡®ä¿ä»»åŠ¡åœ¨ä½ æäº¤å‰æ²¡æœ‰è¢«æ›´æ”¹è¿‡
vagrant@nomad:~$ nomad run -check-index 15 example.nomad
==> Monitoring evaluation "46a3d9ef"
    Evaluation triggered by job "example"
    Allocation "143aa9a7" created: node "02e1535f", group "cache"
    Allocation "b5b4df8c" created: node "02e1535f", group "cache"
    Allocation "041d0bd2" modified: node "02e1535f", group "cache"
    Evaluation within deployment: "73c2fe13"
    Allocation "143aa9a7" status changed: "pending" -> "running"
    Evaluation status changed: "pending" -> "complete"
==> Evaluation "46a3d9ef" finished with status "complete"

# 4. å†æ¬¡å°è¯•æ›´æ”¹é…ç½®, ä¾‹å¦‚: å‡çº§redisç‰ˆæœ¬
# Configure Docker driver with the image
config {
    image = "redis:4.0"
}
# å†æ¬¡è¿è¡Œ
vagrant@nomad:~$ nomad plan example.nomad
+/- Job: "example"
+/- Task Group: "cache" (1 create/destroy update, 2 ignore)
  +/- Task: "redis" (forces create/destroy update)
    +/- Config {
      +/- image:           "redis:3.2" => "redis:4.2"
          port_map[0][db]: "6379"
        }

Scheduler dry-run:
- All tasks successfully allocated.

Job Modify Index: 40
To submit the job with version verification run:

nomad run -check-index 40 example.nomad

When running the job with the check-index flag, the job will only be run if the
server side version matches the job modify index returned. If the index has
changed, another user has modified the job and the plan's results are
potentially invalid.
(PS: å¯ä»¥çœ‹åˆ°1ä¸ªè¢«æ›´æ–°, 2ä¸ªè¢«å¿½ç•¥, è¿™æ˜¯ç”±äºmax_parallelå‚æ•°è¢«è®¾ç½®ä¸º1, è¡¨ç¤ºæ¯æ¬¡æ‰§è¡Œå•ä¸€çš„å˜åŒ–)

# å‡†å¤‡å°±ç»ªåæˆ‘ä»¬runæœ€æ–°çš„è§„èŒƒ
vagrant@nomad:~$ nomad run example.nomad
==> Monitoring evaluation "1e7876d5"
    Evaluation triggered by job "example"
    Evaluation within deployment: "9efc3833"
    Allocation "aced7654" created: node "02e1535f", group "cache"
    Evaluation status changed: "pending" -> "complete"
==> Evaluation "1e7876d5" finished with status "complete"</pre></div></div>

<h1>5. åœæ­¢ä½œä¸š</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># 1. åœæ­¢ä½œä¸š
vagrant@nomad:~$ nomad stop example
==> Monitoring evaluation "529c7a07"
    Evaluation triggered by job "example"
    Evaluation within deployment: "9efc3833"
    Evaluation status changed: "pending" -> "complete"
==> Evaluation "529c7a07" finished with status "complete"

# 2.åœæ­¢åæŸ¥çœ‹çŠ¶æ€(PS: æ­¤æ—¶çš„çŠ¶æ€æ˜¯dead)
vagrant@nomad:~$ nomad status example
ID            = example
Name          = example
Submit Date   = 02/06/18 08:57:04 UTC
Type          = service
Priority      = 50
Datacenters   = dc1
Status        = dead (stopped)
Periodic      = false
Parameterized = false

Summary
Task Group  Queued  Starting  Running  Failed  Complete  Lost
cache       0       0         0        0       4         0

Latest Deployment
ID          = 9efc3833
Status      = cancelled
Description = Cancelled because job is stopped

Deployed
Task Group  Desired  Placed  Healthy  Unhealthy
cache       3        1       0        0

Allocations
ID        Node ID   Task Group  Version  Desired  Status    Created At
aced7654  02e1535f  cache       2        stop     complete  02/06/18 08:57:04 UTC
143aa9a7  02e1535f  cache       1        stop     complete  02/06/18 08:49:38 UTC
b5b4df8c  02e1535f  cache       1        stop     complete  02/06/18 08:49:38 UTC
041d0bd2  02e1535f  cache       1        stop     complete  02/06/18 08:35:08 UTC</pre></div></div>

<h1>6. åˆ›å»ºé›†ç¾¤</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># 1. åœ¨vagrant sshç¯å¢ƒä¸­é…ç½®nomadæœåŠ¡ç«¯
wget https://raw.githubusercontent.com/hashicorp/nomad/master/demo/vagrant/server.hcl
vagrant@nomad:~$ nomad agent -config server.hcl
==> WARNING: Bootstrap mode enabled! Potentially unsafe operation.
    Loaded configuration from server.hcl
==> Starting Nomad agent...
==> Nomad agent configuration:

                Client: false
             Log Level: DEBUG
                Region: global (DC: dc1)
                Server: true
               Version: 0.7.0
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„å®¢æˆ·ç«¯æ¨¡å¼è¢«ç¦æ­¢ï¼Œè€Œæˆ‘ä»¬åªè¿è¡Œä½œä¸ºæœåŠ¡å™¨ã€‚è¿™æ„å‘³ç€ï¼Œè¯¥æœåŠ¡å™¨å°†ç®¡ç†çŠ¶æ€ï¼Œå¹¶åšå‡ºè°ƒåº¦å†³ç­–ï¼Œä½†ä¸ä¼šè¿è¡Œä»»ä½•ä»»åŠ¡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›ä»£ç†è¿è¡Œçš„ä»»åŠ¡ï¼

# 2. å¯åŠ¨å®¢æˆ·ç«¯, åˆ†åˆ«åˆ›å»º2ä¸ªæ–‡ä»¶client1.hclå’Œclient2.hcl

- client1.hclçš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ 

# Increase log verbosity
log_level = "DEBUG"

# Setup data dir
data_dir = "/tmp/client1"

# Enable the client
client {
    enabled = true

    # For demo assume we are talking to server1. For production,
    # this should be like "nomad.service.consul:4647" and a system
    # like Consul used for service discovery.
    servers = ["127.0.0.1:4647"]
}

- client2.hclçš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ 

# Modify our port to avoid a collision with server1
ports {
    http = 5656
}

# Increase log verbosity
log_level = "DEBUG"

# Setup data dir
data_dir = "/tmp/client2"

# Enable the client
client {
    enabled = true

    # For demo assume we are talking to server1. For production,
    # this should be like "nomad.service.consul:4647" and a system
    # like Consul used for service discovery.
    servers = ["127.0.0.1:4647"]
}

# Modify our port to avoid a collision with server1
ports {
    http = 5657
}

# 3.å¯åŠ¨client1å’Œclient2
sudo nomad agent -config client1.hcl
sudo nomad agent -config client2.hcl


# 4.æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
vagrant@nomad:~$ nomad node-status
ID        DC   Name   Class   Drain  Status
c23a265d  dc1  nomad  <none>  false  ready
9c59eb84  dc1  nomad  <none>  false  ready
(PS: æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰2ä¸ªèŠ‚ç‚¹å‡†å¤‡å¥½äº†)</pre></div></div>

<h1>7. å°†ä»»åŠ¡è·‘åœ¨é›†ç¾¤ä¸Š</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># 1.å¯åŠ¨ä»»åŠ¡
vagrant@nomad:~$ nomad run example.nomad
==> Monitoring evaluation "a2ed1c35"
    Evaluation triggered by job "example"
    Evaluation within deployment: "214b2685"
    Allocation "1cb8043c" created: node "9c59eb84", group "cache"
    Allocation "4e5cd868" created: node "9c59eb84", group "cache"
    Allocation "b8feecf4" created: node "c23a265d", group "cache"
    Evaluation status changed: "pending" -> "complete"
==> Evaluation "a2ed1c35" finished with status "complete"

# 2.æŸ¥çœ‹ä»»åŠ¡è¿è¡Œåœ¨é›†ç¾¤çš„é‚£å°æœºå™¨ä¸Š
nomad status example
Allocations
ID        Node ID   Task Group  Version  Desired  Status   Created At
1cb8043c  9c59eb84  cache       0        run      pending  02/06/18 09:19:38 UTC
4e5cd868  9c59eb84  cache       0        run      pending  02/06/18 09:19:38 UTC
b8feecf4  c23a265d  cache       0        run      pending  02/06/18 09:19:38 UTC
(PS: æˆ‘ä»¬å¯ä»¥å‘ç°æœ‰2ä¸ªä»»åŠ¡è·‘åœ¨äº†èŠ‚ç‚¹9c59eb84, å¦å¤–ä¸ªä»»åŠ¡è·‘åœ¨äº†èŠ‚ç‚¹c23a265d)

# 3.åœæ­¢æœåŠ¡
vagrant@nomad:~$ nomad stop example
==> Monitoring evaluation "012cdac0"
    Evaluation triggered by job "example"
    Evaluation within deployment: "214b2685"
    Evaluation status changed: "pending" -> "complete"
==> Evaluation "012cdac0" finished with status "complete"</pre></div></div>

<h1>8. Nomad Web UI</h1>

<p>http://localhost:4646/ui/jobs</p>

<h1>9.ä½¿ç”¨ansibleç®¡ç†Nomad</h1>

<h2>9.1 å®‰è£…sshpass</h2>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>brew install https://raw.githubusercontent.com/kadwanev/bigboybrew/master/Library/Formula/sshpass.rb</pre></div></div>

<h2>9.2 å¿½ç•¥sshè¿æ¥æ—¶çš„äººæœºäº¤äº’è¿‡ç¨‹</h2>

<p>Facts æ˜¯ç”¨æ¥é‡‡é›†ç›®æ ‡ç³»ç»Ÿä¿¡æ¯çš„ï¼Œå…·ä½“æ˜¯ç”¨setupæ¨¡å—æ¥é‡‡é›†å¾—</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># ä¿®æ”¹ansible.cfgé…ç½®æ–‡ä»¶
[defaults]
host_key_checking = False  # å¿½ç•¥sshè¿æ¥æ—¶çš„äººæœºäº¤äº’è¿‡ç¨‹
fact_caching = jsonfile  # Facts ä½¿ç”¨æ–‡ä»¶ä½œä¸ºç¼“å­˜
fact_caching_connection = ./facts.d/ # Facts ç¼“å­˜ç›®å½•
fact_caching_timeout = 86400  # Facts ç¼“å­˜è¶…æ—¶æ—¶é—´
inventory = ./inventory/</pre></div></div>

<h2>9.3 ansibleç®¡ç†Nomad Server</h2>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># æ‰§è¡Œä¸€äº›nomadå‘½ä»¤
ansible all -m ping
ansible backend-release -m shell -a "pwd"
ansible backend-release -m shell -a "nomad init"
ansible backend-release -m shell -a "cat example.nomad"
ansible backend-release -m shell -a "nomad run"
ansible backend-release -m shell -a "nomad run example.nomad"
ansible backend-release -m shell -a "nomad status"
ansible backend-release -m shell -a "nomad stop -purge example"</pre></div></div>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># ç”Ÿæˆansibleçš„ä¸»æœºèµ„æºæ¦‚è§ˆ
ansible-vault view vars/vault-secret.yml
pip install  ansible-cmdb
ansible-cmdb -f facts.d > 1.html</pre></div></div>

    </div>
    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic green button">æ‰“èµ <i class="red heart icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">MORE WORDS</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer code">
            <span>Â© 1994 - 2018 willdx</span><b>@</b><a class="code" href="https://github.com/willdx/willdx.github.io">blog.willdx.me</a>
            <br/>
            <span class="notprint">
                <span id="busuanzi_container_site_pv">
                    <i class="eye icon"></i><span id="busuanzi_value_site_pv" class="orange text"></span> pv
                </span>
                <b> | </b>
                <span id="busuanzi_container_site_uv">
                    <i class="user icon"></i><span id="busuanzi_value_site_uv" class="orange text"></span> uv
                </span>
                <br/>
            </span>
            <span>Power by <i class="github alternate icon"></i><a href="https://github.com/willdx/willdx.github.io">Github Page</a></span>
            <br/>
            <i class="green superpowers icon"></i>
        </div>
    </body>
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="/assets/js/web.js"></script>
    <script>
        // ç»Ÿè®¡ä»£ç 
        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68394485-1', 'auto');
        ga('send', 'pageview');

        var wrappers = ["cats-wrapper", "donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper"]

        window.onload = function () {
            useWechat();
        }
    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: 'de35601f0076c240632f',
        clientSecret: 'b44ba043a5af4818f53dc13d3b4e49b5a28a2a0c',
        repo: 'willdx.github.io',
        owner: 'willdx',
        admin: ['willdx'],
        id: 'HashiCorpå…¨å®¶æ¡¶-Nomad',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: ['gitment'],
        pagerDirection: "last",
    })
      
    gitalk.render('comments')
    </script>


</html>