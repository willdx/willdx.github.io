<html>
    <head>
        <meta charset="utf-8">
        
    
        <title> Djangoå­¦ä¹ ç¬”è®°19_Django+Docker+ansible+env </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">


        <style type="text/css"> 
        </style>
    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: #fff;">ä¸»é¢˜é€‰æ‹©</span></h3>
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr class="sk-mo" onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">å¢¨</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-green" onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">ç»¿</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-default" onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">é’</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-orange" onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">æ©˜</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">æ³¢å¦</div>
                                <div class="time">2017å¹´2æœˆ21å·</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">ä¸‰ä¸‰</div>
                                <div class="time">2017å¹´4æœˆ10å·</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        å¾®ä¿¡
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        æ”¯ä»˜å®
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:1426409836@qq.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/willdx">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>





            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
              <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="linkify icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    ğŸ±
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="heart icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <h2 class="name">Will Dx</h2>

                <span class="sign">äººä¸–ä¸€èº«éœœé›ª, å½’æ¥ä»æ˜¯å°‘å¹´.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        ä¸»é¡µ
                    </a>
                    <a href="/tweet.html" class="item">
                        æ¨ç‰¹
                    </a>
                    <a href="/about.html" class="item">
                        å…³äºæˆ‘
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        è”ç³»
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1>Djangoå­¦ä¹ ç¬”è®°19_Django+Docker+ansible+env</h1>
        <h4>Posted April 07, 2017</h4>
        <h1>1. Djangoç¯å¢ƒå˜é‡è®¾å®šæœ€ä½³å®è·µ</h1>

<h2>1.1 é»˜è®¤çš„è®¾ç½® global_settings</h2>

<p>Django çš„è®¾ç½®æ–‡ä»¶ä¸éœ€è¦å®šä¹‰æ‰€æœ‰çš„è®¾ç½®ã€‚æ¯ä¸ªè®¾ç½®éƒ½æœ‰ä¸€ä¸ªåˆç†çš„é»˜è®¤å€¼ã€‚è¿™äº›é»˜è®¤å€¼ä½äºdjango/conf/global<em>settings.py æ¨¡å—ä¸­; Djangoå…ˆä»global</em>settings.py ä¸­åŠ è½½è®¾ç½®, ç„¶åä»<code>æŒ‡å®šçš„è®¾ç½®æ–‡ä»¶</code>ä¸­åŠ è½½è®¾ç½®ï¼Œå¦‚æœ‰å¿…è¦åˆ™è¦†ç›–å…¨å±€çš„è®¾ç½®;  </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># æ˜¾ç¤ºå½“å‰çš„è®¾ç½®æ–‡ä»¶å’ŒDjango é»˜è®¤è®¾ç½®ä¹‹é—´çš„å·®å¼‚</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">diffsettings</span>
</pre></div>
</div>
<h2>1.2 configure() æˆ– DJANGO<em>SETTINGS</em>MODULE</h2>

<p><code>æŒ‡å®šçš„è®¾ç½®æ–‡ä»¶</code>: å¯ä»¥é€šè¿‡configure() æˆ– DJANGO<em>SETTINGS</em>MODULEä¸¤ç§æ–¹å¼æ¥è®¾å®š, åªä½¿ç”¨configure() æˆ– DJANGO<em>SETTINGS</em>MODULE ä¸­çš„ä¸€ä¸ª, ä¸å¯ä»¥ä¸¤ä¸ªéƒ½ç”¨å’Œéƒ½ä¸ç”¨;</p>

<p>å¦‚å›¾: (é»˜è®¤çŠ¶æ€ä¸‹, åœ¨manage.pyå’Œwsgi.pyå…¥å£å¤„æŒ‡å®šäº†<code>æŒ‡å®šçš„è®¾ç½®æ–‡ä»¶</code>)</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15024344469151.jpg"></p>
</p>

<p>Djangoä¼šä»<code>æŒ‡å®šçš„è®¾ç½®æ–‡ä»¶</code>ä¸­è¯»å–ç³»ç»Ÿå¯åŠ¨æ‰€éœ€çš„æ‰€æœ‰è®¾ç½®, å¦‚æœä½ æœ‰å…´è¶£å¯ä»¥ç ”ç©¶ä¸€ä¸‹Djangoå¦‚æœä½¿ç”¨è¯¥ç¯å¢ƒå˜é‡çš„, å…¥å£å¦‚ä¸‹:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">daixiang</span><span class="o">/.</span><span class="n">virtualenvs</span><span class="o">/</span><span class="n">accouting_server</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">django</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<h2>1.3 ä¸ºä¸åŒç¯å¢ƒè®¾å®šä¸åŒçš„è®¾å®šæ–‡ä»¶</h2>

<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­, æˆ‘ä»¬å¿…å®šä¼šæœ‰ <code>local(æœ¬åœ°æµ‹è¯•ç¯å¢ƒ)</code> , <code>ci(é›†æˆæµ‹è¯•ç¯å¢ƒ)</code>, <code>pre-release(é¢„å‘å¸ƒç¯å¢ƒ)</code>, <code>online(çº¿ä¸Šç¯å¢ƒ)</code> çš„åŒºåˆ«, æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºé¡¹ç›®è®¾å®šä¸åŒç¯å¢ƒä¸‹çš„<code>è®¾ç½®æ–‡ä»¶</code>;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">â”œâ”€â”€</span> <span class="n">settings</span>
<span class="err">â”‚Â Â </span> <span class="err">â”œâ”€â”€</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
<span class="err">â”‚Â Â </span> <span class="err">â”œâ”€â”€</span> <span class="n">base</span><span class="o">.</span><span class="n">py</span>   <span class="c1"># åŸºç¡€é…ç½®æ–‡ä»¶, é»˜è®¤çš„settings.pyæ–‡ä»¶é‡å‘½ä»¤è€Œæ¥</span>
<span class="err">â”‚Â Â </span> <span class="err">â”œâ”€â”€</span> <span class="n">ci</span><span class="o">.</span><span class="n">py</span>     <span class="c1"># é›†æˆæµ‹è¯•é…ç½®æ–‡ä»¶</span>
<span class="err">â”‚Â Â </span> <span class="err">â”œâ”€â”€</span> <span class="n">local</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># æœ¬åœ°æµ‹è¯•é…ç½®æ–‡ä»¶</span>
<span class="err">â”‚Â Â </span> <span class="err">â”œâ”€â”€</span> <span class="n">online</span><span class="o">.</span><span class="n">py</span> <span class="c1"># çº¿ä¸Šç¯å¢ƒé…ç½®æ–‡ä»¶</span>
<span class="err">â”‚Â Â </span> <span class="err">â””â”€â”€</span> <span class="n">pre</span><span class="o">-</span><span class="n">release</span><span class="o">.</span><span class="n">py</span> <span class="c1"># é¢„å‘å¸ƒç¯å¢ƒé…ç½®æ–‡ä»¶</span>
</pre></div>
</div>
<p>å°†base.pyçš„å†…å®¹éƒ½å¯¼å…¥åˆ°æ¯ä¸ªç‰¹å®šç¯å¢ƒå˜é‡çš„æ–‡ä»¶ä¸­å»; ä»¥local.pyä¸ºä¾‹:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># -*-coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">IS_ENV_ONLINE</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">IS_ENV_PRE_RELEASE</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">IS_ENV_CI</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">IS_ENV_LOCAL</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>è¿™é‡Œæˆ‘ä»¬å¼•å…¥<a href="https://pypi.python.org/pypi/django-environ">Django-environ</a>åº“, ä»–å¸®ç»„æˆ‘ä»¬ç®¡ç†å¥½ç¯å¢ƒå˜é‡;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">pip3</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="n">environ</span>
</pre></div>
</div>
<p>æ›´æ”¹base.pyæ–‡ä»¶, é€šè¿‡DOT<em>ENV</em>FILEç¯å¢ƒå˜é‡æ§åˆ¶ä¸åŒç¯å¢ƒä¸‹, <code>ç¯å¢ƒå˜é‡æ–‡ä»¶</code>çš„å¯¼å…¥, é»˜è®¤ä¸ºlocal.envæ–‡ä»¶</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">environ</span>

<span class="c1"># æ ¹ç›®å½•, å‚è€ƒ: https://pypi.python.org/pypi/django-environ</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span>
<span class="n">APP_DIR</span> <span class="o">=</span> <span class="n">BASE_DIR</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;accouting_app&quot;</span><span class="p">)</span>

<span class="c1"># ç¯å¢ƒå˜é‡, é»˜è®¤local.env</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">Env</span><span class="p">()</span>
<span class="n">DOT_ENV_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOT_ENV_FILE&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;local.env&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">DOT_ENV_FILE</span><span class="p">:</span>
    <span class="n">env_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;accouting_project&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">DOT_ENV_FILE</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">env_file</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Loading : {} ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_file</span><span class="p">))</span>
        <span class="n">env</span><span class="o">.</span><span class="n">read_env</span><span class="p">(</span><span class="n">env_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loading Finished!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>è¿™æ ·åœ¨local.env æ–‡ä»¶å®šä¹‰çš„å˜é‡éƒ½å¯ä»¥ç”¨envå‚æ•°è·å–, ä¾‹å¦‚: </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># DEBUG</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="n">TEMPLATE_DEBUG</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">bool</span><span class="p">(</span><span class="s1">&#39;DJANGO_DEBUG&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ELK</span>
<span class="n">ELK_URL</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s1">&#39;ELK_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;http://elk:9200&#39;</span><span class="p">)</span>
<span class="n">ELK_DOMAIN</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s1">&#39;ELK_DOMAIN&#39;</span><span class="p">,</span> <span class="s1">&#39;elk&#39;</span><span class="p">)</span>
<span class="n">ELK_PORT</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">str</span><span class="p">(</span><span class="s1">&#39;ELK_PORT&#39;</span><span class="p">,</span> <span class="s1">&#39;9200&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­ä¹‹å, å¯ä»¥æ–¹ä¾¿é¡¹ç›®å…¶ä»–æ¨¡å—ä½¿ç”¨</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="k">print</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ELK_URL</span><span class="p">)</span>
</pre></div>
</div>
<h1>2.Ansibleè‡ªåŠ¨åŒ–åŸºç¡€</h1>

<p><a href="http://breezey.blog.51cto.com/2400275/1555530">æ–‡æ¡£æ¥æº</a></p>

<ul>
<li>æ¶æ„å›¾</li>
</ul>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15025194799130.jpg"></p>
</p>

<ul>
<li>æµç¨‹å›¾</li>
</ul>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15025196098962.jpg"></p>
</p>

<h2>2.1 Ansibleç®€ä»‹ä¸Inventory</h2>

<p>Ansibleæ˜¯ä¸€ä¸ªç»¼åˆçš„å¼ºå¤§çš„ç®¡ç†å·¥å…·,ä»–å¯ä»¥å¯¹å¤šå°ä¸»æœºå®‰è£…æ“ä½œç³»ç»Ÿ,å¹¶ä¸ºè¿™äº›ä¸»æœºå®‰è£…ä¸åŒçš„åº”ç”¨ç¨‹åº,ä¹Ÿå¯ä»¥é€šçŸ¥æŒ‡æŒ¥è¿™äº›ä¸»æœºå®Œæˆä¸åŒçš„ä»»åŠ¡.æŸ¥çœ‹å¤šå°ä¸»æœºçš„å„ç§ä¿¡æ¯çš„çŠ¶æ€ç­‰,ansibleéƒ½å¯ä»¥é€šè¿‡æ¨¡å—çš„æ–¹å¼æ¥å®Œæˆ</p>

<ul>
<li>Ansibleç‰¹æ€§</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">No</span> <span class="n">agents</span><span class="err">ï¼šä¸éœ€è¦å†è¢«ç®¡ç†èŠ‚ç‚¹ä¸Šå®‰è£…å®¢æˆ·ç«¯ï¼Œåªè¦æœ‰</span><span class="n">sshd</span><span class="err">å³å¯</span>
<span class="n">No</span> <span class="n">server</span><span class="err">ï¼šåœ¨æœåŠ¡ç«¯ä¸éœ€è¦å¯åŠ¨ä»»ä½•æœåŠ¡ï¼Œåªéœ€è¦æ‰§è¡Œå‘½ä»¤å°±è¡Œ</span>
<span class="n">No</span> <span class="n">additional</span> <span class="n">PKI</span><span class="err">ï¼šç”±äºä¸åŸºäº</span><span class="n">ssl</span><span class="err">ï¼Œæ‰€ä»¥ä¹Ÿä¸åŸºäº</span><span class="n">PKI</span><span class="err">å·¥ä½œ</span>
<span class="n">Modules</span> <span class="ow">in</span> <span class="nb">any</span> <span class="n">language</span><span class="err">ï¼šåŸºäºæ¨¡å—å·¥ä½œï¼Œ</span><span class="n">ansible</span><span class="err">æ‹¥æœ‰ä¼—å¤šçš„æ¨¡å—</span>
<span class="n">YAML</span><span class="err">ï¼šæ”¯æŒ</span><span class="n">YAML</span><span class="err">è¯­æ³•</span>
<span class="n">SSH</span> <span class="n">by</span> <span class="n">default</span><span class="err">ï¼šé»˜è®¤ä½¿ç”¨</span><span class="n">ssh</span><span class="err">æ§åˆ¶å„èŠ‚ç‚¹</span>
</pre></div>
</div>
<ul>
<li>ansibleåŸºæœ¬ç»„æˆ</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">æ ¸å¿ƒï¼š</span><span class="n">ansible</span>
<span class="err">æ ¸å¿ƒæ¨¡å—ï¼ˆ</span><span class="n">Core</span> <span class="n">Modules</span><span class="err">ï¼‰ï¼šè¿™äº›éƒ½æ˜¯</span><span class="n">ansible</span><span class="err">è‡ªå¸¦çš„æ¨¡å—</span> 
<span class="err">æ‰©å±•æ¨¡å—ï¼ˆ</span><span class="n">Custom</span> <span class="n">Modules</span><span class="err">ï¼‰ï¼šå¦‚æœæ ¸å¿ƒæ¨¡å—ä¸è¶³ä»¥å®ŒæˆæŸç§åŠŸèƒ½ï¼Œå¯ä»¥æ·»åŠ æ‰©å±•æ¨¡å—</span>
<span class="err">æ’ä»¶ï¼ˆ</span><span class="n">Plugins</span><span class="err">ï¼‰ï¼šå®Œæˆæ¨¡å—åŠŸèƒ½çš„è¡¥å……</span>
<span class="err">å‰§æœ¬ï¼ˆ</span><span class="n">Playbooks</span><span class="err">ï¼‰ï¼š</span><span class="n">ansible</span><span class="err">çš„ä»»åŠ¡é…ç½®æ–‡ä»¶ï¼Œå°†å¤šä¸ªä»»åŠ¡å®šä¹‰åœ¨å‰§æœ¬ä¸­ï¼Œç”±</span><span class="n">ansible</span><span class="err">è‡ªåŠ¨æ‰§è¡Œ</span>
<span class="err">è¿æ¥æ’ä»¶ï¼ˆ</span><span class="n">Connectior</span> <span class="n">Plugins</span><span class="err">ï¼‰ï¼š</span><span class="n">ansible</span><span class="err">åŸºäºè¿æ¥æ’ä»¶è¿æ¥åˆ°å„ä¸ªä¸»æœºä¸Šï¼Œè™½ç„¶</span><span class="n">ansible</span><span class="err">æ˜¯ä½¿ç”¨</span><span class="n">ssh</span><span class="err">è¿æ¥åˆ°å„ä¸ªä¸»æœºçš„ï¼Œä½†æ˜¯å®ƒè¿˜æ”¯æŒå…¶ä»–çš„è¿æ¥æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦æœ‰è¿æ¥æ’ä»¶</span>
<span class="err">ä¸»æœºç¾¤ï¼ˆ</span><span class="n">Host</span> <span class="n">Inventory</span><span class="err">ï¼‰ï¼šå®šä¹‰</span><span class="n">ansible</span><span class="err">ç®¡ç†çš„ä¸»æœº</span>
</pre></div>
</div>
<h2>2.2 ansible ç¯å¢ƒé…ç½®</h2>

<h3>2.2.1 é…ç½®æ–‡ä»¶æŸ¥æ‰¾é¡ºåº</h3>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>1. ANSIBLE_CONFIG: é¦–å…ˆï¼Œansibleå‘½ä»¤ä¼šæ£€æŸ¥ç¯å¢ƒå˜é‡ï¼ŒåŠè¿™ä¸ªç¯å¢ƒå˜é‡å°†æŒ‡å‘çš„é…ç½®æ–‡ä»¶ã€‚å¯ä»¥é€šè¿‡å¯¼å…¥ç¯å¢ƒå˜é‡çš„æ–¹å¼æ¥åšä¿®æ”¹ï¼Œä¾‹å¦‚ï¼šexport ANSIBLE_CONFIG=/directory_path
2. ./ansible.cfgï¼šå…¶æ¬¡ï¼Œå°†ä¼šæ£€æŸ¥å½“å‰ç›®å½•ä¸‹çš„ansible.cfgé…ç½®æ–‡ä»¶
3. ~/.ansible.cfgï¼šå†æ¬¡ï¼Œå°†ä¼šæ£€æŸ¥å½“å‰ç”¨æˆ·homeç›®å½•ä¸‹çš„.ansible.cfgé…ç½®æ–‡ä»¶
4. /etc/ansible/ansible.cfgï¼šæœ€åï¼Œå°†ä¼šæ£€æŸ¥åœ¨ç”¨è½¯ä»¶åŒ…ç®¡ç†å·¥å…·å®‰è£…ansibleæ—¶è‡ªåŠ¨äº§ç”Ÿçš„é…ç½®æ–‡ä»¶</pre></div></div>

<p>å¦‚æœæ˜¯yumå®‰è£…, é»˜è®¤é…ç½®æ–‡ä»¶åº”è¯¥åœ¨/etc/ansible/ansible.cfg; 
æˆ‘åœ¨macä¸Šé€šè¿‡pipå®‰è£…æ‰¾äº†åŠå¤©æ²¡æœ‰æ‰¾åˆ°ansible.cfgåœ¨å“ªé‡Œ, æˆ‘æ˜¯ç›´æ¥å»GitHubä¸Šæ‰¾åˆ°ansibleé¡¹ç›®, å¤åˆ¶ansible/examples/ansible.cfgåˆ°å½“å‰ç›®å½•,åšäº†ä¸€äº›éœ€è¦çš„æ›´æ”¹:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">âœ</span>  <span class="n">ansible</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;^[\[a-z]&#39;</span> <span class="n">ansible</span><span class="o">.</span><span class="n">cfg</span>
<span class="p">[</span><span class="n">defaults</span><span class="p">]</span>
<span class="n">inventory</span>      <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">hosts</span>  <span class="c1"># é»˜è®¤çš„ä¸»æœºæ–‡ä»¶</span>
<span class="n">remote_tmp</span>     <span class="o">=</span> <span class="o">~/.</span><span class="n">ansible</span><span class="o">/</span><span class="n">tmp</span>
<span class="n">local_tmp</span>      <span class="o">=</span> <span class="o">~/.</span><span class="n">ansible</span><span class="o">/</span><span class="n">tmp</span>
<span class="n">sudo_user</span>      <span class="o">=</span> <span class="n">root</span>
<span class="n">transport</span>      <span class="o">=</span> <span class="n">smart</span>
<span class="n">remote_port</span>    <span class="o">=</span> <span class="mi">22</span>  <span class="c1"># é»˜è®¤sshç«¯å£</span>
<span class="n">host_key_checking</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1"># å…³é—­sshè¿æ¥æç¤ºyes/no</span>
<span class="n">log_path</span> <span class="o">=</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">ansible</span><span class="o">.</span><span class="n">log</span>  <span class="c1"># å¼€å¯æ—¥å¿—è®°å½•</span>
<span class="n">system_warnings</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># å…³é—­ç³»ç»Ÿå‡çº§ç­‰æç¤ºä¿¡æ¯</span>
<span class="n">action_plugins</span>     <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">action</span>
<span class="n">cache_plugins</span>      <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">cache</span>
<span class="n">callback_plugins</span>   <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">callback</span>
<span class="n">connection_plugins</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">connection</span>
<span class="n">lookup_plugins</span>     <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">lookup</span>
<span class="n">inventory_plugins</span>  <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">inventory</span>
<span class="n">vars_plugins</span>       <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="nb">vars</span>
<span class="n">filter_plugins</span>     <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="nb">filter</span>
<span class="n">test_plugins</span>       <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">test</span>
<span class="n">terminal_plugins</span>   <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">terminal</span>
<span class="n">strategy_plugins</span>   <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">strategy</span>
<span class="n">fact_caching</span> <span class="o">=</span> <span class="n">memory</span>
<span class="p">[</span><span class="n">accelerate</span><span class="p">]</span>
<span class="n">accelerate_port</span> <span class="o">=</span> <span class="mi">5099</span>
<span class="n">accelerate_timeout</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">accelerate_connect_timeout</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">accelerate_daemon_timeout</span> <span class="o">=</span> <span class="mi">30</span>
</pre></div>
</div>
<h2>2.3 ansible ç®€å•ä½¿ç”¨</h2>

<ul>
<li><p>é¡¹ç›®ç›®å½•: /Users/daixiang/ansible</p></li>
<li><p>ç®¡ç†ä¸»æœº: Inventory</p></li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># vim hosts
[local]
127.0.0.1 ansible_ssh_user=daixiang

[rundeck]
120.43.103.126:2222 ansible_ssh_user=will</pre></div></div>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>âœ  ansible ansible -i hosts local -m ping -k
SSH password:
127.0.0.1 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
âœ  ansible ansible -i hosts rundeck -m ping -k
SSH password:
120.43.103.126 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
# SSHå…å¯†ç™»å½•åä¸éœ€è¦è¾“å…¥å¯†ç å³å¯æ‰§è¡Œå‘½ä»¤
âœ  ansible ssh-copy-id -i ~/.ssh/id_rsa.pub "-p 2233 xxx@120.43.103.126" 
âœ  ansible ansible -i hosts rundeck -m ping
120.43.103.126 | SUCCESS => {
    "changed": false,
    "ping": "pong"
}</pre></div></div>

<h2>2.4 ansible Inventoryé…ç½®</h2>

<h3>2.4.1 ç®€å•çš„ä¸»æœºå’Œç»„</h3>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>mail.willdx.me
[webservers]
web1.willdx.me
web2.willdx.me
[dbservers]
db1.willdx.me
db2.willdx.me</pre></div></div>

<h3>2.4.2 ç«¯å£ä¸åˆ«å</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1">#  web1è®¾å®šä¸ºçœŸå®IP: 192.168.1.2çš„åˆ«å</span>
<span class="n">web1</span> <span class="n">ansible_ssh_port</span> <span class="o">=</span> <span class="mi">3333</span> <span class="n">ansible_ssh_host</span> <span class="o">=</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.2</span>
</pre></div>
</div>
<h3>2.4.3 æŒ‡å®šä¸»æœºèŒƒå›´</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">webservers</span><span class="p">]</span>
<span class="n">www</span><span class="p">[</span><span class="mo">01</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">willdx</span><span class="o">.</span><span class="n">me</span>
<span class="p">[</span><span class="n">databases</span><span class="p">]</span>
<span class="n">db</span><span class="o">-</span><span class="p">[</span><span class="n">a</span><span class="p">:</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">willdx</span><span class="o">.</span><span class="n">me</span>
</pre></div>
</div>
<h3>2.4.4 ä½¿ç”¨ä¸»æœºå˜é‡</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">ansible_ssh_host</span>     <span class="c1">#ç”¨äºæŒ‡å®šè¢«ç®¡ç†çš„ä¸»æœºçš„çœŸå®IP</span>
<span class="n">ansible_ssh_port</span>     <span class="c1">#ç”¨äºæŒ‡å®šè¿æ¥åˆ°è¢«ç®¡ç†ä¸»æœºçš„sshç«¯å£å·ï¼Œé»˜è®¤æ˜¯22</span>
<span class="n">ansible_ssh_user</span>     <span class="c1">#sshè¿æ¥æ—¶é»˜è®¤ä½¿ç”¨çš„ç”¨æˆ·å</span>
<span class="n">ansible_ssh_pass</span>     <span class="c1">#sshè¿æ¥æ—¶çš„å¯†ç </span>
<span class="n">ansible_sudo_pass</span>     <span class="c1">#ä½¿ç”¨sudoè¿æ¥ç”¨æˆ·æ—¶çš„å¯†ç </span>
<span class="n">ansible_sudo_exec</span>     <span class="c1">#å¦‚æœsudoå‘½ä»¤ä¸åœ¨é»˜è®¤è·¯å¾„ï¼Œéœ€è¦æŒ‡å®šsudoå‘½ä»¤è·¯å¾„</span>
<span class="n">ansible_ssh_private_key_file</span>     <span class="c1">#ç§˜é’¥æ–‡ä»¶è·¯å¾„ï¼Œç§˜é’¥æ–‡ä»¶å¦‚æœä¸æƒ³ä½¿ç”¨ssh-agentç®¡ç†æ—¶å¯ä»¥ä½¿ç”¨æ­¤é€‰é¡¹</span>
<span class="n">ansible_shell_type</span>     <span class="c1">#ç›®æ ‡ç³»ç»Ÿçš„shellçš„ç±»å‹ï¼Œé»˜è®¤sh</span>
<span class="n">ansible_connection</span>     <span class="c1">#SSH è¿æ¥çš„ç±»å‹ï¼š local , ssh , paramikoï¼Œåœ¨ ansible 1.2 ä¹‹å‰é»˜è®¤æ˜¯ paramiko ï¼Œåæ¥æ™ºèƒ½é€‰æ‹©ï¼Œä¼˜å…ˆä½¿ç”¨åŸºäº ControlPersist çš„ ssh ï¼ˆæ”¯æŒçš„å‰æï¼‰</span>
<span class="n">ansible_python_interpreter</span>     <span class="c1">#ç”¨æ¥æŒ‡å®špythonè§£é‡Šå™¨çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º/usr/bin/python åŒæ ·å¯ä»¥æŒ‡å®šruby ã€perl çš„è·¯å¾„</span>
<span class="n">ansible_</span><span class="o">*</span><span class="n">_interpreter</span>     <span class="c1">#å…¶ä»–è§£é‡Šå™¨è·¯å¾„ï¼Œç”¨æ³•ä¸ansible_python_interpreterç±»ä¼¼ï¼Œè¿™é‡Œ&quot;*&quot;å¯ä»¥æ˜¯rubyæˆ–æ‰perlç­‰å…¶ä»–è¯­è¨€</span>


<span class="err">ç¤ºä¾‹å¦‚ä¸‹ï¼š</span>
<span class="p">[</span><span class="n">test</span><span class="p">]</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span> <span class="n">ansible_ssh_user</span><span class="o">=</span><span class="n">root</span> <span class="n">ansible_ssh_pass</span><span class="o">=</span><span class="s1">&#39;P@ssw0rd&#39;</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">1.2</span> <span class="n">ansible_ssh_user</span><span class="o">=</span><span class="n">breeze</span> <span class="n">ansible_ssh_pass</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">1.3</span> <span class="n">ansible_ssh_user</span><span class="o">=</span><span class="n">bernie</span> <span class="n">ansible_ssh_port</span><span class="o">=</span><span class="mi">3055</span> <span class="n">ansible_ssh_pass</span><span class="o">=</span><span class="s1">&#39;456789&#39;</span>
</pre></div>
</div>
<h3>2.4.5 ç»„çš„åŒ…å«ä¸ç»„å†…å˜é‡</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">wuhan</span><span class="p">]</span>
<span class="n">web1</span>
<span class="n">web2</span>

<span class="p">[</span><span class="n">jingzhou</span><span class="p">]</span>
<span class="n">web4</span>
<span class="n">web3</span>

<span class="p">[</span><span class="n">hubei</span><span class="p">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">wuhan</span>
<span class="n">jingzhou</span>

<span class="p">[</span><span class="n">hubei</span><span class="p">:</span><span class="nb">vars</span><span class="p">]</span>
<span class="n">ntp_server</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.10</span>
<span class="n">zabbix_server</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.10</span>

<span class="err">æ³¨ï¼š</span><span class="nb">vars</span><span class="err">å˜é‡åœ¨</span><span class="n">ansible</span> <span class="n">ad</span><span class="o">-</span><span class="n">hoc</span><span class="err">éƒ¨åˆ†ä¸­åŸºæœ¬ç”¨ä¸åˆ°ï¼Œä¸»è¦ç”¨åœ¨</span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="err">ä¸­</span>
</pre></div>
</div>
<h3>2.4.6 ä¸»æœºä¸ç»„æ­£åˆ™åŒ¹é…</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">æŠŠ</span><span class="n">Patterns</span> <span class="err">ç›´æ¥ç†è§£ä¸ºæ­£åˆ™å®é™…æ˜¯ä¸å®Œå…¨å‡†ç¡®çš„ï¼Œæ­£å¸¸çš„ç†è§£ä¸º</span><span class="n">patterns</span><span class="err">æ„å‘³ç€åœ¨</span><span class="n">ansible</span><span class="err">ä¸­ç®¡ç†å“ªäº›ä¸»æœºï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºï¼Œè¦ä¸å“ªå°ä¸»æœºè¿›è¡Œé€šä¿¡ã€‚åœ¨æ¢è®¨è¿™ä¸ªé—®é¢˜ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸‹</span><span class="n">ansible</span><span class="err">çš„ç”¨æ³•ï¼š</span>
<span class="n">ansible</span> <span class="o">&lt;</span><span class="n">pattern_goes_here</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="o">&lt;</span><span class="n">module_name</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">a</span> <span class="o">&lt;</span><span class="n">arguments</span><span class="o">&gt;</span>
<span class="err">ç›´æ¥ä¸Šä¸€ä¸ªç¤ºä¾‹ï¼š</span>
<span class="n">ansible</span> <span class="n">webservers</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;name=httpd state=restarted&quot;</span>
<span class="err">è¿™é‡Œæ˜¯å¯¹</span><span class="n">webservers</span> <span class="err">ç»„æˆ–ä¸»æœºé‡å¯</span><span class="n">httpd</span><span class="err">æœåŠ¡</span> <span class="err">ï¼Œå…¶ä¸­</span><span class="n">webservers</span> <span class="err">å°±æ˜¯</span><span class="n">Pattern</span><span class="err">éƒ¨åˆ†ã€‚è€Œä¹‹æ‰€ä»¥ä¸Šé¢è¯´</span><span class="n">Pattern</span><span class="err">ï¼ˆæ¨¡å¼ï¼‰å¯ä»¥ç†è§£ä¸ºæ­£åˆ™ï¼Œä¸»è¦é’ˆå¯¹ä¸‹é¢ç»å¸¸ç”¨åˆ°çš„ç”¨æ³•è€Œè¨€çš„ã€‚</span>
<span class="mi">1</span><span class="err">ã€è¡¨ç¤ºæ‰€æœ‰çš„ä¸»æœºå¯ä»¥ä½¿ç”¨</span><span class="nb">all</span> <span class="err">æˆ–</span> <span class="o">*</span> 
<span class="mi">2</span><span class="err">ã€é€šé…ç¬¦ä¸é€»è¾‘æˆ–</span>
<span class="err">åˆ©ç”¨é€šé…ç¬¦è¿˜å¯ä»¥æŒ‡å®šä¸€ç»„å…·æœ‰è§„åˆ™ç‰¹å¾çš„ä¸»æœºæˆ–ä¸»æœºåï¼Œå†’å·è¡¨ç¤º</span><span class="ow">or</span><span class="err">ï¼ï¼ï¼é€»è¾‘æˆ–</span>
    <span class="n">web1</span><span class="o">.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span>
    <span class="n">web1</span><span class="o">.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">web2</span><span class="o">.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span>
    <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span>
    <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.</span><span class="o">*</span>
<span class="err">å½“ç„¶ï¼Œè¿™é‡Œçš„</span><span class="o">*</span><span class="err">é€šé…ç¬¦ä¹Ÿå¯ä»¥ç”¨åœ¨å‰é¢ï¼Œå¦‚ï¼š</span>
    <span class="o">*.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span>
    <span class="o">*.</span><span class="n">com</span>    
    <span class="n">webservers1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>     <span class="c1">#è¡¨ç¤ºåŒ¹é… webservers1 ç»„çš„ç¬¬ 1 ä¸ªä¸»æœº    webservers1[0:25]  #è¡¨ç¤ºåŒ¹é… webservers1 ç»„çš„ç¬¬ 1 ä¸ªåˆ°ç¬¬ 25 ä¸ªä¸»æœºï¼ˆå®˜ç½‘æ–‡æ¡£æ˜¯&quot;:&quot;è¡¨ç¤ºèŒƒå›´ï¼Œæµ‹è¯•å‘ç°åº”è¯¥ä½¿ç”¨&quot;-&quot;,æ³¨æ„ä¸è¦å’ŒåŒ¹é…å¤šä¸ªä¸»æœºç»„æ··æ·†ï¼‰</span>
<span class="err">ä¸Šé¢çš„ç”¨æ³•ï¼Œåœ¨å¤šä¸ªç»„ä¹‹é—´åŒæ ·é€‚ç”¨</span> <span class="err">ï¼Œå¦‚ï¼š</span>
    <span class="n">webservers</span>
    <span class="n">webservers</span><span class="p">:</span><span class="n">dbservers</span>  <span class="c1">#è¡¨ç¤ºä¸¤ä¸ªç»„ä¸­æ‰€æœ‰çš„ä¸»æœº</span>
<span class="mi">3</span><span class="err">ã€é€»è¾‘éä¸é€»è¾‘</span><span class="ow">and</span>
<span class="err">éçš„è¡¨è¾¾å¼ï¼Œå¦‚ï¼Œç›®æ ‡ä¸»æœºå¿…é¡»åœ¨ç»„</span><span class="n">webservers</span><span class="err">ä½†ä¸åœ¨</span><span class="n">phoenix</span><span class="err">ç»„ä¸­</span>
    <span class="n">webserver</span><span class="p">:</span><span class="err">!</span><span class="n">phoenix</span>
<span class="err">äº¤é›†çš„è¡¨è¾¾å¼ï¼Œå¦‚ï¼Œç›®æ ‡ä¸»æœºå¿…é¡»å³åœ¨ç»„</span><span class="n">webservers</span><span class="err">ä¸­åˆåœ¨ç»„</span><span class="n">staging</span><span class="err">ä¸­</span>
    <span class="n">webservers</span><span class="p">:</span><span class="o">&amp;</span><span class="n">staging</span>
<span class="err">ä¸€ä¸ªæ›´å¤æ‚çš„ç¤ºä¾‹ï¼š</span>
    <span class="n">webserver</span><span class="p">:</span><span class="n">dbservers</span><span class="p">:</span><span class="o">&amp;</span><span class="n">staging</span><span class="p">:</span><span class="err">!</span><span class="n">phoenix</span>
<span class="err">ä¸Šé¢è¿™ä¸ªå¤æ‚çš„è¡¨è¾¾å¼æœ€åè¡¨ç¤ºçš„ç›®æ ‡ä¸»æœºå¿…é¡»æ»¡è¶³ï¼šåœ¨</span><span class="n">webservers</span><span class="err">æˆ–è€…</span><span class="n">dbservers</span><span class="err">ç»„ä¸­ï¼Œå¿…é¡»è¿˜å­˜åœ¨äº</span><span class="n">staging</span><span class="err">ç»„ä¸­ï¼Œä½†æ˜¯ä¸åœ¨</span><span class="n">phoenix</span><span class="err">ç»„ä¸­</span> <span class="err">ã€‚</span>
<span class="mi">4</span><span class="err">ã€æ··åˆé«˜çº§ç”¨æ³•</span>
    <span class="o">*.</span><span class="n">yanruogu</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="o">*.</span><span class="n">org</span>
<span class="err">è¿˜å¯ä»¥åœ¨å¼€å¤´çš„åœ°æ–¹ä½¿ç”¨â€</span><span class="o">~</span><span class="err">â€ï¼Œç”¨æ¥è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼</span><span class="p">:</span>
    <span class="o">~</span><span class="p">(</span><span class="n">web</span><span class="o">|</span><span class="n">db</span><span class="p">)</span><span class="o">.*</span>\<span class="o">.</span><span class="n">yanruogu</span>\<span class="o">.</span><span class="n">com</span>
<span class="err">ç»™ä¸¤ä¸ª</span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="err">ä¸­å…·ä½“å¯èƒ½ç”¨çš„ç”¨æ³•ï¼š</span>
<span class="n">a</span><span class="err">ã€åœ¨</span><span class="n">ansible</span><span class="o">-</span><span class="n">palybook</span><span class="err">å‘½ä»¤ä¸­ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å˜é‡æ¥ç»„æˆè¿™æ ·çš„è¡¨è¾¾å¼ï¼Œä½†æ˜¯ä½ å¿…é¡»ä½¿ç”¨â€œ</span><span class="o">-</span><span class="n">e</span><span class="err">â€çš„é€‰é¡¹æ¥æŒ‡å®šè¿™ä¸ªè¡¨è¾¾å¼ï¼ˆé€šå¸¸æˆ‘ä»¬ä¸è¿™æ ·ç”¨ï¼‰ï¼š</span>
    <span class="n">ansible</span><span class="o">-</span><span class="n">palybook</span> <span class="o">-</span><span class="n">e</span> <span class="n">webservers</span><span class="p">:</span><span class="err">!</span><span class="p">{{</span><span class="n">excluded</span><span class="p">}}:</span><span class="o">&amp;</span><span class="p">{{</span><span class="n">required</span><span class="p">}}</span>
<span class="n">b</span><span class="err">ã€åœ¨</span><span class="n">ansible</span><span class="err">å’Œ</span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span><span class="err">ä¸­ï¼Œè¿˜å¯ä»¥é€šè¿‡ä¸€ä¸ªå‚æ•°â€</span><span class="o">--</span><span class="n">limit</span><span class="err">â€æ¥æ˜ç¡®æŒ‡å®šæ’é™¤æŸäº›ä¸»æœºæˆ–ç»„ï¼š</span>
    <span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">site</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">limit</span> <span class="n">datacenter2</span>
<span class="n">c</span><span class="err">ã€ä»</span><span class="n">Ansible1</span><span class="o">.</span><span class="mi">2</span><span class="err">å¼€å§‹ï¼Œå¦‚æœæƒ³æ’é™¤ä¸€ä¸ªæ–‡ä»¶ä¸­çš„ä¸»æœºå¯ä»¥ä½¿ç”¨</span><span class="s2">&quot;@&quot;</span><span class="err">ï¼š</span>
    <span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">site</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">limit</span> <span class="nd">@retry_hosts.txt</span>
</pre></div>
</div>
<h2>2.4 ansible Galaxy è§’è‰²å…±äº«å¹³å°</h2>

<p>ansibleçš„galaxyæ˜¯ansibleå®˜æ–¹ä¸€ä¸ªåˆ†äº«roleçš„åŠŸèƒ½å¹³å°, ç½‘å€æ˜¯<a href="https://galaxy.ansible.com/list#/roles?page=1&amp;page_size=10">galaxy.ansible.com</a></p>

<p>å¯ä»¥æŠŠä½ ç¼–å†™çš„roleé€šè¿‡ansible-galaxyä¸Šä¼ åˆ°galaxyç½‘ç«™ä¾›å…¶ä»–äººä¸‹è½½å’Œä½¿ç”¨ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ansible-galaxyå‘½ä»¤å¾ˆç®€å•åœ°å®ç°roleçš„åˆ†äº«å’Œå®‰è£…ï¼Œå½“ç„¶ansibleä¹Ÿæ”¯æŒç›´æ¥ä»githubä¸Šä¸‹è½½role</p>

<p>åœ¨æˆ‘ä»¬ä½¿ç”¨ansible-galaxyå‘½ä»¤ä¸‹è½½roleçš„æ—¶å€™éœ€è¦äº†è§£roleçš„è¿è¡Œå¹³å°å’Œansibleä¾èµ–ç‰ˆæœ¬ä»¥åŠç›¸å…³ä¾èµ–ã€‚æ—¥å¸¸å·¥ä½œä¸­æˆ‘ä»¬ä½¿ç”¨<code>ansible-galaxy install</code>å°±å¯ä»¥ï¼Œé»˜è®¤ä¼šå®‰è£…åˆ°<code>/etc/ansible/roles/</code>ç›®å½•ä¸‹ï¼Œå…¶å¼•ç”¨è·Ÿæˆ‘ä»¬è‡ªå·±å†™çš„roleçš„æ–¹å¼ä¸€æ ·;</p>

<h2>2.5 ansible ad-hocä¸å‘½ä»¤æ‰§è¡Œæ¨¡å—</h2>

<p><a href="http://breezey.blog.51cto.com/2400275/1555530">æ–‡æ¡£æ¥æº</a></p>

<h3>2.5.1 Ad-Hoc</h3>

<p>Ad-Hoc æ˜¯æŒ‡ansibleä¸‹ä¸´æ—¶æ‰§è¡Œçš„ä¸€æ¡å‘½ä»¤ï¼Œå¹¶ä¸”ä¸éœ€è¦ä¿å­˜çš„å‘½ä»¤ï¼Œå¯¹äºå¤æ‚çš„å‘½ä»¤ä¼šä½¿ç”¨playbookã€‚Ad-hocçš„æ‰§è¡Œä¾èµ–äºæ¨¡å—ï¼Œansibleå®˜æ–¹æä¾›äº†å¤§é‡çš„æ¨¡å—ã€‚ å¦‚ï¼šcommandã€rawã€shellã€fileã€cronç­‰ï¼Œå…·ä½“å¯ä»¥é€šè¿‡ansible-doc -l è¿›è¡ŒæŸ¥çœ‹ ã€‚å¯ä»¥ä½¿ç”¨ansible-doc -s moduleæ¥æŸ¥çœ‹æŸä¸ªæ¨¡å—çš„å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ansible-doc help moduleæ¥æŸ¥çœ‹è¯¥æ¨¡å—æ›´è¯¦ç»†çš„ä¿¡æ¯; </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># å‘½ä»¤æ¨¡å¼</span>
<span class="n">ansible</span> <span class="o">-</span><span class="n">i</span> <span class="err">ä¸»æœºæ–‡ä»¶</span> <span class="err">ä¸»æœºæˆ–ç»„</span> <span class="o">-</span><span class="n">m</span> <span class="err">æ¨¡å—å</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;æ¨¡å—å‚æ•°&#39;</span>  <span class="n">ansible</span><span class="err">å‚æ•°</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># åå°æ‰§è¡Œ</span>

<span class="c1">#åå°æ‰§è¡Œå‘½ä»¤3600sï¼Œ-B è¡¨ç¤ºåå°æ‰§è¡Œçš„æ—¶é—´</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">B</span> <span class="mi">3600</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
 
<span class="c1">#æ£€æŸ¥ä»»åŠ¡çš„çŠ¶æ€</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">m</span> <span class="n">async_status</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;jid=123456789&quot;</span> 

<span class="c1">#åå°æ‰§è¡Œå‘½ä»¤æœ€å¤§æ—¶é—´æ˜¯1800så³30åˆ†é’Ÿï¼Œ-P æ¯60sæ£€æŸ¥ä¸‹çŠ¶æ€ï¼Œé»˜è®¤15s</span>
<span class="n">ansible</span> <span class="nb">all</span> <span class="o">-</span><span class="n">B</span> <span class="mi">1800</span> <span class="o">-</span><span class="n">P</span> <span class="mi">60</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</pre></div>
</div>
<h3>2.5.2 å‘½ä»¤è¡Œæ‰§è¡Œæ¨¡å—</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="n">command</span><span class="err">æ¨¡å—ï¼šè¯¥æ¨¡å—é€šè¿‡</span><span class="o">-</span><span class="n">a</span><span class="err">è·Ÿä¸Šè¦æ‰§è¡Œçš„å‘½ä»¤å¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œä¸è¿‡å‘½ä»¤é‡Œå¦‚æœæœ‰å¸¦æœ‰å¦‚ä¸‹å­—ç¬¦éƒ¨åˆ†åˆ™æ‰§è¡Œä¸æˆåŠŸ</span> <span class="err">â€œ</span>  <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span>  <span class="s2">&quot;&amp;&quot;</span> <span class="err">ï¼›</span>
<span class="mf">2.</span> <span class="n">shell</span> <span class="err">æ¨¡å—ï¼šç”¨æ³•åŸºæœ¬å’Œ</span><span class="n">command</span><span class="err">ä¸€æ ·ï¼Œä¸è¿‡å…¶æ˜¯é€šè¿‡</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span><span class="err">è¿›è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥</span><span class="n">shell</span> <span class="err">æ¨¡å—å¯ä»¥æ‰§è¡Œä»»ä½•å‘½ä»¤ï¼Œå°±åƒåœ¨æœ¬æœºæ‰§è¡Œä¸€æ ·ï¼›</span>
<span class="mf">3.</span> <span class="n">raw</span><span class="err">æ¨¡å—ï¼šç”¨æ³•å’Œ</span><span class="n">shell</span> <span class="err">æ¨¡å—ä¸€æ ·</span> <span class="err">ï¼Œå…¶ä¹Ÿå¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå°±åƒåœ¨æœ¬æœºæ‰§è¡Œä¸€æ ·ï¼›</span>
<span class="mf">4.</span> <span class="n">script</span><span class="err">æ¨¡å—ï¼šå…¶æ˜¯å°†ç®¡ç†ç«¯çš„</span><span class="n">shell</span> <span class="err">åœ¨è¢«ç®¡ç†ä¸»æœºä¸Šæ‰§è¡Œï¼Œå…¶åŸç†æ˜¯å…ˆå°†</span><span class="n">shell</span> <span class="err">å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºï¼Œå†åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œï¼ŒåŸç†ç±»ä¼¼äº</span><span class="n">raw</span><span class="err">æ¨¡å—</span><span class="p">;</span>

<span class="err">æ³¨ï¼š</span><span class="n">raw</span><span class="err">æ¨¡å—å’Œ</span><span class="n">comand</span><span class="err">ã€</span><span class="n">shell</span> <span class="err">æ¨¡å—ä¸åŒçš„æ˜¯å…¶æ²¡æœ‰</span><span class="n">chdir</span><span class="err">ã€</span><span class="n">creates</span><span class="err">ã€</span><span class="n">removes</span><span class="err">å‚æ•°ï¼Œ</span><span class="n">chdir</span><span class="err">å‚æ•°çš„ä½œç”¨å°±æ˜¯å…ˆåˆ‡åˆ°</span><span class="n">chdir</span><span class="err">æŒ‡å®šçš„ç›®å½•åï¼Œå†æ‰§è¡Œåé¢çš„å‘½ä»¤ï¼Œè¿™åœ¨åé¢å¾ˆå¤šæ¨¡å—é‡Œéƒ½ä¼šæœ‰è¯¥å‚æ•°</span><span class="p">;</span>

<span class="n">command</span><span class="err">æ¨¡å—åŒ…å«å¦‚ä¸‹é€‰é¡¹ï¼š</span> 
    <span class="n">creates</span><span class="err">ï¼šä¸€ä¸ªæ–‡ä»¶åï¼Œå½“è¯¥æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™è¯¥å‘½ä»¤ä¸æ‰§è¡Œ</span> 
    <span class="n">free_form</span><span class="err">ï¼šè¦æ‰§è¡Œçš„</span><span class="n">linux</span><span class="err">æŒ‡ä»¤</span> 
    <span class="n">chdir</span><span class="err">ï¼šåœ¨æ‰§è¡ŒæŒ‡ä»¤ä¹‹å‰ï¼Œå…ˆåˆ‡æ¢åˆ°è¯¥æŒ‡å®šçš„ç›®å½•</span> 
    <span class="n">removes</span><span class="err">ï¼šä¸€ä¸ªæ–‡ä»¶åï¼Œå½“è¯¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è¯¥é€‰é¡¹ä¸æ‰§è¡Œ</span>
    <span class="n">executable</span><span class="err">ï¼šåˆ‡æ¢</span><span class="n">shell</span><span class="err">æ¥æ‰§è¡ŒæŒ‡ä»¤ï¼Œè¯¥æ‰§è¡Œè·¯å¾„å¿…é¡»æ˜¯ä¸€ä¸ªç»å¯¹è·¯å¾„</span>
</pre></div>
</div>
<h2>2.6 å¸¸ç”¨æ¨¡å—</h2>

<p>æ¨¡å—æŒ‰åŠŸèƒ½åˆ†ç±»ä¸ºï¼šäº‘æ¨¡å—ã€å‘½ä»¤æ¨¡å—ã€æ•°æ®åº“æ¨¡å—ã€æ–‡ä»¶æ¨¡å—ã€èµ„äº§æ¨¡å—ã€æ¶ˆæ¯æ¨¡å—ã€ç›‘æ§æ¨¡å—ã€ç½‘ç»œæ¨¡å—ã€é€šçŸ¥æ¨¡å—ã€åŒ…ç®¡ç†æ¨¡å—ã€æºç æ§åˆ¶æ¨¡å—ã€ç³»ç»Ÿæ¨¡å—ã€å•å…ƒæ¨¡å—ã€webè®¾æ–½æ¨¡å—ã€windowsæ¨¡å—;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="nb">file</span><span class="p">:</span><span class="err">ç”¨äºé…ç½®æ–‡ä»¶å±æ€§</span>
<span class="n">yum</span><span class="err">ï¼šç”¨äºå®‰è£…è½¯ä»¶åŒ…</span>
<span class="n">cron</span><span class="err">ï¼šé…ç½®è®¡åˆ’ä»»åŠ¡</span>
<span class="n">copy</span><span class="err">ï¼šå¤åˆ¶æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœº</span>
<span class="n">command</span><span class="err">ï¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤</span>
<span class="n">raw</span><span class="err">ï¼šç±»ä¼¼äº</span><span class="n">command</span><span class="err">æ¨¡å—ï¼Œæ”¯æŒç®¡é“</span>
<span class="n">user</span><span class="err">ï¼šé…ç½®ç”¨æˆ·</span>
<span class="n">group</span><span class="err">ï¼šé…ç½®ç”¨æˆ·ç»„</span>
<span class="n">service</span><span class="err">ï¼šç”¨äºç®¡ç†æœåŠ¡</span>
<span class="n">ping</span><span class="err">ï¼šç”¨äºæ£€æµ‹è¿œç¨‹ä¸»æœºæ˜¯å¦å­˜æ´»</span>
<span class="n">setup</span><span class="err">ï¼šæŸ¥çœ‹è¿œç¨‹ä¸»æœºçš„åŸºæœ¬ä¿¡æ¯</span>
<span class="n">mount</span><span class="err">ï¼šé…ç½®æŒ‚è½½ç‚¹</span>
</pre></div>
</div>
<h3>2.6.1 fileæ¨¡å—</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">group</span><span class="err">ï¼šå®šä¹‰æ–‡ä»¶</span><span class="o">/</span><span class="err">ç›®å½•çš„å±ç»„</span>
<span class="n">owner</span><span class="err">ï¼šå®šä¹‰æ–‡ä»¶</span><span class="o">/</span><span class="err">ç›®å½•çš„å±ä¸»</span>
<span class="n">mode</span><span class="err">ï¼šå®šä¹‰æ–‡ä»¶</span><span class="o">/</span><span class="err">ç›®å½•çš„æƒé™</span>
<span class="n">path</span><span class="err">ï¼šå¿…é€‰é¡¹ï¼Œå®šä¹‰æ–‡ä»¶</span><span class="o">/</span><span class="err">ç›®å½•çš„è·¯å¾„</span>
<span class="n">recurse</span><span class="err">ï¼šé€’å½’è®¾ç½®æ–‡ä»¶çš„å±æ€§ï¼Œåªå¯¹ç›®å½•æœ‰æ•ˆ</span>
<span class="n">state</span><span class="p">:</span><span class="err">å®šä¹‰æ–‡ä»¶çŠ¶æ€</span>
<span class="n">directory</span><span class="err">ï¼šå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç›®å½•</span>
<span class="n">touch</span><span class="err">ï¼šå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶</span>
<span class="n">absent</span><span class="p">:</span><span class="err">åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•</span>
<span class="err">ç¤ºä¾‹ï¼š</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="nb">file</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;src=/etc/fstab dest=/tmp/fstab state=link&quot;</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="nb">file</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;path=/tmp/fstab state=absent&quot;</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="nb">file</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;path=/tmp/test state=touch&quot;</span>
</pre></div>
</div>
<h3>2.6.2 yumæ¨¡å—</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">enablerepo</span><span class="p">:</span><span class="err">å¯ç”¨æŸä¸ªæº</span>
<span class="n">name</span><span class="p">:</span><span class="err">è¦è¿›è¡Œæ“ä½œçš„è½¯ä»¶åŒ…çš„åå­—ï¼Œä¹Ÿå¯ä»¥ä¼ é€’ä¸€ä¸ª</span><span class="n">url</span><span class="err">æˆ–è€…ä¸€ä¸ªæœ¬åœ°çš„</span><span class="n">rpm</span><span class="err">åŒ…çš„è·¯å¾„</span>
<span class="n">state</span><span class="p">:</span><span class="err">å®šä¹‰è½¯ä»¶åŒ…çŠ¶æ€</span>
<span class="n">present</span><span class="p">:</span><span class="err">å®‰è£…</span>
<span class="n">absent</span><span class="err">ï¼šåˆ é™¤</span>
<span class="n">latest</span><span class="err">ï¼šå®‰è£…æœ€æ–°çš„</span>
<span class="err">ç¤ºä¾‹ï¼š</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">yum</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=httpd state=latest&#39;</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">yum</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=&quot;@Development tools&quot; state=present&#39;</span>
    <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">yum</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm state=present&#39;</span>
</pre></div>
</div>
<h3>2.6.3 cronæ¨¡å—</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">backup</span><span class="err">ï¼šå¯¹è¿œç¨‹ä¸»æœºä¸Šçš„åŸä»»åŠ¡è®¡åˆ’å†…å®¹ä¿®æ”¹ä¹‹å‰åšå¤‡ä»½</span>
<span class="n">day</span><span class="err">ï¼šæ—¥ï¼ˆ</span><span class="mi">1</span><span class="o">-</span><span class="mi">31</span><span class="err">ï¼Œ</span><span class="o">*</span><span class="err">ï¼Œ</span><span class="o">*/</span><span class="mi">2</span><span class="p">,</span><span class="err">â€¦â€¦ï¼‰</span>
<span class="n">hour</span><span class="err">ï¼šå°æ—¶ï¼ˆ</span><span class="mi">0</span><span class="o">-</span><span class="mi">23</span><span class="err">ï¼Œ</span><span class="o">*</span><span class="err">ï¼Œ</span><span class="o">*/</span><span class="mi">2</span><span class="err">ï¼Œâ€¦â€¦ï¼‰</span>
<span class="n">minute</span><span class="err">ï¼šåˆ†é’Ÿï¼ˆ</span><span class="mi">0</span><span class="o">-</span><span class="mi">59</span><span class="err">ï¼Œ</span><span class="o">*</span><span class="err">ï¼Œ</span><span class="o">*/</span><span class="mi">2</span><span class="err">ï¼Œâ€¦â€¦ï¼‰</span>
<span class="n">month</span><span class="err">ï¼šæœˆï¼ˆ</span><span class="mi">1</span><span class="o">-</span><span class="mi">12</span><span class="err">ï¼Œ</span><span class="o">*</span><span class="err">ï¼Œ</span><span class="o">*/</span><span class="mi">2</span><span class="err">ï¼Œâ€¦â€¦ï¼‰</span>
<span class="n">weekday</span><span class="err">ï¼šå‘¨ï¼ˆ</span><span class="mi">0</span><span class="o">-</span><span class="mi">7</span><span class="err">ï¼Œ</span><span class="o">*</span><span class="err">ï¼Œâ€¦â€¦ï¼‰</span>
<span class="n">job</span><span class="err">ï¼šè¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¾èµ–äº</span><span class="n">state</span><span class="o">=</span><span class="n">present</span>
<span class="n">name</span><span class="err">ï¼šè¯¥ä»»åŠ¡çš„æè¿°</span>
<span class="n">special_time</span><span class="err">ï¼šæŒ‡å®šä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œå‚æ•°ï¼š</span><span class="n">reboot</span><span class="p">,</span><span class="n">yearly</span><span class="p">,</span><span class="n">annually</span><span class="p">,</span><span class="n">monthly</span><span class="p">,</span><span class="n">weekly</span><span class="p">,</span><span class="n">daily</span><span class="p">,</span><span class="n">hourly</span>
<span class="n">state</span><span class="err">ï¼šç¡®è®¤è¯¥ä»»åŠ¡è®¡åˆ’æ˜¯åˆ›å»ºè¿˜æ˜¯åˆ é™¤</span>
<span class="n">user</span><span class="err">ï¼šä»¥å“ªä¸ªç”¨æˆ·çš„èº«ä»½æ‰§è¡Œ</span>
<span class="err">ç¤ºä¾‹ï¼š</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">cron</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=&quot;check dirs&quot; hour=&quot;5,2&quot; job=&quot;ls -alh &gt; /dev/null&quot;&#39;</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">cron</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;name=&quot;a job for reboot&quot; special_time=reboot job=&quot;/some/job.sh&quot;&#39;</span>
</pre></div>
</div>
<h3>2.6.4 copyæ¨¡å—</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">src</span><span class="p">:</span><span class="err">æºæ–‡ä»¶</span>
<span class="n">dest</span><span class="p">:</span><span class="err">ç›®æ ‡è·¯å¾„</span>
<span class="n">backup</span><span class="p">:</span><span class="err">è¦†ç›–ä¹‹å‰ï¼Œæ˜¯å¦å¤‡ä»½åŸæ–‡ä»¶</span>
<span class="n">owner</span><span class="p">:</span><span class="err">è®¾å®šæ–‡ä»¶</span><span class="o">/</span><span class="err">ç›®å½•çš„å±ä¸»</span>
<span class="n">group</span><span class="p">:</span><span class="err">è®¾å®šæ–‡ä»¶</span><span class="o">/</span><span class="err">ç›®å½•çš„å±ç»„</span>
<span class="n">mode</span><span class="p">:</span><span class="err">è®¾å®šæ–‡ä»¶</span><span class="o">/</span><span class="err">ç›®å½•çš„æƒé™</span>
<span class="err">ç¤ºä¾‹ï¼š</span>
 <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">copy</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;src=/srv/myfiles/foo.conf dest=/etc/foo.conf owner=foo group=foo mode=0644&quot;</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">copy</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;src=/mine/ntp.conf dest=/etc/ntp.conf owner=root group=root mode=644 backup=yes&quot;</span>
</pre></div>
</div>
<h3>2.6.5 command æ¨¡å—</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">creates</span><span class="err">ï¼šä¸€ä¸ªæ–‡ä»¶åï¼Œå½“è¯¥æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™è¯¥å‘½ä»¤ä¸æ‰§è¡Œ</span>
<span class="n">free_form</span><span class="err">ï¼šè¦æ‰§è¡Œçš„</span><span class="n">linux</span><span class="err">æŒ‡ä»¤</span>
<span class="n">chdir</span><span class="err">ï¼šåœ¨æ‰§è¡ŒæŒ‡ä»¤ä¹‹å‰ï¼Œå…ˆåˆ‡æ¢åˆ°è¯¥æŒ‡å®šçš„ç›®å½•</span>
<span class="n">removes</span><span class="err">ï¼šä¸€ä¸ªæ–‡ä»¶åï¼Œå½“è¯¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è¯¥é€‰é¡¹ä¸æ‰§è¡Œ</span>
<span class="err">ç¤ºä¾‹ï¼š</span>
 <span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;/sbin/reboot&quot;</span>
</pre></div>
</div>
<h3>2.6.6 serviceæ¨¡å—</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">arguments</span><span class="err">ï¼šç»™å‘½ä»¤è¡Œæä¾›ä¸€äº›é€‰é¡¹</span>
<span class="n">enabled</span><span class="err">ï¼šæ˜¯å¦å¼€æœºå¯åŠ¨</span>  <span class="n">yes</span><span class="o">|</span><span class="n">no</span>
<span class="n">name</span><span class="err">ï¼šå¿…é€‰é¡¹ï¼ŒæœåŠ¡åç§°</span>
<span class="n">runlevel</span><span class="err">ï¼šè¿è¡Œçº§åˆ«</span>
<span class="n">sleep</span><span class="err">ï¼šå¦‚æœæ‰§è¡Œäº†</span><span class="n">restarted</span><span class="err">ï¼Œåœ¨åˆ™</span><span class="n">stop</span><span class="err">å’Œ</span><span class="n">start</span><span class="err">ä¹‹é—´æ²‰ç¡å‡ ç§’é’Ÿ</span>
<span class="n">state</span><span class="err">ï¼šå¯¹å½“å‰æœåŠ¡æ‰§è¡Œå¯åŠ¨ï¼Œåœæ­¢ã€é‡å¯ã€é‡æ–°åŠ è½½ç­‰æ“ä½œï¼ˆ</span><span class="n">started</span><span class="p">,</span><span class="n">stopped</span><span class="p">,</span><span class="n">restarted</span><span class="p">,</span><span class="n">reloaded</span><span class="err">ï¼‰</span>
<span class="err">ç¤ºä¾‹ï¼š</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;name=httpd state=started enabled=yes&quot;</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;name=foo pattern=/usr/bin/foo state=started&quot;</span>
<span class="n">ansible</span> <span class="n">test</span> <span class="o">-</span><span class="n">m</span> <span class="n">service</span> <span class="o">-</span><span class="n">a</span> <span class="s2">&quot;name=network state=restarted args=eth0&quot;</span>
</pre></div>
</div>
<h3>2.6.7 useræ¨¡å—</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">home</span><span class="p">:</span><span class="err">æŒ‡å®šå®¶ç›®å½•ï¼Œéœ€è¦</span><span class="n">createhome</span><span class="err">ä¸º</span><span class="n">yes</span>
<span class="n">groups</span><span class="p">:</span><span class="err">ç”¨æˆ·ç»„</span>
<span class="n">uid</span><span class="err">ï¼šç”¨æˆ·</span><span class="n">UID</span>
<span class="n">password</span><span class="p">:</span><span class="err">æŒ‡å®šç”¨æˆ·å¯†ç </span>
<span class="n">name</span><span class="p">:</span><span class="err">ç”¨æˆ·å</span>
<span class="n">createhome</span><span class="p">:</span><span class="err">æ˜¯å¦åˆ›å»ºå®¶ç›®å½•</span>
<span class="n">system</span><span class="p">:</span><span class="err">æ˜¯å¦åˆ›å»ºä¸ºç³»ç»Ÿç”¨æˆ·</span>
<span class="n">remove</span><span class="p">:</span><span class="err">ä½†</span><span class="n">state</span><span class="o">=</span><span class="n">absent</span><span class="err">æ—¶ï¼Œåˆ é™¤å®¶ç›®å½•</span>
<span class="n">state</span><span class="p">:</span><span class="err">åˆ›å»ºæˆ–è€…åˆ é™¤</span>
<span class="n">shell</span><span class="p">:</span><span class="err">æŒ‡å®šç”¨æˆ·</span><span class="n">shell</span><span class="err">ç¯å¢ƒ</span>
</pre></div>
</div>
<h3>2.6.8 æ¨¡å—å¸®åŠ©</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">doc</span> <span class="o">-</span><span class="n">l</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">doc</span> <span class="o">-</span><span class="n">s</span> <span class="n">module_name</span>
</pre></div>
</div>
<h3>2.6.9 setupæ¨¡å—</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># Inventoryä¸»æœºé…ç½®</span>
<span class="p">[</span><span class="n">local</span><span class="p">]</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>

<span class="p">[</span><span class="n">rundeck</span><span class="p">]</span>
<span class="mf">120.43</span><span class="o">.</span><span class="mf">103.126</span>

<span class="c1"># è·å–æœ¬åœ°ä¸»æœºä¿¡æ¯</span>
<span class="n">ansible</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span> <span class="n">local</span> <span class="o">-</span><span class="n">u</span> <span class="n">daixiang</span> <span class="o">-</span><span class="n">m</span> <span class="n">setup</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;filter=ansible_all_ipv4_addresses&#39;</span>
<span class="c1"># è·å–è¿œç¨‹ä¸»æœºä¿¡æ¯</span>
<span class="n">ansible</span> <span class="o">-</span><span class="n">i</span> <span class="n">hosts</span> <span class="n">rundeck</span> <span class="o">-</span><span class="n">u</span> <span class="n">will</span> <span class="o">-</span><span class="n">m</span> <span class="n">setup</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;filter=ansible_all_ipv4_addresses&#39;</span>

<span class="c1"># æ³¨é‡Š:</span>
<span class="o">-</span><span class="n">i</span> <span class="n">Inventory</span><span class="err">ä¸»æœºé…ç½®</span>
<span class="o">-</span><span class="n">u</span> <span class="err">ç”¨æˆ·å</span>
<span class="o">-</span><span class="n">m</span> <span class="err">æ¨¡å—</span>
<span class="o">-</span><span class="n">k</span> <span class="err">è¾“å…¥å¯†ç </span>
</pre></div>
</div>
<h2>2.7 PlayBookç®€ä»‹</h2>

<p>ansbile-playbookæ˜¯ä¸€ç³»åˆ—ansibleå‘½ä»¤çš„é›†åˆï¼Œåˆ©ç”¨yaml è¯­è¨€ç¼–å†™ã€‚playbookå‘½ä»¤æ ¹æ®è‡ªä¸Šè€Œä¸‹çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚åŒæ—¶ï¼Œplaybookå¼€åˆ›äº†å¾ˆå¤šç‰¹æ€§,å®ƒå¯ä»¥å…è®¸ä½ ä¼ è¾“æŸä¸ªå‘½ä»¤çš„çŠ¶æ€åˆ°åé¢çš„æŒ‡ä»¤,å¦‚ä½ å¯ä»¥ä»ä¸€å°æœºå™¨çš„æ–‡ä»¶ä¸­æŠ“å–å†…å®¹å¹¶é™„ä¸ºå˜é‡,ç„¶ååœ¨å¦ä¸€å°æœºå™¨ä¸­ä½¿ç”¨,è¿™ä½¿å¾—ä½ å¯ä»¥å®ç°ä¸€äº›å¤æ‚çš„éƒ¨ç½²æœºåˆ¶,è¿™æ˜¯ansibleå‘½ä»¤æ— æ³•å®ç°çš„;</p>

<p>playbooké€šè¿‡ansible-playbookå‘½ä»¤ä½¿ç”¨,å®ƒçš„å‚æ•°å’Œansibleå‘½ä»¤ç±»ä¼¼,å¦‚å‚æ•°-k(â€“ask-pass) å’Œ -K (â€“ask-sudo) æ¥è¯¢é—®sshå¯†ç å’Œsudoå¯†ç ,-uæŒ‡å®šç”¨æˆ·,è¿™äº›æŒ‡ä»¤ä¹Ÿå¯ä»¥é€šè¿‡è§„å®šçš„å•å…ƒå†™åœ¨playbook;</p>

<p>ansible-playbookçš„ç®€å•ä½¿ç”¨æ–¹æ³•: ansible-playbook example-play.yml;</p>

<h3>2.7.1 ç®€å•Playbookå®ä¾‹</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># cat user.yml</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">create</span> <span class="n">user</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>  <span class="c1"># æŒ‡å®šä¸»æœº</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">root</span>  <span class="c1"># æŒ‡å®šç”¨æˆ·</span>
  <span class="n">gather_facts</span><span class="p">:</span> <span class="n">false</span> <span class="c1"># æ˜¯å¦æ‰§è¡Œsetupæ¨¡å—è·å–ä¸»æœºç›¸å…³ä¿¡æ¯,ä»¥ä¾¿äºtaskä½¿ç”¨åˆ°setupè·å–çš„ä¿¡æ¯</span>
  <span class="nb">vars</span><span class="p">:</span> <span class="c1"># æŒ‡å®šå˜é‡</span>
    <span class="n">user</span><span class="p">:</span><span class="s2">&quot;test&quot;</span>
  <span class="n">tasks</span><span class="p">:</span> <span class="c1"># è®¾å®šä»»åŠ¡</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">create</span>  <span class="n">user</span>  <span class="c1"># ä»»åŠ¡åç§°</span>
      <span class="n">user</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;{{ user }}&quot;</span> <span class="c1"># è°ƒç”¨useræ¨¡å—, nameæ˜¯useræ¨¡å—é‡Œçš„ä¸€ä¸ªå‚æ•°ï¼Œè€Œå¢åŠ çš„ç”¨æˆ·åå­—è°ƒç”¨äº†ä¸Šé¢userå˜é‡çš„å€¼</span>
      
<span class="err">æ³¨é‡Š</span><span class="p">:</span> <span class="err">è‹¥æ˜¯åˆ é™¤ç”¨æˆ·å¯æ”¹ä¸º</span>
<span class="n">user</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;{{ user }}&quot;</span> <span class="n">state</span><span class="o">=</span><span class="n">absent</span> <span class="n">remove</span><span class="o">=</span><span class="n">yes</span>
</pre></div>
</div>
<h3>2.7.2 é€šè¿‡Playbookå®‰è£…apache</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># cat install_apache.yml</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
  <span class="n">gather_facts</span><span class="p">:</span><span class="bp">True</span>
  <span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">apache</span> <span class="n">on</span> <span class="n">CentOS</span>
    <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">httpd</span> <span class="n">state</span><span class="o">=</span><span class="n">present</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;CentOS&quot;</span> 
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">apache</span> <span class="n">on</span> <span class="n">Debian</span>
    <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">apache2</span> <span class="n">state</span><span class="o">=</span><span class="n">present</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;Debian&quot;</span>
</pre></div>
</div>
<h3>2.7.3 Playbookçš„æ„æˆ</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">hosts</span>    <span class="err">ä¸»æœºå±‚</span>
<span class="nb">vars</span>     <span class="err">å˜é‡å±‚</span>
    <span class="n">tasks</span>    <span class="err">ä»»åŠ¡å±‚</span>
<span class="n">handlers</span> <span class="err">è§¦å‘æ¡ä»¶</span>
<span class="n">files</span>    <span class="err">æ–‡ä»¶</span>
<span class="n">template</span> <span class="err">æ¨¡æ¿</span>
</pre></div>
</div>
<ul>
<li>Hostså’Œusers</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="n">hosts</span><span class="err">ï¼šç”¨äºæŒ‡å®šè¦æ‰§è¡ŒæŒ‡å®šä»»åŠ¡çš„ä¸»æœºå…¶å¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªç”±å†’å·åˆ†éš”ä¸»æœºç»„ã€‚</span>
<span class="mf">2.</span> <span class="n">remote_user</span> <span class="err">ï¼šç”¨äºæŒ‡å®šè¿œç¨‹ä¸»æœºä¸Šçš„æ‰§è¡Œä»»åŠ¡çš„ç”¨æˆ·ã€‚ä¸è¿‡</span><span class="n">remote_user</span><span class="err">ä¹Ÿå¯ç”¨äºå„</span><span class="n">task</span><span class="err">ä¸­ã€‚ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå…¶é€šè¿‡</span><span class="n">sudo</span><span class="err">çš„æ–¹å¼åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡å…¶å¯ç”¨äº</span><span class="n">play</span><span class="err">å…¨å±€æˆ–æŸä»»åŠ¡ã€‚æ­¤å¤–ç”šè‡³å¯ä»¥åœ¨</span><span class="n">sudo</span><span class="err">æ—¶ä½¿ç”¨</span><span class="n">sudo_user</span><span class="err">æŒ‡å®š</span><span class="n">sudo</span><span class="err">æ—¶åˆ‡æ¢çš„ç”¨æˆ·ã€‚</span>
<span class="mf">3.</span> <span class="n">user</span><span class="err">ï¼šäº</span><span class="n">remote_user</span><span class="err">ç›¸åŒ</span>
<span class="mf">4.</span> <span class="n">sudo</span><span class="err">ï¼šå¦‚æœè®¾ç½®ä¸º</span><span class="n">yes</span><span class="err">ï¼Œæ‰§è¡Œè¯¥ä»»åŠ¡ç»„çš„ç”¨æˆ·åœ¨æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ï¼Œè·å–</span><span class="n">root</span><span class="err">æƒé™</span>
<span class="mf">5.</span> <span class="n">sudo_user</span><span class="err">ï¼šå¦‚æœè®¾ç½®</span><span class="n">user</span><span class="err">ä¸º</span><span class="n">breeze</span><span class="err">ï¼Œ</span><span class="n">sudo</span><span class="err">ä¸º</span><span class="n">yes</span><span class="err">ï¼Œ</span><span class="n">sudo_user</span><span class="err">ä¸º</span><span class="n">bernie</span><span class="err">æ—¶ï¼Œåˆ™</span><span class="n">breeze</span><span class="err">ç”¨æˆ·åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ä¼šè·å¾—</span><span class="n">bernie</span><span class="err">ç”¨æˆ·çš„æƒé™</span>
<span class="mf">6.</span> <span class="n">connection</span><span class="err">ï¼šé€šè¿‡ä»€ä¹ˆæ–¹å¼è¿æ¥åˆ°è¿œç¨‹ä¸»æœºï¼Œé»˜è®¤ä¸º</span><span class="n">ssh</span>
<span class="mf">7.</span> <span class="n">gather_facts</span><span class="err">ï¼šé™¤éæ˜ç¡®è¯´æ˜ä¸éœ€è¦åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œ</span><span class="n">setup</span><span class="err">æ¨¡å—ï¼Œå¦åˆ™é»˜è®¤è‡ªåŠ¨æ‰§è¡Œã€‚å¦‚æœç¡®å®ä¸éœ€è¦</span><span class="n">setup</span><span class="err">æ¨¡å—ä¼ é€’è¿‡æ¥çš„å˜é‡ï¼Œåˆ™å¯ä»¥å°†è¯¥é€‰é¡¹è®¾ç½®ä¸º</span><span class="bp">False</span>
</pre></div>
</div>
<ul>
<li>ä»»åŠ¡åˆ—è¡¨å’ŒAction</li>
</ul>

<p>ä»»åŠ¡åˆ—è¡¨ä¸­çš„å„ä»»åŠ¡æŒ‰æ¬¡åºé€ä¸ªåœ¨hostsä¸­æŒ‡å®šçš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œå³åœ¨æ‰€æœ‰ä¸»æœºä¸Šå®Œæˆç¬¬ä¸€ä¸ªä»»åŠ¡åå†å¼€å§‹ç¬¬äºŒä¸ªã€‚åœ¨è‡ªä¸Šè€Œä¸‹è¿è¡ŒæŸplaybookæ—¶å¦‚æœä¸­é€”å‘ç”Ÿé”™è¯¯ï¼Œæ‰€æœ‰å·²æ‰§è¡Œä»»åŠ¡éƒ½å°†å›æ»šå› æ­¤åœ¨æ›´æ­£playbookåé‡æ–°æ‰§è¡Œä¸€æ¬¡å³å¯;</p>

<p>taskçš„ç›®çš„æ˜¯ä½¿ç”¨æŒ‡å®šçš„å‚æ•°æ‰§è¡Œæ¨¡å—ï¼Œè€Œåœ¨æ¨¡å—å‚æ•°ä¸­å¯ä»¥ä½¿ç”¨å˜é‡ã€‚<code>æ¨¡å—æ‰§è¡Œæ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ„å‘³ç€å¤šæ¬¡æ‰§è¡Œæ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå…¶ç»“æœå‡ä¸€è‡´</code>ã€‚æ¯ä¸ªtaskéƒ½åº”è¯¥æœ‰å…¶nameç”¨äºplaybookçš„æ‰§è¡Œç»“æœè¾“å‡ºï¼Œå»ºè®®å…¶å†…å®¹å°½å¯èƒ½æ¸…æ™°åœ°æè¿°ä»»åŠ¡æ‰§è¡Œæ­¥éª¤ã€‚å¦‚æœæœªæä¾›nameåˆ™actionçš„ç»“æœå°†ç”¨äºè¾“å‡º;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1">#å¦‚æœå‘½ä»¤æˆ–è„šæœ¬çš„é€€å‡ºç ä¸ä¸ºé›¶å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ›¿ä»£</span>
<span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">run</span> <span class="n">this</span> <span class="n">command</span> <span class="ow">and</span> <span class="n">ignore</span> <span class="n">the</span> <span class="n">result</span>
    <span class="n">shell</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">somecommand</span> <span class="o">||</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">true</span>

<span class="c1">#ä½¿ç”¨ignore_errorsæ¥å¿½ç•¥é”™è¯¯ä¿¡æ¯</span>
<span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">run</span> <span class="n">this</span> <span class="n">command</span> <span class="ow">and</span> <span class="n">ignore</span> <span class="n">the</span> <span class="n">result</span>
    <span class="n">shell</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">somecommand</span>
    <span class="n">ignore_errors</span><span class="p">:</span> <span class="bp">True</span>
</pre></div>
</div>
<ul>
<li>è§¦å‘ä»»åŠ¡handlers: ç”¨äºå½“å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶é‡‡å–ä¸€å®šçš„æ“ä½œ</li>
</ul>

<p><q>notify</q>è¿™ä¸ªactionå¯ç”¨äºåœ¨æ¯ä¸ªplayçš„æœ€åè¢«è§¦å‘ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤šæ¬¡æœ‰æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼Œå–è€Œä»£ä¹‹ä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œæˆåä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œ;</p>

<p>åœ¨notifyä¸­åˆ—å‡ºçš„æ“ä½œç§°ä¸ºhandlerä¹Ÿå³notifyä¸­è°ƒç”¨handlerä¸­å®šä¹‰çš„æ“ä½œ;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">template</span> <span class="n">configuration</span> <span class="nb">file</span>
  <span class="n">template</span><span class="p">:</span> <span class="n">src</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">j2</span> <span class="n">dest</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">foo</span><span class="o">.</span><span class="n">conf</span>
  <span class="n">notify</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">restart</span> <span class="n">memcached</span>
  <span class="o">-</span> <span class="n">restart</span> <span class="n">apache</span>

<span class="c1">#handleræ˜¯taskåˆ—è¡¨è¿™äº›taskä¸å‰è¿°çš„taskå¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒã€‚</span>
<span class="n">handlers</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">restart</span> <span class="n">memcached</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">memcached</span> <span class="n">state</span><span class="o">=</span><span class="n">restarted</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">restart</span> <span class="n">apache</span>
    <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">apache</span> <span class="n">state</span><span class="o">=</span><span class="n">restarted</span>
</pre></div>
</div>
<h2>2.8 PlayBookå¸¸ç”¨æ¨¡å—</h2>

<p>playbookçš„æ¨¡å—ä¸åœ¨ansibleå‘½ä»¤è¡Œä¸‹ä½¿ç”¨çš„æ¨¡å—æœ‰ä¸€äº›ä¸åŒã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºåœ¨playbookä¸­ä¼šä½¿ç”¨åˆ°ä¸€äº›<code>set_fact</code>å’Œ<code>é€šè¿‡setupæ¨¡å—</code>ä»è¿œç¨‹ä¸»æœºä¸Šè·å–åˆ°çš„å˜é‡ã€‚æœ‰äº›æ¨¡å—æ²¡æ³•åœ¨å‘½ä»¤è¡Œä¸‹è¿è¡Œï¼Œå°±æ˜¯å› ä¸ºå®ƒä»¬éœ€è¦è¿™äº›å˜é‡ã€‚è€Œä¸”å³ä½¿é‚£äº›å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸‹å·¥ä½œçš„æ¨¡å—ä¹Ÿå¯ä»¥é€šè¿‡playbookçš„æ¨¡å—è·å–ä¸€äº›æ›´é«˜çº§çš„åŠŸèƒ½;</p>

<h3>2.8.1 templateæ¨¡æ¿</h3>

<ul>
<li>å¸¸ç”¨å‚æ•°</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>backupï¼šå¦‚æœåŸç›®æ ‡æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™å…ˆå¤‡ä»½ç›®æ ‡æ–‡ä»¶
destï¼šç›®æ ‡æ–‡ä»¶è·¯å¾„
forceï¼šæ˜¯å¦å¼ºåˆ¶è¦†ç›–ï¼Œé»˜è®¤ä¸ºyes
groupï¼šç›®æ ‡æ–‡ä»¶å±ç»„
modeï¼šç›®æ ‡æ–‡ä»¶çš„æƒé™
ownerï¼šç›®æ ‡æ–‡ä»¶å±ä¸»
srcï¼šæºæ¨¡æ¿æ–‡ä»¶è·¯å¾„
validateï¼šåœ¨å¤åˆ¶ä¹‹å‰é€šè¿‡å‘½ä»¤éªŒè¯ç›®æ ‡æ–‡ä»¶ï¼Œå¦‚æœéªŒè¯é€šè¿‡åˆ™å¤åˆ¶</pre></div></div>

<ul>
<li>å®˜æ–¹ç®€å•ç¤ºä¾‹ï¼š</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>- template: src=/mytemplates/foo.j2 dest=/etc/file.conf owner=bin group=wheel mode=0644
- template: src=/mytemplates/foo.j2 dest=/etc/file.conf owner=bin group=wheel mode="u=rw,g=r,o=r"
- template: src=/mine/sudoers dest=/etc/sudoers validate='visudo -cf %s'</pre></div></div>

<ul>
<li>æˆ‘çš„ä¸€ä¸ªç®€å•ä¾‹å­</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>- name: named 

  #vars_prompt:
  #  - name: 'hosts'
  #    prompt: 'è¯·è¾“å…¥ä¸»æœºåç§°'
  #    private: no
  #    default: 'localhost'

  #hosts: "{{ hosts }}"
  hosts: "localhost"

  tasks:
    - name: named
      template: src=templates/named.conf.j2 dest=named.conf owner=daixiang group=staff mode=0640</pre></div></div>

<h3>2.8.2 set_fact è‡ªå®šä¹‰facts</h3>

<p>set_factæ¨¡å—å¯ä»¥è‡ªå®šä¹‰factsï¼Œè¿™äº›è‡ªå®šä¹‰çš„factså¯ä»¥é€šè¿‡templateæˆ–è€…å˜é‡çš„æ–¹å¼åœ¨playbookä¸­ä½¿ç”¨;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">ä¸‹é¢æ˜¯ä¸€ä¸ªé…ç½®</span><span class="n">mysql</span> <span class="n">innodb</span> <span class="nb">buffer</span> <span class="n">size</span><span class="err">çš„ç¤ºä¾‹ï¼š</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Configure</span> <span class="n">MySQL</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="n">mysqlservers</span>
  <span class="n">tasks</span><span class="p">:</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">install</span> <span class="n">MySql</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">mysql</span><span class="o">-</span><span class="n">server</span> <span class="n">state</span><span class="o">=</span><span class="n">installed</span>

    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Calculate</span> <span class="n">InnoDB</span> <span class="nb">buffer</span> <span class="n">pool</span> <span class="n">size</span>
      <span class="n">set_fact</span><span class="p">:</span> <span class="n">innodb_buffer_pool_size_mb</span><span class="o">=</span><span class="s2">&quot;{{ ansible_memtotal_mb / 2 }}&quot;</span>

    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Configure</span> <span class="n">MySQL</span> 
      <span class="n">template</span><span class="p">:</span> <span class="n">src</span><span class="o">=</span><span class="n">templates</span><span class="o">/</span><span class="n">my</span><span class="o">.</span><span class="n">cnf</span> <span class="n">dest</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="o">.</span><span class="n">cnf</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0644</span> 
      <span class="n">notify</span><span class="p">:</span> <span class="n">restart</span> <span class="n">mysql</span> 

    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Start</span> <span class="n">MySQL</span> 
      <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">mysqld</span> <span class="n">state</span><span class="o">=</span><span class="n">started</span> <span class="n">enabled</span><span class="o">=</span><span class="n">yes</span> 
  <span class="n">handlers</span><span class="p">:</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">restart</span> <span class="n">mysql</span> 
      <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">mysqld</span> <span class="n">state</span><span class="o">=</span><span class="n">restarted</span>
</pre></div>
</div>
<h3>2.8.3 pause æš‚åœ</h3>

<p>åœ¨playbookæ‰§è¡Œçš„è¿‡ç¨‹ä¸­æš‚åœä¸€å®šæ—¶é—´æˆ–è€…æç¤ºç”¨æˆ·è¿›è¡ŒæŸäº›æ“ä½œ
- å¸¸ç”¨å‚æ•°</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">minutes</span><span class="err">ï¼šæš‚åœå¤šå°‘åˆ†é’Ÿ</span>
<span class="n">seconds</span><span class="err">ï¼šæš‚åœå¤šå°‘ç§’</span>
<span class="n">prompt</span><span class="err">ï¼šæ‰“å°ä¸€ä¸²ä¿¡æ¯æç¤ºç”¨æˆ·æ“ä½œ</span>
<span class="err">ç¤ºä¾‹ï¼š</span>
 <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">wait</span> <span class="n">on</span> <span class="n">user</span> <span class="nb">input</span>
   <span class="n">pause</span><span class="p">:</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Warning! Detected slight issue. ENTER to continue CTRL-C a to quit&quot;</span> 
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">timed</span> <span class="n">wait</span>
  <span class="n">pause</span><span class="p">:</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">30</span>
</pre></div>
</div>
<h3>2.8.4 wait_for ç­‰å¾…æŸä»»åŠ¡å®Œæˆ</h3>

<p>åœ¨playbookçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç­‰å¾…æŸäº›æ“ä½œå®Œæˆä»¥åå†è¿›è¡Œåç»­æ“ä½œ</p>

<ul>
<li>å¸¸ç”¨å‚æ•°</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">connect_timeout</span><span class="err">ï¼šåœ¨ä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œä¹‹å‰ç­‰å¾…è¿æ¥çš„è¶…æ—¶æ—¶é—´</span>
<span class="n">delay</span><span class="err">ï¼šç­‰å¾…ä¸€ä¸ªç«¯å£æˆ–è€…æ–‡ä»¶æˆ–è€…è¿æ¥åˆ°æŒ‡å®šçš„çŠ¶æ€æ—¶ï¼Œé»˜è®¤è¶…æ—¶æ—¶é—´ä¸º</span><span class="mi">300</span><span class="err">ç§’ï¼Œåœ¨è¿™ç­‰å¾…çš„</span><span class="mi">300</span><span class="n">s</span><span class="err">çš„æ—¶é—´é‡Œï¼Œ</span><span class="n">wait_for</span><span class="err">æ¨¡å—ä¼šä¸€ç›´è½®è¯¢æŒ‡å®šçš„å¯¹è±¡æ˜¯å¦åˆ°è¾¾æŒ‡å®šçš„çŠ¶æ€ï¼Œ</span><span class="n">delay</span><span class="err">å³ä¸ºå¤šé•¿æ—¶é—´è½®è¯¢ä¸€æ¬¡çŠ¶æ€ã€‚</span>
<span class="n">host</span><span class="err">ï¼š</span><span class="n">wait_for</span><span class="err">æ¨¡å—ç­‰å¾…çš„ä¸»æœºçš„åœ°å€ï¼Œé»˜è®¤ä¸º</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
<span class="n">port</span><span class="err">ï¼š</span><span class="n">wait_for</span><span class="err">æ¨¡å—å¾…å¾…çš„ä¸»æœºçš„ç«¯å£</span>
<span class="n">path</span><span class="err">ï¼šæ–‡ä»¶è·¯å¾„ï¼Œåªæœ‰å½“è¿™ä¸ªæ–‡ä»¶å­˜åœ¨æ—¶ï¼Œä¸‹ä¸€ä»»åŠ¡æ‰å¼€å§‹æ‰§è¡Œï¼Œå³ç­‰å¾…è¯¥æ–‡ä»¶åˆ›å»ºå®Œæˆ</span>
<span class="n">state</span><span class="err">ï¼šç­‰å¾…çš„çŠ¶æ€ï¼Œå³ç­‰å¾…çš„æ–‡ä»¶æˆ–ç«¯å£æˆ–è€…è¿æ¥çŠ¶æ€è¾¾åˆ°æŒ‡å®šçš„çŠ¶æ€æ—¶ï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹æ‰§è¡Œã€‚å½“ç­‰çš„å¯¹è±¡ä¸ºç«¯å£æ—¶ï¼ŒçŠ¶æ€æœ‰</span><span class="n">started</span><span class="err">ï¼Œ</span><span class="n">stoped</span><span class="err">ï¼Œå³ç«¯å£å·²ç»ç›‘å¬æˆ–è€…ç«¯å£å·²ç»å…³é—­ï¼›å½“ç­‰å¾…çš„å¯¹è±¡ä¸ºæ–‡ä»¶æ—¶ï¼ŒçŠ¶æ€æœ‰</span><span class="n">present</span><span class="err">æˆ–è€…</span><span class="n">started</span><span class="err">ï¼Œ</span><span class="n">absent</span><span class="err">ï¼Œå³æ–‡ä»¶å·²åˆ›å»ºæˆ–è€…åˆ é™¤ï¼›å½“ç­‰å¾…çš„å¯¹è±¡ä¸ºä¸€ä¸ªè¿æ¥æ—¶ï¼ŒçŠ¶æ€æœ‰</span><span class="n">drained</span><span class="err">ï¼Œå³è¿æ¥å·²å»ºç«‹ã€‚é»˜è®¤ä¸º</span><span class="n">started</span>
<span class="n">timeout</span><span class="err">ï¼š</span><span class="n">wait_for</span><span class="err">çš„ç­‰å¾…çš„è¶…æ—¶æ—¶é—´</span><span class="p">,</span><span class="err">é»˜è®¤ä¸º</span><span class="mi">300</span><span class="err">ç§’</span>
</pre></div>
</div>
<ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span> <span class="n">state</span><span class="o">=</span><span class="n">started</span>     <span class="c1">#ç­‰å¾…8080ç«¯å£å·²æ­£å¸¸ç›‘å¬ï¼Œæ‰å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œç›´åˆ°è¶…æ—¶</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span>    <span class="c1">#ç­‰å¾…8000ç«¯å£æ­£å¸¸ç›‘å¬ï¼Œæ¯éš”10sæ£€æŸ¥ä¸€æ¬¡ï¼Œç›´è‡³ç­‰å¾…è¶…æ—¶</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">host</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span> <span class="n">state</span><span class="o">=</span><span class="n">drained</span>    <span class="c1">#ç­‰å¾…8000ç«¯å£ç›´è‡³æœ‰è¿æ¥å»ºç«‹</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">host</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span> <span class="n">state</span><span class="o">=</span><span class="n">drained</span> <span class="n">exclude_hosts</span><span class="o">=</span><span class="mf">10.2</span><span class="o">.</span><span class="mf">1.2</span><span class="p">,</span><span class="mf">10.2</span><span class="o">.</span><span class="mf">1.3</span>    <span class="c1">#ç­‰å¾…8000ç«¯å£æœ‰è¿æ¥å»ºç«‹ï¼Œå¦‚æœè¿æ¥æ¥è‡ª10.2.1.2æˆ–è€…10.2.1.3ï¼Œåˆ™å¿½ç•¥ã€‚</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">foo</span>    <span class="c1">#ç­‰å¾…/tmp/fooæ–‡ä»¶å·²åˆ›å»º</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">foo</span> <span class="n">search_regex</span><span class="o">=</span><span class="n">completed</span>    <span class="c1">#ç­‰å¾…/tmp/fooæ–‡ä»¶å·²åˆ›å»ºï¼Œè€Œä¸”è¯¥æ–‡ä»¶ä¸­éœ€è¦åŒ…å«completedå­—ç¬¦ä¸²</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lock</span><span class="o">/</span><span class="nb">file</span><span class="o">.</span><span class="n">lock</span> <span class="n">state</span><span class="o">=</span><span class="n">absent</span>    <span class="c1">#ç­‰å¾…/var/lock/file.lockè¢«åˆ é™¤</span>
<span class="o">-</span> <span class="n">wait_for</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">proc</span><span class="o">/</span><span class="mi">3466</span><span class="o">/</span><span class="n">status</span> <span class="n">state</span><span class="o">=</span><span class="n">absent</span>        <span class="c1">#ç­‰å¾…æŒ‡å®šçš„è¿›ç¨‹è¢«é”€æ¯</span>
<span class="o">-</span> <span class="n">local_action</span><span class="p">:</span> <span class="n">wait_for</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;{{ ansible_ssh_host | default(inventory_hostname) }}&quot;</span> <span class="n">search_regex</span><span class="o">=</span><span class="n">OpenSSH</span> <span class="n">delay</span><span class="o">=</span><span class="mi">10</span>    <span class="c1">#ç­‰å¾…opensshå¯åŠ¨ï¼Œ10sæ£€æŸ¥ä¸€æ¬¡</span>
</pre></div>
</div>
<h3>2.8.5 assemble åˆå¹¶æ–‡ä»¶</h3>

<p>ç”¨äºç»„è£…æ–‡ä»¶ï¼Œå³å°†å¤šä¸ªé›¶æ•£çš„æ–‡ä»¶ï¼Œåˆå¹¶ä¸€ä¸ªå¤§æ–‡ä»¶</p>

<ul>
<li>å¸¸ç”¨å‚æ•°</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">src</span><span class="err">ï¼šåŸæ–‡ä»¶</span><span class="p">(</span><span class="err">å³é›¶æ•£æ–‡ä»¶</span><span class="p">)</span><span class="err">çš„è·¯å¾„</span>
<span class="n">dest</span><span class="err">ï¼šåˆå¹¶åçš„å¤§æ–‡ä»¶è·¯å¾„</span>
<span class="n">group</span><span class="err">ï¼šåˆå¹¶åçš„å¤§æ–‡ä»¶çš„å±ç»„</span>
<span class="n">owner</span><span class="err">ï¼šåˆå¹¶åçš„å¤§æ–‡ä»¶çš„å±ä¸»</span>
<span class="n">mode</span><span class="err">ï¼šåˆå¹¶åçš„å¤§æ–‡ä»¶çš„æƒé™</span>
<span class="n">validate</span><span class="err">ï¼šä¸</span><span class="n">template</span><span class="err">çš„</span><span class="n">validate</span><span class="err">ç›¸åŒï¼ŒæŒ‡å®šå‘½ä»¤éªŒè¯æ–‡ä»¶</span>
<span class="n">ignore_hidden</span><span class="err">ï¼šç»„è£…æ—¶ï¼Œæ˜¯å¦å¿½ç•¥éšè—æ–‡ä»¶ï¼Œé»˜è®¤ä¸º</span><span class="n">no</span><span class="err">ï¼Œè¯¥å‚æ•°åœ¨</span><span class="mf">2.0</span><span class="err">ç‰ˆæœ¬ä¸­æ–°å¢</span>
</pre></div>
</div>
<ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span> 
  <span class="n">tasks</span><span class="p">:</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Make</span> <span class="n">a</span> <span class="n">Directory</span> <span class="ow">in</span> <span class="o">/</span><span class="n">opt</span>
      <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">sshkeys</span> <span class="n">state</span><span class="o">=</span><span class="n">directory</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0700</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Copy</span> <span class="n">SSH</span> <span class="n">keys</span> <span class="n">over</span> 
      <span class="n">copy</span><span class="p">:</span> <span class="n">src</span><span class="o">=</span><span class="n">keys</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span><span class="o">.</span><span class="n">pub</span> <span class="n">dest</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">sshkeys</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span><span class="o">.</span><span class="n">pub</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0600</span> 
      <span class="n">with_items</span><span class="p">:</span> 
        <span class="o">-</span> <span class="n">dan</span> 
        <span class="o">-</span> <span class="n">kate</span> 
        <span class="o">-</span> <span class="n">mal</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Make</span> <span class="n">the</span> <span class="n">root</span> <span class="n">users</span> <span class="n">SSH</span> <span class="n">config</span> <span class="n">directory</span> 
      <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">ssh</span> <span class="n">state</span><span class="o">=</span><span class="n">directory</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0700</span> 

    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Build</span> <span class="n">the</span> <span class="n">authorized_keys</span> <span class="nb">file</span> 
      <span class="n">assemble</span><span class="p">:</span> <span class="n">src</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">sshkeys</span><span class="o">/</span> <span class="n">dest</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0700</span>   <span class="c1">#å°†/opt/sshkeysç›®å½•é‡Œæ‰€æœ‰çš„æ–‡ä»¶åˆå¹¶åˆ°/root/.ssh/authorized_keysä¸€ä¸ªæ–‡ä»¶ä¸­</span>
</pre></div>
</div>
<h3>2.8.6 add_host åŠ¨æ€æ·»åŠ ä¸»æœº</h3>

<p>åœ¨playbookæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€çš„æ·»åŠ ä¸»æœºåˆ°æŒ‡å®šçš„ä¸»æœºç»„ä¸­</p>

<ul>
<li>å¸¸ç”¨å‚æ•°</li>
</ul>

<p>groupsï¼šæ·»åŠ ä¸»æœºè‡³æŒ‡å®šçš„ç»„
nameï¼šè¦æ·»åŠ çš„ä¸»æœºåæˆ–IPåœ°å€</p>

<ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">add</span> <span class="n">a</span> <span class="n">host</span> <span class="n">to</span> <span class="n">group</span> <span class="n">webservers</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">add_host</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">ip_from_ec2</span> <span class="p">}}</span> <span class="n">group</span><span class="o">=</span><span class="n">webservers</span> <span class="n">foo</span><span class="o">=</span><span class="mi">42</span>    <span class="c1">#æ·»åŠ ä¸»æœºåˆ°webserversç»„ä¸­ï¼Œä¸»æœºçš„å˜é‡fooçš„å€¼ä¸º42</span>
</pre></div>
</div>
<h3>2.8.7 group_by åŠ¨æ€åˆ›å»ºä¸»æœºç»„</h3>

<p>åœ¨playbookæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€çš„åˆ›å»ºä¸»æœºç»„</p>

<ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Create</span> <span class="n">operating</span> <span class="n">system</span> <span class="n">group</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">group_by</span><span class="p">:</span> <span class="n">key</span><span class="o">=</span><span class="n">os_</span><span class="p">{{</span> <span class="n">ansible_distribution</span> <span class="p">}}</span>           <span class="c1">#åœ¨playbookä¸­è®¾ç½®ä¸€ä¸ªæ–°çš„ä¸»æœºç»„</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Run</span> <span class="n">on</span> <span class="n">CentOS</span> <span class="n">hosts</span> <span class="n">only</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="n">os_CentOS</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Install</span> <span class="n">Apache</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">httpd</span> <span class="n">state</span><span class="o">=</span><span class="n">latest</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Run</span> <span class="n">on</span> <span class="n">Ubuntu</span> <span class="n">hosts</span> <span class="n">only</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="n">os_Ubuntu</span>
  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Install</span> <span class="n">Apache</span>
      <span class="n">apt</span><span class="p">:</span> <span class="n">pkg</span><span class="o">=</span><span class="n">apache2</span> <span class="n">state</span><span class="o">=</span><span class="n">latest</span>
</pre></div>
</div>
<h3>2.8.8 debugè°ƒè¯•</h3>

<p>è°ƒè¯•æ¨¡å—ï¼Œç”¨äºåœ¨è°ƒè¯•ä¸­è¾“å‡ºä¿¡æ¯</p>

<ul>
<li>å¸¸ç”¨å‚æ•°</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">msg</span><span class="err">ï¼šè°ƒè¯•è¾“å‡ºçš„æ¶ˆæ¯</span>
<span class="n">var</span><span class="err">ï¼šå°†æŸä¸ªä»»åŠ¡æ‰§è¡Œçš„è¾“å‡ºä½œä¸ºå˜é‡ä¼ é€’ç»™</span><span class="n">debug</span><span class="err">æ¨¡å—ï¼Œ</span><span class="n">debug</span><span class="err">ä¼šç›´æ¥å°†å…¶æ‰“å°è¾“å‡º</span>
<span class="n">verbosity</span><span class="err">ï¼š</span><span class="n">debug</span><span class="err">çš„çº§åˆ«</span>
</pre></div>
</div>
<ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># Example that prints the loopback address and gateway for each host- debug: msg=&quot;System {{ inventory_hostname }} has uuid {{ ansible_product_uuid }}&quot;</span>

<span class="o">-</span> <span class="n">debug</span><span class="p">:</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;System {{ inventory_hostname }} has gateway {{ ansible_default_ipv4.gateway }}&quot;</span>
  <span class="n">when</span><span class="p">:</span> <span class="n">ansible_default_ipv4</span><span class="o">.</span><span class="n">gateway</span> <span class="ow">is</span> <span class="n">defined</span>

<span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">uptime</span>
  <span class="n">register</span><span class="p">:</span> <span class="n">result</span>

<span class="o">-</span> <span class="n">debug</span><span class="p">:</span> <span class="n">var</span><span class="o">=</span><span class="n">result</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span>    <span class="c1">#ç›´æ¥å°†ä¸Šä¸€æ¡æŒ‡ä»¤çš„ç»“æœä½œä¸ºå˜é‡ä¼ é€’ç»™varï¼Œç”±debugæ‰“å°å‡ºresultçš„å€¼</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Display</span> <span class="nb">all</span> <span class="n">variables</span><span class="o">/</span><span class="n">facts</span> <span class="n">known</span> <span class="k">for</span> <span class="n">a</span> <span class="n">host</span>
  <span class="n">debug</span><span class="p">:</span> <span class="n">var</span><span class="o">=</span><span class="n">hostvars</span><span class="p">[</span><span class="n">inventory_hostname</span><span class="p">]</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">4</span>
</pre></div>
</div>
<h3>2.8.9 failç»ˆæ­¢å½“å‰playbookçš„æ‰§è¡Œ</h3>

<p>ç”¨äºç»ˆæ­¢å½“å‰playbookçš„æ‰§è¡Œï¼Œé€šå¸¸ä¸æ¡ä»¶è¯­å¥ç»„åˆä½¿ç”¨ï¼Œå½“æ»¡è¶³æ¡ä»¶æ—¶ï¼Œç»ˆæ­¢å½“å‰playçš„è¿è¡Œã€‚å¯ä»¥ç›´æ¥ç”±failed_whenå–ä»£ã€‚</p>

<p>é€‰é¡¹åªæœ‰ä¸€ä¸ªï¼š
msgï¼šç»ˆæ­¢å‰æ‰“å°å‡ºä¿¡æ¯</p>

<ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">fail</span><span class="p">:</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;The system may not be provisioned according to the CMDB status.&quot;</span>
  <span class="n">when</span><span class="p">:</span> <span class="n">cmdb_status</span> <span class="o">!=</span> <span class="s2">&quot;to-be-staged&quot;</span>
</pre></div>
</div>
<h2>2.9 PlayBookçš„å¾ªç¯</h2>

<h3>2.9.1 with_items æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„å¾ªç¯è¯­å¥</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ç®€å•ä¾‹å­</span>

<span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Secure</span> <span class="n">config</span> <span class="n">files</span>
    <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0600</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span>
    <span class="n">with_items</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">my</span><span class="o">.</span><span class="n">cnf</span>
        <span class="o">-</span> <span class="n">shadow</span>
        <span class="o">-</span> <span class="n">fstab</span>

<span class="c1"># ä¹Ÿå¯ä»¥å°†å¾ªç¯å†…å®¹æå‰ä¼ å…¥ä¸€ä¸ªå˜é‡</span>
<span class="n">with_items</span><span class="p">:</span> <span class="s2">&quot;{{ somelist }}&quot;</span>

<span class="c1"># å­—å…¸ç±»å‹</span>
<span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">add</span> <span class="n">several</span> <span class="n">users</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="p">}}</span> <span class="n">state</span><span class="o">=</span><span class="n">present</span> <span class="n">groups</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span><span class="o">.</span><span class="n">groups</span> <span class="p">}}</span>
  <span class="n">with_items</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;testuser1&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="p">:</span> <span class="s1">&#39;wheel&#39;</span> <span class="p">}</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;testuser2&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span> <span class="p">}</span>
</pre></div>
</div>
<h3>2.9.2 with_nestedåµŒå¥—å¾ªç¯, æ’åˆ—ç»„åˆ</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">give</span> <span class="n">users</span> <span class="n">access</span> <span class="n">to</span> <span class="n">multiple</span> <span class="n">databases</span>
  <span class="n">mysql_user</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">}}</span> <span class="n">priv</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">}}</span><span class="o">.*</span><span class="p">:</span><span class="n">ALL</span> <span class="n">append_privs</span><span class="o">=</span><span class="n">yes</span> <span class="n">password</span><span class="o">=</span><span class="n">foo</span>
  <span class="n">with_nested</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">[</span> <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="s1">&#39;bob&#39;</span> <span class="p">]</span>
    <span class="o">-</span> <span class="p">[</span> <span class="s1">&#39;clientdb&#39;</span><span class="p">,</span> <span class="s1">&#39;employeedb&#39;</span><span class="p">,</span> <span class="s1">&#39;providerdb&#39;</span> <span class="p">]</span>
</pre></div>
</div>
<h3>2.9.3 with_dictéå†æ›´å¤æ‚çš„æ•°æ®ç»“æ„</h3>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>å‡å¦‚æœ‰å¦‚ä¸‹å˜é‡å†…å®¹ï¼š
users:
  alice:
    name: Alice Appleworth
    telephone: 123-456-7890
  bob:
    name: Bob Bananarama
    telephone: 987-654-3210

ç°åœ¨éœ€è¦è¾“å‡ºæ¯ä¸ªç”¨æˆ·çš„ç”¨æˆ·åå’Œæ‰‹æœºå·ï¼š
tasks:
  - name: Print phone records
    debug: msg="User {{ item.key }} is {{ item.value.name }} ({{ item.value.telephone }})"
    with_dict: "{{ users }}"</pre></div></div>

<h3>2.9.4 with_fileglobæ–‡ä»¶åŒ¹é…éå†</h3>

<p>å¯ä»¥æŒ‡å®šä¸€ä¸ªç›®å½•ï¼Œä½¿ç”¨with_fileglobå¯ä»¥å¾ªç¯è¿™ä¸ªç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Make</span> <span class="n">key</span> <span class="n">directory</span>     
      <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">sshkeys</span> <span class="n">ensure</span><span class="o">=</span><span class="n">directory</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0700</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span>     
<span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Upload</span> <span class="n">public</span> <span class="n">keys</span>     
      <span class="n">copy</span><span class="p">:</span> <span class="n">src</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span> <span class="n">dest</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">sshkeys</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0600</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span>     
      <span class="n">with_fileglob</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">keys</span><span class="o">/*.</span><span class="n">pub</span>     
<span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Assemble</span> <span class="n">keys</span> <span class="n">into</span> <span class="n">authorized_keys</span> <span class="nb">file</span>     
      <span class="n">assemble</span><span class="p">:</span> <span class="n">src</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">sshkeys</span> <span class="n">dest</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keysmode</span><span class="o">=</span><span class="mo">0600</span> <span class="n">owner</span><span class="o">=</span><span class="n">root</span> <span class="n">group</span><span class="o">=</span><span class="n">root</span>
</pre></div>
</div>
<p><a href="http://breezey.blog.51cto.com/2400275/1757636">è¯¦æƒ…è¯·å‚è€ƒ</a></p>

<h2>2.10 Ansibleæ¡ä»¶è¯­å¥</h2>

<p>åœ¨æœ‰çš„æ—¶å€™playçš„ç»“æœä¾èµ–äºå˜é‡ã€factæˆ–è€…æ˜¯å‰ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œä»è€Œéœ€è¦ä½¿ç”¨åˆ°æ¡ä»¶è¯­å¥</p>

<h3>2.10.1 åŸºæœ¬ä½¿ç”¨</h3>

<ul>
<li>when</li>
</ul>

<p>æœ‰çš„æ—¶å€™åœ¨ç‰¹å®šçš„ä¸»æœºéœ€è¦è·³è¿‡ç‰¹å®šçš„æ­¥éª¤ï¼Œä¾‹å¦‚åœ¨å®‰è£…åŒ…çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šä¸»æœºçš„æ“ä½œç³»ç»Ÿç±»å‹ï¼Œæˆ–è€…æ˜¯å½“æ“ä½œç³»ç»Ÿçš„ç¡¬ç›˜æ»¡äº†ä¹‹åï¼Œéœ€è¦æ¸…ç©ºæ–‡ä»¶ç­‰,å¯ä»¥ä½¿ç”¨whenè¯­å¥æ¥åšåˆ¤æ–­ ã€‚whenå…³é”®å­—åé¢è·Ÿç€çš„æ˜¯pythonçš„è¡¨è¾¾å¼,åœ¨è¡¨è¾¾å¼ä¸­ä½ èƒ½å¤Ÿä½¿ç”¨ä»»ä½•çš„å˜é‡æˆ–è€…fact,å½“è¡¨è¾¾å¼çš„ç»“æœè¿”å›çš„æ˜¯false,ä¾¿ä¼šè·³è¿‡æœ¬æ¬¡çš„ä»»åŠ¡;</p>

<ul>
<li>åŸºæœ¬ç”¨æ³•ï¼Œç¤ºä¾‹</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Install</span> <span class="n">VIM</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Install</span> <span class="n">VIM</span> <span class="n">via</span> <span class="n">yum</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">vim</span><span class="o">-</span><span class="n">enhanced</span> <span class="n">state</span><span class="o">=</span><span class="n">installed</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;RedHat&quot;</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span><span class="n">Install</span> <span class="n">VIM</span> <span class="n">via</span> <span class="n">apt</span>
      <span class="n">apt</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">vim</span> <span class="n">state</span><span class="o">=</span><span class="n">installed</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;Debian&quot;</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Unexpected</span> <span class="n">OS</span> <span class="n">family</span>
      <span class="n">debug</span><span class="p">:</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;OS Family {{ ansible_os_family }} is not supported&quot;</span> <span class="n">fail</span><span class="o">=</span><span class="n">yes</span>
      <span class="n">when</span><span class="p">:</span> <span class="ow">not</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;RedHat&quot;</span> <span class="ow">or</span> <span class="n">ansible_os_family</span> <span class="o">==</span><span class="s2">&quot;Debian&quot;</span>
</pre></div>
</div>
<ul>
<li>ç­‰å¾…è¾“å…¥ç¡®è®¤</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">pause</span> <span class="k">for</span> <span class="n">unexpected</span> <span class="n">conditions</span>
  <span class="n">pause</span><span class="p">:</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Unexpected OS&quot;</span>
  <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">!=</span><span class="s2">&quot;RedHat&quot;</span>
</pre></div>
</div>
<ul>
<li>whenä¸­ä½¿ç”¨jinja2</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">false</span>
    <span class="n">register</span><span class="p">:</span> <span class="n">result</span>        <span class="c1">#å°†å‘½ä»¤æ‰§è¡Œçš„ç»“æœä¼ é€’ç»™resultå˜é‡</span>
    <span class="n">ignore_errors</span><span class="p">:</span> <span class="bp">True</span>    <span class="c1">#å¿½ç•¥é”™è¯¯</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">something</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">result</span><span class="o">|</span><span class="n">failed</span>    <span class="c1">#å¦‚æœæ³¨å†Œå˜é‡çš„å€¼ æ˜¯ä»»åŠ¡failedåˆ™è¿”å›true</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">something_else</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">result</span><span class="o">|</span><span class="n">success</span>    <span class="c1">#å¦‚æœæ³¨å†Œå˜é‡çš„å€¼æ˜¯ä»»åŠ¡successåˆ™è¿”å›true</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">still</span><span class="o">/</span><span class="n">something_else</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">result</span><span class="o">|</span><span class="n">skipped</span>    <span class="c1">#å¦‚æœæ³¨å†Œå˜é‡çš„å€¼æ˜¯ä»»åŠ¡skippedåˆ™è¿”å›true</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">foo</span>
    <span class="n">when</span><span class="p">:</span> <span class="n">result</span><span class="o">|</span><span class="n">changed</span>    <span class="c1">#å¦‚æœæ³¨å†Œå˜é‡çš„å€¼æ˜¯ä»»åŠ¡changedåˆ™è¿”å›true</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">user</span><span class="p">:</span> <span class="n">root</span>
  <span class="nb">vars</span><span class="p">:</span>
    <span class="n">epic</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">tasks</span><span class="p">:</span>    <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;This certainly is epic!&quot;</span>      <span class="n">when</span><span class="p">:</span> <span class="n">epic</span>
    <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;This certainly is not epic!&quot;</span>
      <span class="n">when</span><span class="p">:</span> <span class="ow">not</span> <span class="n">epic</span>
</pre></div>
</div>
<ul>
<li>å¦‚æœå˜é‡ä¸å­˜åœ¨ï¼Œåˆ™å¯ä»¥é€šè¿‡jinja2çš„&#39;defined&#39;å‘½ä»¤è·³è¿‡ï¼Œç¤ºä¾‹ï¼š</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;I&#39;ve got &#39;{{ foo }}&#39; and am not afraid to use it!&quot;</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">foo</span> <span class="ow">is</span> <span class="n">defined</span>
    <span class="o">-</span> <span class="n">fail</span><span class="p">:</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Bailing out. this play requires &#39;bar&#39;&quot;</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
</pre></div>
</div>
<ul>
<li>whenåœ¨å¾ªç¯è¯­å¥ä¸­çš„ä½¿ç”¨æ–¹æ³•ï¼Œç¤ºä¾‹ï¼š</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">command</span><span class="p">:</span> <span class="n">echo</span> <span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span>
      <span class="n">with_items</span><span class="p">:</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span> <span class="p">]</span>
      <span class="n">when</span><span class="p">:</span> <span class="n">item</span> <span class="o">&gt;</span> <span class="mi">56</span><span class="err">ã€åœ¨</span><span class="n">include</span><span class="err">å’Œ</span><span class="n">roles</span><span class="err">ä¸­ä½¿ç”¨</span><span class="n">when</span><span class="err">ï¼š</span>
<span class="err">åœ¨</span><span class="n">include</span><span class="err">ä¸­ä½¿ç”¨çš„ç¤ºä¾‹ï¼š</span><span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">tasks</span><span class="o">/</span><span class="n">sometasks</span><span class="o">.</span><span class="n">yml</span>
  <span class="n">when</span><span class="p">:</span> <span class="s2">&quot;&#39;reticulating splines&#39; in output&quot;</span>
<span class="err">åœ¨</span><span class="n">roles</span><span class="err">ä¸­ä½¿ç”¨çš„ç¤ºä¾‹ï¼š</span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
     <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">debian_stock_config</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="n">ansible_os_family</span> <span class="o">==</span> <span class="s1">&#39;Debian&#39;</span> <span class="p">}</span>
</pre></div>
</div>
<p><a href="http://breezey.blog.51cto.com/2400275/1757593">è¯¦æƒ…è¯·å‚è€ƒ</a></p>

<h2>2.10 PlayBookçš„roleså’Œinclude</h2>

<p><a href="http://breezey.blog.51cto.com/2400275/1757832">è¯¦æƒ…è¯·å‚è€ƒ</a></p>

<p>å½“å•ä¸ªplaybookæ–‡ä»¶è¶Šæ¥è¶Šå¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦é‡æ–°æ¥ç»„ç»‡Playbooksäº†ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªå¤§çš„playbookæ‹†æˆè‹¥å¹²ä¸ªå°çš„playbookæ–‡ä»¶ï¼Œç„¶åé€šè¿‡includeçš„æ–¹å¼ï¼Œåœ¨ä¸»é…ç½®æ–‡ä»¶ä¸­å°†è¿™äº›é›¶ç¢çš„å°æ–‡ä»¶åŒ…å«è¿›æ¥ï¼Œè¿™å«åšplaybookçš„åŒ…å«ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‰ç…§ä¸€å®šçš„è§„åˆ™å°†æ‰§è¡Œçš„æŸä¸€ç±»å‹ä»»åŠ¡æ”¾åœ¨ä¸€ä¸ªç›®å½•é‡Œï¼Œå¹¶åœ¨è¿™ä¸ªç›®å½•ä¸­å†æ¬¡å¯¹è¿™ä¸ªplaybookæŒ‰ç…§tasks,handlersï¼Œfiles,templates,varsç­‰ç±»å‹åˆ’åˆ†æˆè‹¥å¹²æ–‡ä»¶ï¼Œå°†å¯¹åº”æ–‡ä»¶å­˜æ”¾åœ¨å¯¹åº”çš„ç›®å½•ä¸­ï¼Œè¿™ç§ç»„ç»‡æ–¹å¼å°±å«åšplaybookçš„rolesã€‚</p>

<h3>2.10.1 PlayBookçš„åŒ…å«: include</h3>

<h4>tasksåŒ…å«</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ä¸€ä¸ªtaskæ–‡ä»¶foo.ymlç¤ºä¾‹å¦‚ä¸‹</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">placeholder</span> <span class="n">foo</span>
  <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">foo</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">placeholder</span> <span class="n">bar</span>
  <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bar</span>
  
<span class="c1"># åœ¨å¦ä¸€ä¸ªtaskæ–‡ä»¶bar.ymlä¸­åŒ…å«foo.yml</span>
<span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">tasks</span><span class="o">/</span><span class="n">foo</span><span class="o">.</span><span class="n">yml</span>

<span class="c1"># ä¹Ÿå¯ä»¥åœ¨includeçš„æ—¶å€™ï¼Œå¸¦å…¥å˜é‡</span>
<span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">wordpress</span><span class="o">.</span><span class="n">yml</span> <span class="n">user</span><span class="o">=</span><span class="n">timmy</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">wordpress</span><span class="o">.</span><span class="n">yml</span> <span class="n">user</span><span class="o">=</span><span class="n">alice</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">wordpress</span><span class="o">.</span><span class="n">yml</span> <span class="n">user</span><span class="o">=</span><span class="n">bob</span>

<span class="n">tasks</span><span class="p">:</span>
 <span class="o">-</span> <span class="p">{</span> <span class="n">include</span><span class="p">:</span> <span class="n">wordpress</span><span class="o">.</span><span class="n">yml</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">timmy</span><span class="p">,</span> <span class="n">ssh_keys</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;keys/one.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;keys/two.txt&#39;</span> <span class="p">]</span> <span class="p">}</span>
</pre></div>
</div>
<h4>handlersåŒ…å«</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># handlers1.ymlå†…å®¹å¦‚ä¸‹ï¼š</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">restart</span> <span class="n">apache</span>
  <span class="n">service</span><span class="p">:</span> <span class="n">name</span><span class="o">=</span><span class="n">apache</span> <span class="n">state</span><span class="o">=</span><span class="n">restarted</span>
<span class="c1"># handlers.ymlåŒ…å«handlers1.ymlç¤ºä¾‹</span>
<span class="n">handlers</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">handlers</span><span class="o">/</span><span class="n">handlers</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<h4>æ··åˆåŒ…å«</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># includeä¹Ÿå¯ä»¥ç”¨äºå°†ä¸€ä¸ªplaybookå¯¼å…¥åˆ°å¦ä¸€ä¸ªplaybookä¸­ï¼š</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">play</span> <span class="n">at</span> <span class="n">the</span> <span class="n">top</span> <span class="n">level</span> <span class="n">of</span> <span class="n">a</span> <span class="nb">file</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
  <span class="n">tasks</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">say</span> <span class="n">hi</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">foo</span>
    <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;hi...&quot;</span>
<span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">load_balancers</span><span class="o">.</span><span class="n">yml</span>
<span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span>
<span class="o">-</span> <span class="n">include</span><span class="p">:</span> <span class="n">dbservers</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<h3>2.10.2 PlayBookçš„è§’è‰²: roles</h3>

<h4>åˆ›å»ºrole</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">)</span><span class="err">åˆ›å»ºä»¥</span><span class="n">roles</span><span class="err">å‘½ä»¤çš„ç›®å½•</span>
<span class="mi">2</span><span class="p">)</span><span class="err">åœ¨</span><span class="n">roles</span><span class="err">ç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºè§’è‰²åç§°å‘½åçš„ç›®å½•ï¼Œå¦‚</span><span class="n">websrvs</span><span class="err">ç­‰</span>
<span class="mi">3</span><span class="p">)</span><span class="err">åœ¨æ¯ä¸ªè§’è‰²å‘½åçš„ç›®å½•ä¸­åˆ†åˆ«åˆ›å»º</span><span class="n">files</span><span class="err">ã€</span><span class="n">handlers</span><span class="err">ã€</span><span class="n">meta</span><span class="err">ã€</span><span class="n">tasks</span><span class="err">ã€</span><span class="n">teamplates</span><span class="err">å’Œ</span><span class="nb">vars</span><span class="err">ç›®å½•ï¼Œç”¨ä¸åˆ°çš„ç›®å½•å¯ä»¥åˆ›å»ºä¸ºç©ºç›®å½•ï¼Œä¹Ÿå¯ä»¥ä¸åˆ›å»ºã€‚</span>
<span class="mi">4</span><span class="p">)</span><span class="err">åœ¨</span><span class="n">playbook</span><span class="err">æ–‡ä»¶ä¸­ï¼Œè°ƒç”¨å„è§’è‰²</span>

<span class="n">roles</span><span class="err">å„ç›®å½•çš„ä½œç”¨åŠå¯ç”¨çš„æ–‡ä»¶ï¼š</span>
    <span class="n">files</span><span class="err">ï¼šå­˜æ”¾ç”±</span><span class="n">copy</span><span class="err">æˆ–</span><span class="n">script</span><span class="err">ç­‰æ¨¡å—è°ƒç”¨çš„æ–‡ä»¶</span>
    <span class="n">tempaltes</span><span class="err">ï¼š</span><span class="n">Jinja2</span><span class="err">æ¨¡æ¿æ–‡ä»¶</span>
    <span class="n">tasks</span><span class="err">ï¼šè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸º</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">çš„æ–‡ä»¶ï¼Œå…¶å®šä¹‰äº†æ­¤è§’è‰²çš„ä»»åŠ¡åˆ—è¡¨ï¼Œäº›æ–‡ä»¶å¯ä»¥ä½¿ç”¨</span><span class="n">include</span><span class="err">åŒ…å«å…¶å®ƒçš„ä½äºæ­¤ç›®å½•ä¸­çš„</span><span class="n">task</span><span class="err">æ–‡ä»¶</span>
    <span class="n">handlers</span><span class="err">ï¼šè‡³å°‘åŒ…å«ä¸€ä¸ª</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²ç”¨åˆ°çš„å„</span><span class="n">handler</span><span class="err">ï¼Œåœ¨</span><span class="n">handler</span><span class="err">ä¸­ä½¿ç”¨</span><span class="n">include</span><span class="err">åŒ…å«çš„å…¶ä»–</span><span class="n">handler</span><span class="err">æ–‡ä»¶ä¹Ÿåº”è¯¥ä½äºæ­¤ç›®å½•</span>
    <span class="nb">vars</span><span class="err">ï¼šåº”å½“åŒ…å«ä¸€ä¸ª</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²ç”¨åˆ°çš„å˜é‡</span>
    <span class="n">meta</span><span class="err">ï¼šåº”å½“åŒ…å«ä¸€ä¸ª</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²çš„ç‰¹æ®Šè®¾å®šåŠä¾èµ–å…³ç³»ç­‰</span>
    <span class="n">default</span><span class="err">ï¼šä¸ºå½“å‰è§’è‰²è®¾å®šé»˜è®¤å˜é‡æ—¶ä½¿ç”¨äº›ç›®å½•ï¼ŒåŒ…å«ä¸€ä¸ª</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="err">æ–‡ä»¶</span>
</pre></div>
</div>
<h4>å¼•ç”¨role</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">åŸºæœ¬å¼•ç”¨çš„æ–¹æ³•ï¼š</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
     <span class="o">-</span> <span class="n">common</span>
     <span class="o">-</span> <span class="n">webserver</span>

<span class="err">ä¹Ÿå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•å¼•ç”¨æ—¶å¸¦å…¥å˜é‡ï¼š</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">common</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">foo_app_instance</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="s1">&#39;/opt/a&#39;</span><span class="p">,</span>  <span class="n">port</span><span class="p">:</span> <span class="mi">5000</span> <span class="p">}</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">foo_app_instance</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="s1">&#39;/opt/b&#39;</span><span class="p">,</span>  <span class="n">port</span><span class="p">:</span> <span class="mi">5001</span> <span class="p">}</span>

<span class="err">è¿˜å¯ä»¥åœ¨å¼•ç”¨æ—¶ä½¿ç”¨æ¡ä»¶è¯­å¥ï¼š</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">some_role</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="s2">&quot;ansible_os_family == &#39;RedHat&#39;&quot;</span> <span class="p">}</span>

<span class="err">ä¸‹é¢ä¹Ÿæ˜¯ä¸€ä¸ªå¸¦å…¥å˜é‡çš„ç¤ºä¾‹ï¼š</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">role</span><span class="p">:</span> <span class="n">database</span>
      <span class="n">database_name</span><span class="p">:</span> <span class="p">{{</span> <span class="n">db_name</span> <span class="p">}}</span>
      <span class="n">database_user</span><span class="p">:</span> <span class="p">{{</span> <span class="n">db_pass</span> <span class="p">}}</span>
    <span class="o">-</span> <span class="n">role</span><span class="p">:</span> <span class="n">webserver</span>
      <span class="n">live_hostname</span><span class="p">:</span> <span class="n">web1</span>
      <span class="n">domains</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>
        <span class="o">-</span> <span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<h4>pre<em>taskså’Œpost</em>tasks</h4>

<ul>
<li>ä»»åŠ¡ä¹‹å‰æˆ–è€…ä¹‹åæ‰§è¡Œ</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">å¦‚æœåœ¨æ‰§è¡Œä¸€ä¸ª</span><span class="n">role</span><span class="err">æ—¶ï¼Œéœ€è¦åœ¨å…¶å‰æˆ–å…¶åä¾ç„¶è¦æ‰§è¡ŒæŸäº›ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨</span><span class="n">pre_tasks</span><span class="err">åŠ</span><span class="n">post_tasks</span><span class="err">æ¥å£°æ˜ã€‚</span><span class="n">pre_tasks</span><span class="err">æ˜¯åœ¨</span><span class="n">role</span><span class="err">ä¹‹å‰æ‰§è¡Œï¼Œè€Œ</span><span class="n">post_tasks</span><span class="err">åˆ™åœ¨</span><span class="n">role</span><span class="err">ä¹‹åæ‰§è¡Œï¼š</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">deply</span> <span class="n">webservers</span>
  <span class="n">host</span><span class="p">:</span> <span class="n">webservers</span>
  <span class="n">vars_files</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">secrets</span><span class="o">.</span><span class="n">yml</span>
  <span class="n">pre_tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">update</span> <span class="n">yum</span> <span class="n">cache</span>
      <span class="n">yum</span><span class="p">:</span> <span class="n">update_cache</span><span class="o">=</span><span class="n">yes</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">role</span><span class="p">:</span> <span class="n">apache</span>
      <span class="n">database_host</span><span class="p">:</span> <span class="p">{{</span> <span class="n">hostvars</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ansible_eth0</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">address</span> <span class="p">}}</span>
      <span class="n">domains</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">exampel</span><span class="o">.</span><span class="n">com</span>
        <span class="o">-</span> <span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
  <span class="n">post_tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="k">print</span> <span class="n">something</span>
      <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;The roles have been updated!&quot;</span>
</pre></div>
</div>
<h4>roleçš„ä¾èµ–</h4>

<p>å¦‚æœå½“å‰roleåœ¨æ‰§è¡Œå‰éœ€è¦ä¾èµ–å¦ä¸€ä¸ªroleï¼Œæˆ‘ä»¬å¯ä»¥åœ¨rolesçš„metaç›®å½•ä¸­çš„main.ymlä¸­å®šä¹‰roleçš„ä¾èµ–å…³ç³»;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">ç¤ºä¾‹</span><span class="mi">1</span><span class="err">ï¼š</span>
<span class="c1">#roles/webservers/meta/main.yml</span>
<span class="n">dependencies</span><span class="p">:</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">common</span><span class="p">,</span> <span class="n">some_parameter</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">apache</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="mi">80</span> <span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span> <span class="n">role</span><span class="p">:</span> <span class="n">postgres</span><span class="p">,</span> <span class="n">dbname</span><span class="p">:</span> <span class="n">blarg</span><span class="p">,</span> <span class="n">other_parameter</span><span class="p">:</span> <span class="mi">12</span> <span class="p">}</span>

<span class="err">ç¤ºä¾‹</span><span class="mi">2</span><span class="err">ï¼š</span>
<span class="n">dependencies</span><span class="p">:</span>
  <span class="o">-</span> <span class="p">{</span><span class="n">role</span><span class="p">:</span> <span class="n">ntp</span><span class="p">,</span> <span class="n">ntp_server</span><span class="o">=</span><span class="n">ntp</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="n">role</span><span class="p">:</span> <span class="n">web</span><span class="p">}</span>
  <span class="o">-</span> <span class="p">{</span><span class="n">role</span><span class="p">:</span> <span class="n">memcached</span><span class="p">}</span>
</pre></div>
</div>
<h4>Ansible Galaxy</h4>

<p>ansible-galaxyæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒå¿«é€Ÿçš„åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„rolesç›®å½•ç»“æ„ï¼Œè¿˜å¯ä»¥é€šè¿‡å®ƒåœ¨https:/galaxy.ansible.comä¸Šä¸‹è½½åˆ«äººå†™å¥½çš„rolesï¼Œç›´æ¥æ‹¿æ¥ç”¨;</p>

<p>é€šè¿‡ansible-galaxyåˆå§‹åŒ–ä¸€ä¸ªrolesçš„ç›®å½•ç»“æ„ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy init /etc/ansible/roles/websrvs</pre></div></div>

<p>å®‰è£…åˆ«äººå†™å¥½çš„rolesï¼š</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy install -p /etc/ansible/roles bennojoy.mysql</pre></div></div>

<p>åˆ—å‡ºå·²å®‰è£…çš„rolesï¼š</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy list</pre></div></div>

<p>æŸ¥çœ‹å·²å®‰è£…çš„rolesä¿¡æ¯ï¼š</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy info bennojoy.mysql</pre></div></div>

<p>å¸è½½rolesï¼š</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>ansible-galaxy remove bennojoy.mysql</pre></div></div>

<h2>2.11 Ansibleçš„å˜é‡è¯¦è§£</h2>

<p><a href="http://breezey.blog.51cto.com/2400275/1757832">è¯¦æƒ…è¯·å‚è€ƒ</a></p>

<h3>2.11.1 åœ¨Inventoryä¸­å®šä¹‰å˜é‡</h3>

<p>å‚è€ƒ2.4</p>

<h3>2.11.2 åœ¨Playbookä¸­å®šä¹‰å˜é‡</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mi">1</span><span class="err">ã€é€šè¿‡</span><span class="nb">vars</span><span class="err">å…³é”®å­—å®šä¹‰ï¼š</span>
<span class="nb">vars</span><span class="p">:</span> 
  <span class="n">http_port</span><span class="p">:</span> <span class="mi">80</span>
  <span class="n">server_name</span><span class="p">:</span> <span class="n">localhost</span>
  <span class="n">cert_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">crt</span>
  <span class="n">key_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">key</span>
  <span class="n">conf_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">conf</span>

<span class="mi">2</span><span class="err">ã€é€šè¿‡</span><span class="n">vars_files</span><span class="err">å…³é”®å­—å¼•å…¥å˜é‡æ–‡ä»¶ï¼š</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
  <span class="nb">vars</span><span class="p">:</span>
    <span class="n">favcolor</span><span class="p">:</span> <span class="n">blue</span>
  <span class="n">vars_files</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">external_vars</span><span class="o">.</span><span class="n">yml</span>
    <span class="o">-</span> <span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">nginx_vars</span><span class="o">.</span><span class="n">yml</span>

<span class="o">/</span><span class="nb">vars</span><span class="o">/</span><span class="n">nginx_vars</span><span class="o">.</span><span class="n">yml</span><span class="err">ç¤ºä¾‹ï¼š</span>
<span class="n">http_port</span><span class="p">:</span> <span class="mi">80</span>
<span class="n">server_name</span><span class="p">:</span> <span class="n">localhost</span>
<span class="n">cert_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">crt</span>
<span class="n">key_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">key</span>
<span class="n">conf_file</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">conf</span>

<span class="mi">3</span><span class="err">ã€é€šè¿‡</span><span class="n">vars_prompt</span><span class="err">æ¥å®ç°äººæœºäº¤äº’ï¼š</span>
<span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
<span class="n">remote_user</span><span class="p">:</span> <span class="n">root</span>
<span class="n">vars_prompt</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;https_passphrase&#39;</span>          <span class="c1">#å­˜å‚¨æ•°æ®çš„å˜é‡å</span>
    <span class="n">prompt</span><span class="p">:</span> <span class="s1">&#39;Key Passphrase&#39;</span>          <span class="c1">#æ‰‹å·¥è¾“å…¥æ•°æ®</span>
    <span class="n">private</span><span class="p">:</span> <span class="n">yes</span>                      <span class="c1">#å½“è¯¥å€¼ä¸ºyesï¼Œåˆ™ç”¨æˆ·çš„è¾“å…¥ä¸ä¼šè¢«æ‰“å°</span>

<span class="mi">4</span><span class="err">ã€é€šè¿‡</span><span class="n">playbook</span><span class="err">çš„</span><span class="n">roles</span><span class="err">å®šä¹‰å˜é‡</span>
<span class="err">è¯¦è§ã€Š</span><span class="n">ansible10</span><span class="err">ï¼š</span><span class="n">Playbook</span><span class="err">çš„è§’è‰²ä¸åŒ…å«ã€‹</span>
</pre></div>
</div>
<h3>2.11.3 registeræ³¨å†Œå˜é‡</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">åœ¨æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠæŸä¸€æ¡ä»»åŠ¡æ‰§è¡Œçš„ç»“æœä¿å­˜ä¸‹æ¥ï¼Œå¯ä»¥åœ¨æ¥ä¸‹çš„ä»»åŠ¡ä¸­è°ƒç”¨æˆ–è€…åšäº›åˆ¤æ–­ï¼Œå¯ä»¥é€šè¿‡</span><span class="n">register</span><span class="err">å…³é”®å­—æ¥å®ç°ï¼šä¸‹é¢æ˜¯ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚æœ</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">motd</span><span class="err">æ–‡ä»¶ä¸­åŒ…å«æœ‰</span><span class="s1">&#39;hi&#39;</span><span class="err">å­—ç¬¦ä¸²æ—¶ï¼Œåˆ™è¾“å‡º</span><span class="s2">&quot;mothd contains ther word hi&quot;</span><span class="err">ï¼š</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">test</span> <span class="n">play</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">tasks</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">motd</span>
        <span class="n">register</span><span class="p">:</span> <span class="n">motd_contents</span>
      <span class="o">-</span> <span class="n">shell</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;motd contains the word hi&quot;</span>
        <span class="n">when</span><span class="p">:</span> <span class="n">motd_contents</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
        
<span class="err">ä¸‹é¢æ˜¯ä¸€ä¸ª</span><span class="n">register</span><span class="err">çš„å˜é‡åœ¨å¾ªç¯ä¸­ä½¿ç”¨çš„ä¾‹å­ï¼š</span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">registered</span> <span class="n">variable</span> <span class="n">usage</span> <span class="k">as</span> <span class="n">a</span> <span class="n">with_items</span> <span class="nb">list</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">tasks</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">retrieve</span> <span class="n">the</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">home</span> <span class="n">directories</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">ls</span> <span class="o">/</span><span class="n">home</span>
        <span class="n">register</span><span class="p">:</span> <span class="n">home_dirs</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">add</span> <span class="n">home</span> <span class="n">dirs</span> <span class="n">to</span> <span class="n">the</span> <span class="n">backup</span> <span class="n">spooler</span>
        <span class="nb">file</span><span class="p">:</span> <span class="n">path</span><span class="o">=/</span><span class="n">mnt</span><span class="o">/</span><span class="n">bkspool</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span> <span class="n">src</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span> <span class="n">state</span><span class="o">=</span><span class="n">link</span>
        <span class="n">with_items</span><span class="p">:</span> <span class="n">home_dirs</span><span class="o">.</span><span class="n">stdout_lines</span>
        <span class="c1"># same as with_items: home_dirs.stdout.split()</span>
</pre></div>
</div>
<h3>2.11.4 é€šè¿‡factè·å–è¿œç¨‹ä¸»æœºå˜é‡</h3>

<p>æˆ‘ä»¬åœ¨ä¹‹å‰è®²ad-hocå¸¸ç”¨æ¨¡å—çš„æ—¶å€™æåˆ°setupæ¨¡å—ï¼Œç”¨äºè·å–è¿œç¨‹ä¸»æœºçš„ç›¸å…³ä¿¡æ¯ï¼Œå¹¶å¯ä»¥å°†è¿™äº›ä¿¡æ¯ä½œä¸ºå˜é‡åœ¨playbooké‡Œè¿›è¡Œè°ƒç”¨ã€‚è€Œsetupæ¨¡å—è·å–è¿™äº›ä¿¡æ¯çš„æ–¹æ³•å°±æ˜¯ä¾èµ–äºfactã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸å†è¯¦ç»†è¯´æ˜è·å–åˆ°çš„é»˜è®¤factçš„å†…å®¹ã€‚ansibleé™¤äº†èƒ½è·å–åˆ°é¢„å®šä¹‰çš„factçš„å†…å®¹,è¿˜æ”¯æŒæ‰‹åŠ¨ä¸ºæŸä¸ªä¸»æœºå®šåˆ¶factã€‚ç§°ä¹‹ä¸ºæœ¬åœ°factã€‚æœ¬åœ°facté»˜è®¤å­˜æ”¾äºç›®æ ‡ä¸»æœºçš„/etc/ansible/facts.dç›®å½•ä¸‹ï¼Œå¦‚æœæ–‡ä»¶ä¸º.iniæ ¼å¼æˆ–è€…jsonæ ¼å¼ï¼Œansibleä¼šè‡ªåŠ¨è¯†åˆ«ã€‚ä»¥è¿™ç§å½¢å¼åŠ è½½çš„factæ˜¯keyä¸ºansible_localçš„ç‰¹æ®Šå˜é‡ã€‚</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œä¸€ä¸ª</span><span class="o">.</span><span class="n">ini</span><span class="err">æ ¼å¼çš„</span><span class="n">example</span><span class="o">.</span><span class="n">fact</span><span class="err">æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</span>
<span class="p">[</span><span class="n">book</span><span class="p">]</span>
<span class="n">title</span><span class="o">=</span><span class="n">Ansible</span> <span class="n">Book</span>
<span class="n">author</span><span class="o">=</span><span class="n">Breeze</span> <span class="n">Yan</span>
<span class="err">å°†å…¶å¤åˆ¶åˆ°ç›®æ ‡ä¸»æœºçš„</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ansible</span><span class="o">/</span><span class="n">facts</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="err">ç›®å½•ï¼Œé€šè¿‡</span><span class="n">debug</span><span class="err">æ¨¡å—æ‰“å°è¾“å‡ºï¼š</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="k">print</span> <span class="n">ansible_local</span>
  <span class="n">debug</span><span class="p">:</span> <span class="n">var</span><span class="o">=</span><span class="n">ansibl_local</span>
<span class="err">ä¼šæ‰“å°å‡ºå¦‚ä¸‹å†…å®¹ï¼š</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="n">localhost</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ansible_local&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;Breeze Yan&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Ansible Book&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">å¦‚æœä¸æƒ³ä»</span><span class="n">fact</span><span class="err">ä¸­è·å–å˜é‡ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•å…³é—­</span><span class="n">fact</span><span class="err">ï¼š</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="n">whatever</span>
  <span class="n">gather_facts</span><span class="p">:</span> <span class="n">no</span>
</pre></div>
</div>
<h3>2.11.5 ä½¿ç”¨set_factæ¨¡å—å®šä¹‰æ–°çš„å˜é‡</h3>

<p>å‚è§: Playbookå¸¸ç”¨æ¨¡å— set_factéƒ¨åˆ†</p>

<h3>2.11.6 å†…ç½®å˜é‡</h3>

<ul>
<li>hostvars</li>
</ul>

<p>è·å–æŸå°æŒ‡å®šçš„ä¸»æœºçš„ç›¸å…³å˜é‡ã€‚å¦‚æœæœ‰ä¸€å°webæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ä¸­éœ€è¦æŒ‡å®šdbæœåŠ¡å™¨çš„ipåœ°å€ï¼Œæˆ‘ä»¬å‡å®šè¿™å°dbæœåŠ¡å™¨çš„hostnameä¸ºdb.exmaple.com,ipåœ°å€ç»‘å®šåœ¨eth0ç½‘å¡ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•åœ¨webæœåŠ¡å™¨ä¸Šè°ƒç”¨dbæœåŠ¡å™¨çš„ipåœ°å€ï¼š
<code>{{ hostvars[&#39;db.example.com&#39;].ansible_eth0.ipv4.address }}</code>
éœ€è¦æ³¨æ„çš„æ˜¯db.example.comä¸èƒ½ä½¿ç”¨ipåœ°å€æ¥å–ä»£ï¼Œåªèƒ½ä½¿ç”¨ä¸»æœºåæˆ–åˆ«å</p>

<ul>
<li>inventory<em>hostnameä¸inventory</em>hostname_short</li>
</ul>

<p>inventory<em>hostnameæ˜¯Ansibleæ‰€è¯†åˆ«çš„å½“å‰æ­£åœ¨è¿è¡Œtaskçš„ä¸»æœºçš„ä¸»æœºåã€‚å¦‚æœåœ¨inventoryé‡Œå®šä¹‰è¿‡åˆ«åï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯é‚£ä¸ªåˆ«åï¼Œå¦‚æœinentoryåŒ…å«å¦‚ä¸‹ä¸€è¡Œï¼š
<code>server1 ansible_ssh_host=192.168.1.1</code>
åˆ™inventory</em>hostnameå³ä¸ºserver1;</p>

<p>åˆ©ç”¨hostvarså’Œinventory_hostnameå˜é‡ï¼Œå¯ä»¥è¾“å‡ºä¸å½“å‰ä¸»æœºç›¸å…³è”çš„æ‰€æœ‰å˜é‡ï¼š
<code>- debug: var=hostvars[inventory_hostname]</code></p>

<p>ä¸inventory<em>hostnameç›¸è¿‘çš„è¿˜æœ‰ä¸€ä¸ªinventory</em>hostname<em>shortï¼Œå¦‚æœä¸€å°ä¸»æœºçš„inventory</em>hostnameä¸ºserver1.exmaple.comï¼Œåˆ™inventory<em>hostname</em>shortçš„å€¼ä¸ºserver1</p>

<ul>
<li>group_names</li>
</ul>

<p>ç”¨äºæ ‡è¯†å½“å‰æ­£åœ¨æ‰§è¡Œtaskçš„ç›®æ ‡ä¸»æœºä½äºçš„ä¸»æœºç»„ã€‚å‡å¦‚æˆ‘ä»¬æœ‰ä¸‰å°ä¸»æœºï¼Œç”¨æ¥é…ç½®æˆä¸€ä¸»äºŒä»çš„mysqlæœåŠ¡å™¨ã€‚</p>

<ul>
<li>groups</li>
</ul>

<p>å½“ä½ æƒ³è¦è®¿é—®ä¸€ç»„ä¸»æœºçš„å˜é‡æ—¶ï¼Œgroupså˜é‡ä¼šå¾ˆæœ‰ç”¨ã€‚å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªinventoryæ–‡ä»¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">web</span><span class="p">]</span>
<span class="n">server1</span>
<span class="n">server2</span>
</pre></div>
</div>
<p>åœ¨é…ç½®ä¸€å°HAproxyçš„è´Ÿè½½å‡è¡¡å™¨æ—¶ï¼Œæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶è‚¯å®šéœ€è¦webç¾¤ç»„çš„æ‰€æœ‰æœåŠ¡å™¨çš„IPï¼Œé…ç½®æ–‡ä»¶åŒ…å«å¦‚ä¸‹ç‰‡æ®µï¼š</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>backend web-backend
{% for host in groups.web%}
    server {{host.inventory_hostname}} {{ host.ansible_default_ipv4.address }}:80
{% endfor %}</pre></div></div>

<p>æœ€ç»ˆç”Ÿæˆçš„æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">backend</span> <span class="n">web</span><span class="o">-</span><span class="n">backend</span>
    <span class="n">server</span> <span class="n">server1</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span>
    <span class="n">server</span> <span class="n">server2</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.2</span>
</pre></div>
</div>
<ul>
<li>play_hosts    #å½“å‰playbookä¼šåœ¨å“ªäº›hostsä¸Šè¿è¡Œ</li>
<li>ansible_version    #å½“å‰ansibleçš„ç‰ˆæœ¬</li>
<li>inventory_dir    #ä¸»æœºæ¸…å•æ‰€åœ¨ç›®å½•</li>
<li>inventory_file    #ä¸»æœºæ¸…å•æ–‡ä»¶</li>
</ul>

<h3>2.11.7 é€šè¿‡å‘½ä»¤è¡Œè®¾ç½®å˜é‡</h3>

<ul>
<li>ç¤ºä¾‹</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="s1">&#39;{{ hosts }}&#39;</span>
  <span class="n">remote_user</span><span class="p">:</span> <span class="s1">&#39;{{ user }}&#39;</span>
  <span class="n">tasks</span><span class="p">:</span>
     <span class="o">-</span> <span class="o">...</span>

<span class="c1"># æ‰§è¡Œ</span>
<span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">release</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="nb">vars</span> <span class="s2">&quot;hosts=vipers user=starbuck&quot;</span>
</pre></div>
</div>
<p>ä¹Ÿå¯ä»¥å†™æˆç±»ä¼¼å¦‚ä¸‹æ–¹å¼ï¼š</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="nb">vars</span> <span class="s1">&#39;{&quot;pacman&quot;:&quot;mrs&quot;,&quot;ghosts&quot;:[&quot;inky&quot;,&quot;pinky&quot;,&quot;clyde&quot;,&quot;sue&quot;]}&#39;</span>
</pre></div>
</div>
<ul>
<li>å˜é‡ä¼˜å…ˆçº§</li>
</ul>

<p>æ³¨ï¼š<code>å­ç»„ä¼šè¦†ç›–çˆ¶ç»„ï¼Œä¸»æœºæ€»æ˜¯è¦†ç›–ç»„å®šä¹‰çš„å˜é‡</code></p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mi">1</span><span class="err">ã€</span><span class="n">extra</span> <span class="nb">vars</span><span class="p">(</span><span class="err">å‘½ä»¤ä¸­</span><span class="o">-</span><span class="n">e</span><span class="p">)</span><span class="err">æœ€ä¼˜å…ˆ</span>
<span class="mi">2</span><span class="err">ã€</span><span class="n">inventory</span> <span class="err">ä¸»æœºæ¸…å•ä¸­è¿æ¥å˜é‡</span><span class="p">(</span><span class="n">ansible_ssh_user</span> <span class="err">ç­‰</span><span class="p">)</span>
<span class="mi">3</span><span class="err">ã€</span><span class="n">play</span> <span class="err">ä¸­</span> <span class="nb">vars</span><span class="err">ã€</span><span class="n">vars_files</span> <span class="err">ç­‰</span>
<span class="mi">4</span><span class="err">ã€å‰©ä½™çš„åœ¨</span> <span class="n">inventory</span> <span class="err">ä¸­å®šä¹‰çš„å˜é‡</span>
<span class="mi">5</span><span class="err">ã€ç³»ç»Ÿçš„</span> <span class="n">facts</span> <span class="err">å˜é‡</span>
<span class="mi">6</span><span class="err">ã€è§’è‰²å®šä¹‰çš„é»˜è®¤å˜é‡</span><span class="p">(</span><span class="n">roles</span><span class="o">/</span><span class="n">rolesname</span><span class="o">/</span><span class="n">defaults</span><span class="o">/</span><span class="n">main</span><span class="o">.</span><span class="n">yml</span><span class="p">)</span>
</pre></div>
</div>
<h1>3.ä½¿ç”¨ansibleç®¡ç†ä¸åŒç¯å¢ƒä¸‹çš„docker-composeæ–‡ä»¶</h1>

<p>æ¨¡æ¿é…ç½®åœ¨é¡¹ç›®å†…éƒ¨, å…¥å£ä¸ºcomposeæ–‡ä»¶, é€šè¿‡æç¤ºç”¨æˆ·è¾“å…¥, å¹¶æ ¹æ®ç”¨æˆ·è¾“å…¥å¯¼å…¥ä¸åŒçš„ç¯å¢ƒå˜é‡, ä»¥ä¾¿äºç”Ÿæˆä¸åŒç¯å¢ƒä¸‹çš„docker-composeå¯åŠ¨æ–‡ä»¶; æœ€ç»ˆé€šè¿‡å¯åŠ¨æ–‡ä»¶å¯åŠ¨ç‰¹å®šç¯å¢ƒä¸‹çš„æœåŠ¡;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># composeæ–‡ä»¶</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Build</span> <span class="n">Docker</span> <span class="n">Compose</span> <span class="n">File</span>
  <span class="n">vars_prompt</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;hosts&#39;</span>
      <span class="n">prompt</span><span class="p">:</span> <span class="s1">&#39;launch to host&#39;</span>
      <span class="n">private</span><span class="p">:</span> <span class="n">no</span>
      <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;localhost&#39;</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;env_type&#39;</span>
      <span class="n">prompt</span><span class="p">:</span> <span class="s1">&#39;docker-compose default env type [test_ci,test,dev,prod]&#39;</span>
      <span class="n">private</span><span class="p">:</span> <span class="n">no</span>
      <span class="n">default</span><span class="p">:</span> <span class="s1">&#39;test_ci&#39;</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="s2">&quot;{{ hosts }}&quot;</span>
  <span class="c1">#become: yes</span>
  <span class="c1">#become_user: root</span>

  <span class="n">pre_tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">include_vars</span><span class="p">:</span> <span class="s1">&#39;./vars/main.yml&#39;</span>

  <span class="n">tasks</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">template</span><span class="p">:</span>
        <span class="n">src</span><span class="p">:</span> <span class="s2">&quot;{{item.src}}&quot;</span>
        <span class="n">dest</span><span class="p">:</span> <span class="s2">&quot;../{{item.dest}}&quot;</span>
        <span class="n">force</span><span class="p">:</span> <span class="n">yes</span>
      <span class="n">when</span><span class="p">:</span> <span class="s2">&quot;&#39;composefiles&#39; in item.src&quot;</span>
      <span class="n">with_items</span><span class="p">:</span> <span class="s2">&quot;{{project_templates}}&quot;</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">setup</span> <span class="n">compose</span> <span class="n">environment</span> <span class="nb">file</span>
      <span class="n">copy</span><span class="p">:</span>
        <span class="n">dest</span><span class="p">:</span> <span class="s2">&quot;../.env&quot;</span>
        <span class="n">content</span><span class="p">:</span> <span class="o">|</span>
          <span class="n">COMPOSE_FILE</span><span class="o">=</span><span class="n">dc</span><span class="o">-</span><span class="p">{{</span><span class="n">env_type</span><span class="p">}}</span><span class="o">.</span><span class="n">yml</span>
          <span class="n">COMPOSE_PROJECT_NAME</span><span class="o">=</span><span class="p">{{</span><span class="n">system_project_slug</span><span class="p">}}</span>
</pre></div>
</div>
<h1>4. è™šæ‹Ÿç¯å¢ƒæ­å»º,IDEåŸºæœ¬é…ç½®,IDEé…ç½®debugç¯å¢ƒ</h1>
<blockquote class="blockquote-normal">
                <p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸éœ€è¦æ¯æ¬¡éƒ½docker-compose down &amp;&amp; docker-compose upæµ‹è¯•;  æœ€ç»ˆè¾¾åˆ°çš„æ•ˆæœæ˜¯, åœ¨IDEä¸Šè¿›è¡Œæµ‹è¯•;</p></blockquote>
<h2>4.1 è™šæ‹Ÿç¯å¢ƒæ­å»º</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">åœ¨</span><span class="n">root</span><span class="err">ç”¨æˆ·ä¸‹ï¼š</span>
    <span class="n">pip</span> <span class="n">install</span> <span class="n">virtualenv</span> <span class="n">virtualenvwrapper</span>
    <span class="n">find</span> <span class="o">/</span> <span class="o">|</span><span class="n">grep</span> <span class="n">virtualenvwrapper</span><span class="o">.</span><span class="n">sh</span> 
    <span class="err">ä¾‹å¦‚ç»“æœæ˜¯ï¼š</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">virtualenvwrapper</span><span class="o">.</span><span class="n">sh</span>

    <span class="err">åœ¨æ™®é€šç”¨æˆ·ä¸‹ï¼š</span>
    <span class="n">vim</span>  <span class="o">~/.</span><span class="n">zshrc</span>
    <span class="err">åœ¨æœ«å°¾æ·»åŠ ï¼š</span> <span class="n">source</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">virtualenvwrapper</span><span class="o">.</span><span class="n">sh</span>
    <span class="err">è¿è¡Œå‘½ä»¤ä½¿é…ç½®ç”Ÿæ•ˆï¼š</span> <span class="n">source</span> <span class="o">~/.</span><span class="n">zshrc</span>
    <span class="err">è¿è¡Œå‘½ä»¤ï¼š</span><span class="n">mkvirtualenv</span>  <span class="err">å¯ä»¥çŸ¥é“è™šæ‹Ÿç¯å¢ƒé…ç½®å·²ç”Ÿæ•ˆ</span>
    <span class="p">(</span><span class="n">PS</span><span class="err">ï¼šé»˜è®¤çš„è™šæ‹Ÿç¯å¢ƒè¢«åˆ›å»ºåœ¨</span><span class="o">~/.</span><span class="n">virtualenvs</span><span class="o">/</span><span class="err">ä¸‹</span><span class="p">,</span><span class="err">å¹¶ä¸”é»˜è®¤æ˜¯</span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="err">çš„ä¸ä¾èµ–ç³»ç»Ÿä¸­å·²ç»å®‰è£…å¥½çš„ç¬¬ä¸‰æ–¹åŒ…</span><span class="p">)</span>
</pre></div>
</div>
<h2>4.2 IDEåŸºæœ¬é…ç½®</h2>

<p><a href="http://wiki.jikexueyuan.com/project/intellij-idea-tutorial/introduce.html">æå®¢å­¦é™¢</a>, å†…å®¹æ˜¯æå¥½çš„, åªæ˜¯åé¢çœ‹ä¸åˆ°å›¾ç‰‡äº†, å¸Œæœ›å®˜æ–¹å°½æ—©ä¿®å¤;</p>

<h3>4.2.1 å®‰è£…(çœç•¥)</h3>

<h3>4.2.2 ä½¿ç”¨License serveræ¿€æ´»</h3>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038894391460.jpg"></p>
</p>

<h3>4.2.3 å¿…é¡»çŸ¥é“çš„å‡ ä¸ªå¿«æ·é”®</h3>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th style="text-align: center">å¿«æ·é”®</th>
<th style="text-align: left">æè¿°</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: center">Command+;</td>
<td style="text-align: left">Project Structure(é¡¹ç›®ç»“æ„): ç”¨ä¸è®¾å®šä¸€ä¸ªé¡¹ç›®çš„ç¯å¢ƒ,ä¾‹å¦‚,è™šæ‹Ÿç¯å¢ƒ</td>
</tr>
<tr>
<td style="text-align: center">Command+,</td>
<td style="text-align: left">Preferences(é¦–é€‰é¡¹): IDEçš„ç¯å¢ƒè®¾å®š, ä¾‹å¦‚,å®‰è£…æ’ä»¶,æ’ä»¶é…ç½®,é…ç½®ä¸»é¢˜</td>
</tr>
<tr>
<td style="text-align: center">Command+bæˆ–è€…Command+é¼ æ ‡å·¦é”®ç‚¹å‡»</td>
<td style="text-align: left">è·³è½¬åˆ°å¼•ç”¨çš„åœ°æ–¹, ç›¸å¯¹çš„: Command+[ è¿”å›ä¸Šä¸€æ­¥; Command+] è¿”å›ä¸‹ä¸€æ­¥, è¿™æ ·å°±å¯ä»¥æ¥å›è·³è½¬äº†;</td>
</tr>
<tr>
<td style="text-align: center">Command+1</td>
<td style="text-align: left">æ‰“å¼€Project</td>
</tr>
<tr>
<td style="text-align: center">Command+2</td>
<td style="text-align: left">æ‰“å¼€Favarite</td>
</tr>
<tr>
<td style="text-align: center">Command+3</td>
<td style="text-align: left">æ‰“å¼€Favarite</td>
</tr>
<tr>
<td style="text-align: center">Command+6</td>
<td style="text-align: left">æ‰“å¼€TODO</td>
</tr>
<tr>
<td style="text-align: center">Command+7</td>
<td style="text-align: left">æ‰“å¼€Structure</td>
</tr>
<tr>
<td style="text-align: center">Option+Command+l</td>
<td style="text-align: left">æ ¼å¼åŒ–ä»£ç </td>
</tr>
<tr>
<td style="text-align: center">Ctrl+Option+r</td>
<td style="text-align: left">é€‰æ‹©å†…å®¹Run, è‹¥Ctrl+råˆ™æ˜¯runå½“å‰çš„æµ‹è¯•</td>
</tr>
<tr>
<td style="text-align: center">Ctrl+Option+d</td>
<td style="text-align: left">é€‰æ‹©å†…å®¹Debug, è‹¥Ctrl+dåˆ™æ˜¯debugå½“å‰çš„æµ‹è¯•</td>
</tr>
<tr>
<td style="text-align: center">Shift+F1</td>
<td style="text-align: left">æŸ¥çœ‹å‡½æ•°æˆ–è€…ç±»çš„æ–‡æ¡£</td>
</tr>
<tr>
<td style="text-align: center">Shift+F6</td>
<td style="text-align: left">é‡å‘½åæ–‡ä»¶</td>
</tr>
</tbody>
</table></div>
<h2>4.3 IDEé…ç½®Djangoé¡¹ç›®</h2>

<p>æ‰“å¼€Project Structure, é…ç½®è™šæ‹Ÿç¯å¢ƒProject</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038923813468.jpg"></p>
</p>

<p>é…ç½®Modules</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038924901816.jpg"></p>
</p>

<h2>4.4 IDEé…ç½®Djangoé¡¹ç›®çš„æœ¬åœ°æµ‹è¯•ç¯å¢ƒ</h2>

<p>ç‚¹å‡»Edit Configurationsé…ç½®æµ‹è¯•</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038925740827.jpg"></p>
</p>

<p>é…ç½®è¯¦æƒ…(æµ‹è¯•å’Œæœ¬åœ°ç¯å¢ƒå˜é‡æœ‰å¾ˆå¤§çš„å…³ç³»)</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15038927744659.jpg"></p>
</p>

<h1>5. Djangoä½¿ç”¨JekinsåšæŒç»­é›†æˆ</h1>

<h2>5.1 Jekinsç¯å¢ƒæ­å»º</h2>

<p>~æœªå®Œå¾…ç»­~</p>

<h2>5.2 Jekinsæµ‹è¯•æŠ¥å‘Š</h2>

<p>~æœªå®Œå¾…ç»­~</p>

<h2>5.3 æµ‹è¯•æŠ¥å‘Šæ‰©å±•</h2>

<p>~æœªå®Œå¾…ç»­~</p>

<h1>6. Djangoé¡¹ç›®120.43.103.126çš„ç®¡ç†å‘½ä»¤å…¨éƒ¨è¿ç§»åˆ°Rundeckåšé›†ä¸­ç®¡ç†</h1>

<p>~æœªå®Œå¾…ç»­~</p>

    </div>
    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic green button">æ‰“èµ <i class="red heart icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">MORE WORDS</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer code">
            <span>Â© 1994 - 2018 willdx</span><b>@</b><a class="code" href="https://willdx.github.io">willdx.github.io</a>
            <br/>
            <span class="notprint">
                <span id="busuanzi_container_site_pv">
                    <i class="eye icon"></i><span id="busuanzi_value_site_pv" class="orange text"></span> pv
                </span>
                <b> | </b>
                <span id="busuanzi_container_site_uv">
                    <i class="user icon"></i><span id="busuanzi_value_site_uv" class="orange text"></span> uv
                </span>
                <br/>
            </span>
            <span>Power by <i class="github alternate icon"></i><a href="https://github.com/willdx/willdx.github.io">Github Page</a></span>
            <br/>
            <i class="green superpowers icon"></i>
        </div>
    </body>
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="/assets/js/web.js"></script>
    <script>
        // ç»Ÿè®¡ä»£ç 
        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68394485-1', 'auto');
        ga('send', 'pageview');

        var wrappers = ["cats-wrapper", "donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper"]

        window.onload = function () {
            useWechat();
        }
    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: '177af99888a292531873',
        clientSecret: '7c0927c7cdf0d94eed7dad0b238552c10ec6f53c',
        repo: 'willdx.github.io',
        owner: 'willdx',
        admin: ['willdx'],
        id: 'Django-Docker-Compose-Envfileé›†æˆå®è·µ',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: ['gitment'],
        pagerDirection: "last",
    })
      
    gitalk.render('comments')
    </script>


</html>