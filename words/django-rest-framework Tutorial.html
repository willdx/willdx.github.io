<html>
    <head>
        <meta charset="utf-8">
        
    
        <title> django-rest-framework Tutorialç¬”è®° </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">


        <style type="text/css"> 
        </style>
    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: #fff;">ä¸»é¢˜é€‰æ‹©</span></h3>
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr class="sk-mo" onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">å¢¨</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-green" onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">ç»¿</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-default" onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">é’</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-orange" onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">æ©˜</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">æ³¢å¦</div>
                                <div class="time">2017å¹´2æœˆ21å·</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">ä¸‰ä¸‰</div>
                                <div class="time">2017å¹´4æœˆ10å·</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        å¾®ä¿¡
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        æ”¯ä»˜å®
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:1426409836@qq.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/willdx">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>





            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
              <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="linkify icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    ğŸ±
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="heart icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <h2 class="name">Will Dx</h2>

                <span class="sign">äººä¸–ä¸€èº«éœœé›ª, å½’æ¥ä»æ˜¯å°‘å¹´.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        ä¸»é¡µ
                    </a>
                    <a href="/tweet.html" class="item">
                        æ¨ç‰¹
                    </a>
                    <a href="/about.html" class="item">
                        å…³äºæˆ‘
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        è”ç³»
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1>django-rest-framework Tutorialç¬”è®°</h1>
        <h4>Posted April 07, 2017</h4>
        <h1>0. Quikstart</h1>

<p>åˆ›å»ºä¸€ä¸ªç®€å•çš„é¡¹ç›®, å…è®¸ç®¡ç†å‘˜æŸ¥çœ‹å’Œç¼–è¾‘ç”¨æˆ·å’Œç»„; ä»¥æ­¤æ¥å¤§è‡´äº†è§£Django REST framworkçš„ä½¿ç”¨æ–¹å¼;</p>

<h2>0.1 åˆ›å»ºé¡¹ç›®</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># åˆ›å»ºé¡¹ç›®ç›®å½•</span>
<span class="n">mkdir</span> <span class="n">tutorial</span>
<span class="n">cd</span> <span class="n">tutorial</span>

<span class="c1"># åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒ</span>
<span class="n">mkvirtualenv</span> <span class="n">env</span>

<span class="c1"># è¿›å…¥è™šæ‹Ÿç¯å¢ƒ</span>
<span class="n">workon</span> <span class="n">env</span> <span class="err">æˆ–è€…</span> <span class="n">source</span> <span class="n">env</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>

<span class="c1"># å®‰è£…Djangoå’Œframworkåœ¨è™šæ‹Ÿç¯å¢ƒ</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">django</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">djangorestframework</span>

<span class="c1"># å¯åŠ¨ä¸€ä¸ªé¡¹ç›®</span>
<span class="n">django</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">py</span> <span class="n">startproject</span> <span class="n">tutorial</span> <span class="o">.</span>
 
<span class="c1"># å¹¶åˆ›å»ºä¸€ä¸ªAPP </span>
<span class="n">django</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">py</span> <span class="n">startapp</span> <span class="n">quickstart</span>

<span class="c1"># åŒæ­¥æ•°æ®åº“</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>

<span class="c1"># åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦å·(admin/password123)</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">createsuperuser</span>
</pre></div>
</div>
<h2>0.2 åºåˆ—åŒ–</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># quickstart/serializers.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>


<span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GroupSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Group</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>

<span class="c1"># HyperlinkedModelSerializerç±»æ–‡æ¡£</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">A type of `ModelSerializer` that uses hyperlinked relationships instead</span>
<span class="sd">    of primary key relationships. Specifically:</span>

<span class="sd">    * A &#39;url&#39; field is included instead of the &#39;id&#39; field.</span>
<span class="sd">    * Relationships to other instances are hyperlinks, instead of primary keys.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># è¯´æ˜: ä¸Šè¿°ä»£ç ä¸­æˆ‘ä»¬ä½¿ç”¨äº†`HyperlinkedModelSerializer`, </span>

<span class="c1"># å°½ç®¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸»é”®æˆ–è€…å…¶ä»–å…³ç³», ä¹Ÿä¸èƒ½å¦è®¤`hyperlinking`æ˜¯ä¸€ä¸ª`å¾ˆRESTfulè®¾è®¡`çš„äº‹å®;</span>
<span class="p">(</span><span class="n">PS</span><span class="p">:</span> <span class="err">ä½¿ç”¨ä¸­å‘ç°</span><span class="p">,</span> <span class="n">hyperlinking</span><span class="err">å°±æ˜¯æŠŠæ•°æ®çš„å…³ç³»è¡¨ç¤ºä¸ºä¸€ä¸ªæ¥å£</span><span class="p">,</span> <span class="err">å®¢æˆ·ç«¯è·å–æ•°æ®å°±ç›´æ¥è°ƒç”¨æ¥å£å³å¯</span><span class="p">,</span> <span class="err">è€Œä¸éœ€è¦æ‹¼æ¥</span><span class="p">)</span>
</pre></div>
</div>
<h2>0.2 è§†å›¾</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># quickstart/views.py</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">quickstart.serializers</span> <span class="kn">import</span> <span class="n">UserSerializer</span><span class="p">,</span> <span class="n">GroupSerializer</span>


<span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows users to be viewed or edited.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-date_joined&#39;</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>


<span class="k">class</span> <span class="nc">GroupViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows groups to be viewed or edited.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">GroupSerializer</span>
</pre></div>
</div>
<ul>
<li>ViewSets</li>
</ul>

<p>Rather than write multiple views we&#39;re grouping together all the common behavior into classes called ViewSets;(æ„è¯‘: æˆ‘ä»¬å°†ä¸€ç»„ç›¸åŒè§„åˆ™çš„viewç»„åˆåœ¨ä¸€èµ·, è€Œä¸ç”¨å»ä¸ºæ¯ä¸€ä¸ªåŠ¨ä½œéƒ½å†™ä¸€ä¸ªview)</p>

<p>We can easily break these down into individual views if we need to, but using viewsets keeps the view logic nicely organized as well as being very concise.(æ„è¯‘: å°½ç®¡æˆ‘ä»¬èƒ½å¾ˆå®¹æ˜“å°†ä¸€ä¸ªåŠŸèƒ½æ‹†åˆ†ä¸ºå¤šä¸ªview, ä½†æ˜¯æ›´æ¨èä½¿ç”¨viewsetsçš„æ–¹å¼, å› ä¸ºå®ƒæ›´ç›´è§‚,ç®€æ´;)</p>

<h2>0.3 URLs</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># tutorial/urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
<span class="kn">from</span> <span class="nn">quickstart</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserViewSet</span><span class="p">)</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">GroupViewSet</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^api-auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;rest_framework.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;rest_framework&#39;</span><span class="p">))</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Because we&#39;re using viewsets instead of views, we can automatically generate the URL conf for our API, by simply registering the viewsets with a router class.(æ„è¯‘: ç”±äºæˆ‘ä»¬ä½¿ç”¨viewsetsçš„æ–¹å¼ç¼–å†™views, ä½¿å¾—æˆ‘ä»¬åœ¨ç¼–å†™urlsçš„æ—¶å€™åªéœ€è¦é€šè¿‡router.registerçš„æ–¹å¼å°±å¯ä»¥è‡ªåŠ¨ç”ŸæˆURLé…ç½®)</p>

<p>Again, if we need more control over the API URLs we can simply drop down to using regular class-based views, and writing the URL conf explicitly.(æ„è¯‘: å½“æˆ‘ä»¬éœ€è¦å¯¹æ¥å£æœ‰æ›´å¤šçš„æ§åˆ¶çš„æ—¶å€™ä¹Ÿå¯ä»¥è½¬ä¸ºå†™å¸¸è§„çš„åŸºäºç±»çš„views, è¿™æ ·çš„è¯å°±éœ€è¦å°†URLé…ç½®å†™çš„å¾ˆæ˜ç¡®)</p>

<p>Finally, we&#39;re including default login and logout views for use with the browsable API. That&#39;s optional, but useful if your API requires authentication and you want to use the browsable API.(æ„è¯‘: æœ€å, æˆ‘ä»¬æ·»åŠ äº†é»˜è®¤çš„ ç™»å½•/æ³¨é”€ è§†å›¾, è¿™æ˜¯å¯é€‰çš„; ä¸è¿‡å½“ä½ æƒ³åœ¨æµè§ˆå™¨ä¸Šè°ƒè¯•éœ€è¦è®¤è¯çš„æ¥å£æ—¶è¿™ä¸ªé…ç½®å°±æ’ä¸Šç”¨åœºäº†)</p>

<h2>0.4 Settings</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># tutorial/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="o">...</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;rest_framework.permissions.IsAdminUser&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;PAGE_SIZE&#39;</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>0.5 æµ‹è¯•API</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># å¯åŠ¨æœåŠ¡å™¨</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">runserver</span>
</pre></div>
</div>
<ul>
<li>å‘½ä»¤è¡Œæµ‹è¯•</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># curl</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Accept: application/json; indent=4&#39;</span> <span class="o">-</span><span class="n">u</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">users</span><span class="o">/</span>

<span class="c1"># httpie</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">users</span><span class="o">/</span>
</pre></div>
</div>
<ul>
<li>æµè§ˆå™¨æµ‹è¯•</li>
</ul>

<p>ç™»å½•å‰:</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15039124608135.jpg"></p>
</p>

<p>ç™»å½•å:</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15039124923087.jpg"></p>
</p>

<h1>1. åºåˆ—åŒ–-Serialization</h1>

<h2>1.1 ä»‹ç»</h2>

<p>æœ¬ç« å°†é€šè¿‡å†™ä¸€ä¸ª<code>code highlighting Web API</code>é¡¹ç›®æ¥ä»‹ç»RESTframworkçš„å„ä¸ªéƒ¨åˆ†;</p>

<h2>1.2 ä¾‹å­</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ä½¿ç”¨quikstartéƒ¨åˆ†çš„è™šæ‹Ÿç¯å¢ƒ</span>
<span class="n">workon</span> <span class="n">virtualenv</span> 
<span class="n">pip</span> <span class="n">install</span> <span class="n">pygments</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">tutorial</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">startapp</span> <span class="n">snippets</span>

<span class="c1"># é…ç½®settings.py</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rest_framework&#39;</span><span class="p">,</span>
    <span class="s1">&#39;snippets.apps.SnippetsConfig&#39;</span><span class="p">,</span> <span class="c1"># æ·»åŠ app</span>
<span class="p">]</span>

<span class="err">è¯´æ˜</span><span class="p">:</span> <span class="err">è‹¥</span><span class="n">Django</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mf">1.9</span><span class="p">,</span> <span class="err">åº”è¯¥ç›´æ¥å†™</span><span class="n">snippets</span>

<span class="c1"># é…ç½®æ¨¡å‹</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">get_all_lexers</span>
<span class="kn">from</span> <span class="nn">pygments.styles</span> <span class="kn">import</span> <span class="n">get_all_styles</span>

<span class="n">LEXERS</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_all_lexers</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">LANGUAGE_CHOICES</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">LEXERS</span><span class="p">])</span>
<span class="n">STYLE_CHOICES</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_all_styles</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">Snippet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">linenos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STYLE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;friendly&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,)</span>
        
<span class="c1"># åŒæ­¥æ•°æ®åº“</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">makemigrations</span> <span class="n">snippets</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>

<span class="c1"># åˆ›å»ºåºåˆ—åŒ–æ–‡ä»¶</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span><span class="p">,</span> <span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">STYLE_CHOICES</span>


<span class="k">class</span> <span class="nc">SnippetSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">allow_blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;textarea.html&#39;</span><span class="p">})</span>
    <span class="n">linenos</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ChoiceField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ChoiceField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STYLE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;friendly&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and return a new `Snippet` instance, given the validated data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update and return an existing `Snippet` instance, given the validated data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">linenos</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linenos&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">linenos</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instance</span>
<span class="c1"># è¯´æ˜: serializers.Serializerå’Œformsçš„è¡¨ç°å½¢å¼å·®ä¸å¤š, ç”¨æ¥ä¿è¯æäº¤æ•°æ®çš„æœ‰æ•ˆæ€§</span>
</pre></div>
</div>
<p>åºåˆ—åŒ–/ååºåˆ—åŒ–æµç¨‹(å¦‚å›¾):</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15039716904071.jpg"></p>
</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># python manage.py shell</span>

<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="kn">from</span> <span class="nn">rest_framework.renderers</span> <span class="kn">import</span> <span class="n">JSONRenderer</span>
<span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">JSONParser</span>

<span class="n">snippet</span> <span class="o">=</span> <span class="n">Snippet</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">&#39;foo = &quot;bar&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">snippet</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="n">snippet</span> <span class="o">=</span> <span class="n">Snippet</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">&#39;print &quot;hello, world&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">snippet</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># model instance: è¿”å›pythonåŸç”Ÿæ•°æ®æ ¼å¼(dict)</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># render: è¿”å›json</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">JSONRenderer</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">content</span>

<span class="c1"># ååºåˆ—åŒ–: å…ˆè½¬ä¸ºstream, åœ¨parseä¸ºpythonåŸç”Ÿæ•°æ®æ ¼å¼(dict)</span>
<span class="kn">from</span> <span class="nn">django.utils.six</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">JSONParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

<span class="c1"># ååºåˆ—åŒ–ä¹‹åçš„pythonåŸç”Ÿæ•°æ®æ ¼å¼, è½¬ä¸ºmodel instance</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>

<span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># querysetsä¹Ÿå¯ä»¥è¢«åºåˆ—åŒ–, æ·»åŠ ä¸€ä¸ªå‚æ•°many=true</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<h2>1.3 æ¨¡å‹åºåˆ—åŒ–-Model Serializers</h2>

<p>æˆ‘ä»¬çš„<code>SnippetSerializer</code>ç±»å¤åˆ¶äº†å¾ˆå¤šä»£ç , è¿™äº›ä»£ç åœ¨<code>Snippet</code>æ¨¡å‹ä¸­å·²ç»å®šä¹‰è¿‡äº†, å¦‚æœèƒ½è®©ä»£ç æ›´ç®€æ´ä¸€äº›å°±å¥½äº†å•Š!</p>

<p>ç”¨ç±»ä¼¼Djangoçš„ <code>Form</code>å’Œ<code>ModelForm</code>æ–¹æ³•, æˆ‘ä»¬é‡æ–°å®šä¹‰snippets/serializers.pyæ–‡ä»¶, ä»£ç å¦‚ä¸‹:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SnippetSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Snippet</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;linenos&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">)</span>
        
<span class="c1"># serializersæœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§, å¯ä»¥æŸ¥çœ‹åºåˆ—åŒ–å®ä¾‹çš„è¯¦æƒ…</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">serializer</span><span class="p">))</span>
<span class="c1"># SnippetSerializer():</span>
<span class="c1">#    id = IntegerField(label=&#39;ID&#39;, read_only=True)</span>
<span class="c1">#    title = CharField(allow_blank=True, max_length=100, required=False)</span>
<span class="c1">#    code = CharField(style={&#39;base_template&#39;: &#39;textarea.html&#39;})</span>
<span class="c1">#    linenos = BooleanField(required=False)</span>
<span class="c1">#    language = ChoiceField(choices=[(&#39;Clipper&#39;, &#39;FoxPro&#39;), (&#39;Cucumber&#39;, &#39;Gherkin&#39;), (&#39;RobotFramework&#39;, &#39;RobotFramework&#39;), (&#39;abap&#39;, &#39;ABAP&#39;), (&#39;ada&#39;, &#39;Ada&#39;)...</span>
<span class="c1">#    style = ChoiceField(choices=[(&#39;autumn&#39;, &#39;autumn&#39;), (&#39;borland&#39;, &#39;borland&#39;), (&#39;bw&#39;, &#39;bw&#39;), (&#39;colorful&#39;, &#39;colorful&#39;)...</span>

<span class="err">ä»è¿”å›ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°</span><span class="p">,</span> <span class="n">Model</span> <span class="n">Serializers</span><span class="err">å¸®æˆ‘ä»¬æŠŠ</span><span class="n">Model</span><span class="err">éƒ¨åˆ†çš„ä»£ç è½¬åŒ–ä¸ºäº†</span><span class="n">Serializers</span><span class="err">æ‰€éœ€è¦çš„è¯­æ³•</span><span class="p">;</span> <span class="err">å¤§è‡´å¯ä»¥æ¦‚æ‹¬ä¸º</span><span class="p">:</span> 
<span class="mf">1.</span> <span class="err">æ ¹æ®è¾“å…¥ç¡®å®šå­—æ®µé›†</span>
<span class="mf">2.</span> <span class="n">create</span><span class="p">()</span> <span class="ow">and</span> <span class="n">update</span><span class="p">()</span> <span class="err">çš„é»˜è®¤å®ç°</span>
<span class="err">å¦‚æœæœ‰ç‰¹æ®Šéœ€è¦æˆ‘ä»¬å¯ä»¥é‡å†™å­—æ®µå®šä¹‰å’Œé»˜è®¤å®ç°çš„æ–¹æ³•</span><span class="p">;</span>
</pre></div>
</div>
<h2>1.4 åœ¨Djangoè§†å›¾ä¸­ä½¿ç”¨Serializer</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># snippets/views.py</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">JsonResponse</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>
<span class="kn">from</span> <span class="nn">rest_framework.renderers</span> <span class="kn">import</span> <span class="n">JSONRenderer</span>
<span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">JSONParser</span>
<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>

<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">snippet_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all code snippets, or create a new snippet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">snippets</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippets</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">JSONParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        
<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">snippet_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve, update or delete a code snippet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">JSONParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
        <span class="n">snippet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">)</span>
        
<span class="c1"># snippets/urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">snippet_list</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">snippet_detail</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># tutorial/urls.py</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;snippets.urls&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>æµ‹è¯•</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># http http://127.0.0.1:8000/snippets/</span>

<span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="err">âœ</span>  <span class="n">tutorial</span> <span class="n">http</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">466</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">29</span> <span class="n">Aug</span> <span class="mi">2017</span> <span class="mo">03</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">52</span> <span class="n">GMT</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">WSGIServer</span><span class="o">/</span><span class="mf">0.1</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">11</span>
<span class="n">X</span><span class="o">-</span><span class="n">Frame</span><span class="o">-</span><span class="n">Options</span><span class="p">:</span> <span class="n">SAMEORIGIN</span>

<span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;foo = </span><span class="se">\&quot;</span><span class="s2">bar</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print </span><span class="se">\&quot;</span><span class="s2">hello, world</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;foo = </span><span class="se">\&quot;</span><span class="s2">bar</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print </span><span class="se">\&quot;</span><span class="s2">hello, world</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="c1"># (env) âœ  tutorial http http://127.0.0.1:8000/snippets/1/</span>
<span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">110</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">29</span> <span class="n">Aug</span> <span class="mi">2017</span> <span class="mo">03</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">42</span> <span class="n">GMT</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">WSGIServer</span><span class="o">/</span><span class="mf">0.1</span> <span class="n">Python</span><span class="o">/</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">11</span>
<span class="n">X</span><span class="o">-</span><span class="n">Frame</span><span class="o">-</span><span class="n">Options</span><span class="p">:</span> <span class="n">SAMEORIGIN</span>

<span class="p">{</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;foo = </span><span class="se">\&quot;</span><span class="s2">bar</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>æ³¨é‡Š: @csrf<em>exempt
Note that because we want to be able to POST to this view from clients that won&#39;t have a CSRF token we need to mark the view as csrf</em>exempt. This isn&#39;t something that you&#39;d normally want to do, and REST framework views actually use more sensible behavior than this, but it&#39;ll do for our purposes right now.(æ„è¯‘: å¤§æ¦‚çš„æ„æ€æ˜¯: æˆ‘ä»¬éœ€è¦ä½¿ç”¨clientsè¿›è¡Œæ¥å£æµ‹è¯•, è€Œclientsä¸ä¼šæºå¸¦csrfçš„token,æ‰€ä»¥æˆ‘ä»¬åœ¨viewè§†å›¾ä¸Šæ·»åŠ @csrf_exemptç¡®ä¿æµ‹è¯•èƒ½é€šè¿‡; ä½†æ˜¯, åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨Djangoé»˜è®¤çš„CSRFè§„åˆ™æ˜¯æ›´å®‰å…¨çš„.)</p>

<h2>1.5 å°ç»“</h2>

<p>ç›®å‰ä¸ºæ­¢, æˆ‘ä»¬ç¼–å†™äº†å‡ ä¸ªåŸºäºDjango REST framworkçš„serialization API;
æˆ‘ä»¬çš„APIè§†å›¾ç›®å‰æ²¡æœ‰åšä»»ä½•ç‰¹åˆ«çš„äº‹æƒ…ï¼Œé™¤äº†æœåŠ¡JSONå“åº”ï¼Œè¿˜æœ‰ä¸€äº›é”™è¯¯å¤„ç†è¾¹ç¼˜æƒ…å†µï¼Œæˆ‘ä»¬ä»ç„¶æƒ³æ¸…ç†ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„Web API;</p>

<h1>2.è¯·æ±‚å’Œå“åº”-Requests and responses</h1>

<p>ä»è¿™ä¸€èŠ‚å¼€å§‹, æˆ‘ä»¬å°†è¿›å…¥REST frameworkçš„æ ¸å¿ƒ, æˆ‘ä»¬éœ€è¦äº†è§£å‡ ä¸ªå¿…è¦çš„æ„å»ºå—.</p>

<h2>2.1 è¯·æ±‚å¯¹è±¡-Request objects</h2>

<p>REST framework introduces a Request object that extends the regular HttpRequest, and provides more flexible request parsing. The core functionality of the Request object is the request.data attribute, which is similar to request.POST, but more useful for working with Web APIs.(æ„è¯‘: <code>REST framework Request object</code>æ‰©å±•è‡ªæ ‡å‡†çš„<code>HttpRequest</code>, ä¸æ­¤åŒæ—¶æ·»åŠ äº†æ›´çµæ´»çš„è¯·æ±‚è§£æ, ä¹Ÿå°±æ˜¯<code>request.data</code>å±æ€§)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">POST</span>  <span class="c1"># Only handles form data.  Only works for &#39;POST&#39; method.</span>
<span class="n">request</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># Handles arbitrary data.  Works for &#39;POST&#39;, &#39;PUT&#39; and &#39;PATCH&#39; methods.</span>
</pre></div>
</div>
<h2>2.2 å“åº”å¯¹è±¡-Response objects</h2>

<p>REST framework also introduces a Response object, which is a type of TemplateResponse that takes unrendered(æœªæ¸²æŸ“çš„) content and uses content negotiation to determine the correct content type to return to the client.(æ„è¯‘: <code>REST framework Response object</code>æ˜¯ä¸€ç§<code>TemplateResponse</code>, å®ƒå°†æœªæ¸²æŸ“çš„å†…å®¹è½¬åŒ–ä¸ºæ­£ç¡®çš„æ ¼å¼<code>content type</code>ç„¶åè¿”å›ç»™client)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Renders to content type as requested by the client.</span>
</pre></div>
</div>
<h2>2.3 è¿”å›çŠ¶æ€ç -Status codes</h2>

<p>Using numeric HTTP status codes in your views doesn&#39;t always make for obvious reading, and it&#39;s easy to not notice if you get an error code wrong. REST framework provides more explicit identifiers for each status code, such as HTTP<em>400</em>BAD_REQUEST in the status module. It&#39;s a good idea to use these throughout rather than using numeric identifiers.(æ„è¯‘: Djangoè¿”å›çŠ¶æ€ç é»˜è®¤æ˜¯ç”¨æ•°å­—æ ‡è¯†çš„, è¿™æ ·çš„æ–¹å¼å¾ˆéš¾æ¸…æ™°çš„æè¿°å…·ä½“çš„é”™è¯¯, RESTframworkä½¿ç”¨ç±»ä¼¼<code>HTTP_400_BAD_REQUEST</code>(å¤§å†™å­—ç¬¦ä¸²+çŠ¶æ€ç )çš„æ–¹å¼æ¥æ ‡è¯†çŠ¶æ€ç )</p>

<h2>2.4 åŒ…è£…APIè§†å›¾-Wrapping API views</h2>

<p>RESTæ¡†æ¶æä¾›ä¸¤ä¸ªåŒ…è£…å¯ä»¥ç”¨æ¥å†™APIè§†å›¾:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="sb">`@api_view`</span><span class="err">è£…é¥°å™¨å¯ä»¥ä½¿ç”¨åœ¨å‡½æ•°æ–¹å¼çš„</span><span class="n">view</span><span class="err">è§†å›¾</span><span class="o">.</span>
<span class="mf">2.</span> <span class="sb">`APIView`</span><span class="err">ç±»ä½¿ç”¨åœ¨åŸºäºç±»çš„è§†å›¾</span><span class="o">.</span>
</pre></div>
</div>
<p>These wrappers provide a few bits of functionality such as making sure you receive Request instances in your view, and adding context to Response objects so that content negotiation can be performed.(æ„è¯‘: è¿™äº›åŒ…è£…æä¾›äº†ä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚,ç¡®ä¿ä½ æ”¶åˆ°è¯·æ±‚ï¼Œå¹¶å¢åŠ ä¸Šä¸‹æ–‡å“åº”å¯¹è±¡ï¼Œå¯ä»¥è¿›è¡Œå†…å®¹åå•†;)</p>

<p>The wrappers also provide behaviour such as returning 405 Method Not Allowed responses when appropriate, and handling any ParseError exception that occurs when accessing request.data with malformed input.(æ„è¯‘: è¯¥åŒ…è£…è¿˜æä¾›,å¦‚è¿”å›405å“åº”æ–¹æ³•ï¼Œä»¥åŠè§£ærequest.dataæ•°æ®å¾—åˆ°ä¸€ä¸ªé”™è¯¯è¾“å…¥çš„å“åº”;)</p>

<h2>2.5 ä¾‹å­: å°†ä¸Šè¿°ç»„ä»¶åº”ç”¨åˆ°è§†å›¾</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># æœ¬ä¾‹ä¸­ä¸ä½¿ç”¨`JSONResponse`, è€Œä½¿ç”¨Response</span>
<span class="c1"># ä½¿ç”¨ request.data è·å–POSTè¯·æ±‚å‚æ•°</span>
<span class="c1"># ä½¿ç”¨ @api_view([&#39;GET&#39;, &#39;POST&#39;]) æ§åˆ¶è§†å›¾å‡½æ•°æ”¯æŒçš„æ–¹æ³•ç±»å‹</span>
<span class="c1"># ä½¿ç”¨ restframwork Response è¿”å›æ­£ç¡®æˆ–è€…é”™è¯¯çš„å“åº”, å¹¶ä½¿ç”¨å…¶statusæ¨¡å—, ç”¨ä»¥æŠ›å‡ºç‰¹å®šå«ä¹‰çš„å¼‚å¸¸</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>


<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">snippet_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all snippets, or create a new snippet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">snippets</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippets</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">snippet_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve, update or delete a snippet instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span>
        <span class="n">snippet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
</pre></div>
</div>
<h2>2.6 è®©APIå¯ä»¥æ”¯æŒå¯é€‰çš„æ ¼å¼åç¼€</h2>

<p>ä¾‹å­</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># viewsæ·»åŠ formatå‚æ•°</span>

<span class="k">def</span> <span class="nf">snippet_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">pass</span>
    
<span class="k">def</span> <span class="nf">snippet_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">pass</span>
    
<span class="c1"># format_suffix_patterns, URLæ·»åŠ formatå‚æ•°æ”¯æŒ</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">rest_framework.urlpatterns</span> <span class="kn">import</span> <span class="n">format_suffix_patterns</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">snippet_list</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">snippet_detail</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">(</span><span class="n">urlpatterns</span><span class="p">)</span>
</pre></div>
</div>
<p>æµ‹è¯•get</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># è¿”å›HTML</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">.</span><span class="n">api</span> 

<span class="c1"># è¿”å›JSON</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>æµ‹è¯•POST</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">é€šè¿‡ä½¿ç”¨Content-Type header,æˆ‘ä»¬å¯ä»¥æ§åˆ¶ä½¿ç”¨ä»€ä¹ˆæ ¼å¼çš„æ•°æ®å‘èµ·POSTè¯·æ±‚</span>
<span class="sd">ä½¿ç”¨httpieåº“æ›´ç®€æ´</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># POST using form data</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="o">--</span><span class="n">form</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;print 123&quot;</span>

<span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print 123&quot;</span><span class="p">,</span>
  <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
  <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span>
<span class="p">}</span>

<span class="c1"># POST using JSON</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="o">--</span><span class="n">json</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;print 456&quot;</span>

<span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print 456&quot;</span><span class="p">,</span>
    <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>æˆ‘ä»¬ä¸ä¸€å®šè¦åŠ ä¸Šè¿™äº›é¢å¤–çš„URLæ¨¡å¼ï¼Œä½†å®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç®€å•çš„ï¼ŒæŒ‡ç‰¹å®šæ ¼å¼çš„æ¸…æ´æ–¹å¼;</p>

<h2>2.7 å°ç»“</h2>

<p>åˆ°æ­¤ä¸ºæ­¢,æˆ‘ä»¬å­¦ä¹ äº†<code>RESTframwork</code> å¦‚ä½•åœ¨ <code>åŸºäºå‡½æ•°çš„è§†å›¾</code>ä¸­ä½¿ç”¨æ–¹æ³•, å­¦ä¹ äº†RESTframworkä¸‹çš„è¯·æ±‚å’Œå“åº”å¦‚ä½•ä½¿ç”¨, å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨æ›´å…·æ„ä¹‰çš„<code>Status code</code>, å­¦ä¹ äº†å¦‚ä½•åŒ…è£…APIè®©å…¶ä»…ä»…æ”¯æŒéƒ¨åˆ†æ–¹æ³•, å­¦ä¹ äº†å¦‚ä½•ç»™APIæ·»åŠ æ ¼å¼åç¼€å»è½»ä¾¿çš„è·å–ä¸åŒè¿”å›æ ¼å¼çš„APIæ¥å£;</p>

<h1>3. åŸºäºç±»çš„è§†å›¾-Class based views</h1>

<p>æˆ‘ä»¬å¯ä»¥å†™åŸºäºClassçš„APIè§†å›¾ã€‚è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ¨¡å¼ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿé‡ç”¨çš„åŠŸèƒ½ï¼Œå¹¶æœ‰åŠ©äºæˆ‘ä»¬ä¿æŒä»£ç å¹²å‡€, æ•´æ´;</p>

<h2>3.1 é‡å†™æˆ‘ä»¬çš„è§†å›¾å‡½æ•°ä¸ºåŸºäºç±»çš„æ–¹å¼</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># views.py</span>

<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">status</span>


<span class="k">class</span> <span class="nc">SnippetList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all snippets, or create a new snippet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">snippets</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippets</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve, update or delete a snippet instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">SnippetSerializer</span><span class="p">(</span><span class="n">snippet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">snippet</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
 
<span class="c1"># urls</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">rest_framework.urlpatterns</span> <span class="kn">import</span> <span class="n">format_suffix_patterns</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">(</span><span class="n">urlpatterns</span><span class="p">)</span> 

<span class="c1"># æ­¤æ—¶å°±å’Œä¸Šä¸€éƒ¨åˆ†çš„APIä¸€æ ·äº†</span>
</pre></div>
</div>
<h2>3.2 ä½¿ç”¨æ··åˆç±»çš„æ–¹å¼æ¥ä»£æ›¿<code>@api_view</code>è£…é¥°å™¨åŠŸèƒ½</h2>

<p>Using mixins</p>

<p>One of the big wins of using class-based views is that it allows us to easily compose reusable bits of behaviour.(æ„è¯‘: æ··åˆç±»çš„æ–¹å¼ä½¿ä»£ç æœ‰æ›´å¥½çš„é‡ç”¨æ€§)</p>

<p>The create/retrieve/update/delete operations that we&#39;ve been using so far are going to be pretty similar for any model-backed API views we create. Those bits of common behaviour are implemented in REST framework&#39;s mixin classes.(æ„è¯‘: å¸¸è§çš„ åˆ›å»º/è·å–/æ›´æ–°/åˆ é™¤ æ“ä½œéƒ½å¯ä»¥ç”¨æ··åˆç±»çš„æ–¹å¼å®ç°, éœ€è¦ä»€ä¹ˆåŠŸèƒ½å°±æ·»åŠ å¯¹åº”çš„æ··åˆç±»)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># é‡æ„views</span>

<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">mixins</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>

<span class="k">class</span> <span class="nc">SnippetList</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
                  <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
                  <span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">RetrieveModelMixin</span><span class="p">,</span>
                    <span class="n">mixins</span><span class="o">.</span><span class="n">UpdateModelMixin</span><span class="p">,</span>
                    <span class="n">mixins</span><span class="o">.</span><span class="n">DestroyModelMixin</span><span class="p">,</span>
                    <span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The base class provides the core functionality, and the mixin classes provide the .list() and .create() actions. We&#39;re then explicitly binding the get and post methods to the appropriate actions. Simple enough stuff so far.(æ„è¯‘: åŸºç±»æä¾›äº†æ ¸å¿ƒåŠŸèƒ½ï¼Œæ··åˆç±»æä¾›list()å’Œcreate()è¡ŒåŠ¨, æˆ‘ä»¬é€šè¿‡ç»§æ‰¿å¯¹åº”actionçš„æ··åˆç±», æ·»åŠ å¯¹åº”actionçš„æ”¯æŒ, åˆ°ç›®å‰ä¸ºæ­¢, å·²ç»è¶³å¤Ÿç®€å•äº†)</p>

<h2>3.3 ä½¿ç”¨é€šç”¨ç±»è§†å›¾-Using generic class-based views</h2>

<p>é€šç”¨ç±»è§†å›¾æ˜¯å¯¹æ··åˆç±»è§†å›¾çš„ç®€å•å°è£…, åŠŸèƒ½è¿›è¡Œäº†ä¸€äº›åˆå¹¶é‡ç»„æ“ä½œ;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># åŸºäºç±»çš„é€šç”¨è§†å›¾</span>

<span class="kn">from</span> <span class="nn">snippets.models</span> <span class="kn">import</span> <span class="n">Snippet</span>
<span class="kn">from</span> <span class="nn">snippets.serializers</span> <span class="kn">import</span> <span class="n">SnippetSerializer</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>

<span class="k">class</span> <span class="nc">SnippetList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>

<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>
    
<span class="c1"># ListCreateAPIViewæºä»£ç </span>
<span class="k">class</span> <span class="nc">ListCreateAPIView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ListModelMixin</span><span class="p">,</span>
                        <span class="n">mixins</span><span class="o">.</span><span class="n">CreateModelMixin</span><span class="p">,</span>
                        <span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concrete view for listing a queryset or creating a model instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="err">å¯ä»¥çœ‹å‡º</span><span class="p">,</span> <span class="err">é€šç”¨ç±»è§†å›¾å…¶å®å°±æ˜¯ç»§æ‰¿å“åº”çš„</span><span class="n">mixins</span><span class="err">ç±»</span><span class="p">,</span> <span class="err">ç„¶åå†…å®¹å®ç°äº†å¯¹åº”ç±»éœ€è¦çš„</span><span class="n">action</span><span class="err">æ–¹æ³•</span>
</pre></div>
</div>
<h2>3.4 å°ç»“</h2>

<p>å“‡ï¼Œé‚£æ˜¯ç›¸å½“çš„ç®€æ´ã€‚æˆ‘ä»¬å·²ç»å¾—åˆ°äº†å¤§é‡çš„è‡ªç”±ï¼Œæˆ‘ä»¬çš„ä»£ç çœ‹èµ·æ¥æ˜¯å¥½çš„ï¼Œå¹²å‡€çš„ï¼Œåœ°é“çš„Djangoã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿›å…¥æœ¬æ•™ç¨‹çš„4éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹æˆ‘ä»¬å¦‚ä½•å¤„ç†æˆ‘ä»¬çš„APIè®¤è¯å’Œæƒé™;</p>

<h1>4. è®¤è¯å’Œæƒé™-Authentication and permissions</h1>

<p>ç›®å‰æˆ‘ä»¬çš„APIæ²¡æœ‰é™åˆ¶è°å¯ä»¥ç¼–è¾‘æˆ–åˆ é™¤ä»£ç ç‰‡æ®µ</p>

<ol>
<li>snippetsæ€»å…³è”ä¸€ä¸ªåˆ›å»ºè€…; (Authentication)</li>
<li>åªæœ‰é€šè¿‡è®¤è¯çš„ç”¨æˆ·å¯ä»¥åˆ›å»ºç‰‡æ®µ; (Authentication)</li>
<li>åŒ¿åè´¦æˆ·æˆ–è€…æœªè®¤è¯çš„è¯·æ±‚æ‹¥æœ‰éƒ¨åˆ†APIçš„åªè¯»æƒé™; (Authentication) </li>
<li>åªæœ‰ä»£ç æ®µçš„åˆ›å»ºè€…å¯ä»¥æ›´æ–°å’Œåˆ é™¤å®ƒ; (permissions)</li>
</ol>

<h2>4.1 è¿˜æ˜¯ä¹‹å‰ä»£ç æ®µçš„ä¾‹å­-Adding information to our model</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># æ¨¡å‹æ·»åŠ å­—æ®µ</span>
<span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;auth.User&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
<span class="n">highlighted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="c1"># å®ä¾‹ä¿å­˜, é«˜äº®æ˜¾ç¤ºä»£ç ç‰‡æ®µ</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">å¯¼å…¥æ¨¡å—, é‡å†™saveå‡½æ•°</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">get_all_lexers</span>
<span class="kn">from</span> <span class="nn">pygments.styles</span> <span class="kn">import</span> <span class="n">get_all_styles</span>
<span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">get_lexer_by_name</span>
<span class="kn">from</span> <span class="nn">pygments.formatters.html</span> <span class="kn">import</span> <span class="n">HtmlFormatter</span>
<span class="kn">from</span> <span class="nn">pygments</span> <span class="kn">import</span> <span class="n">highlight</span>

<span class="n">LEXERS</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_all_lexers</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">LANGUAGE_CHOICES</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">LEXERS</span><span class="p">])</span>
<span class="n">STYLE_CHOICES</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_all_styles</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">Snippet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">linenos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STYLE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;friendly&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;auth.User&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">highlighted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the `pygments` library to create a highlighted HTML</span>
<span class="sd">        representation of the code snippet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">get_lexer_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">linenos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linenos</span> <span class="ow">and</span> <span class="s1">&#39;table&#39;</span> <span class="ow">or</span> <span class="bp">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">}</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">HtmlFormatter</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="n">linenos</span><span class="p">,</span>
                                  <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlighted</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Snippet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,)</span>
    
<span class="c1"># åˆ é™¤ä¹‹å‰çš„Sqliteæ•°æ®å’Œmigrationsæ–‡ä»¶, é‡æ–°ç”Ÿæˆæ•°æ®åº“, åˆ›å»ºè¶…çº§ç”¨æˆ·</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="n">tmp</span><span class="o">.</span><span class="n">db</span> <span class="n">db</span><span class="o">.</span><span class="n">sqlite3</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">r</span> <span class="n">snippets</span><span class="o">/</span><span class="n">migrations</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">makemigrations</span> <span class="n">snippets</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">createsuperuser</span>

<span class="c1"># æ·»åŠ ç”¨æˆ·åºåˆ—åŒ–ä»£ç , serializers.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">å› ä¸º &#39;snippets&#39; å’Œç”¨æˆ·modelæ˜¯åå‘å…³è”ï¼ˆreverse relationshipï¼Œå³å¤šå¯¹ä¸€ï¼‰ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ ModelSerializeræ—¶å¹¶ä¸ä¼šç¼ºçœåŠ å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ˜¾å¼çš„æ¥å®ç°</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">snippets</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">PrimaryKeyRelatedField</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;snippets&#39;</span><span class="p">)</span>
        
<span class="err">è¯´æ˜</span><span class="p">:</span> <span class="n">snippets</span><span class="err">ä¹Ÿå¯ä»¥è¿™æ ·å†™</span><span class="p">(</span><span class="n">PS</span><span class="p">:</span> <span class="err">æš‚æ—¶è¿˜ä¸çŸ¥é“ä¸¤ç§ä¸åŒçš„å®ç°æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«</span><span class="p">)</span>
    <span class="n">snippets</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">PrimaryKeyRelatedField</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">allow_null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<span class="c1"># Usersè§†å›¾å®ç°</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">æˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¸€äº›viewsï¼Œå¯¹ç”¨æˆ·å‘ˆç°è€Œè¨€ï¼Œæˆ‘ä»¬æœ€å¥½ä½¿ç”¨åªè¯»çš„viewï¼Œæ‰€ä»¥ä½¿ç”¨ ListAPIView å’Œ RetrieveAPIView æ³›å‹ç±»Views</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">UserList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>

<span class="k">class</span> <span class="nc">UserDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveAPIView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    
<span class="c1"># ä¿®æ”¹URL(PS: æ³¨æ„æ’é™¤å…¶ä»–usersçš„URLçš„å¹²æ‰°, æˆ‘å°±çŠ¯è¿‡è¿™ä¹ˆSBçš„é”™è¯¯, æµªè´¹äº†å¾ˆå¤šæ—¶é—´.)</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</pre></div>
</div>
<h2>4.2 ç”¨æˆ·ç›¸å…³ç‰‡æ®µ-Associating Snippets with Users</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># æŠŠSnippetsä¸Userså…³è”</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">æ­¤æ—¶POSTä»£ç ç‰‡æ®µä¼šæŠ¥é”™:</span>
<span class="sd">Exception Type: IntegrityError</span>
<span class="sd">Exception Value:    </span>
<span class="sd">NOT NULL constraint failed: snippets_snippet.owner_id</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">The</span> <span class="n">way</span> <span class="n">we</span> <span class="n">deal</span> <span class="k">with</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">by</span> <span class="n">overriding</span> <span class="n">a</span> <span class="o">.</span><span class="n">perform_create</span><span class="p">()</span> <span class="n">method</span> <span class="n">on</span> <span class="n">our</span> <span class="n">snippet</span> <span class="n">views</span><span class="p">,</span> <span class="n">that</span> <span class="n">allows</span> <span class="n">us</span> <span class="n">to</span> <span class="n">modify</span> <span class="n">how</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">save</span> <span class="ow">is</span> <span class="n">managed</span><span class="p">,</span> <span class="ow">and</span> <span class="n">handle</span> <span class="nb">any</span> <span class="n">information</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">implicit</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">incoming</span> <span class="n">request</span> <span class="ow">or</span> <span class="n">requested</span> <span class="n">URL</span><span class="o">.</span>
<span class="p">(</span><span class="err">æ„è¯‘</span><span class="p">:</span> <span class="err">å¯ä»¥åœ¨</span><span class="n">views</span><span class="err">ç±»ä¸­</span><span class="p">,</span> <span class="err">é‡å†™</span><span class="o">.</span><span class="n">perform_create</span><span class="p">()</span><span class="err">æ–¹æ³•æ¥å¤„ç†</span><span class="n">request</span><span class="err">è¯·æ±‚ä¸­çš„éšå¼ä¿¡æ¯</span><span class="p">,</span> <span class="err">ä¾‹å¦‚</span><span class="p">:</span> <span class="err">åœ¨æ­¤ä¾‹ä¸­æˆ‘ä»¬</span><span class="sb">`owner=self.request.user`</span><span class="err">å°†è¯·æ±‚æºå¸¦çš„ç”¨æˆ·å®ä¾‹ä¼ é€’ç»™</span><span class="n">owner</span><span class="err">å±æ€§</span><span class="p">)</span>

<span class="err">åœ¨</span> <span class="n">SnippetList</span> <span class="err">å’Œ</span> <span class="n">SnippetDetail</span> <span class="err">çš„</span><span class="n">view</span><span class="err">ç±»ä¸­ï¼Œéƒ½éœ€è¦æ·»åŠ å¦‚ä¸‹çš„æ–¹æ³•</span><span class="p">:</span>
<span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ä¿å­˜æ•°æ®æ—¶æ·»åŠ ä¸€ä¸ªowner&quot;&quot;&quot;</span>
    <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="sb">``</span><span class="err">`</span>

<span class="c1">## 4.3 æ›´æ–°åºåˆ—åŒ–æ–‡ä»¶-Updating our serializer</span>

<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="c1"># æ›´æ–° serializer</span>
<span class="k">class</span> <span class="nc">SnippetSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ReadOnlyField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;owner.username&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Snippet</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;linenos&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">)</span>

<span class="n">source</span> <span class="err">å‚æ•°è¡¨æ˜å¢åŠ ä¸€ä¸ªæ–°å­—æ®µï¼Œå¯ä»¥æŒ‡å®šåºåˆ—åŒ–å®ä¾‹ä»»ä½•å±æ€§ã€‚å®ƒå¯ä»¥é‡‡ç”¨å¦‚ä¸Šçš„ç‚¹å¼è¡¨ç¤ºï¼ˆ</span><span class="n">dotted</span> <span class="n">notation</span><span class="err">ï¼‰ï¼Œè¿™æ—¶ä»–å¯ä»¥ç›´æ¥éå†åˆ°æŒ‡å®šçš„å±æ€§ã€‚åœ¨</span><span class="n">Django</span><span class="s1">&#39;s templateä¸­ä½¿ç”¨æ—¶ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ç±»ä¼¼çš„æ–¹å¼;</span>

<span class="err">æˆ‘ä»¬å¢åŠ å­—æ®µæ˜¯ä¸€ä¸ª</span><span class="n">ReadOnlyField</span> <span class="err">ç±»ï¼Œè€Œæˆ‘ä»¬ä¹‹å‰çš„å­—æ®µéƒ½æ˜¯æœ‰ç±»å‹çš„ï¼Œä¾‹å¦‚</span> <span class="n">CharField</span><span class="p">,</span> <span class="n">BooleanField</span> <span class="n">etc</span><span class="o">...</span> <span class="err">æ— ç±»å‹å­—æ®µæ€»æ˜¯åªè¯»çš„ï¼Œå®ƒä»¬åªç”¨åœ¨åºåˆ—åŒ–è¡¨ç¤ºä¸­ï¼Œè€Œåœ¨ååºåˆ—åŒ–æ—¶ï¼ˆä¿®æ”¹</span><span class="n">model</span><span class="err">ï¼‰ä¸è¢«ä½¿ç”¨</span><span class="p">;</span>
</pre></div>
</div>
<h2>4.4 æ·»åŠ éœ€è¦çš„æƒé™ç»™è§†å›¾-Adding required permissions to views</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ç»™viewå¢åŠ æƒé™æ§åˆ¶</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ç°åœ¨ä»£ç ç‰‡æ®µ snippets å·²ç»å…³è”äº†ç”¨æˆ·ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åªæœ‰è®¤è¯ç”¨æˆ·æ‰èƒ½å¢ã€åˆ ã€æ”¹snippets;</span>

<span class="sd">REST framework åŒ…æ‹¬è®¸å¤šæƒé™ç±»å¯ç”¨äºviewçš„æ§åˆ¶ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ IsAuthenticatedOrReadOnly, å®ƒå¯ç¡®ä¿è®¤è¯çš„requestè·å–read-writeæƒé™ï¼Œè€Œéè®¤è¯çš„requeståªæœ‰read-onlyæƒé™.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="err">ç°éœ€è¦åœ¨</span><span class="n">views</span><span class="err">æ¨¡å—ä¸­å¢åŠ </span> <span class="n">import</span><span class="p">:</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>
<span class="err">ç„¶åéœ€è¦åœ¨</span> <span class="n">SnippetList</span> <span class="err">å’Œ</span> <span class="n">SnippetDetail</span> <span class="n">view</span><span class="err">ç±»ä¸­éƒ½å¢åŠ å¦‚ä¸‹å±æ€§</span><span class="p">:</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,)</span>
</pre></div>
</div>
<h2>4.5 æ·»åŠ æµè§ˆå™¨ç™»å½•-Adding login to the Browsable API</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ä¸ºå¯æµè§ˆAPIï¼ˆBrowseable APIï¼‰å¢åŠ login</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">å¦‚æœä½ æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®å¯æµè§ˆAPIï¼Œä½ ä¼šå‘ç°åªæœ‰ç™»å½•åæ‰èƒ½åˆ›å»ºæ–°çš„snippetäº†</span>

<span class="sd">r&#39;^api-auth/&#39; éƒ¨åˆ†å¯ä»¥ç”¨ä»»ä½•ä½ æƒ³ç”¨çš„URLæ¥æ›¿ä»£ã€‚è¿™é‡Œå”¯ä¸€çš„é™åˆ¶å°±æ˜¯ urls å¿…é¡»ä½¿ç”¨&#39;rest_framework&#39; å‘½åç©ºé—´;</span>

<span class="sd">æ‰“å¼€æµè§ˆå™¨ï¼Œåˆ·æ–°é¡µé¢ä¼šçœ‹åˆ°é¡µé¢å³ä¸Šæ–¹çš„ &#39;Login&#39; é“¾æ¥ã€‚å¦‚æœä½ ç”¨ä¹‹å‰çš„ç”¨æˆ·ç™»å½•åï¼Œä½ å°±åˆå¯ä»¥åˆ›å»º snippetsäº†;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">include</span>
<span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">patterns</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^api-auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;rest_framework.urls&#39;</span><span class="p">,</span>
                               <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;rest_framework&#39;</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</div>
<h2>4.6 å¯¹è±¡çº§åˆ«çš„æƒé™-Object level permissions</h2>

<p>æˆ‘ä»¬å¸Œæœ›ä»»ä½•äººéƒ½å¯ä»¥æµè§ˆsnippetsï¼Œä½†åªæœ‰åˆ›å»ºsnippetçš„ç”¨æˆ·æ‰èƒ½ç¼–è¾‘æˆ–åˆ é™¤å®ƒ;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># åœ¨ snippets åº”ç”¨ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼š permissions.py</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>


<span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom permission to only allow owners of an object to edit it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># Read permissions are allowed to any request,</span>
        <span class="c1"># so we&#39;ll always allow GET, HEAD or OPTIONS requests.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="c1"># Write permissions are only allowed to the owner of the snippet.</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</pre></div>
</div>
<p>ç°åœ¨æ‰“å¼€æµè§ˆå™¨ï¼Œä½ å¯ä»¥çœ‹è§ &#39;DELETE&#39; å’Œ &#39;PUT&#39; åŠ¨ä½œåªä¼šå‡ºç°åœ¨é‚£äº›ä½ çš„ç™»å½•ç”¨æˆ·åˆ›å»ºçš„snippeté¡µé¢ä¸Šäº†</p>

<p>æ³¨é”€çŠ¶æ€: åªè¯»</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15040671453007.jpg"></p>
</p>

<p>ç™»å½•çŠ¶æ€: å¢/åˆ /æ”¹/æŸ¥
<p class="hassubimage"><img src="http://iwillb.imdancer.com/15040671889236.jpg"></p>
</p>

<h2>4.7 é€šè¿‡APIéªŒè¯-Authenticating with the API</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># æœªè®¤è¯</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;print 123&quot;</span>

<span class="p">{</span>
    <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Authentication credentials were not provided.&quot;</span>
<span class="p">}</span>

<span class="c1"># è®¤è¯å</span>
<span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">tom</span><span class="p">:</span><span class="n">password123</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">snippets</span><span class="o">/</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;print 789&quot;</span>

<span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="s2">&quot;tom&quot;</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;print 789&quot;</span><span class="p">,</span>
    <span class="s2">&quot;linenos&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="s2">&quot;style&quot;</span><span class="p">:</span> <span class="s2">&quot;friendly&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>4.8 å·¥ä½œç”¨ä¸€äº›å¸¸ç”¨æƒé™åº”ç”¨åœºæ™¯çš„è¡¥å……</h2>

<h3>1. æ˜¯å¦éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®  (Authentication)</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ç™»å½•çš„äººæ‰æœ‰è¯»å†™æƒé™</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticated</span><span class="p">)</span>
<span class="c1"># ç™»å½•çš„äººæ‰æœ‰è¯»å†™æƒé™, æœªç™»å½•çš„ç”¨æˆ·åªè¯»</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span>
</pre></div>
</div>
<h3>2. æ˜¯å¦éœ€è¦æ‹¥æœ‰äººæ‰èƒ½å˜æ›´ (permissions)</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># Django RESTframwork æ²¡æœ‰æä¾›é»˜è®¤çš„æƒé™, éœ€è¦æˆ‘ä»¬è‡ªå®šä¹‰</span>
<span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom permission to only allow owners of an object to edit it.</span>
<span class="sd">    è‡ªå®šä¹‰æƒé™: åŒ¿åç”¨æˆ·æœ‰è¯»æƒé™, æ‹¥æœ‰è€…æ‰æœ‰å†™æƒé™</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># # Read permissions are allowed to any request,</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
             <span class="k">return</span> <span class="bp">True</span>
        <span class="c1"># Write permissions are only allowed to the owner of the snippet</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        
<span class="err">å¦‚ä½•åˆ¤æ–­è¯·æ±‚è€…æ˜¯å¦æ˜¯æ‹¥æœ‰è€…?</span>
<span class="err">è¯·æ±‚è€…</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
<span class="err">æ‹¥æœ‰è€…</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span>

<span class="err">æ‹¥æœ‰è€…å±æ€§æ˜¯å¦‚ä½•æ¥çš„å‘¢?</span> 
<span class="err">åœ¨æœ¬æ•™ç¨‹çš„</span><span class="sb">`Snippets`</span><span class="err">ä¾‹å­çš„æ¨¡å‹ä»£ç ä¸­æ·»åŠ äº†</span><span class="n">owner</span><span class="err">å¤–é”®å…³è”å­—æ®µ</span>
<span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;auth.User&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
</pre></div>
</div>
<h3>3. åå°ç®¡ç†å‘˜æ˜¯å¦èƒ½å˜æ›´  (permissions)</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ç®¡ç†å‘˜ç”¨æˆ·æ‰æœ‰æƒé™è®¿é—®, å¦‚ä½•åˆ¤æ–­è¯·æ±‚è€…æ˜¯ç®¡ç†å‘˜å‘¢?</span>
<span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticated</span><span class="p">)</span>
<span class="c1"># æºä»£ç : RESTframworké»˜è®¤æ˜¯é€šè¿‡ç”¨æˆ·æ¨¡å‹ä¸­çš„is_staffå­—æ®µæ¥åˆ¤æ–­çš„</span>
<span class="k">class</span> <span class="nc">IsAdminUser</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows access only to admin users.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span>

<span class="c1"># è‹¥æ˜¯æ¥å£çš„æ•°æ®ä¸€å®šè¦æ‹¥æœ‰è€…æ‰èƒ½è®¿é—®, æ— è®ºæ˜¯è¯»è¿˜æ˜¯å†™</span>
<span class="k">class</span> <span class="nc">IsOwner</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</pre></div>
</div>
<h3>4. ç»™é™¤äº†æ‹¥æœ‰è€…å’Œç®¡ç†å‘˜ä¹‹å¤–çš„ç”¨æˆ·æ·»åŠ ç‰¹å®šå˜æ›´actionçš„æƒé™ (permissions)</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># å¯ä»¥ç»™ç”¨æˆ·åˆ†ç»„,åˆ†è§’è‰²,æ ¹æ®ä¸åŒåˆ†ç»„å†…çš„ä¸åŒè§’è‰²æœ‰ä¸åŒçš„æƒé™è®¾å®š</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">åœ¨adminåå°ç®¡ç†ä¸­å¯ä»¥è¿›è¡Œç”¨æˆ·ç»„ç®¡ç†, æˆ‘ä»¬å¯ä»¥æŒ‰åŠŸèƒ½æ¨¡å—æ·»åŠ ç»„, ç„¶åå°†ä¸åŒçš„ç”¨æˆ·æ·»åŠ åˆ°å¯¹åº”çš„ç»„ä¸­;</span>
<span class="sd">åœ¨permissions.pyæ–‡ä»¶ä¸­å®šä¹‰ç»„ä¸­çš„å„ç§actionçš„æ’åˆ—ç»„åˆç±»ä»¥å®ç°å„ç§æƒé™è¦æ±‚;</span>

<span class="sd">ä¾‹å¦‚: </span>
<span class="sd">æ·»åŠ ä¸€ä¸ªèµ›äº‹ç»„competition_admin, å°†user1åŠ å…¥åˆ°competition_adminç»„, è¦æ±‚èµ›äº‹ç®¡ç†å‘˜ç»„çš„å†…çš„ç”¨æˆ·æ‰èƒ½æ›´æ”¹æ•°æ®, å…¶ä»–çš„ç”¨æˆ·åªèƒ½æŸ¥çœ‹æ•°æ®;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">class</span> <span class="nc">IsCompetitionAdmin</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;æ³¨æ„: æ­¤æ®µä»£ç æ²¡æœ‰ç»è¿‡æµ‹è¯•, åªæ˜¯å†™äº†ä¸€ç§å®ç°æ–¹å¼&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="n">AuthGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;competition_admin&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Groups</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<h3>5. ä¸å…è®¸ç”¨æˆ·åˆ é™¤æ•°æ®, ä»…ä¿ç•™æ›´æ”¹æƒé™</h3>

<p>åœºæ™¯: å†™æƒé™(PUT, PATCH, POST, DELETE), ç”±äºæ•°æ®çš„æ•æ„Ÿæ€§, æˆ‘ä»¬æŠŠåˆ é™¤æ•°æ®éƒ½æ”¹ä¸º<code>éšè—æ•°æ®</code>(å³ä½¿ç”¨PUT, PATCHæ–¹æ³•, ä¼ é€’deleted=1), ç„¶ååœ¨è¯»å–æ•°æ®çš„åœ°æ–¹éƒ½<code>è¿‡æ»¤æœªéšè—</code>çš„(deleted!=1), è¿™ç§æ–¹å¼å‡å°‘æ•°æ®è¯¯åˆ çš„å¯èƒ½. å¦å¤–æ·»åŠ ä¸€ä¸ªå­—æ®µhiddenç”¨æ¥æ ‡è¯†<code>ç”¨æˆ·çš„éšè—æ“ä½œ</code>;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ä¸€æ£’å­æ‰“æ­»: æ¥å£æ”¹ä¸ºåªæ”¯æŒUPDATEæ–¹æ³•</span>
<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
<span class="err">æ›´æ”¹ä¸º</span><span class="p">:</span>
<span class="k">class</span> <span class="nc">SnippetDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateAPIView</span><span class="p">):</span>
</pre></div>
</div>
<p>ç°åœ¨æ‰“å¼€æµè§ˆå™¨ï¼Œ&#39;DELETE&#39; æŒ‰é’®æ²¡æœ‰äº†</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15040740975415.jpg"></p>
</p>

<ul>
<li><a href="https://segmentfault.com/q/1010000005685904">çŸ¥è¯†è¡¥å……1: Patchæ–¹æ³•å’ŒPUTçš„åŒºåˆ«</a></li>
</ul>

<p>PATCHæ–¹æ³•æ˜¯æ–°å¼•å…¥çš„ï¼Œæ˜¯å¯¹PUTæ–¹æ³•çš„è¡¥å……ï¼Œç”¨æ¥å¯¹å·²çŸ¥èµ„æºè¿›è¡Œå±€éƒ¨æ›´æ–°, è¿™å¥è¯æˆ‘ä»¬è¯¥å¦‚ä½•ç†è§£ï¼Ÿ</p>

<p>åœºæ™¯: å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªUserInfoï¼Œé‡Œé¢æœ‰userIdï¼Œ userNameï¼Œ userGenderç­‰10ä¸ªå­—æ®µã€‚å¯ä½ çš„ç¼–è¾‘åŠŸèƒ½å› ä¸ºéœ€æ±‚ï¼Œåœ¨æŸä¸ªç‰¹åˆ«çš„é¡µé¢é‡Œåªèƒ½ä¿®æ”¹userNameï¼Œè¿™æ—¶å€™çš„æ›´æ–°æ€ä¹ˆåšï¼Ÿ</p>

<p>ä½¿ç”¨patchæ–¹æ³•, åªä¼ ä¸€ä¸ªuserNameåˆ°æŒ‡å®šèµ„æºå»ï¼Œè¡¨ç¤ºè¯¥è¯·æ±‚æ˜¯ä¸€ä¸ªå±€éƒ¨æ›´æ–°ï¼Œåç«¯ä»…æ›´æ–°æ¥æ”¶åˆ°çš„å­—æ®µ;
ä½¿ç”¨putæ–¹æ³•,è¦æ±‚å‰ç«¯æä¾›çš„ä¸€å®šæ˜¯ä¸€ä¸ªå®Œæ•´çš„èµ„æºå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰æä¾›å®Œæ•´çš„UserInfo, æ¥å£ä¼šæŠ›å‡ºå¼‚å¸¸;</p>

<p>æµ‹è¯•:
<p class="hassubimage"><img src="http://iwillb.imdancer.com/15040760497071.jpg"></p>
</p>

<p>ä¸å‡ºæ‰€æ–™:
<p class="hassubimage"><img src="http://iwillb.imdancer.com/15040760706408.jpg"></p>
</p>

<ul>
<li><a href="http://www.cnblogs.com/machao/p/5788425.html">çŸ¥è¯†è¡¥å……2: HEADæ–¹æ³•å’ŒOPTIIONSæ–¹æ³•çš„åŒºåˆ«</a></li>
</ul>

<p>HEADæ–¹æ³•å’ŒGETæ–¹æ³•ä¸€è‡´ï¼Œé™¤äº†æœåŠ¡å™¨ä¸èƒ½åœ¨å“åº”é‡Œè¿”å›æ¶ˆæ¯ä¸»ä½“ã€‚HEADè¯·æ±‚å“åº”é‡ŒHTTPå¤´åŸŸé‡Œçš„å…ƒä¿¡æ¯åº”è¯¥å’ŒGETè¯·æ±‚å“åº”é‡Œçš„å…ƒä¿¡æ¯ä¸€è‡´ã€‚æ­¤æ–¹æ³•è¢«ç”¨æ¥è·å–è¯·æ±‚å®ä½“çš„å…ƒä¿¡æ¯è€Œä¸éœ€è¦ä¼ è¾“å®ä½“ä¸»ä½“ï¼ˆentity-bodyï¼‰ã€‚æ­¤æ–¹æ³•ç»å¸¸è¢«ç”¨æ¥æµ‹è¯•è¶…æ–‡æœ¬é“¾æ¥çš„æœ‰æ•ˆæ€§ï¼Œå¯è®¿é—®æ€§ï¼Œå’Œæœ€è¿‘çš„æ”¹å˜;</p>

<p>OPTIONSæ–¹æ³•è¡¨æ˜è¯·æ±‚æƒ³å¾—åˆ°è¯·æ±‚/å“åº”é“¾ä¸Šå…³äºæ­¤è¯·æ±‚é‡Œçš„URIï¼ˆRequest-URIï¼‰æŒ‡å®šèµ„æºçš„é€šä¿¡é€‰é¡¹ä¿¡æ¯ã€‚æ­¤æ–¹æ³•å…è®¸å®¢æˆ·ç«¯å»åˆ¤å®šè¯·æ±‚èµ„æºçš„é€‰é¡¹å’Œ/æˆ–éœ€æ±‚ï¼Œæˆ–è€…æœåŠ¡å™¨çš„èƒ½åŠ›ï¼Œè€Œä¸éœ€è¦åˆ©ç”¨ä¸€ä¸ªèµ„æºåŠ¨ä½œï¼ˆè¯‘æ³¨ï¼šä½¿ç”¨POSTï¼ŒPUTï¼ŒDELETEæ–¹æ³•ï¼‰æˆ–ä¸€ä¸ªèµ„æºè·å–ï¼ˆè¯‘æ³¨ï¼šç”¨GETæ–¹æ³•ï¼‰æ–¹æ³•; æ¯”å¦‚, æœ‰ä¸€ä¸ªå­—æ®µchoices, ä½¿ç”¨OPTIONSæ–¹æ³•å¯ä»¥è¿”å›choicesçš„è¯¦ç»†ä¿¡æ¯, å¦‚æœç”¨GETçš„è¯åªèƒ½çœ‹åˆ°ç®€ä»‹ä¿¡æ¯;   </p>

<h2>4.9 å°ç»“</h2>

<p>æˆ‘ä»¬å·²ç»ä¸ºæˆ‘ä»¬çš„Web APIåˆ›å»ºäº†ç›¸å½“ç»†ç²’åº¦çš„æƒé™æ§åˆ¶å’Œç›¸åº”çš„ç³»ç»Ÿç”¨æˆ·</p>

<h1>5. å…³ç³»å’Œè¶…é“¾æ¥-Relationsships and hyperlinked APIS</h1>

<p>æœ¬æ•™ç¨‹åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒAPI ä¸­å„å®ä½“çš„å…³è”éƒ½æ˜¯é€šè¿‡ä¸»é”®å¤„ç†çš„ã€‚ä¸ºæé«˜æ˜“ç”¨æ€§ï¼Œå®ç°ç”¨è¶…é“¾æ¥æ¥è¡¨ç¤ºå…³è”;</p>

<h2>5.1 åˆ›å»ºä¸€ä¸ªapi_rootè§†å›¾</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># snippets/views.py</span>
<span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">api_view</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.reverse</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="nd">@api_view</span><span class="p">([</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">api_root</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
        <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;user-list&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">),</span>
        <span class="s1">&#39;snippets&#39;</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;snippet-list&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>
    <span class="p">})</span>

<span class="c1"># snippets/urls.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ä½¿ç”¨reverseæ ¹æ®urlåç§°åå‘è§£æå‡ºå®Œæˆçš„URL, åœ¨urls.pyæ–‡ä»¶ä¸­å†™æ˜URL patternsçš„nameåæ‰å¯ä»¥è¿™ä¹ˆä½¿ç”¨</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">rest_framework.urlpatterns</span> <span class="kn">import</span> <span class="n">format_suffix_patterns</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-list&#39;</span><span class="p">),</span> <span class="c1"># å‘½å</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">),</span> <span class="c1"># å‘½å</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-list&#39;</span><span class="p">),</span> <span class="c1"># å‘½å </span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-detail&#39;</span><span class="p">),</span> <span class="c1"># å‘½å</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">api_root</span><span class="p">),</span>  <span class="c1"># add</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/highlight/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetHighlight</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>  <span class="c1"># add</span>
<span class="p">]</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">(</span><span class="n">urlpatterns</span><span class="p">)</span>
</pre></div>
</div>
<h2>5.2 åˆ›å»ºä¸€ä¸ªé«˜äº®ä»£ç æ®µè§†å›¾-Creating an endpoint for the highlighted snippets</h2>

<p>Snippet.highlighted å±æ€§å€¼æ˜¯è¯¥ä»£ç æ®µçš„é«˜äº®è¡¨ç¤ºçš„ HTML ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬ä¸æƒ³è®©å…¶ API è¿”å›çš„æ˜¯ JSON æ ¼å¼ï¼Œè€Œè¦ HTML æ ¼å¼;</p>

<p>REST æ¡†æ¶å¤„ç† HTML æ ¼å¼æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡æ¨¡æ¿æ¥å‘ˆç° HTMLï¼Œå¦ä¸€ç§æ˜¯å¤„ç†é¢„ç¼–ç äº†çš„ HTML ä»£ç ã€‚ä¸ºæ–¹ä¾¿æµ‹è¯•, æœ¬APIé‡‡ç”¨ç¬¬äºŒç§æ–¹å¼;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># å›è¿‡å¤´æ¥æŸ¥çœ‹models.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">æˆ‘ä»¬é‡å†™äº†saveæ–¹æ³•, å°†POSTçš„æ•°æ®æå‰è½¬åŒ–ä¸ºäº†HTMLæ ¼å¼å­˜å‚¨åœ¨highlightedå­—æ®µ</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">class</span> <span class="nc">Snippet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">linenos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">LANGUAGE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">STYLE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;friendly&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;auth.User&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">highlighted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the `pygments` library to create a highlighted HTML</span>
<span class="sd">        representation of the code snippet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lexer</span> <span class="o">=</span> <span class="n">get_lexer_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">linenos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linenos</span> <span class="ow">and</span> <span class="s1">&#39;table&#39;</span> <span class="ow">or</span> <span class="bp">False</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="ow">and</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">}</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">HtmlFormatter</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="n">linenos</span><span class="p">,</span>
                                  <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highlighted</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Snippet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,)</span>
</pre></div>
</div>
<p>ç”±äº Snippet.highlighted æ˜¯ä¸€ä¸ªå®ä¾‹çš„å±æ€§ï¼Œä¸æ˜¯ä¸€ä¸ªæ•°æ®æ¨¡å‹çš„å®ä¾‹ï¼Œæ•…æ²¡æœ‰ç°å­˜çš„é€šç”¨è§†å›¾å¯ä»¥é‡‡ç”¨ï¼Œåªèƒ½ä½¿ç”¨ generics.GenericAPIViewï¼Œç„¶åå®ç° .get();    </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">æˆ‘ä»¬é‡å†™getæ–¹æ³•, è·å–snippetå¯¹è±¡, å¹¶å°†snippet.highlightedå†…å®¹ç»è¿‡renderer_classesæ¨¡æ¿æ¸²æŸ“ä¹‹åè¿”å›;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">renderers</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="k">class</span> <span class="nc">SnippetHighlight</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">GenericAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">renderer_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">renderers</span><span class="o">.</span><span class="n">StaticHTMLRenderer</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">snippet</span><span class="o">.</span><span class="n">highlighted</span><span class="p">)</span>
        
<span class="c1"># renderer_classes</span>
<span class="err">ç”¨æ¥æŒ‡æ˜ç”¨é‚£ç§æ–¹å¼è¿”å›æ•°æ®</span><span class="p">,</span> <span class="n">renderers</span><span class="o">.</span><span class="n">StaticHTMLRenderer</span><span class="err">è¡¨æ˜æ˜¯ç”¨é™æ€æ¨¡æ¿çš„æ–¹å¼è¿”å›ç»™</span><span class="n">client</span><span class="p">;</span>
<span class="err">è‹¥æ³¨é‡Šè¿™è¡Œä»£ç </span><span class="p">,</span> <span class="err">åˆ™</span><span class="n">snippet</span><span class="o">.</span><span class="n">highlighted</span><span class="err">åšä¸ºå­—ç¬¦ä¸²è¿”å›åˆ°ç½‘é¡µ</span><span class="p">;</span>
</pre></div>
</div>
<p>æ·»åŠ  URL:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">api_root</span><span class="p">),</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/highlight/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetHighlight</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</pre></div>
</div>
<h2>5.3 è¶…é“¾æ¥å…³è”-Hyperlinking our API</h2>

<p>æ­£ç¡®å¤„ç†å„å®ä½“é—´çš„å…³è”æ€§æ˜¯ Web API è®¾è®¡å·¥ä½œä¸­çš„éš¾ç‚¹ã€‚ä¸€èˆ¬å¯ç”¨ä»¥ä¸‹å‡ ç§æ–¹æ³•æ¥è¡¨ç¤ºå…³è”æ€§ï¼š</p>

<ol>
<li>ä½¿ç”¨ä¸»é”®</li>
<li>å®ä½“é—´ä½¿ç”¨è¶…é“¾æ¥</li>
<li>ä½¿ç”¨å…³è”å®ä½“ä¸Šçš„ä¸€ä¸ªå”¯ä¸€æ ‡è¯†çš„ slug åŸŸ</li>
<li>ä½¿ç”¨å…³è”å®ä½“çš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤º</li>
<li>å°†å…³è”çš„å®ä½“æ”¾åœ¨çˆ¶å®ä½“å†…</li>
<li>å…¶å®ƒè‡ªå®šä¹‰æ–¹å¼</li>
</ol>

<p>REST æ¡†æ¶æ”¯æŒæ‰€æœ‰è¿™äº›æ–¹æ³•æ¥è¡¨ç¤ºå…³è”ã€‚æœ¬ä¾‹é‡‡ç”¨è¶…é“¾æ¥æ¥è¡¨ç¤ºå®ä½“é—´çš„å…³è”æ€§ã€‚å®ç°æ–¹æ³•æ˜¯å°† SnippetSerializer çš„åŸºç±»ä» ModelSerializer æ”¹ä¸º HyperlinkedModelSerializer;</p>

<p>HyperlinkedModelSerializer ä¸ ModelSerializer çš„åŒºåˆ«æœ‰ï¼š</p>

<ol>
<li>å®ƒé»˜è®¤ä¸åŒ…å« id é¡¹</li>
<li>å®ƒåŒ…å«æœ‰ url é¡¹ï¼Œç±»å‹ä¸º HyperlinkedIdentityField</li>
<li>å…³è”æ€§ä¸ä½¿ç”¨ PrimaryKeyRelatedFieldï¼Œè€Œç”¨ HyperlinkedIdentityField å®ç°</li>
</ol>

<p>é‡æ„ Serializer ä»¥å®ç°è¶…é“¾æ¥å…³è”</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SnippetSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ReadOnlyField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;owner.username&#39;</span><span class="p">)</span>
    <span class="n">highlight</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedIdentityField</span><span class="p">(</span><span class="n">view_name</span><span class="o">=</span><span class="s1">&#39;snippet-highlight&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Snippet</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;highlight&#39;</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;linenos&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UserSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedModelSerializer</span><span class="p">):</span>
    <span class="n">snippets</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedRelatedField</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">view_name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;snippets&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul>
<li>How to Use HyperlinkedModelSerializer</li>
</ul>

<p>ç”±äºä½¿ç”¨äº† HyperlinkedModelSerializerï¼Œæ•…é»˜è®¤ä¸ä¼šåŒ…å« id é¡¹ï¼ŒåŒæ—¶å®šä¹‰äº†ä¸€ä¸ªæ–°çš„ url é¡¹;</p>

<p>HyperlinkedIdentityField ä¸­çš„ view_name å‚æ•°æŒ‡å®šäº†è¯¥è¶…é“¾æ¥é¡¹çš„ URLï¼Œå…¶å€¼é€šè¿‡ reverse() å‡½æ•°è§£æï¼Œå› æ­¤è¿™é‡Œç”¨åˆ°çš„ snippet-detail, snippet-highlight ç­‰ URL åéƒ½å¿…é¡»åœ¨ urls.py ä¸­å®šä¹‰;</p>

<p>å¯¹äºæ•°æ®æ¨¡å‹çš„ Serializerï¼Œå…¶é»˜è®¤çš„ url é¡¹å¯¹åº”çš„ HyperlinkedIdentityField çš„ view_name å€¼ä¸º æ•°æ®æ¨¡å‹å-detailï¼Œä¾‹å¦‚ SnippetSerializer å¯¹åº” snippet-detail;</p>

<p>ç”±ä¸Šé¢çš„ä½¿ç”¨æƒ…å†µå¯çœ‹å‡ºï¼ŒHyperlinkedIdentityField çš„ view_name å‚æ•°å¯¹åº”çš„è§†å›¾ï¼Œéƒ½æ¥æ”¶ä¸€ä¸ª pk å‚æ•°ï¼Œä»¥æŒ‡å‡ºé’ˆå¯¹çš„æ˜¯å“ªä¸ªå…·ä½“çš„æ•°æ®å®ä¾‹, ä¾‹å¦‚:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># æ³¨æ„: è‹¥ä½¿ç”¨è¶…é“¾æ¥, éœ€è¦ä¸ºå¯¹åº”çš„URLæä¾›ä¸€ä¸ªname, æ ¼å¼ä¸º, æ•°æ®æ¨¡å‹å-detail</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>ç”±äº URL ä¸­éƒ½å·²åŠ å…¥äº†æ ¼å¼åç¼€ï¼Œå› æ­¤åœ¨ highlight é¡¹å®šä¹‰ä¸­é€šè¿‡ format=&#39;html&#39; é™åˆ¶è¯¥è¶…é“¾æ¥è¿”å›çš„æ˜¯ HTML æ ¼å¼;</p>

<h2>5.4 å‘½å URL</h2>

<p>æœ€ç»ˆURLè¡¨ç°ä¸º</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">rest_framework.urlpatterns</span> <span class="kn">import</span> <span class="n">format_suffix_patterns</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>

<span class="c1"># API endpoints</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">([</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">api_root</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">SnippetList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">SnippetDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/highlight/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">SnippetHighlight</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-highlight&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">UserList</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span>
        <span class="n">views</span><span class="o">.</span><span class="n">UserDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-detail&#39;</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Login and logout views for the browsable API</span>
<span class="n">urlpatterns</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^api-auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;rest_framework.urls&#39;</span><span class="p">,</span>
                               <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;rest_framework&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
<h2>5.5 æ·»åŠ åˆ†é¡µ</h2>

<p><a href="http://www.django-rest-framework.org/api-guide/pagination/">åˆ†é¡µå®˜æ–¹æ–‡æ¡£</a></p>

<h3>5.5.1 é»˜è®¤åˆ†é¡µ</h3>

<p>Django restframwork çš„åˆ†é¡µæºä»£ç ç»“æ„å¦‚ä¸‹:</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15041536935058.jpg"></p>
</p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹å‡º, RFé»˜è®¤ä¸ºæˆ‘ä»¬æä¾›äº†3ä¸­åˆ†é¡µæ–¹å¼:</p>

<ol>
<li>PageNumberPagination</li>
<li>LimitOffsetPagination</li>
<li>CursorPagination</li>
</ol>

<p>é»˜è®¤æƒ…å†µä¸‹æ˜¯<code>PageNumberPagination</code>çš„æ–¹å¼, æˆ‘ä»¬å¯ä»¥åœ¨settings.pyæ–‡ä»¶ä¸­æ›´æ”¹RFçš„é»˜è®¤åˆ†é¡µæ–¹å¼:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;rest_framework.pagination.LimitOffsetPagination&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PAGE_SIZE&#39;</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</div>
<p>æˆ‘ä¹ˆå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„åˆ†é¡µç±»ä»£æ›¿é»˜è®¤çš„åˆ†é¡µç±»: å®ç°åŠ¨æ€åˆ†é¡µæ•°æ®å¤§å°é™å®š</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># æŒ‡æ˜é»˜è®¤çš„åˆ†é¡µå¤§å°, å¹¶è®¾å®šæœ€å¤§çš„åˆ†é¡µå¤§å°</span>
<span class="k">class</span> <span class="nc">LargeResultsSetPagination</span><span class="p">(</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># é»˜è®¤å€¼</span>
    <span class="n">page_size_query_param</span> <span class="o">=</span> <span class="s1">&#39;page_size&#39;</span>
    <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">10000</span> <span class="c1"># æœ€å¤§å€¼</span>

<span class="k">class</span> <span class="nc">StandardResultsSetPagination</span><span class="p">(</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="n">page_size</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">page_size_query_param</span> <span class="o">=</span> <span class="s1">&#39;page_size&#39;</span>
    <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">1000</span>
    
<span class="c1"># ä»£æ›¿é»˜è®¤çš„åˆ†é¡µç±», For example:</span>
<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;apps.core.pagination.StandardResultsSetPagination&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ç‰¹å®šçš„viewsä¸­æ·»åŠ pagination_classä½¿ç”¨ç‰¹å®šçš„åˆ†é¡µç±»:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BillingRecordsView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Billing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BillingRecordsSerializer</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">LargeResultsSetPagination</span>
</pre></div>
</div>
<h3>5.5.2 DRFé»˜è®¤åˆ†é¡µå™¨è¯¦è§£</h3>

<ul>
<li>PageNumberPagination: è¿™ç§åˆ†é¡µæ–¹å¼æ¥å—ä¸€ä¸ªæ•°å­—é¡µç åœ¨è¯·æ±‚æŸ¥è¯¢å‚æ•°</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ä¾‹å­</span>
<span class="n">GET</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">api</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">accounts</span><span class="o">/</span><span class="err">?</span><span class="n">page</span><span class="o">=</span><span class="mi">4</span>
<span class="c1"># ç»“æœ</span>
<span class="n">HTTP</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="p">{</span>
    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1023</span>
    <span class="s2">&quot;next&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.example.org/accounts/?page=5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;previous&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.example.org/accounts/?page=3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
       <span class="err">â€¦</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code>GenericAPIViewå­ç±»</code>éƒ½å¯ä»¥è®¾ç½®<code>pagination_classå±æ€§</code>æ¥è®¾å®šåˆ†é¡µå™¨;</p>

<p><code>PageNumberPaginationç±»</code>åŒ…å«äº†ä¸€äº›å±æ€§ï¼Œå¯ä»¥é‡å†™ä¿®æ”¹åˆ†é¡µæ ·å¼:</p>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th>å±æ€§åç§°</th>
<th>å±æ€§æè¿°</th>
</tr>
</thead>

<tbody>
<tr>
<td>django<em>paginator</em>class</td>
<td>Djangoé¡µé¢ç±»çš„ä½¿ç”¨ã€‚é»˜è®¤å€¼æ˜¯django.core.paginator.paginatorè¿™åº”è¯¥æ˜¯å¥½çš„ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹</td>
</tr>
<tr>
<td>page_size</td>
<td>ä¸€ä¸ªæ•°å­—å€¼è¡¨ç¤ºé¡µé¢å¤§å°ã€‚å¦‚æœè®¾ç½®ï¼Œè¿™å°†é‡å†™page<em>sizeè®¾ç½®é»˜è®¤è®¾ç½®ä¸ºç›¸åŒçš„å€¼PAGE</em>SIZEè®¾ç½®é”®</td>
</tr>
<tr>
<td>page<em>query</em>param</td>
<td>ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œè¡¨ç¤ºä½¿ç”¨åˆ†é¡µæ§ä»¶çš„æŸ¥è¯¢å‚æ•°çš„åç§°</td>
</tr>
<tr>
<td>page<em>size</em>query_param</td>
<td>å¦‚æœè®¾ç½®ï¼Œè¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼æŒ‡ç¤ºä¸€ä¸ªæŸ¥è¯¢å‚æ•°ï¼Œå…è®¸å®¢æˆ·ç«¯è®¾ç½®é¡µé¢å¤§å°åŸºäºæ¯ä¸ªè¯·æ±‚çš„åç§°ã€‚é»˜è®¤å€¼ä¸ºæ— ï¼Œè¯´æ˜å®¢æˆ·å¯èƒ½æ— æ³•æ§åˆ¶è¯·æ±‚çš„é¡µå¤§å°</td>
</tr>
<tr>
<td>max<em>page</em>size</td>
<td>å¦‚æœè®¾ç½®ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°å­—å€¼è¡¨ç¤ºçš„æœ€å¤§å…è®¸è¯·æ±‚çš„é¡µå¤§å°ã€‚è¿™ä¸ªå±æ€§åªæœ‰å¦‚æœpage<em>size</em>query_paramä¹Ÿæ˜¯é›†</td>
</tr>
<tr>
<td>last<em>page</em>strings</td>
<td>ä¸€ä¸ªåˆ—è¡¨çš„å­—ç¬¦ä¸²å€¼æŒ‡ç¤ºå€¼å¯ä»¥ç”¨page<em>query</em>paramé›†åˆä¸­çš„æœ€åä¸€é¡µçš„è¯·æ±‚ã€‚é»˜è®¤å€¼ä¸º(&#39;last&#39;,)</td>
</tr>
<tr>
<td>template</td>
<td>ä½¿ç”¨æ¸²æŸ“æ—¶åˆ†é¡µçš„æ§ä»¶åœ¨æµè§ˆå™¨APIæ¨¡æ¿çš„åç§°ã€‚å¯ä»¥é‡å†™ä¿®æ”¹æ¸²æŸ“é£æ ¼ï¼Œæˆ–è®¾ç½®æ— ç¦ç”¨HTMLåˆ†é¡µçš„æ§ä»¶å®Œå…¨ã€‚é»˜è®¤å€¼ä¸º<q>rest_framework/pagination/numbers.html</q></td>
</tr>
</tbody>
</table></div>
<p>é»˜è®¤<code>PageNumberPaginationç±»</code>æ˜¯ä½¿ç”¨settings.pyæ–‡ä»¶ä¸­è®¾å®šçš„é»˜è®¤å€¼, æˆ‘ä»¬éœ€è¦æŒ‡å®šåˆ†é¡µå™¨, ç„¶ååœ¨åˆ†é¡µå™¨ä¸­é‡å†™ä¸Šè¿°å±æ€§(PS: ä¸èƒ½ç›´æ¥å†™åœ¨è§†å›¾ç±»é‡Œé¢)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">ListRetrieveViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API endpoint that allows users to be viewed or edited.</span>

<span class="sd">    UseråŸºæœ¬ä¿¡æ¯viewset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">(</span><span class="n">DjangoFilterBackend</span><span class="p">,)</span>
    <span class="n">filter_fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">IsAdminUser</span><span class="p">]</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">LargeResultsSetPagination</span>
    <span class="c1"># page_size = 1</span>
    <span class="c1"># page_size_query_param = &#39;page_size&#39;</span>
    <span class="c1"># max_page_size = 2</span>
</pre></div>
</div>
<ul>
<li>LimitOffsetPagination</li>
</ul>

<p>è¿™ç§åˆ†é¡µæ–¹å¼å¸¸è¢«ç”¨äºè·å–æ•°æ®çš„å¤šæ¡è®°å½•, clientç«¯è¯·æ±‚ä¸­åŒ…å«2ä¸ªå‚æ•°(offsetå’Œlimit), offsetæŒ‡æ˜ä½ç½®, limitè¡¨ç¤ºç›¸å¯¹äºoffsetä½ç½®å‘åè·å–çš„æ¡ç›®æ•°é‡, ä¾‹å¦‚:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">api</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">accounts</span><span class="o">/</span><span class="err">?</span><span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="o">&amp;</span><span class="n">offset</span><span class="o">=</span><span class="mi">400</span>

<span class="c1"># return</span>
<span class="n">HTTP</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="p">{</span>
    <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1023</span>
    <span class="s2">&quot;next&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.example.org/accounts/?limit=100&amp;offset=500&quot;</span><span class="p">,</span>
    <span class="s2">&quot;previous&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.example.org/accounts/?limit=100&amp;offset=300&quot;</span><span class="p">,</span>
    <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
       <span class="err">â€¦</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>è‹¥å…¨å±€å¼€å¯LimitOffsetPagination</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;rest_framework.pagination.LimitOffsetPagination&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>LimitOffsetPaginationå±æ€§</p>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th>å±æ€§åç§°</th>
<th>å±æ€§æè¿°</th>
</tr>
</thead>

<tbody>
<tr>
<td>default_limit</td>
<td>int, é»˜è®¤è·å–æ¡ç›®æ•°é‡</td>
</tr>
<tr>
<td>limit<em>query</em>param</td>
<td>str, æŸ¥è¯¢å‚æ•°çš„åç§°, é»˜è®¤ä¸ºlimit</td>
</tr>
<tr>
<td>offset<em>query</em>param</td>
<td>str, æŸ¥è¯¢å‚æ•°çš„åç§°, é»˜è®¤ä¸ºoffset</td>
</tr>
<tr>
<td>max_limit</td>
<td>int, è®¾å®šè¿”å›æ•°æ®çš„æœ€å¤§å€¼, é»˜è®¤None</td>
</tr>
<tr>
<td>template</td>
<td>str, æ¸²æŸ“æ—¶åˆ†é¡µæ§ä»¶çš„åç§°, å¯ä»¥é‡å†™æ¸²æŸ“é£æ ¼, æˆ–è€…è®¾å®šä¸ºNoneç¦ç”¨HTMLåˆ†é¡µçš„ç©ºé—´, é»˜è®¤å€¼ä¸º<q>rest_framework/pagination/numbers.html</q></td>
</tr>
</tbody>
</table></div>
<p>é‡å†™æ–¹å¼: (å’ŒPageNumberPaginationç±»ä¼¼)</p>

<ul>
<li>CursorPagination</li>
</ul>

<p>åŸºäºæŒ‡é’ˆçš„åˆ†é¡µ, clientå¯ä»¥ä½¿ç”¨æµè§ˆç»“æœé›†; è¿™ç§åˆ†é¡µæ–¹å¼æå‡ºäº†æ­£å‘å’Œåå‘æ§åˆ¶, è€Œä¸å…è®¸ç”¨æˆ·å¯¼èˆªåˆ°ä»»æ„ä½ç½®;</p>

<p><a href="http://www.django-rest-framework.org/api-guide/pagination/">è¯¦æƒ…è¯·å‚è€ƒ</a></p>

<h3>5.5.3 è‡ªå®šä¹‰åˆ†é¡µå™¨-Custom pagination styles</h3>

<p>åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰åˆ†é¡µçš„åºåˆ—åŒ–ç±», åº”è¯¥ç»§æ‰¿pagination.BasePaginationå¹¶é‡å†™paginate<em>queryset(self, queryset, request, view=None)å’Œget</em>paginated_response(self, data)æ–¹æ³•:</p>

<ul>
<li><p><code>paginate_queryset</code>æ–¹æ³•æ˜¯é€šè¿‡åˆå§‹æŸ¥è¯¢åº”è¯¥è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡åªåŒ…å«åœ¨è¯·æ±‚çš„é¡µé¢æ•°æ®</p></li>
<li><p><code>get_paginated_response</code>æ–¹æ³•é€šè¿‡åºåˆ—åŒ–çš„é¡µé¢æ•°æ®å¹¶è¿”å›ä¸€ä¸ªå“åº”å®ä¾‹</p></li>
</ul>

<p>æ³¨æ„ï¼Œpaginate_querysetæ–¹æ³•å¯ä»¥åœ¨åˆ†é¡µå®ä¾‹è®¾ç½®çŠ¶æ€ï¼Œä»¥åå¯èƒ½è¢«<code>get_paginated_response</code>æ–¹æ³•ä½¿ç”¨;</p>

<ul>
<li>ä¾‹å­</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CustomPagination</span><span class="p">(</span><span class="n">pagination</span><span class="o">.</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_paginated_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span>
            <span class="s1">&#39;links&#39;</span><span class="p">:</span> <span class="p">{</span>
               <span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_link</span><span class="p">(),</span>
               <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_previous_link</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">paginator</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">data</span>
        <span class="p">})</span>
</pre></div>
</div>
<p>è‹¥è®¾ç½®é»˜è®¤</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span> <span class="s1">&#39;my_project.apps.core.pagination.CustomPagination&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PAGE_SIZE&#39;</span><span class="p">:</span> <span class="mi">100</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>5.5.4 HTMLåˆ†é¡µæ§ä»¶-HTML pagination controls</h3>

<p>DRFæµè§ˆå™¨APIä¸Šçš„åˆ†é¡µç©ºé—´æ¨¡æ¿</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">rest_framework</span><span class="o">/</span><span class="n">pagination</span><span class="o">/</span><span class="n">numbers</span><span class="o">.</span><span class="n">html</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">rest_framework</span><span class="o">/</span><span class="n">pagination</span><span class="o">/</span><span class="n">previous_and_next</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é‡å†™è¿™æ¸²æŸ“çš„æ¨¡æ¿, ç„¶ååœ¨è‡ªå®šä¹‰çš„åˆ†é¡µå™¨ä¸­æŒ‡å®š<code>template =</code>, æœ€ååœ¨è§†å›¾ä¸­ä½¿ç”¨è¯¥åˆ†é¡µå™¨;</p>

<h2>5.6 åˆ†é¡µä¸ç½®é¡¶å°ç»“</h2>

<p>åœ¨å·¥ä½œä¸­æˆ‘ä»¬å¾€å¾€ä¼šæœ‰è¿™ç§éœ€æ±‚, å°†æœç´¢ç»“æœä¸­çš„å…·æœ‰æŸäº›ç‰¹æ€§çš„ç»“æœç½®é¡¶, ç„¶åå†æ ¹æ®ç»“æœåˆ†é¡µ; åœ¨æœªä½¿ç”¨RESTframworkå‰, æˆ‘è¦å®ç°è¿™ä¸ªéœ€æ±‚, å¾—å…ˆå»è·å–éœ€è¦ç½®é¡¶çš„æ•°æ®æ¡ç›®æ•°é‡, ç„¶åæ ¹æ®limitå’Œpageå»å®ç°ä¸€ä¸ªè®¡ç®—é€»è¾‘å»åŒ¹é…åœ¨æ¯ä¸€é¡µæ˜¾ç¤ºå…·ä½“çš„å†…å®¹, çœŸæ˜¯****;</p>

<p>å…¶å®ç½®é¡¶åŠŸèƒ½å°±æ˜¯order(æ’åº)åŠŸèƒ½, æˆ‘å…ˆæ ¹æ®äº§å“ç»ç†ç»™çš„éœ€æ±‚(ä¾‹å¦‚: è®¤è¯çš„è½¦åº—ä¿¡æ¯æ”¾åˆ°æœ€å‰é¢æ˜¾ç¤ºchecked=1), é‚£æˆ‘åªéœ€è¦order<em>by(checked, -create</em>time), é»˜è®¤æ˜¯ä»å°åˆ°å¤§æ’åº, åœ¨å‚æ•°é¢å‰åŠ ä¸€ä¸ª<code>-</code>ç¬¦å·, è¡¨ç¤ºåå‘, ä¹Ÿå°±æ˜¯é‡å¤§åˆ°å°æ’åº;</p>

<h2>5.7 å°ç»“</h2>

<p>æ­¤æ—¶,æˆ‘ä»¬èƒ½é€šè¿‡è¶…é“¾æ¥çš„åœ°å€åœ¨å…³è”ä¿¡æ¯çš„æ¥å£ä¸­è·³è½¬; å¹¶ä¸”èƒ½çœ‹åˆ°HTMLæ ¼å¼çš„é«˜äº®ä»£ç æ®µ;</p>

<h1>6. è§†å›¾å’Œè·¯ç”±-ViewSets and routers</h1>

<p>REST æ¡†æ¶ä¸­çš„ ViewSet éå¸¸ç±»ä¼¼ Viewï¼Œå®ƒåŸºäºä¸€äº›å¸¸ç”¨çº¦å®šï¼Œå®ç°äº† list, create, retrieve, update, partial_update, destroy ç­‰æ–¹æ³•;</p>

<p>ViewSet åœ¨æœ€åçš„å®ä¾‹åŒ–æ—¶ï¼Œæ‰ä¼šå°† list, create ç­‰æ–¹æ³•ç»‘å®šåˆ° get, post, put, patch, delete ç­‰ REST æ“ä½œå¯¹åº”çš„å¤„ç†å‡½æ•°ï¼ˆé€šå¸¸ç”± Router åˆ›å»º URL å®šä¹‰æ—¶è‡ªåŠ¨ç»‘å®šï¼‰ï¼Œæœ€åç»‘å®šåˆ° model-list, model-create, model-detail ç­‰ URL; (ä¸ªäººç†è§£: ä¹Ÿå°±æ˜¯è¯´Routerå…¶å®æ˜¯ç”¨æ¥å°†restfulè¯·æ±‚åŠ¨ä½œç»‘å®šåˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°, ä¾‹å¦‚: getè¯·æ±‚ç»‘å®šlistæ–¹æ³•)</p>

<h2>6.1 ä½¿ç”¨ ViewSet è¿›è¡Œé‡æ„</h2>

<h3>6.1.1 åˆå¹¶UserList å’Œ UserDetail</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># ReadOnlyModelViewSet å®ç°äº†åªè¯»çš„æ“ä½œï¼Œå¦‚ list, detail ç­‰</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>

<span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ReadOnlyModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This viewset automatically provides `list` and `detail` actions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
</pre></div>
</div>
<h3>6.1.2 åˆå¹¶SnippetList,SnippetDetail,SnippetHighlight</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">detail_route</span>

<span class="k">class</span> <span class="nc">SnippetViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This viewset automatically provides `list`, `create`, `retrieve`,</span>
<span class="sd">    `update` and `destroy` actions.</span>

<span class="sd">    Additionally we also provide an extra `highlight` action.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Snippet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">SnippetSerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span>
                          <span class="n">IsOwnerOrReadOnly</span><span class="p">,)</span>

    <span class="nd">@detail_route</span><span class="p">(</span><span class="n">renderer_classes</span><span class="o">=</span><span class="p">[</span><span class="n">renderers</span><span class="o">.</span><span class="n">StaticHTMLRenderer</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">highlight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">snippet</span><span class="o">.</span><span class="n">highlighted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">perform_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">):</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>è¿™é‡Œä½¿ç”¨äº† ModelViewSetï¼Œä»è€Œå®ç°äº†é»˜è®¤çš„è¯»å†™æ“ä½œæ–¹æ³•;</p>

<p>è¦å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„æ“ä½œï¼Œæ¯”å¦‚ highlightï¼Œéœ€è¦ä¸ºå…¶å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”åŠ ä¸Šè£…é¥°å™¨ @detail_routeã€‚è¯¥è£…é¥°å™¨å¯ç”¨åœ¨æ‰€æœ‰éæ ‡å‡† create/update/delete é£æ ¼çš„è‡ªå®šä¹‰ API ä¸Š;</p>

<p>ä½¿ç”¨äº† @detail<em>route çš„è‡ªå®šä¹‰æ–¹æ³•çš„ API é»˜è®¤åªå“åº” GET è¯·æ±‚ï¼Œå¦‚æœè¦å“åº” POST ç­‰è¯·æ±‚ï¼Œéœ€è¦åœ¨è£…é¥°å™¨çš„ methods å‚æ•°ä¸­æŒ‡å®šã€‚è‡ªå®šä¹‰æ–¹æ³•çš„ APIï¼Œå…¶ URL é»˜è®¤å°±æ˜¯å‡½æ•°åæœ¬èº«ï¼Œå¦‚ highlightï¼Œè¦æƒ³ä¿®æ”¹ï¼Œéœ€è¦åœ¨ @detail</em>route è£…é¥°å™¨çš„ url_path å‚æ•°ä¸­æŒ‡å®š;</p>

<h2>6.2 æ‰‹åŠ¨ç»‘å®šè¯·æ±‚å’Œå“åº”æ–¹æ³•</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># åˆå¹¶ä¹‹åçš„è§†å›¾, ä¾‹å¦‚: SnippetViewSetæä¾›listå’Œcreateæ–¹æ³•, as_viewçš„ä½œç”¨å°±æ˜¯ç»‘å®š`è¯·æ±‚çš„æ–¹æ³•`åˆ°`å¯¹åº”çš„è§†å›¾å¤„ç†æ–¹æ³•`</span>

<span class="kn">from</span> <span class="nn">snippets.views</span> <span class="kn">import</span> <span class="n">SnippetViewSet</span><span class="p">,</span> <span class="n">UserViewSet</span><span class="p">,</span> <span class="n">api_root</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">renderers</span>

<span class="n">snippet_list</span> <span class="o">=</span> <span class="n">SnippetViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span>
    <span class="s1">&#39;post&#39;</span><span class="p">:</span> <span class="s1">&#39;create&#39;</span>
<span class="p">})</span>
<span class="n">snippet_detail</span> <span class="o">=</span> <span class="n">SnippetViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;retrieve&#39;</span><span class="p">,</span>
    <span class="s1">&#39;put&#39;</span><span class="p">:</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
    <span class="s1">&#39;patch&#39;</span><span class="p">:</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span>
    <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="s1">&#39;destroy&#39;</span>
<span class="p">})</span>
<span class="n">snippet_highlight</span> <span class="o">=</span> <span class="n">SnippetViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;highlight&#39;</span>
<span class="p">},</span> <span class="n">renderer_classes</span><span class="o">=</span><span class="p">[</span><span class="n">renderers</span><span class="o">.</span><span class="n">StaticHTMLRenderer</span><span class="p">])</span>
<span class="n">user_list</span> <span class="o">=</span> <span class="n">UserViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;list&#39;</span>
<span class="p">})</span>
<span class="n">user_detail</span> <span class="o">=</span> <span class="n">UserViewSet</span><span class="o">.</span><span class="n">as_view</span><span class="p">({</span>
    <span class="s1">&#39;get&#39;</span><span class="p">:</span> <span class="s1">&#39;retrieve&#39;</span>
<span class="p">})</span>

<span class="c1"># è®¿é—®URL, æ ¹æ®ä¸åŒçš„requestè¯·æ±‚æ–¹æ³•æ‰¾åˆ°å¯¹åº”çš„è§†å›¾æ–¹æ³•</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">format_suffix_patterns</span><span class="p">([</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">api_root</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/$&#39;</span><span class="p">,</span> <span class="n">snippet_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">snippet_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-detail&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^snippets/(?P&lt;pk&gt;[0-9]+)/highlight/$&#39;</span><span class="p">,</span> <span class="n">snippet_highlight</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;snippet-highlight&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/$&#39;</span><span class="p">,</span> <span class="n">user_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-list&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^users/(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">user_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user-detail&#39;</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
<p>ç°åœ¨ï¼Œç³»ç»Ÿåº”è¯¥èƒ½å’Œä¹‹å‰ä¸€æ ·æ­£å¸¸è¿è¡Œ;</p>

<h2>6.3 æ›´è¿›ä¸€æ­¥,ä½¿ç”¨ViewSeté‡æ„URL</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">snippets</span> <span class="kn">import</span> <span class="n">views</span>
<span class="kn">from</span> <span class="nn">rest_framework.routers</span> <span class="kn">import</span> <span class="n">DefaultRouter</span>

<span class="c1"># Create a router and register our viewsets with it.</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;snippets&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">SnippetViewSet</span><span class="p">)</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserViewSet</span><span class="p">)</span>

<span class="c1"># The API URLs are now determined automatically by the router.</span>
<span class="c1"># Additionally, we include the login URLs for the browsable API.</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^api-auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;rest_framework.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;rest_framework&#39;</span><span class="p">))</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Router è¿˜è‡ªåŠ¨ç”Ÿæˆäº† api<em>rootï¼Œå¹¶ä¸º URL åŠ ä¸Šäº†åç¼€åŠŸèƒ½ï¼Œä»è€Œæ— éœ€å®šä¹‰ api</em>view è§†å›¾åŠä½¿ç”¨ format<em>suffix</em>patterns äº†;</p>

<h2>6.4 å°ç»“</h2>

<p>ViewSetå°†åŒä¸€å¯¹è±¡(ä¾‹å¦‚: ç”¨æˆ·)çš„å¤šä¸ªåŠ¨ä½œ(list/create/retrieve/update/partial_update/destroy)å°è£…åˆ°ä¸€ä¸ªè§†å›¾å‡½æ•°ä¸­å¤„ç†; Routeråˆ™åœ¨URLå±‚é¢å¯¹RESTfulçš„methodå’Œè§†å›¾æä¾›çš„åŠŸèƒ½è¿›è¡Œäº†ç»‘å®šæ“ä½œ;</p>

<p>æœ‰ä»€ä¹ˆå¥½å¤„å‘¢?</p>

<p>è¿™æ ·åšå¤§å¤§ç®€åŒ–äº†ä»£ç å®ç°. åŠ å…¥æˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªç”¨æˆ·æ¥å£, æä¾›å¯¹ç”¨æˆ·è¿™ä¸ªå¯¹è±¡çš„(å¢/åˆ /æ”¹/æŸ¥/éƒ¨åˆ†æ›´æ–°)æ”¯æŒ, é‚£ä¹ˆæˆ‘ä»¬å¾—å†™5ä¸ªviewsè§†å›¾; å½“æˆ‘ä»¬ä½¿ç”¨ViewSetä¹‹åå‘¢? åªéœ€è¦ä¸ºæ¯ä¸€ä¸ªæ“ä½œå¯¹è±¡å†™ä¸€ä¸ªè§†å›¾ç±», æˆ‘ä»¬éœ€è¦æä¾›çš„åŠŸèƒ½(å¢/åˆ /æ”¹/æŸ¥/éƒ¨åˆ†æ›´æ–°)éƒ½è¢«æŠ½è±¡æˆäº†ç±», æˆ‘ä»¬åªéœ€è¦mixinç»§æ‰¿å³å¯, å®Œç¾!</p>

<p>ä¸ªäººæƒ³æ³•, å…ˆç”¨ViewSetå’Œrouterå®ç°æ¥å£-é‡åˆ°ä¸ªæ€§åŒ–éœ€æ±‚åˆ™é‡å†™çˆ¶ç±»æ–¹æ³•-å®åœ¨æ²¡æœ‰åŠæ³•äº†æ‰èƒ½æ”¾å¼ƒæ›´é€šç”¨çš„æ–¹å¼,æŠŠè§†å›¾å‡½æ•°æ‹†å¼€æ¥åš(ä½†æ˜¯ååˆ†ä¸å»ºè®®, è¿™æ ·ä¼šå¯¼è‡´é¡¹ç›®è¶Šæ¥è¶Šé«˜çš„å¤æ‚åº¦, æœ€ç»ˆæ— æ³•æ§åˆ¶...);</p>

<h1>7. ç»“æ„å’Œå®¢æˆ·ç«¯åº“-Schemas and client libraries</h1>

<p>ä¸€ä¸ª schema å°±æ˜¯ä¸€ä¸ªæœºå™¨å¯è¯»çš„æ–‡æ¡£ï¼Œå®ƒå¯¹å¯ç”¨çš„ API ç«¯ç‚¹è¿›è¡Œæè¿°ï¼Œç»™å‡ºå®ƒä»¬çš„ URLï¼Œä»¥åŠæ”¯æŒçš„æ“ä½œ;</p>

<p>æœåŠ¡ç«¯å¯ä»¥ç”Ÿæˆ schema æ–‡æ¡£ï¼Œè€Œå®¢æˆ·ç«¯å¯ä»¥åŸºäºè¯¥ schema æ–‡æ¡£ï¼Œä¸æœåŠ¡ç«¯äº¤äº’;</p>

<h2>7.1 æ¥å£ç»“æ„-Core API</h2>

<p>REST æ¡†æ¶é€šè¿‡ Core API æä¾› schema æ”¯æŒ</p>

<p>Core API æ˜¯ä¸€ç§ç”¨äºæè¿° API çš„æ–‡æ¡£æ ‡å‡†ã€‚åœ¨æœåŠ¡ç«¯ï¼Œé€šè¿‡ Core API å¯ä»¥å°† API å‘ˆç°æˆå„ç§æ”¯æŒçš„ schema æˆ–è¶…åª’ä½“æ ¼å¼æ–‡ä»¶ã€‚è€Œåœ¨å®¢æˆ·ç«¯ï¼Œåœ¨è·å–æœåŠ¡ç«¯ç”Ÿæˆçš„ schema æ–‡ä»¶åï¼Œå¯ä»¥ä¸æœåŠ¡ç«¯è¿›è¡Œäº¤äº’;</p>

<h2>7.2 ä¸ºæœåŠ¡ç«¯æä¾› schema æ”¯æŒ</h2>

<p>REST æ¡†æ¶å³æ”¯æŒæ‰‹åŠ¨å®šä¹‰ schema è§†å›¾ï¼Œä¹Ÿæ”¯æŒè‡ªåŠ¨ç”Ÿæˆ schemaã€‚å› æˆ‘ä»¬ä½¿ç”¨äº† ViewSet å’Œ Routerï¼Œæ•…é‡‡ç”¨è‡ªåŠ¨ç”Ÿæˆ schema æ–¹å¼;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># snippets/urls.py</span>

<span class="kn">from</span> <span class="nn">rest_framework.schemas</span> <span class="kn">import</span> <span class="n">get_schema_view</span>

<span class="n">schema_view</span> <span class="o">=</span> <span class="n">get_schema_view</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Pastebin API&#39;</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^schema/$&#39;</span><span class="p">,</span> <span class="n">schema_view</span><span class="p">),</span>
    <span class="c1">#...</span>
<span class="p">]</span>
</pre></div>
</div>
<p>æµè§ˆå™¨ä¸ŠæŸ¥çœ‹</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/15041707925906.jpg"></p>
</p>

<p>å‘½ä»¤è¡ŒæŸ¥çœ‹</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">âœ</span>  <span class="o">~</span> <span class="n">http</span> <span class="o">-</span><span class="n">a</span> <span class="n">admin</span><span class="p">:</span><span class="n">password123</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">schema</span><span class="o">/</span> <span class="n">Accept</span><span class="p">:</span><span class="n">application</span><span class="o">/</span><span class="n">coreapi</span><span class="o">+</span><span class="n">json</span>

<span class="c1"># è¿”å›</span>
<span class="p">{</span>
    <span class="s2">&quot;_meta&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Pastebin API&quot;</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://127.0.0.1:8000/schema/&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;document&quot;</span><span class="p">,</span>
   <span class="o">....</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>7.3 å‘½ä»¤è¡Œå®¢æˆ·ç«¯-coreapi-cli</h2>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">coreapi</span><span class="o">-</span><span class="n">cli</span>
</pre></div>
</div>
<p><a href="http://www.django-rest-framework.org/tutorial/7-schemas-and-client-libraries/">è¯¦æƒ…è¯·å‚è€ƒ</a></p>

<p>æµ‹è¯•äº†ä¸€æ³¢å‘ç°ä¸æ˜¯å¾ˆå¥½ç”¨, å¦æ‰¾äº†ä¸€ä¸ª<a href="https://github.com/core-api/python-client">pythonç‰ˆçš„coreapi-cli</a>æœ‰éœ€è¦çš„å¯ä»¥è¯•ç”¨ä¸‹;</p>

<h1>8. Django REST frameworkæœ€ä½³å®è·µ</h1>

<p><a href="https://segmentfault.com/a/1190000004399682">å‚è€ƒé“¾æ¥</a></p>

<p>ä½œä¸ºåŸºç¡€æ¶æ„è®¾è®¡è€…, éœ€è¦è€ƒè™‘é‚£äº›é—®é¢˜å‘¢?</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">*</span> <span class="mf">1.</span> <span class="err">ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†</span>
<span class="o">*</span> <span class="mf">2.</span> <span class="err">ç»Ÿä¸€çš„æƒé™ç³»ç»Ÿ</span>
<span class="o">*</span> <span class="mf">3.</span> <span class="err">ç»Ÿä¸€çš„è®¤è¯ç³»ç»Ÿ</span>
<span class="o">*</span> <span class="mf">3.</span> <span class="err">ç»Ÿä¸€çš„å‚æ•°æ ¡éªŒ</span>
<span class="o">*</span> <span class="mf">5.</span> <span class="err">è®¤è¯</span>
<span class="o">*</span> <span class="mf">6.</span> <span class="err">ç»Ÿä¸€çš„æŸ¥è¯¢è¿‡æ»¤</span>
<span class="o">*</span> <span class="mf">7.</span> <span class="err">ä»£ç åˆ†å±‚</span><span class="p">,</span> <span class="err">ä¾‹å¦‚</span><span class="p">:</span> <span class="err">å¸¸è§„çš„</span><span class="n">m</span> <span class="n">s</span> <span class="n">v</span> <span class="n">c</span><span class="err">æ¨¡å‹ä¸‹</span><span class="p">,</span> <span class="err">å†æŒ‰ç…§åŠŸèƒ½æ¨¡å—å»åˆ†</span>
<span class="o">*</span> <span class="mf">8.</span> <span class="err">ç»Ÿä¸€å¥½ç”¨çš„å­˜å‚¨å±‚</span>
<span class="o">*</span> <span class="mf">9.</span> <span class="err">ç¼“å­˜å¦‚ä½•å¯ä»¥åšçš„æ›´ç®€å•ç»Ÿä¸€</span>
</pre></div>
</div>
<h2>8.1 restfulAPIçš„åŸºç¡€å¥—è·¯</h2>

<ol>
<li>ç»§æ‰¿æŸä¸ªGenericView,é‡å†™é‡Œé¢çš„æŸä¸ªæ–¹æ³•ï¼Œæœ€å¤§çš„æ˜¯getã€postã€putã€patchã€deleteè¿™äº›æ–¹æ³•ï¼Œç„¶è€Œå¹¶ä¸æ¨èï¼ˆåº”è¯¥é‡å†™mixiné‡Œé¢çš„æ–¹æ³•ï¼‰</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CoursesView</span><span class="p">(</span><span class="n">ListCreateAPIView</span><span class="p">):</span>

    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">(</span><span class="n">SchoolPermissionFilterBackend</span><span class="p">,</span> <span class="n">filters</span><span class="o">.</span><span class="n">DjangoFilterBackend</span><span class="p">,</span> <span class="n">filters</span><span class="o">.</span><span class="n">SearchFilter</span><span class="p">)</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticated</span><span class="p">,</span> <span class="n">ModulePermission</span><span class="p">)</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
    <span class="n">filter_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;term&#39;</span><span class="p">,)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="s1">&#39;school__name&#39;</span><span class="p">)</span>
    <span class="n">module_perms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;course.course&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CourseFullMessageSerializer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CourseSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;school&#39;</span><span class="p">,</span> <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">school__is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">term__is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">)</span>
              
    <span class="nd">@POST</span><span class="p">(</span><span class="s1">&#39;school&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="s1">&#39;required&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">school</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SchoolPermissionFilterBackend</span><span class="p">()</span><span class="o">.</span><span class="n">has_school_permission</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">school</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">PermissionDenied</span><span class="p">,</span> <span class="n">err_message</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;æ²¡æœ‰å¯¹åº”å­¦æ ¡çš„æƒé™&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;æ²¡æœ‰å¯¹åº”å­¦æ ¡çš„æƒé™&#39;</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perform_create</span><span class="p">(</span><span class="n">serializer</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_success_headers</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">CourseFullMessageSerializer</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</pre></div>
</div>
<ol>
<li>å®ç°ä¸€ä¸ªserilizerï¼ŒjsonåŒ–response</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CourseSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Course</span>
        <span class="n">read_only_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">CourseFullMessageSerializer</span><span class="p">(</span><span class="n">CourseSerializer</span><span class="p">):</span>

    <span class="n">school</span> <span class="o">=</span> <span class="n">SchoolLittleMessageSerializer</span><span class="p">()</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;term.name&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<ol>
<li>å†™ä¸€ä¸ªurl, è¿”å›JSONæ•°æ®æˆ–è€…æ¸²æŸ“åˆ°æ¨¡æ¿</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^courses/$&#39;</span><span class="p">,</span> <span class="n">CoursesView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;course-list&#39;</span><span class="p">),</span>
</pre></div>
</div>
<h2>8.2 åºåˆ—åŒ–çš„æ•°æ®å…³è”åµŒå¥—</h2>

<h3>8.2.1 è·å–å¤–é”®å…³è”æ•°æ®</h3>

<p>äº§ç”Ÿæ•ˆæœ:  åœ¨åŸæœ‰æ•°æ®åŸºç¡€ä¸Š, æ·»åŠ å¤–é”®å…³ç³»è¡¨çš„å±æ€§æ•°æ®, æ¯ä¸€æ¡æ•°æ®éƒ½ä¼šæ·»åŠ è¿™äº›æ•°æ®; </p>

<ol>
<li>å¤–é”®ç›´æ¥å¯ä»¥å¼•ç”¨å…¶ä»–çš„serializer, ä¾‹å¦‚: è¯¾ç¨‹è¡¨/è¯¾ç¨‹ç›®å½•è¡¨(1å¯¹å¤šå…³ç³»)</li>
</ol>

<p>åºåˆ—åŒ–çš„æ­£å‘å…³è”:  è¯¾ç¨‹-è¯¾ç¨‹ç›®å½•ä¸ºä¾‹å­</p>

<p>è¯¾ç¨‹æœ‰å¤šä¸ªç›®å½•,  é‚£ä¹ˆç›®å½•è¡¨ä¸Šå»ºä¸€ä¸ªå¤–é”®åç§°ä¸ºcourseå…³è”åˆ°è¯¾ç¨‹è¡¨, è¡¨ç¤ºè¯¥ç›®å½•å”¯ä¸€å±äºæŸè¯¾ç¨‹;</p>

<p>é»˜è®¤æƒ…å†µä¸‹, æˆ‘ä»¬æŸ¥çœ‹è¯¾ç¨‹ç›®å½•è¡¨å°±åªèƒ½çœ‹åˆ°ç›®å½•çš„ç®€ç•¥ä¿¡æ¯ and è¯¾ç¨‹ID; è‹¥æˆ‘ä»¬æƒ³åœ¨ç›®å½•çš„APIçš„æ¯ä¸€ä¸ªå…ƒç´ ä¸­éƒ½æ˜¾ç¤ºè¯¾ç¨‹çš„è¯¦æƒ…ä¿¡æ¯, é‚£ä¹ˆæˆ‘ä»¬åœ¨è¯¾ç¨‹ç›®å½•çš„åºåˆ—åŒ–ç±»ä¸­, æ·»åŠ ä¸€ä¸ªcourse=CourseSerializer(many=True)ç±»å±æ€§; å½“æˆ‘ä»¬çš„Modelä¸­å­˜åœ¨å¤–é”®, æˆ‘ä»¬æƒ³æŸ¥çœ‹å¤–é”®æ‰€ä»£è¡¨çš„è¯¦æƒ…ä¿¡æ¯, æˆ‘ä»¬å¯ä»¥ç›´æ¥åµŒå¥—å¯¹åº”çš„åºåˆ—åŒ–ç±»;</p>

<p>å¦ä¸€ç§æƒ…å†µ, å½“æˆ‘æƒ³åœ¨è¯¾ç¨‹ä¿¡æ¯ä¸­è·å–è¯¾ç¨‹çš„ç›®å½•è¯¦ç»†, åŒæ ·æˆ‘ä»¬éœ€è¦æ·»åŠ ç±»å±æ€§, ä¸è¿‡å†™æ³•ä¸å¤ªä¸€æ ·,  ä¾‹å¦‚: Course and CourseDirectory,   æˆ‘ä»¬å¯ä»¥åœ¨Courseæ¨¡å‹çš„åºåˆ—åŒ–ç±»ä¸­æ·»åŠ ç±»å±æ€§, coursedirectory_set = CourseDirectorySerializer(many=true)</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MiniCourseDirectorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;è¯¾ç¨‹ç›®å½•&quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CourseDirectory</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;chapter_name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;knowledges&#39;</span><span class="p">,</span> <span class="s1">&#39;quiz&#39;</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">class</span> <span class="nc">CourseDetailSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;è¯¾ç¨‹è¯¦æƒ…æ•°æ®: è·å–å¤–é”®å…³è”çš„è¯¾ç¨‹ç›®å½•ä¿¡æ¯&quot;&quot;&quot;</span>
    <span class="n">coursedirectory_set</span> <span class="o">=</span> <span class="n">MiniCourseDirectorySerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># å¤šå¯¹å¯¹å­—æ®µ</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Course</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<ol>
<li>å¤–é”®çš„å±æ€§å¯ä»¥ä½¿ç”¨sourceï¼Œä¾‹å¦‚phone</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">è¯¾ç¨‹æ¨¡å—-åºåˆ—åŒ–</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">accouting_app.models</span> <span class="kn">import</span> <span class="n">Course</span><span class="p">,</span> <span class="n">CourseDirectory</span>


<span class="k">class</span> <span class="nc">CourseSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;è¯¾ç¨‹åŸºç¡€æ•°æ®åºåˆ—åŒ–&quot;&quot;&quot;</span>

    <span class="c1"># directory = CourseDirectorySerializer(many=True)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Course</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
        <span class="c1"># depth = 0</span>


<span class="k">class</span> <span class="nc">CourseDirectorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;è¯¾ç¨‹ç›®å½•æ•°æ®åºåˆ—åŒ–</span>

<span class="sd">    1. å¤–é”®ç›´æ¥å¯ä»¥å¼•ç”¨å…¶ä»–çš„serializer, ä¾‹å¦‚: è¯¾ç¨‹ç›®å½•æœ‰ä¸€ä¸ªå¤–é”®course</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># coursen = CourseSerializer()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;course.title&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">course_desc</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;course.description&#39;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">SerializerMethodField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CourseDirectory</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># exclude = (&#39;course&#39;,)</span>

    <span class="k">def</span> <span class="nf">get_other</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;xxxx&quot;</span>


<span class="k">class</span> <span class="nc">MiniCourseDirectorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CourseDirectory</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;chapter_name&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;knowledges&#39;</span><span class="p">,</span> <span class="s1">&#39;quiz&#39;</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">CourseDetailSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;è¯¾ç¨‹è¯¦æƒ…æ•°æ®, åˆå¹¶ç›¸å…³çš„è¡¨&quot;&quot;&quot;</span>
    <span class="n">coursedirectory_set</span> <span class="o">=</span> <span class="n">MiniCourseDirectorySerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Course</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<h3>8.2.2 get_xxxæ–¹æ³•ç”¨äºæ·»åŠ æ¨¡å‹ç±»ä¸­ä¸å­˜åœ¨çš„å­—æ®µ,æˆ–ä¿®æ”¹å·²æœ‰å­—æ®µ</h3>

<p>get_otheræ–¹æ³•ç”¨äºåœ¨åŸæœ‰çš„åºåˆ—åŒ–ç±»é‡Œé¢æ·»åŠ é¢å¤–çš„å­—æ®µ, æˆ–è€…ä¿®æ”¹ç°æœ‰å­—æ®µ; å®ƒéœ€è¦ä¸SerializerMethodField()é…åˆä½¿ç”¨;</p>

<p>ä¸€ä¸ªå¾ˆå¸¸è§çš„ä½¿ç”¨åœºæ™¯: ç”¨æˆ·é¡µé¢éœ€è¦è·å–ç”¨æˆ·çš„ä¸€äº›æ±‡æ€»ä¿¡æ¯(ä¾‹å¦‚,å„ç§èšåˆæ•°æ®, è¿™äº›é¢å¤–å±æ€§å¾€å¾€ä¼šè¢«å­˜å‚¨åˆ°ç¼“å­˜ä¸­), å¦‚æœæˆ‘è¦é€šè¿‡æ¨¡å‹åºåˆ—åŒ–çš„æ–¹å¼è¿”å›æ•°æ®, é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨ `get_å­—æ®µ()æ–¹æ³•, æ­é…SerializerMethodField()ä½¿ç”¨;</p>

<h3>8.2.3 ä½¿ç”¨ModelViewSet+TemplateHTMLRendereræœåŠ¡ç«¯æ¸²æŸ“æ¨¡æ¿</h3>

<p>ModelViewSetä¿®æ”¹renderer_classes, æœåŠ¡ç«¯æ¸²æŸ“æ¨¡æ¿, ä¸æ¨èç›´æ¥é‡å†™listæ–¹æ³•, æ¨èé‡å†™mixinä¸­çš„æ–¹æ³•:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CourseDirectoryPageViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ReadOnlyModelViewSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è¯¾ç¨‹ç›®å½•Page: æœåŠ¡ç«¯æ¸²æŸ“</span>

<span class="sd">    è¯¾ç¨‹ç›®å½•é¡µé¢, åŒ…å«è¯¾ç¨‹æè¿°,ç›®å½•ä¿¡æ¯,çŸ¥è¯†ç‚¹/æµ‹è¯•é¢˜çš„IDå’ŒName</span>
<span class="sd">    éšå«è§„åˆ™: forå¾ªç¯æ¯ä¸€ä¸ªçŸ¥è¯†ç‚¹, è·å–çŸ¥è¯†ç‚¹å¯¹åº”çš„æµ‹è¯•æ”¾åˆ°çŸ¥è¯†ç‚¹å…ƒç´ ä¹‹å, ä¾æ¬¡ç±»æ¨</span>
<span class="sd">    å¦å¤–, è·å–æœ¬ç« èŠ‚çš„æµ‹è¯•é¢˜ä¿¡æ¯æ”¾åˆ°æœ«å°¾, æ ¼å¼åŒ–ä¸ºæœ€ç»ˆçš„åˆ—è¡¨, å¹¶æ¸²æŸ“åˆ°ç½‘é¡µç«¯</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticated</span><span class="p">,)</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">(</span><span class="n">DjangoFilterBackend</span><span class="p">,)</span>
    <span class="n">filter_fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">LargeResultsSetPagination</span>
    <span class="n">renderer_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">TemplateHTMLRenderer</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;è‡ªå®šä¹‰æƒé™&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">IsAuthenticated</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">permission</span><span class="p">()</span> <span class="k">for</span> <span class="n">permission</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">permission_classes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;è¯¾ç¨‹listé¡µé¢ä½¿ç”¨: CourseSerializer; æ¸²æŸ“åˆ°: course_list_page.html&quot;&quot;&quot;</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CourseSerializer</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">serializer_class</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;course&#39;</span><span class="p">:</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;accouting_app/course/course_list_page.html&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;è¯¾ç¨‹ç›®å½•é¡µé¢ä½¿ç”¨: CourseDirectoryContentSerializer; æ¸²æŸ“åˆ°: course_directory.html&quot;&quot;&quot;</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Course</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">CourseDirectoryContentSerializer</span><span class="p">(</span><span class="n">course</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">&#39;course&#39;</span><span class="p">:</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">},</span> <span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;accouting_app/course/course_directory_page.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<h3>8.2.4 å¦‚ä½•å†™ä¸€ä¸ªåµŒå¥—ç»“æ„çš„åºåˆ—åŒ–ç±»</h3>

<p>åœ¨ModelSerializerä¸­åµŒå¥—å…¶ä»–Serializer.Serializerçš„ç±»å®ä¾‹</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GradeDataSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å¡åº¦ä¿¡æ¯(ä¸Šå¡ã€ä¸‹å¡ã€å¹³è·¯ã€æœ€å¤§é«˜ç¨‹ã€å¹³å‡é«˜ç¨‹)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">udis</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">udur</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">...</span>
    
<span class="k">class</span> <span class="nc">WorkoutUploadSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è½¨è¿¹ä¸Šä¼ åºåˆ—åŒ–</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">equipment_data_source</span> <span class="o">=</span> <span class="n">EquipmentDataSourceSerializer</span><span class="p">()</span>
    <span class="n">grade_data</span> <span class="o">=</span> <span class="n">GradeDataSerializer</span><span class="p">()</span>
    <span class="o">....</span>
</pre></div>
</div>
<h2>8.3 Django REST frameworkçš„å„ç§æŠ€å·§â€”â€”3.æƒé™</h2>

<p><a href="https://segmentfault.com/a/1190000004400312#articleHeader5">å‚è€ƒæ–‡æ¡£</a></p>

<h3>8.3.0 æƒé™åŸºç¡€</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">rest</span><span class="err">æ¡†æ¶å·²ç»æä¾›çš„æƒé™ç±»ï¼š</span>

<span class="n">AllowAny</span>

<span class="err">æ­¤æƒé™å°†å…è®¸ç”¨æˆ·çš„ä»»ä½•è®¿é—®ï¼Œä¸æ²¡æœ‰è®¾ç½®çš„æ•ˆæœä¸€æ ·ã€‚</span>

<span class="n">IsAuthenticated</span>

<span class="err">å¦‚æœä½ ä½¿ç”¨çš„æ˜¯</span><span class="n">django</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="err">ï¼Œæˆ–æ‰©å±•è‡ªè¯¥ç±»ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿˜æ˜¯å¾ˆé€‚åˆä½¿ç”¨çš„ã€‚åœ¨</span><span class="n">views</span><span class="err">ä¸­ä½¿ç”¨</span><span class="n">auth</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span><span class="err">å°±å¯ä»¥è¿›è¡Œæˆæƒäº†ã€‚</span>

<span class="n">IsAdminUser</span>

<span class="err">å¦‚æœ</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="err">ï¼Œé‚£ä¹ˆç”¨æˆ·çš„æ“ä½œå°±ä¼šè¢«å…è®¸ï¼Œå¦åˆ™è¢«æ‹’ç»ã€‚æ‰€ä»¥è¿™ä¸ªèƒ½å¤Ÿåšåˆ°ç‰¹å®šç”¨æˆ·çš„è®¿é—®æƒé™æ§åˆ¶ã€‚å½“ç„¶ï¼Œä¹Ÿè¦ä½¿ç”¨</span><span class="n">django</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="err">ç±»æ‰è¡Œã€‚</span>

<span class="n">IsAuthenticatedOrReadOnly</span>

<span class="err">å¦‚æœå·²ç»æˆæƒï¼Œæˆ–åªæ˜¯æ‰§è¡Œåªè¯»æ“ä½œï¼Œé‚£ä¹ˆå°†ä¼šè¢«å…è®¸ã€‚</span>

<span class="err">åªè¯»æ“ä½œåŒ…æ‹¬ï¼š</span><span class="n">GET</span><span class="p">,</span><span class="n">HEAD</span><span class="p">,</span><span class="n">OPTIONS</span>

<span class="n">DjangoModelPermissions</span>

<span class="n">DjangoModelPermissionsOrAnonReadOnly</span>

<span class="n">DjangoObjectPermissions</span>

<span class="err">è‡ªå®šä¹‰æƒé™</span>

<span class="err">è‡ªå®šä¹‰æƒé™ç±»å¯ä»¥ç»§æ‰¿è‡ªä¸Šé¢çš„æ‰€æœ‰çš„ç±»ï¼Œä½†æ˜¯æœ€å¥½è¿˜æ˜¯ç»§æ‰¿è‡ª</span><span class="n">BasePermission</span><span class="p">,</span><span class="err">é‡å†™ä¸¤ä¸ªæ–¹æ³•ï¼š</span>

<span class="n">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span><span class="err">ï¼š</span>

<span class="err">è¿™ä¸ªæ˜¯</span><span class="n">views</span><span class="err">èŒƒå›´çš„æƒé™</span>

<span class="n">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span><span class="err">ï¼š</span>

<span class="err">è¿™ä¸ªæ˜¯å¯¹è±¡èŒƒå›´çš„æƒé™ï¼Œé€šå¸¸ç”¨äºéªŒè¯å¯¹è±¡æ˜¯å¦å±äºæäº¤çš„ç”¨æˆ·</span>

<span class="err">ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>

<span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># Read permissions are allowed to any request,</span>
        <span class="c1"># so we&#39;ll always allow GET, HEAD or OPTIONS requests.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
<span class="n">w</span>
<span class="err">åœ¨ç”¨æˆ·æäº¤åšå®¢çš„æ—¶å€™ï¼Œä¸Šé¢çš„</span><span class="n">has_permission</span><span class="err">æ–¹æ³•å°±ä¼šèµ·ä½œç”¨ï¼Œå¦‚æœæ²¡æœ‰ç™»å½•ï¼Œé‚£ä¹ˆä¼šè¿”å›</span><span class="bp">False</span><span class="err">ï¼Œæ‹’ç»æäº¤ã€‚</span>

<span class="err">è€Œ</span><span class="n">has_object_permission</span><span class="err">åœ¨ç”¨æˆ·ä¿®æ”¹ï¼Œåˆ é™¤åšå®¢çš„æ—¶å€™ä¼šèµ·ä½œç”¨ï¼Œå¦‚æœä¿®æ”¹çš„åšå®¢ä¸å±äºè¯¥ç”¨æˆ·ï¼Œé‚£ä¹ˆä¼šè¢«æ‹’ç»</span>
</pre></div>
</div>
<h3>8.3.1 ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æŸä¸ªapiçš„æƒé™</h3>

<p>ä¾‹å¦‚: éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticated</span><span class="p">,)</span>
</pre></div>
</div>
<p>è‹¥éœ€è¦è‡ªå®šä¹‰æƒé™å¯ä»¥ä»¿ç…§IsAuthenticatedé‡å†™APIæ‰€éœ€è¦çš„æƒé™</p>

<h3>8.3.2 ç”¨æˆ·å¯¹äºç›¸åŒapiçš„ä¸åŒæƒé™çœ‹åˆ°ä¸åŒçš„æ•°æ®ï¼ˆå…¶å®ä¸€ä¸ªfilterï¼‰</h3>

<p>è¿™ä¸ªéœ€æ±‚å¾ˆæ™®é, ä¾‹å¦‚: åå°ç®¡ç†å‘˜ç³»ç»Ÿä¸­, æ™®é€šç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜è´¦å·ç™»å½•åçœ‹åˆ°ä¸åŒçš„ç•Œé¢;</p>

<p>é‡å†™get<em>queryset æˆ–è€… filter</em>queryset;</p>

<h3>8.3.3 ä¸åŒæƒé™ç”¨æˆ·å¯¹äºapiçš„è®¿é—®é¢‘æ¬¡ï¼Œå…¶ä»–é™åˆ¶ç­‰ç­‰</h3>

<p><a href="http://www.django-rest-framework.org/api-guide/throttling/">å®˜æ–¹æ–‡æ¡£-èŠ‚æµ</a></p>

<p>å¯ä»¥è®¾å®šä¸åŒæƒé™çš„ç”¨æˆ·æœ‰ä¸åŒçš„è®¿é—®é¢‘æ¬¡;</p>

<p>å¯ä»¥æ”¯æŒ: 
å…¨å±€
APIçº§åˆ«
è‡ªå®šä¹‰æ–¹å¼</p>

<h3>8.3.4 å‡åˆ é™¤ï¼Œå„ç§çº§è”å‡åˆ é™¤</h3>

<p>éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š</p>

<ol>
<li>å¦‚æœæ²¡æœ‰å…¶ä»–ä¸œè¥¿å¯¹ä»–æœ‰å¤–é”®ï¼Œåˆ™ç›´æ¥å¯ä»¥åˆ </li>
<li>å¦‚æœå…¶ä»–ä¸œè¥¿å¯¹ä»–æœ‰äº†å¤–é”®ï¼Œåˆ™éœ€è¦ç»™æç¤ºï¼ˆç”¨æˆ·ç¡®å®šåå¯ä»¥åˆ é™¤ï¼‰</li>
<li>é¦–å…ˆçœ‹å®ç° æ³¨æ„ç»§æ‰¿é¡ºåºä¸€å®šä¸èƒ½é”™ï¼ï¼ï¼</li>
</ol>

<p>æ³¨æ„ç»§æ‰¿é¡ºåºä¸€å®šä¸èƒ½é”™:</p>

<ol>
<li>UnActiveModelMixinå¯¹åº”å‡åˆ é™¤</li>
<li>DeleteForeignObjectRelModelMixinå¯¹åº”å¤–é”®æ£€æŸ¥</li>
<li>RetrieveUpdateDestroyAPIViewæ˜¯é»˜è®¤çš„restçš„viewï¼Œæä¾›deleteæ”¯æŒï¼Œä¸»è¦æ˜¯éœ€è¦xxxDestroyAPIView</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UnActiveModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    åˆ é™¤ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸çœŸåˆ é™¤ï¼Œçº§è”å°†å¯¹åº”å¤–é”®å¯¹è±¡çš„is_activeè®¾ç½®ä¸ºfalseï¼Œéœ€è¦å¤–é”®å¯¹è±¡éƒ½æœ‰is_activeå­—æ®µ.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">perform_destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="n">rel_fileds</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ForeignObjectRel</span><span class="p">)]</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">rel_fileds</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="n">manager</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">manager</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="n">ForeignObjectRelDeleteError</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;{} ä¸Šæœ‰å…³è”æ•°æ®&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">)</span>
                    <span class="n">manager</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FieldDoesNotExist</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span> 
                    <span class="c1"># ç†è®ºä¸Šï¼Œçº§è”åˆ é™¤çš„modelä¸Šé¢åº”è¯¥ä¹Ÿæœ‰is_activeå­—æ®µï¼Œå¦åˆ™ä»£ç é€»è¾‘åº”è¯¥æœ‰é—®é¢˜</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ModelDontHaveIsActiveFiled</span><span class="p">(</span>
                            <span class="s1">&#39;{}.{} æ²¡æœ‰is_activeå­—æ®µ, è¯·æ£€æŸ¥ç¨‹åºé€»è¾‘&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                                <span class="n">manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="p">))</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">DeleteForeignObjectRelModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;åˆ é™¤ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœä»–å·²æœ‰å¤–é”®å…³è”åˆ™æŠ›å‡ºå¼‚å¸¸&#39;&#39;&#39;</span>
    <span class="nd">@POST_OR_GET</span><span class="p">(</span><span class="s1">&#39;force_delete&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">force_delete</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_delete</span><span class="p">:</span>
            <span class="n">rel_fileds</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ForeignObjectRel</span><span class="p">)]</span>
            <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">rel_fileds</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="n">manager</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="p">:</span>
                    <span class="k">continue</span>      
                <span class="c1"># one to one</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;is_active&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ForeignObjectRelDeleteError</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;{} ä¸Šæœ‰å…³è”æ•°æ®&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="s1">&#39;is_active&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">ForeignObjectRelDeleteError</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;{} ä¸Šæœ‰å…³è”æ•°æ®&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">FieldDoesNotExist</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">ForeignObjectRelDeleteError</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;{} ä¸Šæœ‰å…³è”æ•°æ®&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perform_destroy</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">)</span>
</pre></div>
</div>
<h2>8.4 Django REST frameworkçš„å„ç§æŠ€å·§â€”â€”4.Generic View</h2>

<p><a href="https://segmentfault.com/a/1190000004400540">4.Generic View</a></p>

<h2>8.5 Django REST frameworkçš„å„ç§æŠ€å·§â€”â€”5.æœç´¢</h2>

<p><a href="https://segmentfault.com/a/1190000004400863">5.æœç´¢</a></p>

<h2>8.6 Django REST frameworkçš„å„ç§æŠ€å·§â€”â€”6.å¼‚å¸¸å¤„ç†</h2>

<p><a href="https://segmentfault.com/a/1190000004400960">6.å¼‚å¸¸å¤„ç†</a></p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">six</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">PermissionDenied</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">exceptions</span><span class="p">,</span> <span class="n">status</span>
<span class="kn">from</span> <span class="nn">rest_framework.compat</span> <span class="kn">import</span> <span class="n">set_rollback</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">xingzhe_conf.constants</span> <span class="kn">import</span> <span class="n">WORKOUT_BUSINESS_STATE_CHOICES</span> <span class="k">as</span> <span class="n">BC</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">XResponseResult</span> <span class="k">as</span> <span class="n">XResult</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_exception_handler</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the response that should be used for any given exception.</span>

<span class="sd">    By default we handle the REST framework `APIException`, and also</span>
<span class="sd">    Django&#39;s built-in `Http404` and `PermissionDenied` exceptions.</span>

<span class="sd">    Any unhandled exceptions may return `None`, which will cause a 500 error</span>
<span class="sd">    to be raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#view = context.get(&#39;view&#39;)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">extra_data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;extra_data&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
    <span class="n">bcode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">extra_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="n">BC</span><span class="o">.</span><span class="n">failure</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">APIException</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;auth_header&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">auth_header</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;wait&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Retry-After&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exc</span><span class="o">.</span><span class="n">wait</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">XResult</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">bcode</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">default_detail</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">XResult</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">bcode</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">))</span>

        <span class="n">set_rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">Http404</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Not found.&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">XResult</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">bcode</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

        <span class="n">set_rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">PermissionDenied</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Permission denied.&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">XResult</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">bcode</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

        <span class="n">set_rollback</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>
    
<span class="c1"># åœ¨settings.pyä¸­åŠ ä¸Š &#39;EXCEPTION_HANDLER&#39;: </span>
<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;api.exception_handler.custom_exception_handler&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>8.7 Django REST frameworkçš„å„ç§æŠ€å·§â€”â€”7.å¯¼å…¥å¯¼å‡º</h2>

<p><a href="https://segmentfault.com/a/1190000004401099">7.å¯¼å…¥å¯¼å‡º</a></p>

<h1>9.å·¥ä½œä¸­å¸¸ç”¨æŠ€å·§</h1>

<h2>9.1 many=true</h2>

<p>åœºæ™¯: æœ‰æ—¶å€™æˆ‘ä»¬çš„æ•°æ®ç»“æ„æ˜¯: [{}, {}, {}], å¦‚ä½•å¯¹è¿™ç§æ•°æ®æ ¼å¼è¿›è¡Œåºåˆ—åŒ–å‘¢?</p>

<p>æ–¹æ³•: å†™å…¶ä¸­å•ä¸ª{}çš„åºåˆ—åŒ–å™¨, ç„¶ååœ¨ä½¿ç”¨çš„æ—¶å€™æ·»åŠ ä¸Šmany=trueå‚æ•°, ä¾‹å¦‚:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># åºåˆ—åŒ–</span>
<span class="k">class</span> <span class="nc">SingleWorkoutDetailSegmentSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;è½¨è¿¹è¯¦æƒ…æ—¶å€™éœ€è¦çš„èµ›æ®µä¿¡æ¯æ ¼å¼ä¸º: [{}, {}], æ­¤åºåˆ—åŒ–è¡¨ç¤º{}é‡Œé¢éƒ¨åˆ†&quot;&quot;&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">workout_id</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>

<span class="c1"># ä½¿ç”¨</span>
<span class="n">SingleWorkoutDetailSegmentSerializer</span><span class="p">(</span><span class="n">format_segments</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<h2>9.2 list<em>route ä¸ detail</em>route</h2>

<p>åœºæ™¯: æ¯”å¦‚è¯´getè¯·æ±‚, è¯·æ±‚è‡ªå·±çš„æ•°æ®ä¸è¯·æ±‚ä»–äººçš„æ•°æ®(åˆ—è¡¨/è¯¦æƒ…)è‚¯å®šæ˜¯ä¸ä¸€æ ·çš„, é‚£ä¹ˆå¦‚ä½•åŒºåˆ†å‘¢?</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.decorators</span> <span class="kn">import</span> <span class="n">list_route</span><span class="p">,</span> <span class="n">detail_route</span>

<span class="n">my_serializer_class</span> <span class="o">=</span> <span class="n">MyWorkoutListSerialzier</span>
<span class="nd">@list_route</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">mine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; RESTFUL-API: æˆ‘çš„å†å²åˆ—è¡¨</span>

<span class="sd">        :param request:</span>
<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">())</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">backends</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_filter_backends</span><span class="p">)</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_user_id</span><span class="p">(</span><span class="n">request</span><span class="p">),</span>
                                   <span class="n">deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span>
                                         <span class="n">klass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_serializer_class</span><span class="p">,</span>
                                         <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">serializer</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">XRes</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">BSC</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
<h2>9.3 filter_queryset</h2>

<p>åœºæ™¯: è¯·æ±‚æˆ‘çš„å†å²è®°å½•,ä¸€äº›é¢å¤–å­—æ®µä¼ é€’ä¼šå¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤, ä¾‹å¦‚, Xå¹´Xæœˆçš„å†å²è®°å½•; å†…éƒ¨è¿˜ä¼šæœ‰ä¸€äº›åˆ¤æ–­é€»è¾‘, å¦‚æœç›´æ¥å†™åˆ¤æ–­é€»è¾‘åˆ°Viewé‡Œé¢, å°±ä¼šæ˜¾å¾—å¾ˆç¬¨æ‹™, é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨filter<em>queryset, å¹¶ä¸”è‡ªå·±å®šä¹‰ä¸€ä¸ªlist</em>filter_backendsè¿‡æ»¤å™¨, å°†ç‰¹å®šçš„åˆ¤æ–­é€»è¾‘æ”¾åˆ°å‚æ•°è¿‡æ»¤å™¨ä¸­;</p>

<p>ä¾‹å­: å¯¹ä¸Šä¸€ä¸ªä¾‹å­çš„è¡¥å……</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">YYYYMMFilterBackend</span><span class="p">(</span><span class="n">BaseFilterBackend</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
            <span class="n">now_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">now_time</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span>
            <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span> <span class="k">if</span> <span class="n">month</span> <span class="k">else</span> <span class="n">month</span>

            <span class="c1"># æŒ‰å¹´è·å–å†å²è®°å½•, æˆ–è€…æŒ‰æŸå¹´çš„æŸæœˆ: è®¡ç®—æ—¶é—´èŒƒå›´çš„æ—¶é—´æˆ³æ ¼å¼</span>
            <span class="k">if</span> <span class="n">month</span> <span class="ow">and</span> <span class="n">year</span><span class="p">:</span>
                <span class="n">first_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">if</span> <span class="n">month</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">last_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="k">elif</span> <span class="n">year</span><span class="p">:</span>
                <span class="n">first_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">last_day_unix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000</span>

            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">start_time__gte</span><span class="o">=</span><span class="n">first_day_unix</span><span class="p">,</span>
                <span class="n">start_time__lt</span><span class="o">=</span><span class="n">last_day_unix</span><span class="p">,</span>
            <span class="p">)</span>

<span class="n">list_filter_backends</span> <span class="o">=</span> <span class="p">(</span><span class="n">YYYYMMFilterBackend</span><span class="p">,</span> <span class="p">)</span>  <span class="c1"># è¿™é‡Œ</span>
</pre></div>
</div>
<h2>9.4 get_serializer</h2>

<p>åœºæ™¯: ä¸åŒæƒ…å¢ƒä¸åŒçš„åºåˆ—åŒ–å™¨, æœ‰å‡ ç§åŠæ³•; 
    ç¬¬ä¸€ç§, æ ¹æ®ä¸åŒçš„æƒ…å†µé‡å†™get<em>serializer</em>classæ–¹æ³•;
    ç¬¬äºŒç§, ä½¿ç”¨get_serializerçš„kwargsæ‰©å±•å­—æ®µçš„æ–¹å¼;</p>

<p>æ–¹æ³•1: é‡å†™get<em>serializer</em>class</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;è®¾å®šåºåˆ—åŒ–å™¨&quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span>
        <span class="n">session_user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SESSION_KEY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">params_user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">session_user_id</span> <span class="ow">and</span> <span class="n">params_user_id</span> <span class="ow">and</span> <span class="n">session_user_id</span> <span class="o">==</span> <span class="n">params_user_id</span><span class="p">:</span>
                <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">OldSelfWorkoutListSerializer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">OldOtherUserWorkoutListSerializer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">WorkoutUploadSerializer</span>
        <span class="k">return</span> <span class="n">serializer_class</span>
</pre></div>
</div>
<p>æ–¹æ³•2: é‡å†™get_serializer</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Return the serializer instance that should be used for validating and</span>
<span class="sd">   deserializing input, and for serializing output.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="n">klass</span> <span class="o">=</span> <span class="bp">None</span>
   <span class="k">if</span> <span class="s1">&#39;klass&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
       <span class="n">klass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;klass&#39;</span><span class="p">)</span>
   <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">klass</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer_class</span><span class="p">()</span>
   <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer_context</span><span class="p">()</span>
   <span class="k">return</span> <span class="n">serializer_class</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
   
<span class="c1"># åœ¨æœ¬æ–‡9.2çš„ä¾‹å­ä¸­, è·å–åºåˆ—åŒ–å™¨çš„è¿‡ç¨‹, æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªklassçš„å‚æ•°</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span>
                                <span class="n">klass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_serializer_class</span><span class="p">,</span>
                                <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<h2>9.5 å®šä¹‰è¿”å›çš„æ•°æ®ç»“æ„</h2>

<p>åŒ…å«3éƒ¨åˆ†:</p>

<p>code
data
msg</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">XResponseResult</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
</pre></div>
</div>
<h2>9.6 åºåˆ—åŒ–æœ‰æ•ˆæ€§åˆ¤æ–­</h2>

<p>åœºæ™¯: æˆ‘éœ€è¦å¦å¤–ä»å¤–éƒ¨ç³»ç»Ÿä¸­æ‹¿åˆ°æ•°æ®, å¤šä¸ªç³»ç»Ÿä¹‹é—´, æˆ–è€…ç¬¬ä¸‰æ–¹ç³»ç»Ÿä¹‹é—´çš„æ•°æ®ä¼ é€’, å¦‚ä½•åˆ¤æ–­æœ‰æ•ˆæ€§å‘¢? æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨åºåˆ—åŒ–çš„æ–¹æ³•: </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># æ•°æ®ä¼ é€’è¿‡æ¥ä¹‹åå…ˆè¿›è¡Œæœ‰æ•ˆæ€§åˆ¤æ–­</span>
<span class="n">scs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UserStartCountSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span>
<span class="n">scs</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">raise_exception</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">scs</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<h1>10. å¥½ç”¨çš„ç¬¬ä¸‰æ–¹çš„åŒ…</h1>

<h2>10.1 å¤æ‚çš„æƒé™æ§åˆ¶</h2>

<p><a href="https://github.com/caxap/rest_condition">rest_condition</a></p>

    </div>
    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic green button">æ‰“èµ <i class="red heart icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">MORE WORDS</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer code">
            <span>Â© 1994 - 2018 willdx</span><b>@</b><a class="code" href="https://github.com/willdx/willdx.github.io">blog.willdx.me</a>
            <br/>
            <span class="notprint">
                <span id="busuanzi_container_site_pv">
                    <i class="eye icon"></i><span id="busuanzi_value_site_pv" class="orange text"></span> pv
                </span>
                <b> | </b>
                <span id="busuanzi_container_site_uv">
                    <i class="user icon"></i><span id="busuanzi_value_site_uv" class="orange text"></span> uv
                </span>
                <br/>
            </span>
            <span>Power by <i class="github alternate icon"></i><a href="https://github.com/willdx/willdx.github.io">Github Page</a></span>
            <br/>
            <i class="green superpowers icon"></i>
        </div>
    </body>
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="/assets/js/web.js"></script>
    <script>
        // ç»Ÿè®¡ä»£ç 
        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68394485-1', 'auto');
        ga('send', 'pageview');

        var wrappers = ["cats-wrapper", "donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper"]

        window.onload = function () {
            useWechat();
        }
    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: 'de35601f0076c240632f',
        clientSecret: 'b44ba043a5af4818f53dc13d3b4e49b5a28a2a0c',
        repo: 'willdx.github.io',
        owner: 'willdx',
        admin: ['willdx'],
        id: 'django-rest-framework Tutorial',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: ['gitment'],
        pagerDirection: "last",
    })
      
    gitalk.render('comments')
    </script>


</html>