<html>
    <head>
        <meta charset="utf-8">
        
    
        <title> ELKè®¾è®¡ä¸å®ç° </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">


        <style type="text/css"> 
        </style>
    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: #fff;">ä¸»é¢˜é€‰æ‹©</span></h3>
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr class="sk-mo" onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">å¢¨</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-green" onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">ç»¿</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-default" onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">é’</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-orange" onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">æ©˜</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">æ³¢å¦</div>
                                <div class="time">2017å¹´2æœˆ21å·</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">ä¸‰ä¸‰</div>
                                <div class="time">2017å¹´4æœˆ10å·</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        å¾®ä¿¡
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        æ”¯ä»˜å®
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:1426409836@qq.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/willdx">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>





            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
              <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="linkify icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    ğŸ±
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="heart icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <h2 class="name">Will Dx</h2>

                <span class="sign">äººä¸–ä¸€èº«éœœé›ª, å½’æ¥ä»æ˜¯å°‘å¹´.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        ä¸»é¡µ
                    </a>
                    <a href="/tweet.html" class="item">
                        æ¨ç‰¹
                    </a>
                    <a href="/about.html" class="item">
                        å…³äºæˆ‘
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        è”ç³»
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1>ELKè®¾è®¡ä¸å®ç°</h1>
        <h4>Posted April 07, 2017</h4>
        <p>[TOC]</p>

<h1>0.ELK?</h1>

<p>You Know, For Search!</p>

<p>1.å…¨æ–‡æœç´¢
2.ç»“æ„åŒ–æ•°æ®å®æ—¶ç»Ÿè®¡
3.æ•°æ®åˆ†æ
4.å¤æ‚è¯­è¨€å¤„ç†
5.åœ°ç†ä½ç½®
6.å¯¹è±¡é—´å…³è”å…³ç³»ç­‰
7.ç”šè‡³è¿˜å¯ä»¥æ•°æ®å»ºæ¨¡
ç­‰åŠŸèƒ½....</p>

<p>åŸºäºå¯¹æ—¥å¿—çš„å®æ—¶åˆ†æï¼Œå¯ä»¥éšæ—¶æŒæ¡æœåŠ¡çš„è¿è¡ŒçŠ¶å†µã€ç»Ÿè®¡ PV/UVã€å‘ç°å¼‚å¸¸æµé‡ã€åˆ†æç”¨æˆ·è¡Œä¸ºã€æŸ¥çœ‹çƒ­é—¨ç«™å†…æœç´¢å…³é”®è¯ç­‰</p>

<h1>1.How To ELK?</h1>

<p><code>æœ¬æ–‡åŸºäºELK stack 5.4ç‰ˆæœ¬</code></p>

<h1>2.ä»å®˜æ–¹æ¶æ„å›¾å¼€å§‹</h1>
<blockquote class="blockquote-normal">
                <p>å®˜æ–¹ELKæ¶æ„å›¾</p></blockquote>
<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14953425865573.jpg"></p>
                    <p class="img-title"><span class="symbol">#</span>å®˜æ–¹ELKæ¶æ„å›¾</p></p>
<blockquote class="blockquote-normal">
                <p><code>Beats</code>: æ—¥å¿—æ”¶é›†å™¨çš„ç»Ÿç§°, å…¶ä¸­FileBeatç”¨äºæ”¶é›†æ–‡ä»¶æ—¥å¿—;<br/><code>Logstash</code>: æ—¥å¿—æ”¶é›†ã€è¿‡æ»¤ã€è½¬å‘çš„ä¸­é—´ä»¶ï¼Œå„ç±»æ—¥å¿—ç»Ÿä¸€æ”¶é›†/è¿‡æ»¤/è½¬å‘Elasticsearch<br/><code>Elasticsearch</code>: åˆ†å¸ƒå¼ã€å¯æ‰©å±•ã€å®æ—¶çš„æœç´¢ä¸æ•°æ®åˆ†æå¼•æ“;<br/><code>Kibana</code>: æ˜¯ä¸€ä¸ªå¯è§†åŒ–å·¥å…·ï¼Œä¸»è¦è´Ÿè´£æŸ¥è¯¢ Elasticsearch çš„æ•°æ®å¹¶ä»¥å¯è§†åŒ–çš„æ–¹å¼å±•ç°ç»™ä¸šåŠ¡æ–¹ï¼Œæ¯”å¦‚å„ç±»é¥¼å›¾ã€ç›´æ–¹å›¾ã€åŒºåŸŸå›¾ç­‰;</p></blockquote>
<h2>2.1 ç®€å•äº†è§£å„ä¸ªä¸šåŠ¡ç»„ä»¶</h2>

<h3>2.1.1 FileBeat</h3>

<p><a href="https://www.elastic.co/downloads/beats/filebeat">ä¸‹è½½é“¾æ¥</a></p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># ä½¿ç”¨æ–¹æ³•

1. ä¸‹è½½-è§£å‹-è¿›å…¥è§£å‹ç¼©ç›®å½•.
2. ç¼–è¾‘ `filebeat.yml`, filebeat.full.ymlä¸ºå®Œæ•´ç‰ˆçš„é…ç½®æ–‡ä»¶.
3. å¯åŠ¨æ–¹å¼ `sudo ./filebeat -e -c filebeat.yml`.</pre></div></div>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># è§£æNginxè®¿é—®æ—¥å¿—: è·å–æ—¥å¿—-å­˜å‚¨åˆ°redis

filebeat.prospectors:
- input_type: log
  paths:
    - /track/nginx/logs/sx3/access.log # `æ—¥å¿—æ–‡ä»¶åœ°å€`
  encoding: utf-8
  document_type: sx3_nginx_access  # `æ‰“æ ‡ç­¾`
  scan_frequency: 10s
  harvester_buffer_size: 16384
  #multiline:
  #  pattern: '^\d'
  #  match: after

tags: ["sx3"]
ignore_older: 24

output.redis:
  enabled: true
  hosts: ["xxxxxx:6379"] # `redisåœ°å€`
  port: 6379
  key: sx3_nginx_access
  #password:
  db: 0
  datatype: list
  worker: 1
  loadbalance: true # `è´Ÿè½½å‡è¡¡`
  timeout: 5s
  max_retries: 3
  bulk_max_size: 2048

  #ssl.enabled: true
  #ssl.verification_mode: full
  #ssl.supported_protocols: [TLSv1.0, TLSv1.1, TLSv1.2]
  #ssl.certificate_authorities: ["/etc/pki/root/ca.pem"]
  #ssl.certificate: "/etc/pki/client/cert.pem"
  #ssl.key: "/etc/pki/client/cert.key"
  #ssl.key_passphrase: ''
  #ssl.cipher_suites: []
  #ssl.curve_types: []

logging.to_files: true
logging.files:
  path: /docker_data/elk_data/filebeat
  name: filebeat
  rotateeverybytes: 80485760
  keepfiles: 7</pre></div></div>

<h3>2.1.2 LogStash</h3>

<p><a href="https://artifacts.elastic.co/downloads/logstash/logstash-5.4.0.tar.gz">ä¸‹è½½é“¾æ¥</a></p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># ä½¿ç”¨æ–¹æ³•
1. ä¸‹è½½-è§£å‹-è¿›å…¥è§£å‹ç¼©ç›®å½•
2. `mkdir conf&& cd conf&& touch logstash-simple.conf`
3. vim logstash-simple.conf
    æ·»åŠ : æ ‡å‡†è¾“å…¥-æ ‡å‡†è¾“å‡ºæµ‹è¯•
input { stdin { } }
output {
  #elasticsearch { hosts => ["localhost:9200"] }
  stdout { codec => rubydebug }
}
4. å¯åŠ¨æ–¹å¼ `bin/logstash -f logstash-simple.conf`</pre></div></div>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># LogStashå¸¸ç”¨å‡½æ•°

filter{} å¸¸ç”¨å‡½æ•°è§£æ
grok{} æ˜¯ä¸€ä¸ªè§£ææ—¥å¿—æ•°æ®çš„å¥½æ’ä»¶
mutate{} å¯ä»¥ç”¨äºå¤„ç†æ•°æ®ç±»å‹ç›¸å…³çš„è½¬æ¢
geoip{} å¯ä»¥æ ¹æ®æ—¥å¿—ä¸­çš„ IP æ•°æ®ç›´æ¥è§£æå‡ºæ›´åŠ è¯¦ç»†ç›´è§‚çš„ä½ç½®æ•°æ®
date{} ç”¨äºå°†æ—¥æœŸè§£æä¸º @timestamp
useragent{} å¯ä»¥æ›´ä½³çš„è·å¾—ç”¨æˆ·æµè§ˆå™¨çš„å±æ€§</pre></div></div>
<blockquote class="blockquote-normal">
                <p>Logstashè¯­æ³•ä¼šæœ‰ä¸€äº›å‘, ç‰¹åˆ«æ˜¯å¦‚æœä½ çº¿ä¸Šçš„Nginxæ—¥å¿—è¿˜ä¸æ˜¯é»˜è®¤æ ¼å¼çš„æ—¶å€™</p></blockquote>
<p><a href="http://grokdebug.herokuapp.com/">æ¨èä½¿ç”¨grokdebugåœ¨çº¿æµ‹è¯•</a></p>

<p><a href="https://github.com/elastic/logstash/blob/v1.4.2/patterns/grok-patterns">é»˜è®¤logstash Grokå…¨å±€å˜é‡</a></p>

<p><a href="http://udn.yyuap.com/doc/logstash-best-practice-cn/filter/grok.html">å¦‚ä½•è‡ªå®šä¹‰logstashæ¨¡å¼</a></p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># è‡ªå·±å†™çš„å‡ ä¸ªä¾‹å­, å¯èƒ½æœ‰é”™, æ¬¢è¿æŒ‡æ­£, åç»­æ›´æ–°

# 1.To redis 
# æ¨èä½¿ç”¨`FileBeat`, å®ƒæ›´è½»é‡çº§å¹¶ä¸”é€Ÿåº¦æ›´å¿«
# ä½†æ˜¯,å¹³å¸¸å¼€å‘ç±»çš„éœ€æ±‚å¯ä»¥ç›´æ¥ä½¿ç”¨`logstash`æå®š, æ„Ÿè§‰ä¼šæ›´æ–¹ä¾¿

input {
  stdin { }
  file {
    type => "sx3_nginx_access"
    path => "/home/will/elk/logstash/access.log"
    start_position => beginning
    codec =>  multiline {
      'negate' => true
      'pattern' => '^\d'
      'what' => 'previous'
    }
  }
}

output {
  stdout { codec => rubydebug }
  if [type] == "sx3_nginx_access" {
    redis {
      host => "localhost"
      data_type => "list"
      key => "sx3_nginx_access"
    }
  }
}


# 2.Nginx access log to elastic (PS: è·å–`redis`çš„æ•°æ®, æ ¼å¼åŒ–åå¯¼å…¥`ElasticSearch`)
input {
  redis {
    host => "10.117.44.44"
    type => "sx3_nginx_access"
    data_type => "list"
    key => "sx3_nginx_access"
  }
}

filter {
  if [type] == "sx3_nginx_access" {
        grok {
          match => {
            "message" => [
              "%{BASE16FLOAT:upstream_response_time} \| %{COMBINEDAPACHELOG} %{GREEDYDATA:request_time}",
              "%{NGINXCOMBINEDAPACHELOG}"
            ]
          }
          patterns_dir => ["/home/will/elk_stack/logstash/patterns"] # è‡ªå®šä¹‰çš„æ¨¡å¼åŒ¹é…å˜é‡Dir
          remove_field => [ "message" ]
        }

        mutate {
          convert => ["response", "integer"]
          convert => ["bytes", "integer"]
          convert => ["responsetime", "float"]
          convert => ["upstream_response_time", "float"]
          convert => ["request_time", "float"]
          gsub => ["referrer", "[\"]", ""]
          gsub => ["agent", "[\"]", ""]
        }

        geoip {
          source => "clientip"
          target => "geoip"
          add_tag => [ "sx3-geoip" ]
        }

        useragent {
          source => "agent"
    }

    #date {
    #  match => [ "timestamp" , "yyyy/MM/dd HH:mm:ss" ]
    #  timezone => 'UTC'
    #}

  }
}

# 3. nginx_error_logæ¨¡å¼åŒ¹é…

cat nginx_error_log_format.conf
input {
  redis {
    host => "10.117.44.44"
    type => "sx3_nginx_error"
    data_type => "list"
    key => "sx3_nginx_error"
  }
}

filter{
  if [type] == "sx3_nginx_error" {
    grok {
      match => {
        "message" => [
          "(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[%{DATA:err_severity}\] (%{NUMBER:pid:int}#%{NUMBER}: \*%{NUMBER}|\*%{NUMBER}) %{DATA:err_message}(?:, client: (?<client_ip>%{IP}|%{HOSTNAME}))(?:, server: %{IPORHOST:server})(?:, request: \"%{WORD:verb} (%{URIPATH:urlpath}%{URIPARAM:urlparam} HTTP/%{NUMBER:httpversion})\")(?:, host: %{QS:hostname})(?:, referrer: \"%{URI:referrer}\")",

          "(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[%{DATA:err_severity}\] (%{NUMBER:pid:int}#%{NUMBER}: \*%{NUMBER}|\*%{NUMBER}) %{DATA:err_message}(?:, client: (?<client_ip>%{IP}|%{HOSTNAME}))(?:, server: %{IPORHOST:server})(?:, request: \"%{WORD:verb} (%{URIPATH:urlpath}%{URIPARAM:urlparam} HTTP/%{NUMBER:httpversion})\")(?:, upstream: \"%{URI:upstream}\")",

          "(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[%{DATA:err_severity}\] (%{NUMBER:pid:int}#%{NUMBER}: \*%{NUMBER}|\*%{NUMBER}) %{DATA:err_message}(?:, client: (?<client_ip>%{IP}|%{HOSTNAME}))(?:, server: %{IPORHOST:server})(?:, request: \"%{WORD:verb} (%{URIPATH:urlpath}%{URIPARAM:urlparam} HTTP/%{NUMBER:httpversion})\")",

          "(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[%{DATA:err_severity}\] (%{NUMBER:pid:int}#%{NUMBER}: \*%{NUMBER}|\*%{NUMBER}) %{DATA:err_message}(?:, client: (?<client_ip>%{IP}|%{HOSTNAME}))(?:, server: %{IPORHOST:server})(?:, request: \"%{WORD:verb} (%{URIPATH:urlpath} HTTP/%{NUMBER:httpversion})\")(?:, referrer: \"%{URI:referrer}\")",

          "(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[%{DATA:err_severity}\] (%{NUMBER:pid:int}#%{NUMBER}: \*%{NUMBER}|\*%{NUMBER}) %{DATA:err_message}(?:, client: (?<client_ip>%{IP}|%{HOSTNAME}))(?:, server: %{IPORHOST:server})(?:, request: \"%{WORD:verb} (%{URIPATH:urlpath} HTTP/%{NUMBER:httpversion})\")(?:, upstream: \"%{URI:upstream}\")",

          "(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[%{DATA:err_severity}\] (%{NUMBER:pid:int}#%{NUMBER}: \*%{NUMBER}|\*%{NUMBER}) %{DATA:err_message}(?:, client: (?<client_ip>%{IP}|%{HOSTNAME}))(?:, server: %{IPORHOST:server})(?:, request: \"%{WORD:verb} (%{URIPATH:urlpath} HTTP/%{NUMBER:httpversion})\")"
        ]
      }
    remove_field => [ "message" ]
    }
    date {
      match => [ "timestamp" , "yyyy/MM/dd HH:mm:ss" ]
      timezone => 'UTC'
    }
  }
}

output {
  elasticsearch { hosts => ["xxx:9200"] index => "logstash-nginx-error-%{+YYYY.MM.dd}"}
  stdout { codec => rubydebug }
}</pre></div></div>

<h2>patternsè§£é‡Š</h2>

<ul>
<li>logstash æä¾›çš„é»˜è®¤çš„æ­£åˆ™è¡¨è¾¾å¼, ä½†æ˜¯ä¸ä¸€å®šæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚</li>
<li>å½“é‡åˆ°å…¶ä»–éœ€è¦è‡ªå®šä¹‰çš„æ—¶å€™:</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>grok {
        match => { "request" => '"%{WORD:verb} %{URIPATH:urlpath}(?:\?%{NGX_URIPARAM:urlparam})?(?: HTTP/%{NUMBER:httpversion})"' }
        patterns_dir => ["/etc/logstash/patterns"]  # å®šä¹‰æ¨¡å¼åŒ¹é…çš„ä½ç½®
        remove_field => [ "message", "errinfo", "request" ]
    }
}</pre></div></div>

<ul>
<li>æ¨¡å¼åŒ¹é…ä½¿ç”¨è§„åˆ™</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>%{PATTERN_NAME:capture_name:data_type}</pre></div></div>

<ul>
<li>patternså†…å®¹</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>cat /home/will/elk_stack/logstash/patterns/grok_patterns_extend
EMAIL [a-z_0-9.-]{1,64}@([a-z0-9-]{1,200}.){1,5}[a-z]{1,6}
NGINXCOMBINEDAPACHELOG %{BASE16FLOAT:upstream_response_time} \| %{IPORHOST:clientip} %{USER:ident} %{EMAIL:auth} \[%{HTTPDATE:timestamp}\] "(?:%{WORD:verb} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})" %{NUMBER:response} (?:%{NUMBER:bytes}|-) %</pre></div></div>

<h3>2.1.3 ElasticSearch</h3>

<p><a href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.4.0.zip">ä¸‹è½½é“¾æ¥</a></p>
<div class="code-wrapper"><div class="lang-label">Bash</div><div class="highlight"><pre><span></span><span class="c1"># ä½¿ç”¨æ–¹æ³•</span>

<span class="m">1</span>. ä¸‹è½½-è§£å‹-è¿›å…¥ç›®å½•
<span class="m">2</span>. vim config/elasticsearch.yml æ›´æ”¹é…ç½®æ–‡ä»¶

é…ç½®ä¾‹å­: grep -n <span class="s1">&#39;^[a-Z]&#39;</span> config/elasticsearch.yml
custer.name: xzelk
node.name: master
node.master: <span class="nb">true</span>
node.data: <span class="nb">true</span>
node.attr.rack: r1
path.data: /docker_data/elk_data/elastic/data
path.logs: /docker_data/elk_data/elastic/logs
network.host: <span class="m">0</span>.0.0.0
http.port: <span class="m">9200</span>
discovery.zen.ping.unicast.hosts: <span class="o">[</span><span class="s2">&quot;10.117.44.44:9300&quot;</span><span class="o">]</span>

<span class="m">3</span>.å¯åŠ¨ ./bin/elasticsearch
<span class="m">4</span>.æ£€æŸ¥ curl http://localhost:9200/
</pre></div>
</div>
<h3>2.1.4 Kibana</h3>

<p><a href="https://artifacts.elastic.co/downloads/kibana/kibana-5.4.0-linux-x86_64.tar.gz">ä¸‹è½½é“¾æ¥</a></p>
<div class="code-wrapper"><div class="lang-label">Bash</div><div class="highlight"><pre><span></span><span class="c1"># ä½¿ç”¨æ–¹æ³•</span>

<span class="m">1</span>. ä¸‹è½½-è§£å‹-è¿›å…¥ç›®å½•-æ‰“å¼€é…ç½®ç¼–è¾‘å™¨ä¸­çš„kibana.yml
<span class="m">2</span>. é…ç½®elasticsearch.urlæŒ‡å‘ä½ çš„ElasticSearchå®ä¾‹
<span class="m">3</span>. å¯åŠ¨: bin/kibana
<span class="m">4</span>. æ£€æŸ¥: http://localhost:5601
</pre></div>
</div>
<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14953885310695.jpg"></p>
                    <p class="img-title"><span class="symbol">#</span>kibanaç®€å•åˆ†æ</p></p>

<h3>2.1.4 x-pack</h3>

<p><a href="https://www.elastic.co/cn/products/x-pack">x-pack</a></p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14953890510638.jpg"></p>
                    <p class="img-title"><span class="symbol">#</span>x-parkæä¾›ä»¥ä¸‹åŠŸèƒ½-é™¤äº†Monitorç»„ä»¶(éœ€è¦åˆ°å®˜æ–¹æ³¨å†Œsç”³è¯·), å…¶å®ƒçš„éƒ½éœ€è¦æ”¶è´¹</p></p>

<p><a href="https://www.elastic.co/guide/en/x-pack/current/installing-license.html">æ›´æ–°license</a></p>
<blockquote class="blockquote-normal">
                <p>ç”±äºè®¤è¯æ”¶è´¹, æ‰€ä»¥æ›²çº¿æ•‘å›½, Nginxä¸Šé…ç½®ç®€å•å¯†ç è®¤è¯</p></blockquote>
<p><a href="https://kibana.logstash.es/content/kibana/v5/production.html">é…ç½®åœ°å€</a></p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>upstream kibana5 {
    server 127.0.0.1:5601 fail_timeout=0;
}
server {
    listen               *:80;
    server_name          kibana_server;
    access_log           /var/log/nginx/kibana.srv-log-dev.log;
    error_log            /var/log/nginx/kibana.srv-log-dev.error.log;

    ssl                  on;
    ssl_certificate      /etc/nginx/ssl/all.crt;
    ssl_certificate_key  /etc/nginx/ssl/server.key;

    location / {
        root   /var/www/kibana;
        index  index.html  index.htm;
    }

    location ~ ^/kibana5/.* {
        proxy_pass           http://kibana5;
        rewrite              ^/kibana5/(.*)  /$1 break;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Host            $host;
        auth_basic           "Restricted";
        auth_basic_user_file /etc/nginx/conf.d/kibana.myhost.org.htpasswd;
    }
}
å¦‚æœç”¨æˆ·å¤Ÿå¤šï¼Œå½“ç„¶ä½ å¯ä»¥å•ç‹¬è·‘ä¸€ä¸ª kibana5 é›†ç¾¤ï¼Œç„¶ååœ¨ upstream é…ç½®æ®µä¸­æ·»åŠ å¤šä¸ªä»£ç†åœ°å€åšè´Ÿè½½å‡è¡¡ã€‚</pre></div></div>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>htpasswd -c /$path/.htpasswd $username</pre></div></div>

<h1>3. å®è·µæ¶æ„</h1>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14953863776685.jpg"></p>
                    <p class="img-title"><span class="symbol">#</span>è¡Œè€…ELKæ¶æ„</p></p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># ä¸ºäº†å°½é‡ä¿è¯æ•°æ®å®Œæ•´æ€§, ä¸­é—´åŠ äº†ç¼“å­˜

1. Filebeat è·å–Nginxæ—¥å¿—, å¯¼å…¥kafka æˆ–è€… redis
2. Logstash è·å–å¯¹åº”redisé˜Ÿåˆ—ä¸­çš„æ•°æ®format, å¯¼å…¥Elasticsearch
3. Kibana è®¾å®šåˆ°Elasticsearchçš„è¿æ¥, å®æ—¶æŸ¥è¯¢å’Œå¯è§†åŒ–åˆ†æ

æ•´ä¸ªæ¶æ„å¯ä»¥æ¨ªå‘æ‰©å±•, redis/logstash/elasticsearch/kibana éƒ½å¯ä»¥åšé›†ç¾¤</pre></div></div>

<h2>3.1 Elasticsearché›†ç¾¤é…ç½®</h2>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html">å®˜æ–¹æ–‡æ¡£</a></p>

<h2>3.2 ELK é›†ç¾¤ç®¡ç†</h2>

<h3>3.2.1 é›†ç¾¤ç®¡ç†API</h3>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># é›†ç¾¤å¥åº·çŠ¶æ€
curl 'http://10.117.44.44:9200/_cat/health?v'

# è·å–é›†ç¾¤çš„ä¸€ç³»åˆ—èŠ‚ç‚¹
curl 'http://10.117.44.44:9200/_cat/nodes?v'

# åˆ—å‡ºæ‰€æœ‰çš„ç´¢å¼•
curl 'http://10.117.44.44:9200/_cat/indices?v'

# åˆ›å»ºä¸€ä¸ªç´¢å¼•
curl -XPUT 'http://10.117.44.44:9200/customer?pretty'

# å¾€ç´¢å¼•çš„æŸä¸ªç±»å‹ä¸­æ·»åŠ å†…å®¹
# customerç´¢å¼•çš„externalç±»å‹æ·»åŠ ä¸€ä¸ªå­—å…¸
curl -XPUT 'http://10.117.44.44:9200/customer/external/1?pretty' -d '
{
  "name": "John Doe"
}'
{
  "_index" : "customer",
  "_type" : "external",
  "_id" : "1",
  "_version" : 1,
  "created" : true
}

# æŸ¥æ‰¾åˆšåˆšåˆ›å»ºçš„æ•°æ®
curl -XGET 'http://10.117.44.44:9200/customer/external/1?pretty'
{
  "_index" : "customer",
  "_type" : "external",
  "_id" : "1",
  "_version" : 1,
  "found" : true,
  "_source" : { "name": "John Doe" }
}

# æ›´æ–°æ–‡æ¡£
curl -XPUT 'localhost:9200/customer/external/1?pretty' -d '
{
  "name": "Jane Doe"
}'

# åˆ é™¤æ–‡æ¡£
curl -XDELETE 'localhost:9200/customer/external/2?pretty'

# æ‰¹å¤„ç†
# åˆ é™¤åªè¦æ±‚è¦åˆ é™¤çš„æ–‡ä»¶çš„IDï¼Œç„¶åï¼Œç›¸åº”çš„æºæ–‡ä»¶ä¹Ÿå°±æ²¡æœ‰äº†

curl -XPOST 'localhost:9200/customer/external/_bulk?pretty' -d '
{"update":{"_id":"1"}}
{"doc": { "name": "John Doe becomes Jane Doe" } }
{"delete":{"_id":"2"}}
'</pre></div></div>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>æ€»ç»“: ElasticSearchçš„restfulè¯­æ³•å¤§è‡´å¦‚ä¸‹
curl -X<REST Verb> <Node>:<Port>/<Index>/<Type>/<ID></pre></div></div>

<h3>3.2.1 é›†ç¾¤ç®¡ç†ç¬¬ä¸‰å‘åº“-cerebro</h3>

<p><a href="https://github.com/lmenezes/cerebro">Githubåœ°å€</a></p>
<blockquote class="blockquote-normal">
                <p>Cerebro æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ Elasticsearch é›†ç¾¤ç®¡ç†è½¯ä»¶,å¯ä»¥æ–¹ä¾¿åœ°æŸ¥çœ‹é›†ç¾¤çŠ¶æ€, ä»¥åŠä¸€äº›é›†ç¾¤ç®¡ç†å·¥ä½œ</p></blockquote><div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre># ä½¿ç”¨æ–¹æ³•
1. ä¸‹è½½-è§£å‹-è¿›å…¥ç›®å½•
2. è¿è¡Œ bin/cerebro -Dhttp.port=1234 -Dhttp.address=127.0.0.1</pre></div></div>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14953887822023.jpg"></p>
                    <p class="img-title"><span class="symbol">#</span>ç®¡ç†ç•Œé¢</p></p>

<h1>å®‰è£…åæŠ¥é”™: max file limit</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>vim /etc/security/limits.conf
* hard nofile 655360
* soft nofile 655360</pre></div></div>

<h1>å®‰è£…åæŠ¥é”™: vm bala bala bala....</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>vim /etc/sysctl.conf
vm.max_map_count=2621440  #æ·»åŠ è¿™ä¸€è¡Œ</pre></div></div>

<h1>ç§‘æ™®å°çŸ¥è¯†-ç½‘ç«™æµé‡ç»Ÿè®¡</h1>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>UVï¼ˆUnique visitor): ç”¨æˆ·å”¯ä¸€æ€§, ä¸€å¤©å†…åŒä¸ªè®¿å®¢å¤šæ¬¡è®¿é—®ä»…è®¡ç®—ä¸€ä¸ªUV;
IPï¼ˆInternet Protocol): IPå”¯ä¸€æ€§, ä¸€å¤©å†…ç›¸åŒçš„IPåœ°å€å¤šæ¬¡ä»…è¢«è®¡ç®—ä¸€æ¬¡IP;
PVï¼ˆPage View):é¡µé¢çš„æµè§ˆæ¬¡æ•°ç´¯è®¡;
VVï¼ˆVisit View): è®¿é—®ç½‘ç«™çš„æ¬¡æ•°ç´¯è®¡;</pre></div></div>

<h1>ELKå…¸æ•…-è¿™ä¸ªç¨‹åºå‘˜è·‘åäº†å•Š!</h1>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14953816260996.jpg"></p>
                    <p class="img-title"><span class="symbol">#</span>ç¨‹åºå‘˜çš„æ•…äº‹</p></p>

    </div>
    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic green button">æ‰“èµ <i class="red heart icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">MORE WORDS</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer code">
            <span>Â© 1994 - 2018 willdx</span><b>@</b><a class="code" href="https://willdx.github.io">willdx.github.io</a>
            <br/>
            <span class="notprint">
                <span id="busuanzi_container_site_pv">
                    <i class="eye icon"></i><span id="busuanzi_value_site_pv" class="orange text"></span> pv
                </span>
                <b> | </b>
                <span id="busuanzi_container_site_uv">
                    <i class="user icon"></i><span id="busuanzi_value_site_uv" class="orange text"></span> uv
                </span>
                <br/>
            </span>
            <span>Power by <i class="github alternate icon"></i><a href="https://github.com/willdx/willdx.github.io">Github Page</a></span>
            <br/>
            <i class="green superpowers icon"></i>
        </div>
    </body>
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="/assets/js/web.js"></script>
    <script>
        // ç»Ÿè®¡ä»£ç 
        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68394485-1', 'auto');
        ga('send', 'pageview');

        var wrappers = ["cats-wrapper", "donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper"]

        window.onload = function () {
            useWechat();
        }
    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: '177af99888a292531873',
        clientSecret: '7c0927c7cdf0d94eed7dad0b238552c10ec6f53c',
        repo: 'willdx.github.io',
        owner: 'willdx',
        admin: ['willdx'],
        id: 'ELKè®¾è®¡ä¸å®ç°',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: ['gitment'],
        pagerDirection: "last",
    })
      
    gitalk.render('comments')
    </script>


</html>