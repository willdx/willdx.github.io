<html>
    <head>
        <meta charset="utf-8">
        
    
        <title> pythoné­”æ³•æ–¹æ³•ä¸“é¢˜02-python3.5åç¨‹åŸç† </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">


        <style type="text/css"> 
        </style>
    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: #fff;">ä¸»é¢˜é€‰æ‹©</span></h3>
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr class="sk-mo" onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">å¢¨</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-green" onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">ç»¿</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-default" onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">é’</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-orange" onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">æ©˜</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">æ³¢å¦</div>
                                <div class="time">2017å¹´2æœˆ21å·</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">ä¸‰ä¸‰</div>
                                <div class="time">2017å¹´4æœˆ10å·</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        å¾®ä¿¡
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        æ”¯ä»˜å®
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:1426409836@qq.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/willdx">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>





            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
              <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="linkify icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    ğŸ±
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="heart icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <h2 class="name">Will Dx</h2>

                <span class="sign">äººä¸–ä¸€èº«éœœé›ª, å½’æ¥ä»æ˜¯å°‘å¹´.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        ä¸»é¡µ
                    </a>
                    <a href="/tweet.html" class="item">
                        æ¨ç‰¹
                    </a>
                    <a href="/about.html" class="item">
                        å…³äºæˆ‘
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        è”ç³»
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1>pythoné­”æ³•æ–¹æ³•ä¸“é¢˜02-python3.5åç¨‹åŸç†</h1>
        <h4>Posted April 07, 2017</h4>
        <h1>python3.5åç¨‹åŸç†ç¬”è®°</h1>

<h2>è¿­ä»£å™¨iterator</h2>

<p>å¯¹äºstringã€listã€dictã€tupleç­‰è¿™ç±»å®¹å™¨å¯¹è±¡,ä½¿ç”¨forå¾ªç¯éå†æ˜¯å¾ˆæ–¹ä¾¿çš„;åœ¨åå°forè¯­å¥å¯¹å®¹å™¨å¯¹è±¡è°ƒç”¨iter()å‡½æ•°,iter()æ˜¯pythonçš„å†…ç½®å‡½æ•°;iter()ä¼šè¿”å›ä¸€ä¸ªå®šä¹‰äº†next()æ–¹æ³•çš„è¿­ä»£å™¨å¯¹è±¡,å®ƒåœ¨å®¹å™¨ä¸­é€ä¸ªè®¿é—®å®¹å™¨å†…å…ƒç´ ,next()ä¹Ÿæ˜¯pythonçš„å†…ç½®å‡½æ•°;åœ¨æ²¡æœ‰åç»­å…ƒç´ æ—¶,next()ä¼šæŠ›å‡ºä¸€ä¸ªStopIterationå¼‚å¸¸,é€šçŸ¥forè¯­å¥å¾ªç¯ç»“æŸ;</p>

<p>pythonè‡ªå¸¦çš„å®¹å™¨å¯¹è±¡,å®ƒä»¬éƒ½å®ç°äº†ç›¸åº”çš„è¿­ä»£å™¨æ–¹æ³•,é‚£å¦‚æœæ˜¯è‡ªå®šä¹‰ç±»éœ€è¦éå†æ€ä¹ˆåŠï¼Ÿ</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>1.å®ç°ä¸€ä¸ª__iter__(self)æ–¹æ³•,è¿”å›self
2.å®ç°ä¸€ä¸ª__next__(self)æ–¹æ³•,è¿”å›å¯¹åº”çš„å€¼
3.ç»“æŸæ—¶æ‰‹åŠ¨raise StopIteration å¼‚å¸¸</pre></div></div>

<p>ä¸€ä¸ªç»å…¸çš„ä¾‹å­:  <strong>è‡ªå®šä¹‰è¿­ä»£å™¨</strong>ç±»è¿”å› æ–æ³¢é‚£å¥‘æ•°åˆ—</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Fib</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">max</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Fib</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="nb">max</span>
    
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;éå†æ—¶è¢«iter()è°ƒç”¨,è¿”å›ä¸€ä¸ªè¿­ä»£å™¨&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;éå†æ—¶å†…ç½®çš„next()æ•°è°ƒç”¨__next__(self)æ–¹æ³•&quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span> <span class="c1">#æ‰‹åŠ¨æŠ›ä¸€åœº</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Fib</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
<h2>ç”Ÿæˆå™¨Generator</h2>
<blockquote class="blockquote-normal">
                <p>Python 2.2ç”Ÿæˆå™¨äº§ç”Ÿ<strong>ç”Ÿæˆå™¨</strong>æ¦‚å¿µ,ç”Ÿæˆå™¨å…è®¸åˆ›å»ºä¸€ä¸ªåœ¨è®¡ç®—ä¸‹ä¸€ä¸ªå€¼æ—¶ä¸ä¼šæµªè´¹å†…å­˜ç©ºé—´çš„è¿­ä»£å™¨</p></blockquote>
<p>ç”Ÿæˆå™¨æ˜¯ä¸€ç§æ›´æ–¹ä¾¿çš„åˆ›å»ºè¿­ä»£å™¨çš„æ–¹å¼,æ¯ä¸€æ¬¡yieldè°ƒç”¨è‡ªåŠ¨åˆ›å»ºçš„<strong>iter</strong>()å’Œ <strong>next</strong>()æ–¹æ³•,è¿”å›å½“å‰çš„è¿­ä»£å€¼,è‡ªyieldå¤„æš‚åœå‡½æ•°,ä¸‹ä¸€æ¬¡yieldä»å…¶æš‚åœå¤„æ¢å¤è¿è¡Œ;ç»ˆç»“æ—¶,ä¼šè‡ªåŠ¨æŠ›å‡ºStopIterationå¼‚å¸¸;</p>

<p>ä¸€ä¸ªç»å…¸çš„ä¾‹å­:  <strong>ç”Ÿæˆå™¨</strong>è¿”å› æ–æ³¢é‚£å¥‘æ•°åˆ—</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">flb</span><span class="p">(</span><span class="nb">max</span><span class="p">):</span>
    <span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">n</span><span class="o">&lt;</span> <span class="nb">max</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">b</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="o">+</span><span class="n">a</span>
        <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
<span class="p">[</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flb</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">]</span>
</pre></div>
</div>
<p>pythonè¿˜æä¾›äº†ä¸€ä¸ªç”Ÿæˆå™¨è¡¨è¾¾å¼: </p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ç”Ÿæˆå™¨ï¼Ÿå› ä¸ºåˆ›å»ºæ–¹ä¾¿,å¹¶èŠ‚çœ cpu å’Œ å†…å­˜(ram)</p>

<p>å¯ä»¥åˆ©ç”¨ç”Ÿæˆå™¨â€œæš‚åœâ€çš„éƒ¨åˆ†,æ·»åŠ â€œå°†ä¸œè¥¿å‘é€å›ç”Ÿæˆå™¨â€çš„åŠŸèƒ½,é‚£ä¹ˆ Python çªç„¶å°±æœ‰äº†åç¨‹çš„æ¦‚å¿µ,python2.5ä¸ºç”Ÿæˆå™¨å¼•å…¥äº†send()æ–¹æ³•,è¿™è®©æˆ‘ä»¬ä¸ä»…å¯ä»¥æš‚åœç”Ÿæˆå™¨,è€Œä¸”èƒ½å¤Ÿä¼ é€’å€¼åˆ°ç”Ÿæˆå™¨æš‚åœçš„åœ°æ–¹;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">jumping_range</span><span class="p">(</span><span class="n">up_to</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">up_to</span><span class="p">:</span>
        <span class="n">jump</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">index</span>
        <span class="k">if</span> <span class="n">jump</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">jump</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="n">jump</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="n">jumping_range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">))</span>  <span class="c1"># 0</span>
    <span class="k">print</span><span class="p">(</span><span class="n">iterator</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># 2</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">))</span>  <span class="c1"># 3</span>
    <span class="k">print</span><span class="p">(</span><span class="n">iterator</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># 2</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1">#3,4</span>
</pre></div>
</div>
<h2>@types.coroutine/yield from</h2>
<blockquote class="blockquote-normal">
                <p>Python3.3ä¸­çš„<strong>yield from</strong> è¯­æ³•ä½¿ç”Ÿæˆå™¨ä¹‹é—´å¯ä»¥ä¸²è”èµ·æ¥,ä¾¿äºç”Ÿæˆå™¨çš„é‡æ„;</p></blockquote><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="k">yield from</span> <span class="n">iterator</span>
<span class="c1">#ç›¸å½“äº</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
    <span class="k">yield</span> <span class="n">x</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1">#é‡æ„</span>
<span class="k">def</span> <span class="nf">lazy_range</span><span class="p">(</span><span class="n">up_to</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">gratuitous_refactor</span><span class="p">():</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">up_to</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">index</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">yield from</span> <span class="n">gratuitous_refactor</span><span class="p">()</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1">#ä¸²è”</span>
<span class="k">def</span> <span class="nf">bottom</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">yield</span> <span class="mi">42</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">middle</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">bottom</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">top</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">middle</span><span class="p">())</span>
    
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">top</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># Prints &#39;42&#39;.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># Prints &#39;84&#39;</span>
    <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</div>
<h3>ç”Ÿæˆå™¨æ€»ç»“</h3>

<p>Python 2.2 ä¸­çš„ç”Ÿæˆå™¨è®©ä»£ç æ‰§è¡Œè¿‡ç¨‹å¯ä»¥æš‚åœ;Python 2.5 ä¸­å¯ä»¥å°†å€¼è¿”å›ç»™æš‚åœçš„ç”Ÿæˆå™¨, è¿™ä½¿å¾— Python ä¸­åç¨‹çš„æ¦‚å¿µæˆä¸ºå¯èƒ½;åŠ ä¸Š Python 3.3 ä¸­çš„ yield from,ä½¿å¾—é‡æ„ç”Ÿæˆå™¨ä¸å°†å®ƒä»¬ä¸²è”èµ·æ¥éƒ½å¾ˆç®€å•;</p>

<h2>asyncio</h2>
<blockquote class="blockquote-normal">
                <p>Python3.4ä¸­çš„<strong>@asyncio.coroutine</strong> è¯­æ³•ç”¨æ¥æä¾›äº‹ä»¶å¾ªç¯ç‰¹æ€§;</p></blockquote>
<h3>ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªç¯ï¼Ÿ</h3>

<p>äº‹ä»¶å¾ªç¯ â€œ<strong>æ˜¯ä¸€ç§ç­‰å¾…ç¨‹åºåˆ†é…äº‹ä»¶æˆ–æ¶ˆæ¯çš„ç¼–ç¨‹æ¶æ„</strong>â€, åŸºæœ¬ä¸Šæ¥è¯´äº‹ä»¶å¾ªç¯å°±æ˜¯,â€œå½“Aå‘ç”Ÿæ—¶,æ‰§è¡ŒBâ€;</p>

<p>ä¾‹å¦‚:æ¯ä¸ªæµè§ˆå™¨ä¸­éƒ½å­˜åœ¨çš„JavaScriptäº‹ä»¶å¾ªç¯;å½“ä½ ç‚¹å‡»äº†æŸä¸ªä¸œè¥¿ï¼ˆâ€œå½“Aå‘ç”Ÿæ—¶â€ï¼‰,è¿™ä¸€ç‚¹å‡»åŠ¨ä½œä¼šå‘é€ç»™JavaScriptçš„äº‹ä»¶å¾ªç¯,å¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ³¨å†Œè¿‡çš„ onclick å›è°ƒæ¥å¤„ç†è¿™ä¸€ç‚¹å‡»ï¼ˆâ€œæ‰§è¡ŒBâ€ï¼‰;åªè¦æœ‰æ³¨å†Œè¿‡çš„å›è°ƒå‡½æ•°å°±ä¼šä¼´éšç‚¹å‡»åŠ¨ä½œçš„ç»†èŠ‚ä¿¡æ¯è¢«æ‰§è¡Œ;äº‹ä»¶å¾ªç¯è¢«è®¤ä¸ºæ˜¯ä¸€ç§å¾ªç¯æ˜¯å› ä¸ºå®ƒä¸åœåœ°æ”¶é›†äº‹ä»¶å¹¶é€šè¿‡å¾ªç¯æ¥å†³å®šå¦‚ä½•åº”å¯¹è¿™äº›äº‹ä»¶;</p>

<p>å¯¹Python æ¥è¯´,ç”¨ asyncio æ¥æä¾›äº‹ä»¶å¾ªç¯,asyncio é‡ç‚¹è§£å†³ç½‘ç»œæœåŠ¡ä¸­çš„é—®é¢˜,äº‹ä»¶å¾ªç¯åœ¨è¿™é‡Œå°†æ¥è‡ªå¥—æ¥å­—ï¼ˆsocketï¼‰çš„ I/O å·²ç»å‡†å¤‡å¥½è¯»å’Œ/æˆ–å†™ä½œä¸ºâ€œå½“Aå‘ç”Ÿæ—¶â€ï¼ˆé€šè¿‡selectorsæ¨¡å—ï¼‰</p>

<p>äº‹ä»¶å¾ªç¯æä¾›ä¸€ç§å¾ªç¯æœºåˆ¶,è®©ä½ å¯ä»¥â€œåœ¨Aå‘ç”Ÿæ—¶,æ‰§è¡ŒBâ€;åŸºæœ¬ä¸Šæ¥è¯´äº‹ä»¶å¾ªç¯å°±æ˜¯ç›‘å¬å½“æœ‰ä»€ä¹ˆå‘ç”Ÿæ—¶,åŒæ—¶äº‹ä»¶å¾ªç¯ä¹Ÿå…³å¿ƒè¿™ä»¶äº‹å¹¶æ‰§è¡Œç›¸åº”çš„ä»£ç ;Python 3.4 ä»¥åé€šè¿‡æ ‡å‡†åº“ asyncio è·å¾—äº†äº‹ä»¶å¾ªç¯çš„ç‰¹æ€§;</p>

<p>Python 3.4 é€šè¿‡å¹¶å‘ç¼–ç¨‹çš„å½¢å¼å·²ç»å¯¹å¼‚æ­¥ç¼–ç¨‹æœ‰äº†è¶³å¤Ÿçš„æ”¯æŒ;å¼‚æ­¥ç¼–ç¨‹ç®€å•æ¥è¯´å°±æ˜¯ä»£ç æ‰§è¡Œçš„é¡ºåºåœ¨ç¨‹åºè¿è¡Œå‰æ˜¯æœªçŸ¥çš„ï¼ˆå› æ­¤æ‰ç§°ä¸ºå¼‚æ­¥è€ŒéåŒæ­¥ï¼‰;å¹¶å‘ç¼–ç¨‹æ˜¯ä»£ç çš„æ‰§è¡Œä¸ä¾èµ–äºå…¶ä»–éƒ¨åˆ†,å³ä¾¿æ˜¯å…¨éƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…æ‰§è¡Œï¼ˆå¹¶å‘ä¸æ˜¯å¹¶è¡Œ);</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="nd">@asyncio.coroutine</span>
<span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;T-minus&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;({})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">))</span>
        <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="err">ï¼ƒå¼€å¯å¹¶å‘ä»»åŠ¡</span>
<span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">countdown</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">countdown</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="p">]</span>
<span class="c1"># å¼€å¯äº‹ä»¶å¾ªç¯</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="err">ï¼ƒ</span> <span class="err">ç»“æœ</span><span class="p">:</span><span class="err">å¤šä»»åŠ¡äº¤æ›¿æ‰§è¡Œ</span>
<span class="n">T</span><span class="o">-</span><span class="n">minus</span> <span class="mi">2</span> <span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">T</span><span class="o">-</span><span class="n">minus</span> <span class="mi">3</span> <span class="p">(</span><span class="n">B</span><span class="p">)</span>
<span class="n">T</span><span class="o">-</span><span class="n">minus</span> <span class="mi">1</span> <span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">T</span><span class="o">-</span><span class="n">minus</span> <span class="mi">2</span> <span class="p">(</span><span class="n">B</span><span class="p">)</span>
<span class="n">T</span><span class="o">-</span><span class="n">minus</span> <span class="mi">1</span> <span class="p">(</span><span class="n">B</span><span class="p">)</span>
</pre></div>
</div>
<p>//ä¸‹é¢å‡ æ®µè¯copyè€Œæ¥, æš‚æ—¶ä¸æ˜¯å¾ˆç†è§£
Python 3.4 ä¸­,asyncio.coroutine ä¿®é¥°å™¨ç”¨æ¥æ ‡è®°ä½œä¸ºåç¨‹çš„å‡½æ•°,è¿™é‡Œçš„åç¨‹æ˜¯å’ŒasyncioåŠå…¶äº‹ä»¶å¾ªç¯ä¸€èµ·ä½¿ç”¨çš„;è¿™èµ‹äºˆäº† Python ç¬¬ä¸€ä¸ªå¯¹äºåç¨‹çš„æ˜ç¡®å®šä¹‰ï¼šå®ç°äº†PEP 342æ·»åŠ åˆ°ç”Ÿæˆå™¨ä¸­çš„è¿™ä¸€æ–¹æ³•çš„å¯¹è±¡,å¹¶é€šè¿‡[collections.abc.Coroutineè¿™ä¸€æŠ½è±¡åŸºç±»]è¡¨å¾çš„å¯¹è±¡;è¿™æ„å‘³ç€çªç„¶ä¹‹é—´æ‰€æœ‰å®ç°äº†åç¨‹æ¥å£çš„ç”Ÿæˆå™¨,å³ä¾¿å®ƒä»¬å¹¶ä¸æ˜¯è¦ä»¥åç¨‹æ–¹å¼åº”ç”¨,éƒ½ç¬¦åˆè¿™ä¸€å®šä¹‰;ä¸ºäº†ä¿®æ­£è¿™ä¸€ç‚¹,<strong>asyncio è¦æ±‚æ‰€æœ‰è¦ç”¨ä½œåç¨‹çš„ç”Ÿæˆå™¨å¿…é¡»ç”±asyncio.coroutineä¿®é¥°</strong></p>

<p>æœ‰äº†å¯¹åç¨‹æ˜ç¡®çš„å®šä¹‰ï¼ˆèƒ½å¤ŸåŒ¹é…ç”Ÿæˆå™¨æ‰€æä¾›çš„APIï¼‰,ä½ å¯ä»¥å¯¹ä»»ä½•asyncio.Futureå¯¹è±¡ä½¿ç”¨ yield from,ä»è€Œå°†å…¶ä¼ é€’ç»™äº‹ä»¶å¾ªç¯,æš‚åœåç¨‹çš„æ‰§è¡Œæ¥ç­‰å¾…æŸäº›äº‹æƒ…çš„å‘ç”Ÿï¼ˆ future å¯¹è±¡å¹¶ä¸é‡è¦,åªæ˜¯asyncioç»†èŠ‚çš„å®ç°ï¼‰;ä¸€æ—¦ future å¯¹è±¡è·å–äº†äº‹ä»¶å¾ªç¯,å®ƒä¼šä¸€ç›´åœ¨é‚£é‡Œç›‘å¬,ç›´åˆ°å®Œæˆå®ƒéœ€è¦åšçš„ä¸€åˆ‡;å½“ future å®Œæˆè‡ªå·±çš„ä»»åŠ¡ä¹‹å,äº‹ä»¶å¾ªç¯ä¼šå¯Ÿè§‰åˆ°,æš‚åœå¹¶ç­‰å¾…åœ¨é‚£é‡Œçš„åç¨‹ä¼šé€šè¿‡send()æ–¹æ³•è·å–futureå¯¹è±¡çš„è¿”å›å€¼å¹¶å¼€å§‹ç»§ç»­æ‰§è¡Œï¼›</p>

<p>ä»¥ä¸Šé¢çš„ä»£ç ä¸ºä¾‹;äº‹ä»¶å¾ªç¯å¯åŠ¨æ¯ä¸€ä¸ª countdown() åç¨‹,ä¸€ç›´æ‰§è¡Œåˆ°é‡è§å…¶ä¸­ä¸€ä¸ªåç¨‹çš„ yield from å’Œ asyncio.sleep() ;è¿™æ ·ä¼šè¿”å›ä¸€ä¸ª asyncio.Futureå¯¹è±¡å¹¶å°†å…¶ä¼ é€’ç»™äº‹ä»¶å¾ªç¯,åŒæ—¶æš‚åœè¿™ä¸€åç¨‹çš„æ‰§è¡Œ;äº‹ä»¶å¾ªç¯ä¼šç›‘æ§è¿™ä¸€futureå¯¹è±¡,ç›´åˆ°å€’è®¡æ—¶1ç§’é’Ÿä¹‹åï¼ˆåŒæ—¶ä¹Ÿä¼šæ£€æŸ¥å…¶å®ƒæ­£åœ¨ç›‘æ§çš„å¯¹è±¡,æ¯”å¦‚åƒå…¶å®ƒåç¨‹ï¼‰;1ç§’é’Ÿçš„æ—¶é—´ä¸€åˆ°,äº‹ä»¶å¾ªç¯ä¼šé€‰æ‹©åˆšåˆšä¼ é€’äº†futureå¯¹è±¡å¹¶æš‚åœäº†çš„ countdown() åç¨‹,å°†futureå¯¹è±¡çš„ç»“æœè¿”å›ç»™åç¨‹,ç„¶ååç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œ;è¿™ä¸€è¿‡ç¨‹ä¼šä¸€ç›´æŒç»­åˆ°æ‰€æœ‰çš„ countdown() åç¨‹æ‰§è¡Œå®Œæ¯•,äº‹ä»¶å¾ªç¯ä¹Ÿè¢«æ¸…ç©º;</p>

<h2>async/await</h2>
<blockquote class="blockquote-normal">
                <p>Python 3.5ä¸­ç”±<strong>yield from</strong> å’Œ <strong>asyncio</strong>çš„åŠŸèƒ½ç›¸ç»“åˆå¾—åˆ° <strong>await/async</strong>è¿™ä¸€æ–°è¯­æ³•;</p></blockquote>
<p>Python 3.5 æ·»åŠ äº†types.coroutine ä¿®é¥°å™¨,ä¹Ÿå¯ä»¥åƒ asyncio.coroutine ä¸€æ ·å°†ç”Ÿæˆå™¨æ ‡è®°ä¸ºåç¨‹;ä½ å¯ä»¥ç”¨ async def æ¥å®šä¹‰ä¸€ä¸ªåç¨‹å‡½æ•°,è™½ç„¶è¿™ä¸ªå‡½æ•°ä¸èƒ½åŒ…å«ä»»ä½•å½¢å¼çš„ yield è¯­å¥ï¼›åªæœ‰ return å’Œ await å¯ä»¥ä»åç¨‹ä¸­è¿”å›å€¼</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">py35_coro</span><span class="p">():</span>
    <span class="n">await</span> <span class="n">stuff</span><span class="p">()</span>
</pre></div>
</div>
<p>è™½ç„¶awaitçš„ä½¿ç”¨å’Œyield fromå¾ˆåƒ,ä½†awaitå¯ä»¥æ¥å—çš„å¯¹è±¡å´æ˜¯ä¸åŒçš„;await å½“ç„¶å¯ä»¥æ¥å—åç¨‹,å› ä¸ºåç¨‹çš„æ¦‚å¿µæ˜¯æ‰€æœ‰è¿™ä¸€åˆ‡çš„åŸºç¡€;ä½†æ˜¯å½“ä½ ä½¿ç”¨ await æ—¶,å…¶æ¥å—çš„å¯¹è±¡å¿…é¡»æ˜¯awaitable å¯¹è±¡ï¼šå¿…é¡»æ˜¯å®šä¹‰äº†<strong>await</strong>()æ–¹æ³•ä¸”è¿™ä¸€æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªä¸æ˜¯åç¨‹çš„è¿­ä»£å™¨;åç¨‹æœ¬èº«ä¹Ÿè¢«è®¤ä¸ºæ˜¯ awaitable å¯¹è±¡ï¼ˆè¿™ä¹Ÿæ˜¯collections.abc.Coroutine ç»§æ‰¿ collections.abc.Awaitableçš„åŸå› ï¼‰;è¿™ä¸€å®šä¹‰éµå¾ª Python å°†å¤§éƒ¨åˆ†è¯­æ³•ç»“æ„åœ¨åº•å±‚è½¬åŒ–æˆæ–¹æ³•è°ƒç”¨çš„ä¼ ç»Ÿ,å°±åƒ a + b å®é™…ä¸Šæ˜¯a.<strong>add</strong>(b) æˆ–è€… b.<strong>radd</strong>(a);</p>

<p>è®©æˆ‘ä»¬ç”¨ç®€å•çš„è¯æ¥æ€»ç»“ä¸€ä¸‹;ç”¨async defå¯ä»¥å®šä¹‰å¾—åˆ°åç¨‹;å®šä¹‰åç¨‹çš„å¦ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡types.coroutineä¿®é¥°å™¨ â€“ ä»æŠ€æœ¯å®ç°çš„è§’åº¦æ¥è¯´å°±æ˜¯æ·»åŠ äº† CO<em>ITERABLE</em>COROUTINEæ ‡è®° â€“ æˆ–è€…æ˜¯collections.abc.Coroutineçš„å­ç±»;ä½ åªèƒ½é€šè¿‡åŸºäºç”Ÿæˆå™¨çš„å®šä¹‰æ¥å®ç°åç¨‹çš„æš‚åœ;</p>

<p>awaitable å¯¹è±¡è¦ä¹ˆæ˜¯ä¸€ä¸ªåç¨‹è¦ä¹ˆæ˜¯ä¸€ä¸ªå®šä¹‰äº†<strong>await</strong>()æ–¹æ³•çš„å¯¹è±¡ â€“ ä¹Ÿå°±æ˜¯collections.abc.Awaitable â€“ ä¸”<strong>await</strong>()å¿…é¡»è¿”å›ä¸€ä¸ªä¸æ˜¯åç¨‹çš„è¿­ä»£å™¨;awaitè¡¨è¾¾å¼åŸºæœ¬ä¸Šä¸yield fromç›¸åŒä½†åªèƒ½æ¥å—awaitableå¯¹è±¡ï¼ˆæ™®é€šè¿­ä»£å™¨ä¸è¡Œï¼‰;asyncå®šä¹‰çš„å‡½æ•°è¦ä¹ˆåŒ…å«returnè¯­å¥ â€“ åŒ…æ‹¬æ‰€æœ‰Pythonå‡½æ•°ç¼ºçœçš„return None â€“ å’Œ/æˆ–è€… awaitè¡¨è¾¾å¼ï¼ˆyieldè¡¨è¾¾å¼ä¸è¡Œï¼‰;asyncå‡½æ•°çš„é™åˆ¶ç¡®ä¿ä½ ä¸ä¼šå°†åŸºäºç”Ÿæˆå™¨çš„åç¨‹ä¸æ™®é€šçš„ç”Ÿæˆå™¨æ··åˆä½¿ç”¨,å› ä¸ºå¯¹è¿™ä¸¤ç§ç”Ÿæˆå™¨çš„æœŸæœ›æ˜¯éå¸¸ä¸åŒçš„;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Represent how long a coroutine should before starting again.</span>

<span class="sd">    Comparison operators are implemented for use by heapq. Two-item</span>
<span class="sd">    tuples unfortunately don&#39;t work because when the datetime.datetime</span>
<span class="sd">    instances are equal, comparison falls to the coroutine and they don&#39;t</span>
<span class="sd">    implement comparison methods, triggering an exception.</span>

<span class="sd">    Think of this as being like asyncio.Task/curio.Task.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait_until</span><span class="p">,</span> <span class="n">coro</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coro</span> <span class="o">=</span> <span class="n">coro</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_until</span> <span class="o">=</span> <span class="n">wait_until</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_until</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">waiting_until</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_until</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">waiting_until</span>

<span class="k">class</span> <span class="nc">SleepingLoop</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;An event loop focused on delaying execution of coroutines.</span>

<span class="sd">    Think of this as being like asyncio.BaseEventLoop/curio.Kernel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">coros</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="n">coros</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Start all the coroutines.</span>
        <span class="k">for</span> <span class="n">coro</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
            <span class="n">wait_for</span> <span class="o">=</span> <span class="n">coro</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span><span class="p">,</span> <span class="n">Task</span><span class="p">(</span><span class="n">wait_for</span><span class="p">,</span> <span class="n">coro</span><span class="p">))</span>
        <span class="c1"># Keep running until there is no more work to do.</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="c1"># Get the coroutine with the soonest resumption time.</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">task</span><span class="o">.</span><span class="n">waiting_until</span><span class="p">:</span>
                <span class="c1"># We&#39;re ahead of schedule; wait until it&#39;s time to resume.</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">waiting_until</span> <span class="o">-</span> <span class="n">now</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># It&#39;s time to resume the coroutine.</span>
                <span class="n">wait_until</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">coro</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_waiting</span><span class="p">,</span> <span class="n">Task</span><span class="p">(</span><span class="n">wait_until</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">coro</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="c1"># The coroutine is done.</span>
                <span class="k">pass</span>

<span class="nd">@types.coroutine</span>
<span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pause a coroutine for the specified number of seconds.</span>

<span class="sd">    Think of this as being like asyncio.sleep()/curio.sleep().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">wait_until</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
    <span class="c1"># Make all coroutines on the call stack pause; the need to use `yield`</span>
    <span class="c1"># necessitates this be generator-based and not an async-based coroutine.</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">wait_until</span>
    <span class="c1"># Resume the execution stack, sending back how long we actually waited.</span>
    <span class="k">return</span> <span class="n">actual</span> <span class="o">-</span> <span class="n">now</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Countdown a launch for `length` seconds, waiting `delay` seconds.</span>

<span class="sd">    This is what a user would typically write.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;waiting&#39;</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="s1">&#39;seconds before starting countdown&#39;</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;starting after waiting&#39;</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">length</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;T-minus&#39;</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
        <span class="n">waited</span> <span class="o">=</span> <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;lift-off!&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Start the event loop, counting down 3 separate launches.</span>

<span class="sd">    This is what a user would typically write.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">SleepingLoop</span><span class="p">(</span><span class="n">countdown</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">countdown</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                        <span class="n">countdown</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Total elapsed time is&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<h2>å‚è€ƒèµ„æ–™</h2>

<p>-https://segmentfault.com/a/1190000002900850</p>

    </div>
    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic green button">æ‰“èµ <i class="red heart icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">MORE WORDS</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer code">
            <span>Â© 1994 - 2018 willdx</span><b>@</b><a class="code" href="https://github.com/willdx/willdx.github.io">blog.willdx.me</a>
            <br/>
            <span class="notprint">
                <span id="busuanzi_container_site_pv">
                    <i class="eye icon"></i><span id="busuanzi_value_site_pv" class="orange text"></span> pv
                </span>
                <b> | </b>
                <span id="busuanzi_container_site_uv">
                    <i class="user icon"></i><span id="busuanzi_value_site_uv" class="orange text"></span> uv
                </span>
                <br/>
            </span>
            <span>Power by <i class="github alternate icon"></i><a href="https://github.com/willdx/willdx.github.io">Github Page</a></span>
            <br/>
            <i class="green superpowers icon"></i>
        </div>
    </body>
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="/assets/js/web.js"></script>
    <script>
        // ç»Ÿè®¡ä»£ç 
        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68394485-1', 'auto');
        ga('send', 'pageview');

        var wrappers = ["cats-wrapper", "donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper"]

        window.onload = function () {
            useWechat();
        }
    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: 'de35601f0076c240632f',
        clientSecret: '903d34bc340117aaeadda4cb5c3bfe09a95c76db\n',
        repo: 'willdx.github.io',
        owner: 'willdx',
        admin: ['willdx'],
        id: 'pythoné­”æ³•æ–¹æ³•ä¸“é¢˜02-python3-5åç¨‹åŸç†',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: [''],
        pagerDirection: "last",
    })
      
    gitalk.render('comments')
    </script>


</html>