<html>
    <head>
        <meta charset="utf-8">
        
    
        <title> Elasticsearch权威指南-读书笔记 </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">


        <style type="text/css"> 
        </style>
    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: #fff;">主题选择</span></h3>
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr class="sk-mo" onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">墨</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-green" onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">绿</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-default" onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">青</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr class="sk-orange" onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">橘</td>
                                <td width="50%;"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">波妞</div>
                                <div class="time">2017年2月21号</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">三三</div>
                                <div class="time">2017年4月10号</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        微信
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        支付宝
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:1426409836@qq.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/willdx">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>





            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
              <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="linkify icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    🐱
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="heart icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <h2 class="name">Will Dx</h2>

                <span class="sign">人世一身霜雪, 归来仍是少年.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        主页
                    </a>
                    <a href="/tweet.html" class="item">
                        推特
                    </a>
                    <a href="/about.html" class="item">
                        关于我
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        联系
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1>Elasticsearch权威指南-读书笔记</h1>
        <h4>Posted April 07, 2017</h4>
        <h1>0.署名出处</h1>

<p><strong>本文章仅供个人学习使用, 主要是自己的一份读书笔记, 最优的选择是阅读官方文档, 链接如下:</strong></p>

<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_using_code_examples.html">署名出处</a></p>

<h1>1.前言</h1>

<p>世界已然被数据淹没, 我们将大量的数据存储在结构化的数据库里,或者noSQL中. 当然,应用能够正常运行, 但是当我们需要去分析这些数据来做一些决策的时候就不知所措了...</p>

<p>所以此时, 省时省力省钱的方法是对接第三方平台, 比如说友盟</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14956974653485.jpg"></p>
                    <p class="img-title"><span class="symbol">#</span>友盟产品图解</p></p>

<p>等....</p>

<p>但是毕竟不能帮你做所有的事情, 除非你把数据都提供给他!</p>

<p>Elasticsearch 是一个分布式、可扩展、实时的搜索与数据分析引擎。 它能从项目一开始就赋予你的数据以搜索、分析和探索的能力; <code>全文搜索</code> + <code>结构化数据实时统计</code>相结合, 能解决你大部分的分析运营需求;</p>

<p>当然, Elasticsearch 不仅仅只是<code>全文搜索</code>, 它还支持<code>结构化搜索</code>、<code>数据分析</code>、<code>复杂的语言处理</code>、<code>地理位置和对象间关联关系</code>等, 甚至我们可以<code>数据建模</code>来充分利用 Elasticsearch 的水平伸缩性;</p>

<p>我们常用 ELK stack 来做日志分析(当然, 我们公司也在用), 所以我在想是否能更深入一些, 做一些业务分析(主要是用户行为分析), 来满足一些运营提供的需求(人生苦短, 长痛不如短痛!),
那么, JUST Do it!</p>

<h1>2.Elasticsearch导航</h1>

<p>1.<code>你知道的, 为了搜索</code>章节 到 <code>分片内部原理</code></p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>主要介绍Elastic的数据输入输出, 如何处理你的文档数据, 如何进行基本的搜索操作, 如何管理你的索引;
附加章节:(理论)
集群内的原理,分布式文档存储,执行分布式检索,分片内部原理</pre></div></div>

<ol>
<li><p><code>结构化搜索</code> 到 <code>控制相关度</code></p>

<p>深入搜索, 如何索引和查询, 如何利用一些高级特性(例如: <code>邻近词</code>[word proximity] 和 <code>部分匹配</code>[partial matching]);
了解相关度评分是如何工作的以及如何控制它来确保第一页总是返回最佳的搜索结果;</p></li>
<li><p><code>开始处理各种语言</code> 到 <code>拼写错误</code></p>

<p>解决如何有效使用<code>分析器</code>和<code>查询器</code>来处理语言的头痛问题. 例如, 排序,词干提取,停用词,同义词,模糊匹配.</p></li>
<li><p><code>高阶概念</code> 到 <code>Doc Values and Fielddata</code> </p>

<p>讨论<code>聚合</code>(aggregations)和<code>分析</code>, 对你的数据进行<code>摘要化</code>和<code>分组</code>来呈现整体趋势</p></li>
<li><p><code>地理坐标点</code> 到 <code>地理形状</code> </p>

<p>介绍 Elasticsearch 支持的两种地理位置检索方式：<code>经纬坐标点</code>和<code>复杂的地理形状</code>（geo-shapes）</p></li>
<li><p><code>关联关系处理</code> 到 <code>扩容设计</code> </p>

<p>如何为你的<code>数据建模</code>来高效使用 Elasticsearch。在搜索引擎里表达实体间的关系可能不是那么容易，因为它不是用来设计做这个的。这些章节还会阐述如何<code>设计索引来匹配你系统中的数据流</code>。</p></li>
<li><p><code>监控</code> 到 <code>部署后</code> </p>

<p>讨论生产环境上线的重要配置、监控点以及如何诊断以避免出现问题</p></li>
</ol>

<h1>3. 在线资源</h1>

<p><a href="https://www.elastic.co/guide/">Elasticsearch Guide</a></p>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch 参考手册</a></p>

<p><a href="https://discuss.elastic.co/c/elasticsearch/">英文社区</a>
<a href="http://elasticsearch.cn/">中文社区</a></p>

<h1>4.基础入门</h1>

<h2>4.1 你知道的, 为了搜索…</h2>

<p>Elasticsearch 是一个开源的搜索引擎，建立在一个全文搜索引擎库 <code>Apache Lucene™</code>基础之上。 <code>Lucene</code> 可以说是当下最先进、高性能、全功能的搜索引擎库--无论是开源还是私有.</p>

<p>Elasticsearch 使用 Java 编写, 内部使用 Lucene 做索引与搜索, 提供一套简单一致的 RESTful API 去隐藏 Lucene 的复杂性, 最终提供简单,易用,可扩展,功能强大的实时搜索引擎;</p>

<p>开源协议: <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache 2 license</a>
源码地址: <a href="https://github.com/elastic/elasticsearch">github.com/elastic/elasticsearch</a>
贡献者社区: <a href="https://github.com/elastic/elasticsearch/blob/master/CONTRIBUTING.md">Contributing to Elasticsearch</a>
讨论组: <a href="https://discuss.elastic.co/">discuss.elastic.co</a></p>

<h2>4.2 安装并运行Elasticsearch</h2>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/_installation.html">官方安装文档部分</a></p>

<p><strong>有几点需要注意:</strong></p>

<p>1.Elasticsearch依赖较新的java版本, 最好的方式是从 www.java.com 获得官方提供的最新版本的 Java</p>

<p>2.启动</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">elasticsearch</span><span class="o">-&lt;</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">elasticsearch</span> <span class="o">-</span><span class="n">d</span>
<span class="c1"># -d 表示守护进程运行</span>
</pre></div>
</div>
<p>3.测试 Elasticsearch 是否启动成功</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="s1">&#39;http://localhost:9200/?pretty&#39;</span>

<span class="p">{</span>
  <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;Tom Foster&quot;</span><span class="p">,</span>
  <span class="s2">&quot;cluster_name&quot;</span> <span class="p">:</span> <span class="s2">&quot;elasticsearch&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;number&quot;</span> <span class="p">:</span> <span class="s2">&quot;2.1.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_hash&quot;</span> <span class="p">:</span> <span class="s2">&quot;72cd1f1a3eee09505e036106146dc1949dc5dc87&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_timestamp&quot;</span> <span class="p">:</span> <span class="s2">&quot;2015-11-18T22:40:03Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;build_snapshot&quot;</span> <span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;lucene_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;5.3.1&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;tagline&quot;</span> <span class="p">:</span> <span class="s2">&quot;You Know, for Search&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>4.3 和Elasticsearch交互</h2>

<h3>4.3.1 客户端类型</h3>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">Elasticsearch客户端</a></p>

<p>节点客户端(Node client):</p>
<blockquote class="blockquote-normal">
                <p>节点客户端作为一个非数据节点加入到本地集群中。换句话说，它本身不保存任何数据，但是它知道数据在集群中的哪个节点中，并且可以把请求转发到正确的节点。</p></blockquote>
<p>传输客户端(Transport client):</p>
<blockquote class="blockquote-normal">
                <p>轻量级的传输客户端可以将请求发送到远程集群。它本身不加入集群，但是它可以将请求转发到集群中的一个节点上。</p></blockquote>
<p><strong>注意: 集群中的节点通过端口 9300 彼此通信。如果这个端口没有打开，节点将无法形成一个集群</strong></p>

<h3>4.3.2 RESTFul API</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span><span class="o">&lt;</span><span class="n">VERB</span><span class="o">&gt;</span> <span class="s1">&#39;&lt;PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;&#39;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;&lt;BODY&gt;&#39;</span>

<span class="err">计算集群中文档的数量</span><span class="p">:</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">XGET</span> <span class="s1">&#39;http://localhost:9200/_count?pretty&#39;</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match_all&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div><div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>VERB</td>
<td>适当的 HTTP 方法 或 谓词 : GET<code>、</code>POST<code>、</code>PUT<code>、</code>HEAD 或者 <code>DELETE</code></td>
</tr>
<tr>
<td>PROTOCOL</td>
<td>http 或者 https<code>（如果你在 Elasticsearch 前面有一个</code>https 代理）</td>
</tr>
<tr>
<td>HOST</td>
<td>Elasticsearch 集群中任意节点的主机名，或者用 localhost 代表本地机器上的节点。</td>
</tr>
<tr>
<td>PORT</td>
<td>运行 Elasticsearch HTTP 服务的端口号，默认是 9200</td>
</tr>
<tr>
<td>PATH</td>
<td>API 的终端路径（例如 <em>count 将返回集群中文档数量）。Path 可能包含多个组件，例如：</em>cluster/stats 和 _nodes/stats/jvm</td>
</tr>
<tr>
<td>QUERY_STRING</td>
<td>任意可选的查询字符串参数 (例如 ?pretty 将格式化地输出 JSON 返回值，使其更容易阅读)</td>
</tr>
<tr>
<td>BODY</td>
<td>一个 JSON 格式的请求体 (如果请求需要的话)</td>
</tr>
</tbody>
</table></div>
<h3>4.3.3 面向文档</h3>

<p>假设有一个包含了其他对象或者数组的很复杂的对象(非简单key-value), 如果你想这个对象存储在关系型数据库中. 那意味着你要把这个对象进行拆分, 一个字段&gt;对应一列, 以适应表结构; 当你存储到数据库中之后, 你又不得不用各种关联重新把对象构造到一起;  </p>

<p>Elasticsearch 是<code>面向文档</code>的，意味着它存储整个对象或文档_。Elasticsearch 不仅存储文档，而且 _索引 每个文档的内容使之可以被检索。在 Elasticsearch 中，你 对文档进行索引、检索、排序和过滤--而不是对行列数据。这是一种完全不同的思考数据的方式，也是 Elasticsearch 能支持复杂全文检索的原因。</p>

<p>Elasticsearch 使用<code>JavaScript Object Notation</code> 或者 <code>JSON</code> 作为文档的序列化格式; 建议把对象格式化为JSON之后导入Elassearch;</p>

<h3>4.3.4 索引雇员文档</h3>
<blockquote class="blockquote-normal">
                <p>我们受雇于 Megacorp 公司，作为 HR 部门新的 “热爱无人机” （<em><q>We love our drones!</q></em>）激励项目的一部分，我们的任务是为此创建一个雇员目录。该目录应当能培养雇员认同感及支持实时、高效、动态协作，因此有一些业务需求：</p></blockquote>
<p>需求:</p>

<ol>
<li>支持包含多值标签、数值、以及全文本的数据</li>
<li>检索任一雇员的完整信息</li>
<li>允许结构化搜索，比如查询 30 岁以上的员工</li>
<li>允许简单的全文搜索以及较复杂的短语搜索</li>
<li>支持在匹配文档内容中高亮显示搜索片段</li>
<li>支持基于数据创建和管理分析仪表盘</li>
</ol>

<p><strong>科普</strong></p>

<p>1.存储数据到Elasticsearch的行为叫做 <code>索引</code>
2.一个文档就是一个雇员对象
3.Elastic集群-多个索引
4.个索引包含多个类型
5.不同的类型存储着多个文档
6.每个文档有多个属性</p>

<p><a href="http://naotu.baidu.com/file/0eddc365cc56757c89729218ef3b1c43">Elastic文档存储图解</a></p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957089310479.jpg"></p>
</p>

<p><strong><code>索引</code>在Elastic语境中的多种含义</strong></p>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th>不同索引</th>
<th>描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>索引（名词)</td>
<td>一个 索引 类似于传统关系数据库中的一个 数据库 ，是一个存储关系型文档的地方。 索引 (index) 的复数词为 indices 或 indexes</td>
</tr>
<tr>
<td>索引（动词)</td>
<td>索引一个文档 就是存储一个文档到一个 索引 （名词）中以便它可以被检索和查询到。这非常类似于 SQL 语句中的 INSERT 关键词，除了文档已存在时新文档会替换旧文档情况之外</td>
</tr>
<tr>
<td>倒排索引</td>
<td>关系型数据库通过增加一个 索引 比如一个 B树（B-tree）索引 到指定的列上，以便提升数据检索速度。Elasticsearch 和 Lucene 使用了一个叫做 倒排索引 的结构来达到相同的目的</td>
</tr>
</tbody>
</table></div><blockquote class="blockquote-normal">
                <p>默认的，一个文档中的每一个属性都是 被索引 的（有一个倒排索引）和可搜索的。一个没有倒排索引的属性是不能被搜索到的。</p></blockquote>
<p><strong>添加文档</strong></p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957099211476.jpg"></p>
                    <p class="img-title"><span class="symbol">#</span>创建索引-添加类型-添加文档</p></p>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>

<tbody>
<tr>
<td>megacorp</td>
<td>索引名称</td>
</tr>
<tr>
<td>employee</td>
<td>类型名称</td>
</tr>
<tr>
<td>1</td>
<td>特定雇员的ID</td>
</tr>
</tbody>
</table></div>
<p><strong>再添加2个文档</strong></p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957101522414.jpg"></p>
</p>

<h3>4.3.5 检索雇员文档</h3>

<p>_source 属性，内容是 John Smith 雇员的原始 JSON 文档</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957103817869.jpg"></p>
</p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957106198874.jpg"></p>
</p>

<h3>4.3.6 轻量搜索</h3>

<p>GET操作根据ID直接获取到置顶的文档;
接下来试试, 简单的搜索功能!</p>

<p><strong>1. 搜索所有</strong></p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">megacorp</span><span class="o">/</span><span class="n">employee</span><span class="o">/</span><span class="n">_search</span>
<span class="c1"># 一个搜索默认返回十条结果</span>
<span class="c1"># 返回</span>
<span class="p">{</span>
  <span class="s2">&quot;took&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;timed_out&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;max_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;megacorp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;employee&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Jane&quot;</span><span class="p">,</span>
          <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
          <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
          <span class="s2">&quot;about&quot;</span><span class="p">:</span> <span class="s2">&quot;I like to collect rock albums&quot;</span><span class="p">,</span>
          <span class="s2">&quot;interests&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;music&quot;</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;megacorp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;employee&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_score&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
          <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
          <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
          <span class="s2">&quot;about&quot;</span><span class="p">:</span> <span class="s2">&quot;I love to go rock climbing&quot;</span><span class="p">,</span>
          <span class="s2">&quot;interests&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;sports&quot;</span><span class="p">,</span>
            <span class="s2">&quot;music&quot;</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>1. 带条件的搜索</strong></p>
<blockquote class="blockquote-normal">
                <p>Query-string 搜索通过命令非常方便地进行临时性的搜索, 但是, 它有其局限性</p></blockquote>
<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/search-lite.html">轻量搜索</a></p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">megacorp</span><span class="o">/</span><span class="n">employee</span><span class="o">/</span><span class="n">_search</span><span class="err">?</span><span class="n">q</span><span class="o">=</span><span class="n">last_name</span><span class="p">:</span><span class="n">Smith</span>
</pre></div>
</div>
<h3>4.3.7 使用DSL查询表达式搜索</h3>

<p><strong>领域特定语言(DSL)</strong></p>

<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957137565178.jpg"></p>
</p>
<blockquote class="blockquote-normal">
                <p>返回结果与之前的查询一样，但还是可以看到有一些变化。其中之一是，不再使用 query-string 参数，而是一个请求体替代。这个请求使用 JSON 构造，并使用了一个 match 查询（属于查询类型之一，后续将会了解）</p></blockquote>
<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957137703234.jpg"></p>
</p>

<h3>4.3.8 更复杂的搜索</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">**</span><span class="err">多个条件</span><span class="o">**</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">megacorp</span><span class="o">/</span><span class="n">employee</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;must&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;match&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;last_name&quot;</span> <span class="p">:</span> <span class="s2">&quot;smith&quot;</span> 
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;range&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;age&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;gt&quot;</span> <span class="p">:</span> <span class="mi">30</span> <span class="p">}</span> 
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>4.3.9 全文搜索-传统数据库很难搞定</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">megacorp</span><span class="o">/</span><span class="n">employee</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;about&quot;</span> <span class="p">:</span> <span class="s2">&quot;rock climbing&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h4>相关性得分</h4>
<blockquote class="blockquote-normal">
                <p>Elasticsearch 默认按照相关性得分排序，即每个文档跟查询的匹配程度, 匹配程度越高的在前面</p></blockquote>
<h3>4.3.10 短语搜索</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="c1"># match_phrase: 全文搜索匹配短语的结果</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">megacorp</span><span class="o">/</span><span class="n">employee</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match_phrase&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;about&quot;</span> <span class="p">:</span> <span class="s2">&quot;rock climbing&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>4.3.11 高亮搜索</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">megacorp</span><span class="o">/</span><span class="n">employee</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match_phrase&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;about&quot;</span> <span class="p">:</span> <span class="s2">&quot;rock climbing&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;highlight&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;fields&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;about&quot;</span> <span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="err">返回</span><span class="p">:</span>
<span class="p">{</span>
  <span class="s2">&quot;took&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
  <span class="s2">&quot;timed_out&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;max_score&quot;</span><span class="p">:</span> <span class="mf">0.53484553</span><span class="p">,</span>
    <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="s2">&quot;megacorp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_type&quot;</span><span class="p">:</span> <span class="s2">&quot;employee&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_score&quot;</span><span class="p">:</span> <span class="mf">0.53484553</span><span class="p">,</span>
        <span class="s2">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
          <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>
          <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
          <span class="s2">&quot;about&quot;</span><span class="p">:</span> <span class="s2">&quot;I love to go rock climbing&quot;</span><span class="p">,</span>
          <span class="s2">&quot;interests&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;sports&quot;</span><span class="p">,</span>
            <span class="s2">&quot;music&quot;</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="s2">&quot;highlight&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;about&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;I love to go &lt;em&gt;rock&lt;/em&gt; &lt;em&gt;climbing&lt;/em&gt;&quot;</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1"># 其中highlight.about部分是高亮匹配的内容</span>
</pre></div>
</div>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/search-request-highlighting.html">更多关于高亮片段</a></p>

<h3>4.3.12 聚合分析</h3>
<blockquote class="blockquote-normal">
                <p>Elasticsearch 有一个功能叫聚合（aggregations），允许我们基于数据生成一些精细的分析结果。聚合与 SQL 中的 GROUP BY 类似但更强大</p></blockquote>
<h4>挖掘出雇员中最受欢迎的兴趣爱好</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">megacorp</span><span class="o">/</span><span class="n">employee</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
  <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;all_interests&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;interests&quot;</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957232666586.jpg"></p>
</p>
<blockquote class="blockquote-normal">
                <p>illegal<em>argument</em>exception报错解决</p></blockquote>
<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957229248531.jpg"></p>
                    <p class="img-title"><span class="symbol">#</span>illegal_argument_exception报错解决</p></p>

<h4>普通查询+聚合=组合查询</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">megacorp</span><span class="o">/</span><span class="n">employee</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;smith&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;all_interests&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;interests&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h4>分级汇总-特定兴趣爱好员工的平均年龄</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">megacorp</span><span class="o">/</span><span class="n">employee</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;all_interests&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;terms&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;interests&quot;</span> <span class="p">},</span>
            <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;avg_age&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;avg&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;age&quot;</span> <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># 返回:</span>
<span class="p">{</span>
  <span class="s2">&quot;took&quot;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
  <span class="s2">&quot;timed_out&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="p">},</span>
  <span class="s2">&quot;aggregations&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;all_interests&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;doc_count_error_upper_bound&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;sum_other_doc_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;buckets&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;music&quot;</span><span class="p">,</span>
          <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="s2">&quot;avg_age&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">28.5</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;sports&quot;</span><span class="p">,</span>
          <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="s2">&quot;avg_age&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">25</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h2>4.4 教程结语</h2>

<p>读完基础入门感觉ELK简直逆天, 后续还有更多高级功能以满足不同场景的数据分析需求, 例如:suggestions、geolocation、percolation、fuzzy 与 partial matching 等特性</p>

<p>另外,如何组合你的数据(难道这就是<code>数据建模</code>?)达到最佳搜索效果, 是个比较复杂的事情, 需要既了解ELK的特性, 还需要了解业务, 并且大量测试才能达到想要的效果; </p>

<p>革命尚未成功, 同志仍需努力!</p>

<h2>4.5 分布式特性</h2>
<blockquote class="blockquote-normal">
                <p>ELK天生就是分布式的, 只需要满足3个条件:</p></blockquote>
<p>1.网络和端口连通性正常
2.配置同样的cluster.name 
3.设定单播地址,默认9300端口</p>

<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/important-configuration-changes.html">详情参见-Elasticsearch重要配置的修改</a></p>
<blockquote class="blockquote-normal">
                <p>Elasticsearch 尽可能地屏蔽了分布式系统的复杂性, 一些操作会在后台自动执行：</p></blockquote>
<ol>
<li>分配文档到不同的容器 或 分片 中，文档可以储存在一个或多个节点中</li>
<li>按集群节点来均衡分配这些分片，从而对索引和搜索过程进行负载均衡</li>
<li>复制每个分片以支持数据冗余，从而防止硬件故障导致的数据丢失</li>
<li>将集群中任一节点的请求路由到存有相关数据的节点</li>
<li>集群扩容时无缝整合新节点，重新分配分片以便从离群节点恢复</li>
</ol>
<blockquote class="blockquote-normal">
                <p>master收集到日志后，会把一部分数据碎片到salve上（随机的一部分数据), master和slave又都会各自做副本，并把副本放到对方机器上，这样就保证了数据不会丢失</p></blockquote>
<p><p class="hassubimage"><img src="http://iwillb.imdancer.com/14957259788781.jpg"></p>
</p>

<h1>5.深入搜索</h1>

<h2>5.1 结构化搜索</h2>

<p>搜索具有内在结构数据的过程, 叫做<code>结构化搜索</code>;例如: 比较数据或时间的范围 或 判断两个值的大小;</p>

<p>文本也可以是结构化的;</p>

<p>结构化查询得到的结果总是<q>True/False</q>, 不关心相关度评分;</p>

<h3>5.1.1 精确值查找</h3>

<p>精确值查找使用, 过滤器(filters); 过滤器不会执行相关度计算, 并且容易被缓存; </p>

<p>在 Elasticsearch 的查询表达式（query DSL）中，我们可以使用 term 查询来 实现 <code>精确值查找</code>;</p>

<h3>5.1.2 term查询数字</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">插入一些测试数据</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">XPOST</span> <span class="s1">&#39;localhost:9200/my_store/products/_bulk?pretty&#39;</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span><span class="s1">&#39;</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;productID&quot;</span> <span class="p">:</span> <span class="s2">&quot;XHDK-A-1293-#fJ3&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;productID&quot;</span> <span class="p">:</span> <span class="s2">&quot;KDKE-B-9947-#kL5&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;productID&quot;</span> <span class="p">:</span> <span class="s2">&quot;JODL-X-1937-#pV7&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">4</span> <span class="p">}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;productID&quot;</span> <span class="p">:</span> <span class="s2">&quot;QQPX-R-3956-#aD8&quot;</span> <span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">使用</span><span class="n">SQL</span>
<span class="n">SELECT</span> <span class="n">document</span>
<span class="n">FROM</span>   <span class="n">products</span>
<span class="n">WHERE</span>  <span class="n">price</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">使用查询表达式（</span><span class="n">query</span> <span class="n">DSL</span><span class="err">）的</span> <span class="sb">` term查询`</span>

<span class="n">GET</span> <span class="o">/</span><span class="n">my_store</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">_search</span>

<span class="p">{</span>
    <span class="s2">&quot;term&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">20</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>通常当查找一个精确值的时候，我们不希望对查询进行评分计算。只希望对文档进行包括或排除的计算，所以我们会使用 <code>constant_score查询</code>以<code>非评分模式</code>来执行 term 查询并以<code>1</code>作为统一评分;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">my_store</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="c1"># 我们用 constant_score 将 term 查询转化成为过滤器</span>
        <span class="s2">&quot;constant_score&quot;</span> <span class="p">:</span> <span class="p">{</span>  
            <span class="s2">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="c1"># term 精确查询</span>
                <span class="s2">&quot;term&quot;</span> <span class="p">:</span> <span class="p">{</span> 
                    <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">20</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>5.1.3 term 查询文本编辑</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">SQL</span>

<span class="n">SELECT</span> <span class="n">product</span>
<span class="n">FROM</span>   <span class="n">products</span>
<span class="n">WHERE</span>  <span class="n">productID</span> <span class="o">=</span> <span class="s2">&quot;XHDK-A-1293-#fJ3&quot;</span>

<span class="o">-</span> <span class="err">查询表达式（</span><span class="n">query</span> <span class="n">DSL</span><span class="p">)</span><span class="o">-</span> <span class="n">term</span><span class="err">查询</span>
<span class="o">-</span> <span class="err">注意</span><span class="p">:</span> <span class="n">term</span><span class="err">是包含的关系，并不是等于的意思</span>

<span class="n">GET</span> <span class="o">/</span><span class="n">my_store</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;constant_score&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;term&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;productID&quot;</span> <span class="p">:</span> <span class="s2">&quot;XHDK-A-1293-#fJ3&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">发现无法查询到预想的结果</span>

<span class="p">{</span>
  <span class="s2">&quot;took&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;timed_out&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
  <span class="s2">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;max_score&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>

    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">为什么呢？问题不在</span> <span class="n">term</span> <span class="err">查询，而在于索引数据的方式。</span> <span class="err">如果我们使用</span> <span class="n">analyze</span> <span class="n">API</span> <span class="p">(</span><span class="err">分析</span> <span class="n">API</span><span class="p">)</span><span class="err">，我们可以看到这里的</span> <span class="n">UPC</span> <span class="err">码被拆分成多个更小的</span> <span class="n">token</span><span class="p">:</span>

<span class="n">GET</span> <span class="o">/</span><span class="n">my_store</span><span class="o">/</span><span class="n">_analyze</span>
<span class="p">{</span>
  <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;productID&quot;</span><span class="p">,</span>
  <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;XHDK-A-1293-#fJ3&quot;</span>
<span class="p">}</span>

<span class="err">返回</span><span class="p">:</span>
<span class="p">{</span>
  <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;xhdk&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;1293&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;NUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;fj3&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_offset&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
      <span class="s2">&quot;end_offset&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;ALPHANUM&gt;&quot;</span><span class="p">,</span>
      <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="err">从结果中我们发现</span><span class="p">:</span>
<span class="mf">1.</span> <span class="n">Elasticsearch</span> <span class="err">用</span> <span class="mi">4</span> <span class="err">个不同的</span> <span class="n">token</span> <span class="err">而不是单个</span> <span class="n">token</span> <span class="err">来表示这个</span> <span class="n">UPC</span> 
<span class="mf">2.</span> <span class="err">所有字母都是小写的</span>
<span class="mf">3.</span> <span class="err">丢失了连字符和哈希符</span> <span class="c1"># </span>

<span class="o">-</span> <span class="err">所以当我们用</span> <span class="n">term</span> <span class="err">查询查找精确值</span> <span class="n">XHDK</span><span class="o">-</span><span class="n">A</span><span class="o">-</span><span class="mi">1293</span><span class="o">-</span><span class="c1">#fJ3 的时候，找不到任何文档，因为它并不在我们的倒排索引中，正如前面呈现出的分析结果，索引里有四个 token; </span>
<span class="o">-</span> <span class="err">我们对文本进行精确查询的时候</span><span class="p">,</span> <span class="err">需要告诉</span><span class="n">Elasticsearch</span><span class="err">该字段具有精确值</span><span class="p">,</span> <span class="err">要将其设置成</span> <span class="n">not_analyzed</span> <span class="err">无需分析的</span><span class="p">;</span>
<span class="o">-</span><span class="err">为了修正搜索结果，我们需要首先删除旧索引（因为它的映射不再正确）然后创建一个能正确映射的新的索引</span><span class="p">;</span>

<span class="o">&gt;</span> <span class="err">删除索引是必须的，因为我们不能更新已存在的映射</span>
<span class="n">DELETE</span> <span class="o">/</span><span class="n">my_store</span>
<span class="o">&gt;</span> <span class="err">在索引被删除后，我们可以创建新的索引并为其指定自定义映射</span>
<span class="n">PUT</span> <span class="o">/</span><span class="n">my_store</span> 
<span class="p">{</span>
    <span class="s2">&quot;mappings&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;products&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;productID&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                    <span class="c1"># 这里我们告诉 Elasticsearch ，我们不想对 productID 做任何分析</span>
                    <span class="s2">&quot;index&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span> 
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="o">-</span> <span class="err">再次写入数据</span><span class="p">,</span> <span class="err">就可以查询了</span><span class="p">;</span> <span class="n">not_analyzed</span> <span class="err">其实是关闭了这个字段的分词了</span><span class="p">;</span>

<span class="o">-</span> <span class="err">内部过滤器的操作</span>
<span class="err">在内部</span><span class="p">,</span> <span class="n">ElasticSearch</span><span class="err">会在运行非评分查询时执行多个操作</span><span class="p">:</span>
<span class="mf">1.</span> <span class="err">查找匹配文档</span>
    <span class="n">term</span> <span class="err">查询在倒排索引中查找</span> <span class="n">XHDK</span><span class="o">-</span><span class="n">A</span><span class="o">-</span><span class="mi">1293</span><span class="o">-</span><span class="c1">#fJ3 然后获取包含该 term 的所有文档。本例中，只有文档 1 满足我们要求</span>

<span class="mf">2.</span> <span class="err">创建位集合</span><span class="p">(</span><span class="n">bitset</span><span class="p">)</span>
    <span class="err">过滤器会创建一个</span> <span class="n">bitset</span> <span class="err">（一个包含</span> <span class="mi">0</span> <span class="err">和</span> <span class="mi">1</span> <span class="err">的数组），它描述了哪个文档会包含该</span> <span class="n">term</span> <span class="err">。匹配文档的标志位是</span> <span class="mi">1</span> <span class="err">。本例中，</span><span class="n">bitset</span> <span class="err">的值为</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="err">。在内部，它表示成一个</span> <span class="s2">&quot;roaring bitmap&quot;</span><span class="err">，可以同时对稀疏或密集的集合进行高效编码</span>

<span class="mf">3.</span> <span class="err">迭代位集合</span><span class="p">(</span><span class="n">bitset</span><span class="p">)</span>

    <span class="err">一旦为每个查询生成了</span> <span class="n">bitsets</span> <span class="err">，</span><span class="n">Elasticsearch</span> <span class="err">就会循环迭代</span> <span class="n">bitsets</span> <span class="err">从而找到满足所有过滤条件的匹配文档的集合。执行顺序是启发式的，但一般来说先迭代稀疏的</span> <span class="n">bitset</span> <span class="err">（因为它可以排除掉大量的文档）</span>
    
<span class="mf">4.</span> <span class="err">增量使用计数</span>

    <span class="n">Elasticsearch</span> <span class="err">能够缓存非评分查询从而获取更快的访问，但是它也会不太聪明地缓存一些使用极少的东西。非评分计算因为倒排索引已经足够快了，所以我们只想缓存那些我们</span> <span class="err">知道</span> <span class="err">在将来会被再次使用的查询，以避免资源的浪费</span>

    <span class="err">理论上非评分查询</span> <span class="err">先于</span> <span class="err">评分查询执行。非评分查询任务旨在降低那些将对评分查询计算带来更高成本的文档数量，从而达到快速搜索的目的。</span>
</pre></div>
</div>
<h3>5.1.4 组合过滤器</h3>

<p>怎样用 Elasticsearch 来表达下面的 SQL ？</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">product</span>
<span class="n">FROM</span>   <span class="n">products</span>
<span class="n">WHERE</span>  <span class="p">(</span><span class="n">price</span> <span class="o">=</span> <span class="mi">20</span> <span class="n">OR</span> <span class="n">productID</span> <span class="o">=</span> <span class="s2">&quot;XHDK-A-1293-#fJ3&quot;</span><span class="p">)</span>
  <span class="n">AND</span>  <span class="p">(</span><span class="n">price</span> <span class="o">!=</span> <span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
<h4>布尔过滤器</h4>

<p>一个 bool 过滤器由三部分组成：</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;must&quot;</span> <span class="p">:</span>     <span class="p">[],</span> <span class="c1"># 所有的语句都 必须（must） 匹配，与 AND 等价</span>
      <span class="s2">&quot;should&quot;</span> <span class="p">:</span>   <span class="p">[],</span> <span class="c1"># 所有的语句都 不能（must not） 匹配，与 NOT 等价</span>
      <span class="s2">&quot;must_not&quot;</span> <span class="p">:</span> <span class="p">[],</span> <span class="c1"># 至少有一个语句要匹配，与 OR 等价</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="nb">bool</span> <span class="err">过滤器的每个部分都是可选的（例如，我们可以只有一个</span> <span class="n">must</span> <span class="err">语句），而且每个部分内部可以只有一个或一组过滤器</span>
</pre></div>
</div>
<p>匹配上文提到的SQL查询例子:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">my_store</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="c1"># 需要一个 filtered 查询将所有的东西包起来</span>
      <span class="s2">&quot;filtered&quot;</span> <span class="p">:</span> <span class="p">{</span> 
         <span class="s2">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="c1"># should中的term查询条件是 or 的关系</span>
              <span class="s2">&quot;should&quot;</span> <span class="p">:</span> <span class="p">[</span>
                 <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">}},</span> 
                 <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;productID&quot;</span> <span class="p">:</span> <span class="s2">&quot;XHDK-A-1293-#fJ3&quot;</span><span class="p">}}</span> 
              <span class="p">],</span>
              <span class="c1"># must_not表示非的关系</span>
              <span class="s2">&quot;must_not&quot;</span> <span class="p">:</span> <span class="p">{</span>
                 <span class="s2">&quot;term&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">30</span><span class="p">}</span> 
              <span class="p">}</span>
           <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>布尔过滤器支持嵌套:</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>一个SQL例子:
SELECT document
FROM   products
WHERE  productID      = "KDKE-B-9947-#kL5"
  OR (     productID = "JODL-X-1937-#pV7"
       AND price     = 30 )
       
转换为bool过滤器:
GET /my_store/products/_search
{
   "query" : {
      "filtered" : {
         "filter" : {
            "bool" : {
              "should" : [
                { "term" : {"productID" : "KDKE-B-9947-#kL5"}}, 
                { "bool" : { 
                  "must" : [
                    { "term" : {"productID" : "JODL-X-1937-#pV7"}}, 
                    { "term" : {"price" : 30}} 
                  ]
                }}
              ]
           }
         }
      }
   }
}</pre></div></div>

<h3>5.1.5 查找多个精确值 terms</h3>

<p>与 term 查询一样，也需要将其置入 filter 语句的常量评分查询中使用:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">my_store</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;constant_score&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;terms&quot;</span> <span class="p">:</span> <span class="p">{</span> 
                    <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>5.1.6 term包含而不是相等</h3>
<blockquote class="blockquote-normal">
                <p>term 和 terms 是 包含（contains）操作，而非 等值（equals）判断</p></blockquote>
<p><p class="hassubimage"><img src="/media/14958744638432.jpg"></p>
</p>

<h4>精确相等(term+计数器)</h4>
<blockquote class="blockquote-normal">
                <p>添加标签数量限制, 例如, 匹配search字段,并且只匹配search字段</p></blockquote><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">假设现在有一条数据有一个标签</span><span class="p">,</span> <span class="err">标签数量为</span><span class="mi">1</span><span class="p">;</span> <span class="err">另一个有</span><span class="mi">2</span><span class="err">个标签</span><span class="p">,</span> <span class="err">标签数量为</span><span class="mi">2</span>
<span class="p">{</span> <span class="s2">&quot;tags&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">],</span> <span class="s2">&quot;tag_count&quot;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;tags&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="s2">&quot;open_source&quot;</span><span class="p">],</span> <span class="s2">&quot;tag_count&quot;</span> <span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>

<span class="o">-</span> <span class="n">DSL</span><span class="err">可以这么写</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;constant_score&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">{</span>
                 <span class="s2">&quot;bool&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;must&quot;</span> <span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;tags&quot;</span> <span class="p">:</span> <span class="s2">&quot;search&quot;</span> <span class="p">}</span> <span class="p">},</span> <span class="c1"># 精确匹配tags字段</span>
                        <span class="p">{</span> <span class="s2">&quot;term&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;tag_count&quot;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="c1"># 并且tag子弹的计数器为1</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>5.1.7 查找范围</h3>

<h4>数字范围</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">document</span>
<span class="n">FROM</span>   <span class="n">products</span>
<span class="n">WHERE</span>  <span class="n">price</span> <span class="n">BETWEEN</span> <span class="mi">20</span> <span class="n">AND</span> <span class="mi">40</span>
</pre></div>
</div>
<p>Elasticsearch 有 range 查询， 不出所料地，可以用它来查找处于某个范围内的文档：</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>"range" : {
    "price" : {
        "gte" : 20,
        "lte" : 40
    }
}</pre></div></div>

<ul>
<li>gt: &gt; 大于（greater than）</li>
<li>lt: &lt; 小于（less than）</li>
<li>gte: &gt;= 大于或等于（greater than or equal to）</li>
<li>lte: &lt;= 小于或等于（less than or equal to）</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">例子</span><span class="p">:</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">my_store</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;constant_score&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;range&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;gte&quot;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="s2">&quot;lt&quot;</span>  <span class="p">:</span> <span class="mi">40</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">如果想要范围无界（比方说</span> <span class="o">&gt;</span><span class="mi">20</span> <span class="err">），只须省略其中一边的限制：</span>
<span class="s2">&quot;range&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;gt&quot;</span> <span class="p">:</span> <span class="mi">20</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h4>日期范围</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">日期范围</span>
<span class="s2">&quot;range&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;timestamp&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;gt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-01-01 00:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-01-07 00:00:00&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="nb">range</span> <span class="err">查询支持对</span> <span class="err">日期计算（</span><span class="n">date</span> <span class="n">math</span><span class="err">）进行操作，比方说，如果我们想查找时间戳在过去一小时内的所有文档：</span>

<span class="o">-</span> <span class="err">相对时间</span>
<span class="s2">&quot;range&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;timestamp&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;gt&quot;</span> <span class="p">:</span> <span class="s2">&quot;now-1h&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">-</span> <span class="err">绝对时间</span>
<span class="s2">&quot;range&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;timestamp&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;gt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-01-01 00:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lt&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-01-01 00:00:00||+1M&quot;</span> 
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/mapping-date-format.html">时间格式参考文档</a></p>

<h4>字符串范围</h4>

<p>range 查询同样可以处理字符串字段， 字符串范围可采用 字典顺序（lexicographically） 或字母顺序（alphabetically）。例如，下面这些字符串是采用字典序（lexicographically）排序的;</p>

<p>在倒排索引中的词项就是采取字典顺序（lexicographically）排列的，这也是字符串范围可以使用这个顺序来确定的原因;</p>

<p>字符串计算比较缓慢;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">需求</span><span class="p">:</span> <span class="err">从</span> <span class="n">a</span> <span class="err">到</span> <span class="n">b</span><span class="err">（不包含</span><span class="n">b</span><span class="err">）的字符串</span>
<span class="s2">&quot;range&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;title&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;gte&quot;</span> <span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lt&quot;</span> <span class="p">:</span>  <span class="s2">&quot;b&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>5.1.8 处理Null值</h3>

<p>世界并不简单，数据往往会有缺失字段，或有显式的空值或空数组。为了应对这些状况，Elasticsearch 提供了一些工具来处理空或缺失值;</p>

<h4>存在查询(IS NOT NULL)</h4>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>- 用SQL表示
SELECT tags
FROM   posts
WHERE  tags IS NOT NULL

- 用DSL表示
GET /my_index/posts/_search
{
    "query" : {
        "constant_score" : {
            "filter" : {
                "exists" : { "field" : "tags" }
            }
        }
    }
}</pre></div></div>

<h4>缺失查询(IS NULL)</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">SQL</span>
<span class="n">SELECT</span> <span class="n">tags</span>
<span class="n">FROM</span>   <span class="n">posts</span>
<span class="n">WHERE</span>  <span class="n">tags</span> <span class="n">IS</span> <span class="n">NULL</span>

<span class="o">-</span> <span class="n">DSL</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">posts</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;constant_score&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;missing&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;tags&quot;</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>我们可以自定义 占位符（placeholder）</strong></p>

<h4>对象上的存在与缺失</h4>
<blockquote class="blockquote-normal">
                <p>exits / missing 条件也可以有mapping一样的工作方式; </p></blockquote>
<p>例如,需要判断一个用户的first name是否存在</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">文档</span>
 <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;first&quot;</span> <span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span>
      <span class="s2">&quot;last&quot;</span> <span class="p">:</span>  <span class="s2">&quot;Smith&quot;</span>
   <span class="p">}</span>
<span class="p">}</span>
<span class="o">-</span> <span class="err">可以使用</span><span class="n">name</span><span class="o">.</span><span class="n">first</span> <span class="err">或者</span> <span class="n">name</span><span class="o">.</span><span class="n">last</span> <span class="err">去查询</span><span class="p">;</span> 
<span class="p">{</span>
    <span class="s2">&quot;exists&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field.first&quot;</span> <span class="p">:</span> <span class="s2">&quot;name&quot;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="o">-</span> <span class="err">如果只是用</span><span class="n">name</span><span class="err">查询</span>
<span class="p">{</span>
    <span class="s2">&quot;exists&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;name&quot;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="o">--</span> <span class="err">实际执行的是：</span>
<span class="p">{</span>
    <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;name.first&quot;</span> <span class="p">}},</span>
            <span class="p">{</span> <span class="s2">&quot;exists&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;name.last&quot;</span> <span class="p">}}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">如果</span> <span class="n">first</span> <span class="err">和</span> <span class="n">last</span> <span class="err">都是空，那么</span> <span class="n">name</span> <span class="err">这个命名空间才会被认为不存在</span>
</pre></div>
</div>
<h3>5.1.9 关于缓存</h3>

<p>在 Elasticsearch 的较早版本中，默认的行为是缓存一切可以缓存的对象; 有一些缓存并不是特别合理, 比如我有3百万的用户, 每个具体用户ID出现的概率都很小, 为所有用户ID做bitset缓存对性能有较大的影响;</p>

<p>为了解决问题，Elasticsearch 会基于使用频次自动缓存查询。如果一个非评分查询在最近的 256 词查询中被使用过（次数取决于查询类型），那么这个查询就会作为缓存的候选。但是，并不是所有的片段都能保证缓存 bitset 。只有那些文档数量超过 10,000 （或超过总文档数量的 3% )才会缓存 bitset 。因为小的片段可以很快的进行搜索和合并，这里缓存的意义不大;</p>

<p>一旦缓存了，非评分计算的 bitset 会一直驻留在缓存中直到它被剔除。剔除规则是基于 LRU 的：一旦缓存满了，最近最少使用的过滤器会被剔除;</p>

<h2>5.2 全文搜索</h2>

<p>相关性（Relevance）:</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>它是评价查询与其结果间的相关程度，并根据这种相关程度对结果排名的一种能力，这种计算方式可以是 TF/IDF 方法（参见 相关性的介绍）、地理位置邻近、模糊相似，或其他的某些算法;</pre></div></div>

<p>分析（Analysis）:</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>它是将文本块转换为有区别的、规范化的 token 的一个过程，（参见 分析的介绍） 目的是为了（a）创建倒排索引以及（b）查询倒排索引;</pre></div></div>

<h3>5.2.1 全文搜索</h3>

<ul>
<li>数据</li>
</ul>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>DELETE /my_index 

PUT /my_index
{ "settings": { "number_of_shards": 1 }} 

POST /my_index/my_type/_bulk
{ "index": { "_id": 1 }}
{ "title": "The quick brown fox" }
{ "index": { "_id": 2 }}
{ "title": "The quick brown fox jumps over the lazy dog" }
{ "index": { "_id": 3 }}
{ "title": "The quick brown fox jumps over the quick dog" }
{ "index": { "_id": 4 }}
{ "title": "Brown fox brown dog" }</pre></div></div>

<ul>
<li>单个词查询</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;QUICK!&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">查询的步骤是：检查字段类型</span><span class="o">-</span><span class="err">分析查询字符串</span><span class="o">-</span><span class="err">查找匹配文档</span><span class="o">-</span><span class="err">为每个文档评分</span>
</pre></div>
</div>
<ul>
<li>多词查询</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;BROWN DOG!&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">-</span> <span class="err">任何文档只要</span> <span class="n">title</span> <span class="err">字段里包含</span> <span class="err">指定词项中的至少一个词</span> <span class="err">就能匹配，被匹配的词项越多，文档就越相关</span><span class="p">;</span> <span class="err">这是一种</span> <span class="sb">`or 搜索`</span><span class="p">,</span> <span class="err">为了提高精度</span><span class="p">,</span> <span class="err">我们可以更改默认的多词匹配模式为</span><span class="sb">`and`</span><span class="p">;</span>  
<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>      
                <span class="s2">&quot;query&quot;</span><span class="p">:</span>    <span class="s2">&quot;BROWN DOG!&quot;</span><span class="p">,</span>
                <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;and&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">还有一种需求是</span><span class="p">:</span> <span class="err">多个匹配项只匹配其中一部分</span>
    <span class="n">match</span> <span class="err">查询支持</span> <span class="sb">`minimum_should_match 最小匹配参数`</span><span class="err">，</span> <span class="err">这让我们可以指定必须匹配的词项数用来表示一个文档是否相关。我们可以将其设置为某个具体数字，更常用的做法是将其设置为一个百分数，因为我们无法控制用户搜索时输入的单词数量</span><span class="p">;</span>
    
<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span>                <span class="s2">&quot;quick brown dog&quot;</span><span class="p">,</span>
        <span class="s2">&quot;minimum_should_match&quot;</span><span class="p">:</span> <span class="s2">&quot;75%&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="err">注意</span><span class="p">:</span> <span class="err">这个百分比也不一定完全是你设置的这个数字</span><span class="p">,</span> <span class="n">minimum_should_match</span> <span class="err">会做合适的事情</span><span class="p">,</span><span class="err">上例子中</span><span class="p">,</span> <span class="err">三词项的示例中，</span> <span class="mi">75</span><span class="o">%</span> <span class="err">会自动被截断成</span> <span class="mf">66.6</span><span class="o">%</span> <span class="err">，即三个里面两个词</span><span class="p">;</span>

<span class="n">match</span> <span class="err">的多词查询其实是</span><span class="p">,</span> <span class="err">先执行</span> <span class="n">term</span> <span class="err">查询，然后将查询的结果合并作为最终结果输出。它将两个</span> <span class="n">term</span> <span class="err">查询包入一个</span> <span class="nb">bool</span> <span class="err">查询中</span><span class="p">;</span>
</pre></div>
</div>
<ul>
<li>组合查询</li>
</ul>

<p>search也支持bool查询, 和<code>组合过滤器</code>类型, 但有区别: </p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>过滤器做二元判断：文档是否应该出现在结果中？但查询更精妙，它除了决定一个文档是否应该被包括在结果中，还会计算文档的 相关程度</pre></div></div>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;must&quot;</span><span class="p">:</span>     <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;quick&quot;</span> <span class="p">}},</span>
      <span class="s2">&quot;must_not&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;lazy&quot;</span>  <span class="p">}},</span>
      <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>  <span class="c1"># 用于计算相关性</span>
                  <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span> <span class="p">}},</span>
                  <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;dog&quot;</span>   <span class="p">}}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

 <span class="o">-</span> <span class="err">评分计算</span>

<span class="n">_</span><span class="err">注释</span><span class="p">:</span> <span class="n">master</span> <span class="ow">not</span> <span class="err">语句不会影响评分</span><span class="n">_</span>

 <span class="mf">1.</span><span class="n">bool</span> <span class="err">查询为每个文档计算相关度评分</span><span class="n">_sore</span>
 <span class="mf">2.</span><span class="err">再将所有匹配的</span><span class="n">must</span><span class="err">和</span><span class="n">should</span><span class="err">语句的分数</span> <span class="n">_score</span> <span class="err">求和</span>
 <span class="mf">3.</span><span class="err">最后除以</span><span class="n">must</span><span class="err">和</span><span class="n">should</span><span class="err">语句的总数</span><span class="p">,</span> <span class="err">得到的记录按评分排序</span>
 
 <span class="o">-</span> <span class="err">控制精度</span>
 
 <span class="err">所有</span> <span class="n">must</span> <span class="err">语句必须匹配，所有</span> <span class="n">must_not</span> <span class="err">语句都必须不匹配，但有多少</span> <span class="n">should</span> <span class="err">语句应该匹配呢？</span> <span class="err">默认情况下，没有</span> <span class="n">should</span> <span class="err">语句是必须匹配的，只有一个例外：那就是当没有</span> <span class="n">must</span> <span class="err">语句的时候，至少有一个</span> <span class="n">should</span> <span class="err">语句必须匹配</span><span class="p">;</span>
 
<span class="err">我们可以通过</span> <span class="n">minimum_should_match</span> <span class="err">参数控制需要匹配的</span> <span class="n">should</span> <span class="err">语句的数量，</span> <span class="err">它既可以是一个绝对的数字，又可以是个百分比</span><span class="p">:</span>

<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span> <span class="p">}},</span>
        <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;fox&quot;</span>   <span class="p">}},</span>
        <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;dog&quot;</span>   <span class="p">}}</span>
      <span class="p">],</span>
      <span class="s2">&quot;minimum_should_match&quot;</span><span class="p">:</span> <span class="mi">2</span> 
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>如何使用布尔匹配</li>
</ul>
<blockquote class="blockquote-normal">
                <p>多词 match 查询只是简单地将生成的 term 查询包裹 在一个 bool 查询中</p></blockquote><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;brown fox&quot;</span><span class="p">}</span>
<span class="p">}</span>
<span class="err">等价于</span><span class="p">:</span>
<span class="p">{</span>
  <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span> <span class="p">}},</span>
      <span class="p">{</span> <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;fox&quot;</span>   <span class="p">}}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span>    <span class="s2">&quot;brown fox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;and&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">等价于</span><span class="p">:</span>
<span class="p">{</span>
  <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;must&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span> <span class="p">}},</span>
      <span class="p">{</span> <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;fox&quot;</span>   <span class="p">}}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;quick brown fox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minimum_should_match&quot;</span><span class="p">:</span> <span class="s2">&quot;75%&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">等价于</span><span class="p">:</span>
<span class="p">{</span>
  <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;brown&quot;</span> <span class="p">}},</span>
      <span class="p">{</span> <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;fox&quot;</span>   <span class="p">}},</span>
      <span class="p">{</span> <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;quick&quot;</span> <span class="p">}}</span>
    <span class="p">],</span>
    <span class="s2">&quot;minimum_should_match&quot;</span><span class="p">:</span> <span class="mi">2</span> 
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>查询语句提升权重</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;must&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span> 
                        <span class="s2">&quot;query&quot;</span><span class="p">:</span>    <span class="s2">&quot;full text search&quot;</span><span class="p">,</span>
                        <span class="c1"># content 字段必须包含 full 、 text 和 search 所有三个词</span>
                        <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;and&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="c1"># 如果 content 字段也包含 Elasticsearch 或 Lucene ，文档会获得更高的评分 _score</span>
            <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span> 
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Elasticsearch&quot;</span> <span class="p">}},</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Lucene&quot;</span>        <span class="p">}}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">-</span> <span class="err">如果我们想提高</span><span class="n">Elasticsearch</span><span class="err">的权重</span><span class="p">,</span> <span class="err">使用</span><span class="n">boost</span><span class="err">来提升</span><span class="sb">`相对权重`</span><span class="p">(</span><span class="err">默认为</span><span class="mi">1</span><span class="p">)</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;must&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>  
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;query&quot;</span><span class="p">:</span>    <span class="s2">&quot;full text search&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;and&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;Elasticsearch&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;boost&quot;</span><span class="p">:</span> <span class="mi">3</span> 
                    <span class="p">}</span>
                <span class="p">}},</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;Lucene&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;boost&quot;</span><span class="p">:</span> <span class="mi">2</span> 
                    <span class="p">}</span>
                <span class="p">}}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>控制分析</li>
</ul>

<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_controlling_analysis.html">控制分析中文版原文</a></p>

<p>在不同的环境中有不同的分词, 具体见: <a href="https://www.elastic.co/guide/en/elasticsearch/guide/2.x/_controlling_analysis.html">Controlling Analysis</a></p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">新增一个字段</span><span class="p">,</span> <span class="err">使用英文分词</span>
<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_mapping</span><span class="o">/</span><span class="n">my_type</span>
<span class="p">{</span>
    <span class="s2">&quot;my_type&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;english_title&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span>     <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="s2">&quot;english&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">-</span> <span class="err">分析</span><span class="n">API</span><span class="p">,</span><span class="err">分析</span><span class="n">title</span><span class="err">字段在不同的分词下的表现</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_analyze</span>
<span class="p">{</span>
  <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;my_type.title&quot;</span><span class="p">,</span>   
  <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Foxes&quot;</span>
<span class="p">}</span>
<span class="err">返回词项</span> <span class="n">foxes</span>


<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_analyze</span>
<span class="p">{</span>
  <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;my_type.english_title&quot;</span><span class="p">,</span>   
  <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Foxes&quot;</span>
<span class="p">}</span>
<span class="err">返回词项</span> <span class="n">fox</span>

<span class="err">说明默认分词</span><span class="p">,</span><span class="err">和英文分词</span><span class="p">,</span> <span class="err">经过分析之后的结果不一样</span><span class="s1">&#39;;</span>
<span class="err">这意味着，如果使用底层</span> <span class="n">term</span> <span class="err">查询精确项</span> <span class="n">fox</span> <span class="err">时</span><span class="p">,</span> <span class="n">english_title</span> <span class="err">字段会匹配但</span> <span class="n">title</span> <span class="err">字段不会</span><span class="p">;</span>

<span class="o">-</span> <span class="n">match</span><span class="err">查询知道字段映射的关系</span><span class="p">,</span> <span class="err">能为每个被查询的字段应用正确的分析器</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="n">_validate</span><span class="o">/</span><span class="n">query</span><span class="err">?</span><span class="n">explain</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span>         <span class="s2">&quot;Foxes&quot;</span><span class="p">}},</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;english_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Foxes&quot;</span><span class="p">}}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">返回</span><span class="p">:</span>
<span class="p">(</span><span class="n">title</span><span class="p">:</span><span class="n">foxes</span> <span class="n">english_title</span><span class="p">:</span><span class="n">fox</span><span class="p">)</span>


<span class="o">-</span> <span class="err">默认分析器</span>

<span class="err">索引时的顺序如下：</span>

    <span class="err">字段映射里定义的</span> <span class="n">analyzer</span> <span class="err">，否则</span>
    <span class="err">索引设置中名为</span> <span class="n">default</span> <span class="err">的分析器，默认为</span>
    <span class="n">standard</span> <span class="err">标准分析器</span>

<span class="err">一个搜索时的</span> <span class="err">完整</span> <span class="err">顺序会是下面这样：</span>

    <span class="err">查询自己定义的</span> <span class="n">analyzer</span> <span class="err">，否则</span>
    <span class="err">字段映射里定义的</span> <span class="n">search_analyzer</span> <span class="err">，否则</span>
    <span class="err">字段映射里定义的</span> <span class="n">analyzer</span> <span class="err">，否则</span>
    <span class="err">索引设置中名为</span> <span class="n">default_search</span> <span class="err">的分析器，默认为</span>
    <span class="err">索引设置中名为</span> <span class="n">default</span> <span class="err">的分析器，默认为</span>
    <span class="n">standard</span> <span class="err">标准分析器</span>
    
    
<span class="o">-</span> <span class="err">分析器配置最佳实践</span>

    <span class="err">简单</span><span class="p">:</span> <span class="err">在创建索引或者增加类型映射时，为每个需要自定义的全文字段设置分析器</span><span class="p">;</span> <span class="err">可以在索引级别设置中，为绝大部分的字段设置你想指定的</span> <span class="n">default</span> <span class="err">默认分析器。然后在字段级别设置中，对某一两个字段配置需要指定的分析器</span><span class="p">;</span>
    
    <span class="err">通常，多数字符串字段都是</span> <span class="n">not_analyzed</span> <span class="err">精确值字段，比如标签（</span><span class="n">tag</span><span class="err">）或枚举（</span><span class="n">enum</span><span class="err">），而且更多的全文字段会使用默认的</span> <span class="n">standard</span> <span class="err">分析器或</span> <span class="n">english</span> <span class="err">或其他某种语言的分析器。这样只需要为少数一两个字段指定自定义分析：或许标题</span> <span class="n">title</span> <span class="err">字段需要以支持</span> <span class="err">输入即查找（</span><span class="n">find</span><span class="o">-</span><span class="k">as</span><span class="o">-</span><span class="n">you</span><span class="o">-</span><span class="nb">type</span><span class="err">）</span> <span class="err">的方式进行索引</span><span class="p">;</span>

    <span class="err">对于和时间相关的日志数据，通常的做法是每天自行创建索引，由于这种方式不是从头创建的索引，仍然可以用</span> <span class="err">索引模板（</span><span class="n">Index</span> <span class="n">Template</span><span class="err">）</span> <span class="err">为新建的索引指定配置和映射</span><span class="p">;</span>
</pre></div>
</div>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/indices-templates.html">索引模板</a></p>

<ul>
<li><p>被破坏的相关度</p>

<p>** 科普小知识: 词频/逆向文档频率(TF/IDF) **</p>

<p>词频是计算某个词在当前被查询文档里某个字段中出现的频率，出现的频率越高，文档越相关。 逆向文档频率 将 某个词在索引内所有文档出现的百分数 考虑在内，出现的频率越高，它的权重就越低</p>

<p>简单描述问题场景: 做一个简单的查询, 结果相关性低的结果出现在了相关性高的结果前面;</p>

<p>为什么会出现这种情况呢?</p>

<p>由于性能的原因, Elastic不在所有分片的文档的索引中计算IDF(不计算全局IDF, 只计算本地), 导致的问题是同样的条件在不同的分片上的频率是不同的, 导致相关性混乱的问题;</p>

<p>强制解决方法: 在搜索请求后添加 ?search<em>type=dfs</em>query<em>then</em>fetch ， dfs 是指 分布式频率搜索（Distributed Frequency Search） ， 它告诉 Elasticsearch ，先分别获得每个分片本地的 IDF ，然后根据结果再计算整个索引的全局 IDF; <code>不要在生产环境上使用 dfs_query_then_fetch</code> 。完全没有必要。只要有足够的数据就能保证词频是均匀分布的。没有理由给每个查询额外加上 DFS 这步</p></li>
</ul>

<h3>5.2.2 多字段检索</h3>

<h4>多字符串检索</h4>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>- bool 查询采取 more-matches-is-better 匹配越多越好的方式，所以每条 match 语句的评分结果会被加在一起，从而为每个文档提供最终的分数 _score;
- dis_max 则是以最匹配查询的得分作为_score的值;

GET /_search
{
  "query": {
    "bool": {
      "should": [
        { "match": { "title":  "War and Peace" }},
        { "match": { "author": "Leo Tolstoy"   }}
      ]
    }
  }
}</pre></div></div>

<h4>语句的优先级-boost</h4>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>GET /_search
{
  "query": {
    "bool": {
      "should": [
        { "match": { 
            "title":  {
              "query": "War and Peace",
              "boost": 2
        }}},
        { "match": { 
            "author":  {
              "query": "Leo Tolstoy",
              "boost": 2
        }}},
        { "bool":  { 
            "should": [
              { "match": { "translator": "Constance Garnett" }},
              { "match": { "translator": "Louise Maude"      }}
            ]
        }}
      ]
    }
  }
}</pre></div></div>

<h4>单字符串查询-多个搜索项堆积到单个字段</h4>

<p>当用户输入了单个字符串查询的时候，通常会遇到以下三种情形:
1. 最佳字段
2. 多数字段
3. 混合字段</p>

<h4>最佳字段</h4>

<p>文档在 相同字段 中包含的词越多越好，评分也来自于 <code>最匹配字段</code>;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">场景</span><span class="p">:</span> <span class="err">我们搜索一个词组</span> <span class="n">Brown</span> <span class="n">fox</span>
<span class="err">内容</span><span class="p">:</span> 
<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="mi">1</span>
<span class="p">{</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Quick brown rabbits&quot;</span><span class="p">,</span>
    <span class="s2">&quot;body&quot;</span><span class="p">:</span>  <span class="s2">&quot;Brown rabbits are commonly seen.&quot;</span>
<span class="p">}</span>

<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="mi">2</span>
<span class="p">{</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Keeping pets healthy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;body&quot;</span><span class="p">:</span>  <span class="s2">&quot;My quick brown fox eats rabbits on a regular basis.&quot;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="nb">bool</span> <span class="err">查询</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;should&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Brown fox&quot;</span> <span class="p">}},</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span>  <span class="s2">&quot;Brown fox&quot;</span> <span class="p">}}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">肉眼判断应该是条目</span><span class="mi">2</span><span class="err">更优</span><span class="p">,</span> <span class="err">结果却是条目</span><span class="mi">1</span><span class="err">更优</span><span class="p">;</span> <span class="err">为什么呢?</span> <span class="err">因为</span><span class="sb">`bool计算评分的方式`</span><span class="err">是综合计算</span><span class="mi">2</span><span class="err">个查询的评分</span><span class="p">,</span> <span class="err">文档</span> <span class="mi">1</span> <span class="err">的两个字段都包含</span> <span class="n">brown</span> <span class="err">这个词</span><span class="p">,</span> <span class="err">而文档</span> <span class="mi">2</span> <span class="err">只有</span> <span class="n">body</span><span class="err">里面包含</span><span class="p">,</span> <span class="err">最终计算文档</span><span class="mi">1</span><span class="err">的评分更高</span><span class="p">;</span>

<span class="o">-</span> <span class="err">使用</span> <span class="sb">`dis_max`</span> <span class="err">查询</span><span class="p">:</span> <span class="err">以`单个最佳匹配的语句的评分来作为整体评分</span><span class="p">;</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;dis_max&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;queries&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Brown fox&quot;</span> <span class="p">}},</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span>  <span class="s2">&quot;Brown fox&quot;</span> <span class="p">}}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="err">返回</span><span class="p">:</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;dis_max&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;queries&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Brown fox&quot;</span> <span class="p">}},</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span>  <span class="s2">&quot;Brown fox&quot;</span> <span class="p">}}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="err">此时又会出现其他问题</span><span class="p">,</span> <span class="err">例如</span><span class="p">,</span> <span class="err">我们搜索</span> <span class="s2">&quot;Quick pets&quot;</span><span class="p">,</span> <span class="err">使用最佳匹配评分的时候</span><span class="p">,</span> <span class="err">虽然文档</span><span class="mi">2</span><span class="err">在</span> <span class="n">title</span><span class="err">和</span><span class="n">body</span><span class="err">分别匹配</span><span class="n">quick</span> <span class="err">和</span> <span class="n">pets</span><span class="err">字段</span><span class="p">,</span> <span class="err">文档</span><span class="mi">1</span><span class="err">只是匹配</span><span class="n">quick</span><span class="err">字段</span><span class="p">,</span> <span class="err">但是按照</span><span class="n">dis_max</span><span class="err">查询</span><span class="p">,</span> <span class="err">取最优的单条查询评分得到的结果是一样的</span><span class="p">;</span>

<span class="err">但是此时我们需要在多个</span><span class="n">match</span><span class="err">中</span><span class="p">,</span> <span class="err">同时匹配的查询的文档有更高的优先级</span><span class="p">,</span> <span class="err">那么我们应该怎么做呢?</span>

<span class="err">答案是使用</span><span class="p">:</span> <span class="n">tie_breaker</span><span class="err">参数</span><span class="p">,</span> <span class="err">将其他匹配语句的评分也考虑其中</span><span class="p">,</span> <span class="err">得出的结果</span> <span class="err">文档</span><span class="mi">2</span><span class="err">的评分比文档</span><span class="mi">1</span><span class="err">略高</span><span class="p">;</span>

<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;dis_max&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;queries&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Quick pets&quot;</span> <span class="p">}},</span>
                <span class="p">{</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span>  <span class="s2">&quot;Quick pets&quot;</span> <span class="p">}}</span>
            <span class="p">],</span>
            <span class="s2">&quot;tie_breaker&quot;</span><span class="p">:</span> <span class="mf">0.3</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">tie_breaker</span> <span class="err">参数提供了一种</span> <span class="n">dis_max</span> <span class="err">和</span> <span class="nb">bool</span> <span class="err">之间的折中选择</span><span class="p">:</span> <span class="err">最佳</span><span class="n">_score</span> <span class="o">+</span> <span class="err">其它语句评分结果</span><span class="o">*</span><span class="n">tie_breaker</span>

<span class="n">tie_breaker</span> <span class="err">可以是</span> <span class="mi">0</span> <span class="err">到</span> <span class="mi">1</span> <span class="err">之间的浮点数，其中</span> <span class="mi">0</span> <span class="err">代表使用</span> <span class="n">dis_max</span> <span class="err">最佳匹配语句的普通逻辑，</span> <span class="mi">1</span> <span class="err">表示所有匹配语句同等重要。最佳的精确值需要根据数据与查询调试得出，但是合理值应该与零接近（处于</span> <span class="mf">0.1</span> <span class="o">-</span> <span class="mf">0.4</span> <span class="err">之间），这样就不会颠覆</span> <span class="n">dis_max</span> <span class="err">最佳匹配性质的根本</span><span class="p">;</span> <span class="err">总之设置一个权重</span><span class="p">,</span> <span class="err">来做微调</span><span class="p">;</span>
</pre></div>
</div>
<h4>multi_match 查询</h4>

<p>multi_match 查询为能在多个字段上反复执行相同查询提供了一种便捷方式</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;dis_max&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;queries&quot;</span><span class="p">:</span>  <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;Quick brown fox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minimum_should_match&quot;</span><span class="p">:</span> <span class="s2">&quot;30%&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;Quick brown fox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;minimum_should_match&quot;</span><span class="p">:</span> <span class="s2">&quot;30%&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">},</span>
    <span class="p">],</span>
    <span class="s2">&quot;tie_breaker&quot;</span><span class="p">:</span> <span class="mf">0.3</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="err">上面这个查询用</span> <span class="n">multi_match</span> <span class="err">重写成更简洁的形式：</span>

<span class="p">{</span>
    <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span>                <span class="s2">&quot;Quick brown fox&quot;</span><span class="p">,</span>
        <span class="c1"># best_fields 类型是默认值，可以不指定</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span>                 <span class="s2">&quot;best_fields&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span>               <span class="p">[</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span> <span class="p">],</span>
        <span class="s2">&quot;tie_breaker&quot;</span><span class="p">:</span>          <span class="mf">0.3</span><span class="p">,</span>
        <span class="c1"># 如 minimum_should_match 或 operator 这样的参数会被传递到生成的 match 查询中</span>
        <span class="s2">&quot;minimum_should_match&quot;</span><span class="p">:</span> <span class="s2">&quot;30%&quot;</span> 
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">查询字段名称的模糊匹配</span>
<span class="p">{</span>
    <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span>  <span class="s2">&quot;Quick brown fox&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="s2">&quot;*_title&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">提升单个字段的权重</span>
<span class="o">-</span> <span class="err">可以使用</span> <span class="o">^</span> <span class="err">字符语法为单个字段提升权重，在字段名称的末尾添加</span> <span class="o">^</span><span class="n">boost</span> <span class="err">，</span> <span class="err">其中</span> <span class="n">boost</span> <span class="err">是一个浮点数</span>
<span class="p">{</span>
    <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span>  <span class="s2">&quot;Quick brown fox&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;*_title&quot;</span><span class="p">,</span> <span class="s2">&quot;chapter_title^2&quot;</span> <span class="p">]</span> 
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h4>多数字段查询</h4>

<p><code>相同的文本被索引到其他字段</code>，以提供更精确的匹配; 其他字段是作为匹配每个文档时提高相关度的 信号;</p>

<p>召回率: 返回所有的相关文档； 
精确率: 不返回无关文档;
目的: 在结果的第一页中为用户呈现最为相关的文档;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">多字段映射</span>
<span class="o">-</span> <span class="err">我们将字段索引两次</span><span class="p">,</span> <span class="err">一次使用词干模式以及一次非词干模式</span>
<span class="n">DELETE</span> <span class="o">/</span><span class="n">my_index</span>

<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span>
<span class="p">{</span>
    <span class="c1"># 参考 被破坏的相关度</span>
    <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;number_of_shards&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> 
    <span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;my_type&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1"># title 字段使用 english 英语分析器来提取词干</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span> 
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span>     <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="c1"># title.std 字段使用 standard 标准分析器，所以没有词干提取</span>
                        <span class="s2">&quot;std&quot;</span><span class="p">:</span>   <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span>     <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span><span class="err">接着索引一些文档</span>
<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="mi">1</span>
<span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;My rabbit jumps&quot;</span> <span class="p">}</span>

<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="mi">2</span>
<span class="p">{</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Jumping jack rabbits&quot;</span> <span class="p">}</span>

<span class="o">-</span> <span class="err">简单查询</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;jumping rabbits&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="o">-</span> <span class="err">由于</span><span class="n">title</span><span class="err">使用了</span> <span class="n">English</span> <span class="err">分析器</span><span class="p">,</span> <span class="err">所以查询语句会被英文分词</span><span class="p">,</span> 
<span class="o">-</span> <span class="mi">2</span><span class="err">条文档都匹配</span><span class="p">,</span> <span class="err">并且评分相同</span>
<span class="p">{</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
     <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_score&quot;</span><span class="p">:</span> <span class="mf">0.42039964</span><span class="p">,</span>
        <span class="s2">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
           <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;My rabbit jumps&quot;</span>
        <span class="p">}</span>
     <span class="p">},</span>
     <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_score&quot;</span><span class="p">:</span> <span class="mf">0.42039964</span><span class="p">,</span>
        <span class="s2">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
           <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Jumping jack rabbits&quot;</span>
        <span class="p">}</span>
     <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">如果同时查询两个字段，然后使用</span> <span class="nb">bool</span> <span class="err">查询将评分结果</span> <span class="err">合并</span> <span class="err">，那么两个文档都是匹配的（</span> <span class="n">title</span> <span class="err">字段的作用），而且文档</span> <span class="mi">2</span> <span class="err">的相关度评分更高（</span> <span class="n">title</span><span class="o">.</span><span class="n">std</span> <span class="err">字段的作用）</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span>  <span class="s2">&quot;jumping rabbits&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span>   <span class="s2">&quot;most_fields&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;title.std&quot;</span> <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">结果</span><span class="p">:</span> <span class="err">文档</span> <span class="mi">2</span> <span class="err">现在的评分要比文档</span> <span class="mi">1</span> <span class="err">高</span>
<span class="p">{</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[</span>
     <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_score&quot;</span><span class="p">:</span> <span class="mf">0.8226396</span><span class="p">,</span> 
        <span class="s2">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
           <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Jumping jack rabbits&quot;</span>
        <span class="p">}</span>
     <span class="p">},</span>
     <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_score&quot;</span><span class="p">:</span> <span class="mf">0.10741998</span><span class="p">,</span> 
        <span class="s2">&quot;_source&quot;</span><span class="p">:</span> <span class="p">{</span>
           <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;My rabbit jumps&quot;</span>
        <span class="p">}</span>
     <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>

<span class="err">总结</span><span class="p">:</span> 
    <span class="err">用广度匹配字段</span> <span class="n">title</span> <span class="err">包括尽可能多的文档——以提升召回率</span><span class="p">,</span> <span class="err">同时又使用字段</span> <span class="n">title</span><span class="o">.</span><span class="n">std</span> <span class="err">作为</span> <span class="err">信号</span> <span class="err">将相关度更高的文档置于结果顶部</span>

<span class="err">每个字段对于最终评分的贡献可以通过自定义值</span> <span class="n">boost</span> <span class="err">来控制</span><span class="p">:</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span>       <span class="s2">&quot;jumping rabbits&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span>        <span class="s2">&quot;most_fields&quot;</span><span class="p">,</span>
            <span class="c1"># title 字段的 boost 的值为 10 使它比 title.std 更重要</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span>      <span class="p">[</span> <span class="s2">&quot;title^10&quot;</span><span class="p">,</span> <span class="s2">&quot;title.std&quot;</span> <span class="p">]</span> 
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h4>跨字段搜索</h4>

<p>对于某些实体，我们<code>需要在多个字段中确定其信息</code>，单个字段都只能作为整体的一部分;
例如: Person： first<em>name 和 last</em>name （人名/姓)</p>

<ul>
<li>跨字段实体搜索（cross-fields entity search）</li>
</ul>

<p><strong>多个字段唯一标识一个对象, 查询时我们在多个字段中进行搜索</strong></p>

<p>例如:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">Person</span>
<span class="p">{</span>
    <span class="s2">&quot;firstname&quot;</span><span class="p">:</span>  <span class="s2">&quot;Peter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lastname&quot;</span><span class="p">:</span>   <span class="s2">&quot;Smith&quot;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="n">Address</span>
<span class="p">{</span>
    <span class="s2">&quot;street&quot;</span><span class="p">:</span>   <span class="s2">&quot;5 Poland Street&quot;</span><span class="p">,</span>
    <span class="s2">&quot;city&quot;</span><span class="p">:</span>     <span class="s2">&quot;London&quot;</span><span class="p">,</span>
    <span class="s2">&quot;country&quot;</span><span class="p">:</span>  <span class="s2">&quot;United Kingdom&quot;</span><span class="p">,</span>
    <span class="s2">&quot;postcode&quot;</span><span class="p">:</span> <span class="s2">&quot;W1V 3DG&quot;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">使用</span><span class="n">most_fields</span>
<span class="p">{</span>
  <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;query&quot;</span><span class="p">:</span>       <span class="s2">&quot;Poland Street W1V&quot;</span><span class="p">,</span>
      <span class="s2">&quot;type&quot;</span><span class="p">:</span>        <span class="s2">&quot;most_fields&quot;</span><span class="p">,</span>
      <span class="s2">&quot;fields&quot;</span><span class="p">:</span>      <span class="p">[</span> <span class="s2">&quot;street&quot;</span><span class="p">,</span> <span class="s2">&quot;city&quot;</span><span class="p">,</span> <span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;postcode&quot;</span> <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p>使用most_fields方式问题</p></li>
<li><p>它是为多数字段匹配 任意 词设计的，而不是在 所有字段 中找到最匹配的;</p></li>
<li><p>它不能使用 operator 或 minimum<em>should</em>match 参数来降低次相关结果造成的长尾效应;</p></li>
<li><p>词频对于每个字段是不一样的，而且它们之间的相互影响会导致不好的排序结果;</p></li>
</ul>

<h4>字段中心式查询</h4>

<p>以上三个源于 most<em>fields 的问题都因为它是 <code>字段中心式（field-centric）</code> 而不是 <code>词中心（term-centric）</code> 的：当真正感兴趣的是匹配词的时候，它为我们查找的是最匹配的 字段;
best</em>fields 类型也是字段中心式的， 它也存在类似的问题;</p>

<ul>
<li>问题1: 在多个字段中匹配相同的值</li>
</ul>

<p>most_fields 查询：Elasticsearch 为每个字段生成独立的 match 查询，再用 bool 查询将他们包起来</p>

<p>可以通过explain API查看解析:
    GET /<em>validate/query?explain
    {
      <q>query</q>: {
        &quot;multi</em>match<q>: {
</q>query<q>:</q>Poland Street W1V<q>,
</q>type<q>:</q>most_fields<q>,
</q>fields<q>:  [</q>street<q>,</q>city<q>,</q>country<q>,</q>postcode&quot; ]
        }
      }
    }
    返回:
    (street:poland   street:street   street:w1v)
    (city:poland     city:street     city:w1v)
    (country:poland  country:street  country:w1v)
    (postcode:poland postcode:street postcode:w1v)</p>

<p>可以发现， 两个 字段都与 poland 匹配的文档要比一个字段同时匹配 poland 与 street 文档的评分高</p>

<ul>
<li><p>问题 2: 剪掉长尾, 使用and或者minimum<em>should</em>match参数来消除结果中几乎不相关的长尾;</p>

<p>{
    <q>query</q>: {
        <q>multi_match</q>: {
            <q>query</q>:       <q>Poland Street W1V</q>,
            <q>type</q>:        <q>most_fields</q>,
            <q>operator</q>:    <q>and</q>, 
            <q>fields</q>:      [ <q>street</q>, <q>city</q>, <q>country</q>, <q>postcode</q> ]
        }
    }
}
查询的 explanation 解释如下：
所有词都必须匹配, 可能就不存在能与这个查询匹配的文档!!!
(+street:poland   +street:street   +street:w1v)
(+city:poland     +city:street     +city:w1v)
(+country:poland  +country:street  +country:w1v)
(+postcode:poland +postcode:street +postcode:w1v)</p></li>
<li><p>问题3: 词频/逆向文档频率</p></li>
</ul>

<p><strong>词频</strong> : 一个词在单个文档的某个字段中出现的频率越高，这个文档的相关度就越高;</p>

<p><strong>逆向文档频率</strong>: 一个词在所有文档某个字段索引中出现的频率越高，这个词的相关度就越低;</p>

<p>当搜索多个字段时，TF/IDF 会带来某些令人意外的结果;</p>

<p>解决方案: </p>

<ul>
<li><p>使用冗余字段降低复杂度
存在这些问题仅仅是因为我们在处理着多个字段，如果将所有这些字段组合成单个字段，问题就会消失。可以为 person 文档添加 full_name 字段来解决这个问题;</p></li>
<li><p>自定义 _all 字段: <code>需在索引文档前为其设置好映射, 否者需要重新定义索引</code>
<em>all字段的索引方式是将所有其他字段的值作为一个大字符串索引的; 类似的, 我们可以为人名/地名添加一个自定义的</em>all字段; Elasticsearch 在字段映射中为我们提供 copy_to 参数来实现这个功能;</p>

<p>注意: copy<em>to 设置对multi-field无效。如果尝试这样配置映射，Elasticsearch 会抛异常;
为什么呢？多字段只是以不同方式简单索引“主”字段；它们没有自己的数据源。也就是说没有可供 copy</em>to 到另一字段的数据源;
只要对“主”字段 copy_to 就能轻而易举的达到相同的效果;</p></li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span>
    <span class="p">{</span>
        <span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;person&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span>     <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;copy_to&quot;</span><span class="p">:</span>  <span class="s2">&quot;full_name&quot;</span> 
                    <span class="p">},</span>
                    <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span>     <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;copy_to&quot;</span><span class="p">:</span>  <span class="s2">&quot;full_name&quot;</span> 
                    <span class="p">},</span>
                    <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span>     <span class="s2">&quot;string&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p>使用cross-fields 跨字段查询</p>

<p>自定义 <em>all 的方式是一个好的解决方案，只需在索引文档前为其设置好映射。 不过， Elasticsearch 还在搜索时提供了相应的解决方案：使用 cross</em>fields 类型进行 multi<em>match 查询。 cross</em>fields 使用<code>词中心式（term-centric）</code>的查询方式，这与 best<em>fields 和 most</em>fields 使用字段中心式（field-centric）的查询方式非常不同，<code>它将所有字段当成一个大字段，并在 每个字段 中查找 每个词</code>;</p></li>
</ul>

<h4>cross-fields 跨字段查询</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">字段中心式（</span><span class="n">field</span><span class="o">-</span><span class="n">centric</span><span class="err">）</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">_validate</span><span class="o">/</span><span class="n">query</span><span class="err">?</span><span class="n">explain</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span>       <span class="s2">&quot;peter smith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span>        <span class="s2">&quot;most_fields&quot;</span><span class="p">,</span>
            <span class="s2">&quot;operator&quot;</span><span class="p">:</span>    <span class="s2">&quot;and&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span>      <span class="p">[</span> <span class="s2">&quot;first_name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_name&quot;</span> <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">返回</span><span class="p">:</span>
<span class="p">(</span><span class="o">+</span><span class="n">first_name</span><span class="p">:</span><span class="n">peter</span> <span class="o">+</span><span class="n">first_name</span><span class="p">:</span><span class="n">smith</span><span class="p">)</span>
<span class="p">(</span><span class="o">+</span><span class="n">last_name</span><span class="p">:</span><span class="n">peter</span>  <span class="o">+</span><span class="n">last_name</span><span class="p">:</span><span class="n">smith</span><span class="p">)</span>
<span class="err">解释</span><span class="p">:</span> <span class="err">对于匹配的文档，</span><span class="n">peter</span> <span class="err">和</span> <span class="n">smith</span> <span class="err">都必须同时出现在相同字段中，要么是</span> <span class="n">first_name</span> <span class="err">字段，要么</span> <span class="n">last_name</span> <span class="err">字段</span><span class="p">;</span>
</pre></div>
</div><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="err">词中心式</span> <span class="err">会使用以下逻辑</span><span class="p">:</span>
<span class="o">+</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span><span class="n">peter</span> <span class="n">last_name</span><span class="p">:</span><span class="n">peter</span><span class="p">)</span>
<span class="o">+</span><span class="p">(</span><span class="n">first_name</span><span class="p">:</span><span class="n">smith</span> <span class="n">last_name</span><span class="p">:</span><span class="n">smith</span><span class="p">)</span>
<span class="err">解释</span><span class="p">:</span> <span class="err">词</span> <span class="n">peter</span> <span class="err">和</span> <span class="n">smith</span> <span class="err">都必须出现，但是可以出现在任意字段中</span><span class="p">;</span>
</pre></div>
</div>
<p>cross_fields 类型首先分析查询字符串并生成一个词列表，然后它从所有字段中依次搜索每个词。这种不同的搜索方式很自然的解决了 字段中心式 查询三个问题中的二个;</p>

<p>另外, 逆向文档频率问题, 可以通过 <code>混合 不同字段逆向索引文档频率</code>的方式解决, 为了让 cross_fields 查询以最优方式工作，所有的字段都须使用相同的分析器， 具有相同分析器的字段会被分组在一起作为混合字段使用;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">_validate</span><span class="o">/</span><span class="n">query</span><span class="err">?</span><span class="n">explain</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;multi_match&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span>       <span class="s2">&quot;peter smith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span>        <span class="s2">&quot;cross_fields&quot;</span><span class="p">,</span> <span class="c1"># 用 cross_fields 词中心式匹配</span>
            <span class="s2">&quot;operator&quot;</span><span class="p">:</span>    <span class="s2">&quot;and&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fields&quot;</span><span class="p">:</span>      <span class="p">[</span> <span class="s2">&quot;first_name&quot;</span><span class="p">,</span> <span class="s2">&quot;last_name&quot;</span> <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="err">它通过</span> <span class="err">混合</span> <span class="err">不同字段逆向索引文档频率的方式解决了词频的问题：</span>
<span class="o">+</span><span class="n">blended</span><span class="p">(</span><span class="s2">&quot;peter&quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="p">[</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">])</span>
<span class="o">+</span><span class="n">blended</span><span class="p">(</span><span class="s2">&quot;smith&quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="p">[</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">])</span>
<span class="err">它会同时在</span> <span class="n">first_name</span> <span class="err">和</span> <span class="n">last_name</span> <span class="err">两个字段中查找</span> <span class="n">smith</span> <span class="err">的</span> <span class="n">IDF</span> <span class="err">，然后用两者的最小值作为两个字段的</span> <span class="n">IDF</span> <span class="err">。结果实际上就是</span> <span class="n">smith</span> <span class="err">会被认为既是个平常的姓，也是平常的名</span>
</pre></div>
</div>
<h3>5.2.3 近似匹配</h3>

<h4>短语匹配match_phrase</h4>

<p>match_phrase 查询首先将查询字符串解析成一个词项列表，然后对这些词项进行搜索，但只保留那些包含 全部 搜索词项，且 位置 与搜索词项相同的文档。 比如对于 quick fox 的短语搜索可能不会匹配到任何文档，因为没有文档包含的 quick 词之后紧跟着 fox;</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>GET /my_index/my_type/_search
{
    "query": {
        "match_phrase": {
            "title": "quick brown fox"
        }
    }
}
等同于:
"match": {
    "title": {
        "query": "quick brown fox",
        "type":  "phrase"
    }
}

- 词项的位置
当一个字符串被分词后，这个分析器不但会 返回一个词项列表，而且还会返回各词项在原始字符串中的 位置 或者顺序关系
GET /_analyze?analyzer=standard
Quick brown fo
返回:
{
   "tokens": [
      {
         "token": "quick",
         "start_offset": 0,
         "end_offset": 5,
         "type": "<ALPHANUM>",
         "position": 1 
      },
      {
         "token": "brown",
         "start_offset": 6,
         "end_offset": 11,
         "type": "<ALPHANUM>",
         "position": 2 
      },
      {
         "token": "fox",
         "start_offset": 12,
         "end_offset": 15,
         "type": "<ALPHANUM>",
         "position": 3 
      }
   ]
}

- 满足短语查询的3个条件

例如: quick brown fox 
* quick 、 brown 和 fox 需要全部出现在域中
* brown 的位置应该比 quick 的位置大 1
* fox 的位置应该比 quick 的位置大 2 

本质上来讲，match_phrase 查询是利用一种低级别的 span 查询族（query family）去做词语位置敏感的匹配。 Span 查询是一种词项级别的查询，所以它们没有分词阶段；它们只对指定的词项进行精确搜索</pre></div></div>

<h4>混合起来</h4>

<p>精确短语匹配 或许是过于严格了。也许我们想要包含 “quick brown fox” 的文档也能够匹配 “quick fox,” ， 尽管情形不完全相同</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">my_type</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match_phrase&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;quick fox&quot;</span><span class="p">,</span>
                <span class="s2">&quot;slop&quot;</span><span class="p">:</span>  <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h4>多值字段</h4>

<p>TODO:</p>

<h4>越近越好</h4>

<p>TODO:</p>

<h4>使用邻近度提高相关度</h4>

<p>TODO:</p>

<h4>性能优化</h4>

<p>TODO:</p>

<h4>寻找相关词</h4>

<p>TODO:</p>

<h3>5.2.4 部分匹配</h3>

<h4>邮编与结构化数据</h4>

<p>假设将邮编作为 not_analyzed 的精确值字段索引，所以可以为其创建索引，如下:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span>
<span class="p">{</span>
    <span class="s2">&quot;mappings&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;postcode&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span>  <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;not_analyzed&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>然后索引一些邮编：</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">address</span><span class="o">/</span><span class="mi">1</span>
<span class="p">{</span> <span class="s2">&quot;postcode&quot;</span><span class="p">:</span> <span class="s2">&quot;W1V 3DG&quot;</span> <span class="p">}</span>

<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">address</span><span class="o">/</span><span class="mi">2</span>
<span class="p">{</span> <span class="s2">&quot;postcode&quot;</span><span class="p">:</span> <span class="s2">&quot;W2F 8HW&quot;</span> <span class="p">}</span>

<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">address</span><span class="o">/</span><span class="mi">3</span>
<span class="p">{</span> <span class="s2">&quot;postcode&quot;</span><span class="p">:</span> <span class="s2">&quot;W1F 7HW&quot;</span> <span class="p">}</span>

<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">address</span><span class="o">/</span><span class="mi">4</span>
<span class="p">{</span> <span class="s2">&quot;postcode&quot;</span><span class="p">:</span> <span class="s2">&quot;WC1N 1LZ&quot;</span> <span class="p">}</span>

<span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">address</span><span class="o">/</span><span class="mi">5</span>
<span class="p">{</span> <span class="s2">&quot;postcode&quot;</span><span class="p">:</span> <span class="s2">&quot;SW5 0BE&quot;</span> <span class="p">}</span>
</pre></div>
</div>
<h4>prefix前缀查询</h4>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">address</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;prefix&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;postcode&quot;</span><span class="p">:</span> <span class="s2">&quot;W1&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div><blockquote class="blockquote-normal">
                <p>prefix 查询是一个词级别的底层的查询，它不会在搜索之前分析查询字符串，它假定传入前缀就正是要查找的前缀;</p><br/><p>默认状态下， prefix 查询不做相关度评分计算，它只是将所有匹配的文档返回，并为每条结果赋予评分值 1 。它的行为更像是过滤器而不是查询。 prefix 查询和 prefix 过滤器这两者实际的区别就是过滤器是可以被缓存的，而查询不行;</p><br/><p>prefix 查询或过滤对于一些特定的匹配是有效的，但使用方式还是应当注意。 当字段中词的集合很小时，可以放心使用，但是它的伸缩性并不好，会对我们的集群带来很多压力。可以使用较长的前缀来限制这种影响，减少需要访问的量</p></blockquote>
<h4>通配符与正则表达式(wildcard 和 regexp)</h4>
<blockquote class="blockquote-normal">
                <p>与 prefix 前缀查询的特性类似， wildcard 通配符查询也是一种底层基于词的查询， 与前缀查询不同的是它允许指定匹配的正则式。它使用标准的 shell 通配符查询： ? 匹配任意字符， * 匹配 0 或多个字符</p><br/><p>wildcard 和 regexp 查询的工作方式与 prefix 查询完全一样，它们也需要扫描倒排索引中的词列表才能找到所有匹配的词，然后依次获取每个词相关的文档 ID ，与 prefix 查询的唯一不同是：它们能支持更为复杂的匹配模式;</p><br/><p>这也意味着需要同样注意前缀查询存在性能问题，对有很多唯一词的字段执行这些查询可能会消耗非常多的资源，所以要避免使用左通配这样的模式匹配（如： <em>foo 或 .</em>foo 这样的正则式）</p></blockquote><div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">address</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;wildcard&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;postcode&quot;</span><span class="p">:</span> <span class="s2">&quot;W?F*HW&quot;</span> 
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div><blockquote class="blockquote-normal">
                <p>prefix 、 wildcard 和 regexp 查询是基于词操作的，如果用它们来查询 analyzed 字段，它们会检查字段里面的每个词，而不是将字段作为整体来处理;</p><br/><p>比方说包含 “Quick brown fox” （快速的棕色狐狸）的 title 字段会生成词： quick 、 brown 和 fox</p></blockquote>
<p>会匹配以下这个查询：
<code>{ &quot;regexp&quot;: { &quot;title&quot;: &quot;br.*&quot; }}</code>
但是不会匹配以下两个查询：
<code>{ &quot;regexp&quot;: { &quot;title&quot;: &quot;Qu.*&quot; }}</code> # 在索引里的词是 quick 而不是 Quick
<code>{ &quot;regexp&quot;: { &quot;title&quot;: &quot;quick br*&quot; }}</code> # quick 和 brown 在词表中是分开的</p>

<h4>查询时输入即搜索</h4>

<ul>
<li>在输完查询内容之前，就能为他们展现搜索结果, 这就是所谓的 即时搜索（instant search） 或 输入即搜索（search-as-you-type）</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="o">-</span> <span class="err">与</span> <span class="n">match_phrase</span> <span class="err">查询一致，不同的是它将查询字符串的最后一个词作为前缀使用</span>
<span class="p">{</span>
    <span class="s2">&quot;match_phrase_prefix&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;brand&quot;</span> <span class="p">:</span> <span class="s2">&quot;johnnie walker bl&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">接受</span><span class="n">slop</span><span class="p">,</span> <span class="err">让相对词序位置不那么严格</span>
<span class="p">{</span>
    <span class="s2">&quot;match_phrase_prefix&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;brand&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="s2">&quot;walker johnnie bl&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;slop&quot;</span><span class="p">:</span>  <span class="mi">10</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span> <span class="err">可以通过设置</span> <span class="n">max_expansions</span> <span class="err">参数来限制前缀扩展的影响，</span> <span class="err">一个合理的值是可能是</span> <span class="mi">50</span> 
<span class="p">{</span>
    <span class="s2">&quot;match_phrase_prefix&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;brand&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;query&quot;</span><span class="p">:</span>          <span class="s2">&quot;johnnie walker bl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_expansions&quot;</span><span class="p">:</span> <span class="mi">50</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">参数</span> <span class="n">max_expansions</span> <span class="err">控制着可以与前缀匹配的词的数量，它会先查找第一个与前缀</span> <span class="n">bl</span> <span class="err">匹配的词，然后依次查找搜集与之匹配的词（按字母顺序），直到没有更多可匹配的词或当数量超过</span> <span class="n">max_expansions</span> <span class="err">时结束</span><span class="p">;</span>
</pre></div>
</div>
<h4>索引时优化</h4>
<blockquote class="blockquote-normal">
                <p>可以通过在索引时处理数据提高搜索的灵活性以及提升系统性能。为此仍然需要付出应有的代价：增加的索引空间与变慢的索引能力，但这与每次查询都需要付出代价不同，索引时的代价只用付出一次</p></blockquote>
<h4>Ngrams 在部分匹配的应用</h4>

<ul>
<li><p>在搜索之前准备好供部分匹配的数据可以提高搜索的性能</p></li>
<li><p>部分匹配使用的工具是 n-gram</p></li>
</ul>

<p>可以将 n-gram 看成一个在词语上 滑动窗口 ， n 代表这个 “窗口” 的长度。如果我们要 n-gram quick 这个词 —— 它的结果取决于 n 的选择长度</p>

<ul>
<li>长度 1（unigram）： [ q, u, i, c, k ]</li>
<li>长度 2（bigram）： [ qu, ui, ic, ck ]</li>
<li>长度 3（trigram）： [ qui, uic, ick ]</li>
<li>长度 4（four-gram）： [ quic, uick ]</li>
<li>长度 5（five-gram）： [ quick ]</li>
</ul>

<p>对于输入即搜索（search-as-you-type）这种应用场景, 使用一种特殊的 n-gram 称为 边界 n-grams （edge n-grams）:</p>

<p>它会固定词语开始的一边，以单词 quick 为例，它的边界 n-gram 的结果为：</p>

<ul>
<li>q</li>
<li>qu</li>
<li>qui</li>
<li>quic</li>
<li>quick</li>
</ul>

<h4>索引时输入即搜索</h4>

<ul>
<li>设置索引时输入即搜索的第一步是需要定义好分析链</li>
</ul>

<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/configuring-analyzers.html">配置分析器</a></p>

<ul>
<li><p>准备索引</p></li>
</ul>

<ol>
<li>自定义<code>edge_ngram token 过滤器</code>，称为 <code>autocomplete_filter</code>:</li>
</ol>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>{
    "filter": {
        "autocomplete_filter": {
            "type":     "edge_ngram",
            "min_gram": 1,
            "max_gram": 20
        }
    }
}</pre></div></div>

<p>这个配置的意思是：对于这个 token 过滤器接收的任意词项，过滤器会为之生成一个最小固定值为 1 ，最大为 20 的 n-gram</p>

<ol>
<li>然后会在一个自定义分析器 autocomplete 中使用上面这个 token 过滤器</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;autocomplete&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span>      <span class="s2">&quot;custom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tokenizer&quot;</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;lowercase&quot;</span><span class="p">,</span>
                <span class="c1"># 自定义的 edge-ngram token 过滤器</span>
                <span class="s2">&quot;autocomplete_filter&quot;</span> 
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这个分析器使用 standard 分词器将字符串拆分为独立的词，并且将它们都变成小写形式，然后为每个词生成一个边界 n-gram，这要感谢 autocomplete_filter 起的作用;</p>

<ol>
<li>完整示例如下</li>
</ol>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="o">/</span><span class="n">my_index</span>
<span class="p">{</span>
    <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;number_of_shards&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="c1"># 首先自定义 token 过滤器 </span>
        <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;autocomplete_filter&quot;</span><span class="p">:</span> <span class="p">{</span> 
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span>     <span class="s2">&quot;edge_ngram&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;min_gram&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;max_gram&quot;</span><span class="p">:</span> <span class="mi">20</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="c1"># 然后在分析器中使用它</span>
            <span class="s2">&quot;analyzer&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;autocomplete&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span>      <span class="s2">&quot;custom&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tokenizer&quot;</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;lowercase&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;autocomplete_filter&quot;</span> 
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ol>
<li>验证自定义分析器正常</li>
</ol>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>curl -XGET 'localhost:9200/my_index/_analyze?analyzer=autocomplete&pretty' -H 'Content-Type: application/json' -d'
quick brown
'</pre></div></div>

<ol>
<li>update-mapping API 将这个分析器应用到具体字段</li>
</ol>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>PUT /my_index/_mapping/my_type
{
    "my_type": {
        "properties": {
            "name": {
                "type":     "string",
                "analyzer": "autocomplete"
            }
        }
    }
}</pre></div></div>

<h4>Ngrams 在复合词的应用</h4>

<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/ngrams-compound-words.html">Ngrams 在复合词的应用</a></p>

<h3>5.2.5 控制相关度</h3>

<h4>相关度评分背后的理论</h4>

<h4>Lucene的实用评分函数</h4>

<h4>查询时权重提升</h4>

<h4>使用查询结构修改相关度</h4>

<h4>Not Quite Not</h4>

<h4>忽略TF/IDF</h4>

<h4>function_score 查询</h4>

<h4>按受欢迎度提升权重</h4>

<h4>过滤集提升权重</h4>

<h4>随机评分</h4>

<h4>越近越好</h4>

<h4>理解price价格语句</h4>

<h4>脚本评分</h4>

<h4>可拔插的相似度算法</h4>

<h4>更改相似度</h4>

<h4>调试相关度最后10%要做的事情</h4>

<h1>6.处理人类语言</h1>

<p>略, 详情参见<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/languages.html">处理人类语言</a></p>

<h1>7.聚合</h1>

<h3>7.1 高阶概念</h3>

<ol>
<li><p>桶（Buckets）
满足特定条件的文档的集合, 类似SQL的 (Group by)</p></li>
<li><p>指标（Metrics）
对桶内的文档进行统计计算, 类似SQL的(count, min, max等统计方法)</p></li>
</ol>

<ul>
<li>用SQL来解释</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="c1"># 相当于指标</span>
<span class="n">FROM</span> <span class="n">table</span>
<span class="n">GROUP</span> <span class="n">BY</span> <span class="n">color</span>   <span class="c1"># 相当于桶</span>
</pre></div>
</div>
<h3>7.2 尝试聚合</h3>

<ul>
<li>汽车销售数据</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">XPOST</span> <span class="s1">&#39;localhost:9200/cars/transactions/_bulk?pretty&#39;</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="o">-</span><span class="n">d</span><span class="s1">&#39;</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">10000</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span> <span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;honda&quot;</span><span class="p">,</span> <span class="s2">&quot;sold&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-10-28&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">20000</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span> <span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;honda&quot;</span><span class="p">,</span> <span class="s2">&quot;sold&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-11-05&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span> <span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;ford&quot;</span><span class="p">,</span> <span class="s2">&quot;sold&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-05-18&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">15000</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span> <span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;toyota&quot;</span><span class="p">,</span> <span class="s2">&quot;sold&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-07-02&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">12000</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span> <span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;toyota&quot;</span><span class="p">,</span> <span class="s2">&quot;sold&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-08-19&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">20000</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span> <span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;honda&quot;</span><span class="p">,</span> <span class="s2">&quot;sold&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-11-05&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span> <span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;bmw&quot;</span><span class="p">,</span> <span class="s2">&quot;sold&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-01-01&quot;</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="p">{</span> <span class="s2">&quot;price&quot;</span> <span class="p">:</span> <span class="mi">25000</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span> <span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;ford&quot;</span><span class="p">,</span> <span class="s2">&quot;sold&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-02-12&quot;</span> <span class="p">}</span>
<span class="s1">&#39;</span>
</pre></div>
</div>
<ul>
<li>聚合搜索</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span> 
        <span class="s2">&quot;popular_colors&quot;</span> <span class="p">:</span> <span class="p">{</span> 
            <span class="s2">&quot;terms&quot;</span> <span class="p">:</span> <span class="p">{</span> 
              <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;color&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>返回</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="o">...</span>
   <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[]</span> 
   <span class="p">},</span>
   <span class="s2">&quot;aggregations&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;popular_colors&quot;</span><span class="p">:</span> <span class="p">{</span> 
         <span class="s2">&quot;buckets&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
               <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> 
               <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">4</span> 
            <span class="p">},</span>
            <span class="p">{</span>
               <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
               <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="p">{</span>
               <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
               <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">}</span>
         <span class="p">]</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>添加度量指标-计算平均值</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;colors&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;color&quot;</span>
         <span class="p">},</span>
         <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span> 
            <span class="s2">&quot;avg_price&quot;</span><span class="p">:</span> <span class="p">{</span> 
               <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;price&quot;</span> 
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>返回:</p>
<div class="code-wrapper">
          <div class="lang-label">Raw</div>
        
<div class="highlight"><pre>{
...
   "aggregations": {
      "colors": {
         "buckets": [
            {
               "key": "red",
               "doc_count": 4,
               "avg_price": { 
                  "value": 32500
               }
            },
            {
               "key": "blue",
               "doc_count": 2,
               "avg_price": {
                  "value": 20000
               }
            },
            {
               "key": "green",
               "doc_count": 2,
               "avg_price": {
                  "value": 21000
               }
            }
         ]
      }
   }
...
}</pre></div></div>

<ul>
<li>嵌套桶来获得更详细的桶分布信息</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;colors&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;color&quot;</span>
         <span class="p">},</span>
         <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;avg_price&quot;</span><span class="p">:</span> <span class="p">{</span> 
               <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;price&quot;</span>
               <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;make&quot;</span><span class="p">:</span> <span class="p">{</span> 
                <span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;make&quot;</span> 
                <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>返回:</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="o">...</span>
   <span class="s2">&quot;aggregations&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;colors&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;buckets&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
               <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
               <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
               <span class="s2">&quot;make&quot;</span><span class="p">:</span> <span class="p">{</span> 
                  <span class="s2">&quot;buckets&quot;</span><span class="p">:</span> <span class="p">[</span>
                     <span class="p">{</span>
                        <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;honda&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">3</span>
                     <span class="p">},</span>
                     <span class="p">{</span>
                        <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;bmw&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">1</span>
           <span class="sb">``</span><span class="err">`</span><span class="n">python</span>          <span class="p">}</span>
                  <span class="p">]</span>
               <span class="p">},</span>
               <span class="s2">&quot;avg_price&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">32500</span> 
               <span class="p">}</span>
            <span class="p">},</span>

<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>优化返回-为每个汽车生产商计算最低和最高的价格</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;colors&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;color&quot;</span>
         <span class="p">},</span>
         <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;avg_price&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;price&quot;</span> <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;terms&quot;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;make&quot;</span>
                <span class="p">},</span>
                <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span> 
                    <span class="s2">&quot;min_price&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;price&quot;</span><span class="p">}</span> <span class="p">},</span> 
                    <span class="s2">&quot;max_price&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;price&quot;</span><span class="p">}</span> <span class="p">}</span> 
                <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>条形图</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="s2">&quot;aggs&quot;</span><span class="p">:{</span>
      <span class="s2">&quot;price&quot;</span><span class="p">:{</span>
         <span class="s2">&quot;histogram&quot;</span><span class="p">:{</span> 
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;price&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">20000</span>
         <span class="p">},</span>
         <span class="s2">&quot;aggs&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;revenue&quot;</span><span class="p">:</span> <span class="p">{</span>
               <span class="s2">&quot;sum&quot;</span><span class="p">:</span> <span class="p">{</span> 
                 <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;price&quot;</span>
               <span class="p">}</span>
             <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>7.3 按时间统计</h3>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;sales&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;date_histogram&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;sold&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;yyyy-MM-dd&quot;</span> 
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>返回空Buckets</li>
</ul>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;sales&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;date_histogram&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;sold&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;yyyy-MM-dd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;min_doc_count&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># 这个参数强制返回空 buckets</span>
            <span class="s2">&quot;extended_bounds&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="c1"># 这个参数强制返回整年</span>
                <span class="s2">&quot;min&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-01-01&quot;</span><span class="p">,</span>
                <span class="s2">&quot;max&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-12-31&quot;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>扩展例子</li>
</ul>

<p>buckets 可以嵌套进 buckets 中从而得到更复杂的分析。 作为例子，我们构建聚合以便按季度展示所有汽车品牌总销售额。同时按季度、按每个汽车品牌计算销售总额，以便可以找出哪种品牌最赚钱：</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;sales&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;date_histogram&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;sold&quot;</span><span class="p">,</span>
            <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;quarter&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;yyyy-MM-dd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;min_doc_count&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;extended_bounds&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;min&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-01-01&quot;</span><span class="p">,</span>
                <span class="s2">&quot;max&quot;</span> <span class="p">:</span> <span class="s2">&quot;2014-12-31&quot;</span>
            <span class="p">}</span>
         <span class="p">},</span>
         <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;per_make_sum&quot;</span><span class="p">:</span> <span class="p">{</span>
               <span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;make&quot;</span>
               <span class="p">},</span>
               <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;sum_price&quot;</span><span class="p">:</span> <span class="p">{</span>
                     <span class="s2">&quot;sum&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;price&quot;</span> <span class="p">}</span> 
                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;total_sum&quot;</span><span class="p">:</span> <span class="p">{</span>
               <span class="s2">&quot;sum&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;price&quot;</span> <span class="p">}</span> 
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><p class="hassubimage"><img src="/media/14963139803828.png"></p>
                    <p class="img-title"><span class="symbol">#</span>kibana的效果图</p></p>

<ul>
<li>为聚合添加范围</li>
</ul>

<p>聚合可以与搜索请求同时执行，但是我们需要理解一个新概念： 范围 。 默认情况下，聚合与查询是对同一范围进行操作的，也就是说，聚合是基于我们查询匹配的文档集合进行计算的</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;colors&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;terms&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;color&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">等同于</span><span class="p">:</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match_all&quot;</span> <span class="p">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;colors&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;terms&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;color&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">限定范围</span><span class="p">:</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;ford&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;colors&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;terms&quot;</span> <span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;color&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>全局桶</li>
</ul>

<p>通常我们希望聚合是在查询范围内的，但有时我们也想要搜索它的子集，而聚合的对象却是 所有 数据</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;make&quot;</span> <span class="p">:</span> <span class="s2">&quot;ford&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;single_avg_price&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;avg&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;price&quot;</span> <span class="p">}</span> 
        <span class="p">},</span>
        <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;global&quot;</span> <span class="p">:</span> <span class="p">{},</span> 
            <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;avg_price&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;avg&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;price&quot;</span> <span class="p">}</span> 
                <span class="p">}</span>

            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<h3>7.4 查询结果过滤和聚合</h3>

<p>聚合范围限定还有一个自然的扩展就是过滤。因为聚合是在查询结果范围内操作的，任何可以适用于查询的过滤器也可以应用在聚合上</p>

<ul>
<li>过滤</li>
</ul>

<p>如果我们想找到售价在 $10,000 美元之上的所有汽车同时也为这些车计算平均售价， 可以简单地使用一个 constant_score 查询和 filter 约束：</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;constant_score&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;gte&quot;</span><span class="p">:</span> <span class="mi">10000</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;single_avg_price&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;avg&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;price&quot;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>过滤桶</li>
</ul>

<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_filter_bucket.html">过滤桶</a></p>

<p>如果我们只想对聚合结果过滤怎么办？ 假设我们正在为汽车经销商创建一个搜索页面， 我们希望显示用户搜索的结果，但是我们同时也想在页面上提供更丰富的信息，包括（与搜索匹配的）上个月度汽车的平均售价</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
   <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="s2">&quot;query&quot;</span><span class="p">:{</span>
      <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;make&quot;</span><span class="p">:</span> <span class="s2">&quot;ford&quot;</span>
      <span class="p">}</span>
   <span class="p">},</span>
   <span class="s2">&quot;aggs&quot;</span><span class="p">:{</span>
      <span class="s2">&quot;recent_sales&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span> 
            <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="p">{</span>
               <span class="s2">&quot;sold&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;now-1M&quot;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">},</span>
         <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;average_price&quot;</span><span class="p">:{</span>
               <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;price&quot;</span> 
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul>
<li>后过滤器</li>
</ul>

<p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_post_filter.html">后过滤器</a></p>

<p>目前为止，我们可以同时对搜索结果和聚合结果进行过滤（不计算得分的 filter 查询），以及针对聚合结果的一部分进行过滤(filter 桶);</p>

<p>我们可能会想，<q>只过滤搜索结果，不过滤聚合结果呢？</q> 答案是使用 post_filter;</p>
<div class="code-wrapper"><div class="lang-label">Python</div><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">cars</span><span class="o">/</span><span class="n">transactions</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
    <span class="s2">&quot;size&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;make&quot;</span><span class="p">:</span> <span class="s2">&quot;ford&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="c1"># post_filter 元素是 top-level 而且仅对命中结果进行过滤</span>
    <span class="s2">&quot;post_filter&quot;</span><span class="p">:</span> <span class="p">{</span>    
        <span class="s2">&quot;term&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;color&quot;</span> <span class="p">:</span> <span class="s2">&quot;green&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;aggs&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;all_colors&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;terms&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;field&quot;</span> <span class="p">:</span> <span class="s2">&quot;color&quot;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>注意</strong>
当你需要对搜索结果和聚合结果做不同的过滤时，你才应该使用 post<em>filter ， 有时用户会在普通搜索使用 post</em>filter</p>

<p><strong>小结</strong></p>

<p>选择合适类型的过滤（如：搜索命中、聚合或两者兼有）通常和我们期望如何表现用户交互有关。选择合适的过滤器（或组合）取决于我们期望如何将结果呈现给用户。</p>

<p>在 filter 过滤中的 non-scoring 查询，同时影响搜索结果和聚合结果。
filter 桶影响聚合。
post_filter 只影响搜索结果</p>

<h3>7.5 多桶排序</h3>
<blockquote class="blockquote-normal">
                <p>未完待续</p></blockquote>
<h3>7.5 近似聚合</h3>
<blockquote class="blockquote-normal">
                <p>未完待续</p></blockquote>
<h3>7.6 通过聚合发现异常指标</h3>
<blockquote class="blockquote-normal">
                <p>未完待续</p></blockquote>
<h3>7.7 Doc Values and Fielddate</h3>
<blockquote class="blockquote-normal">
                <p>未完待续</p></blockquote>
<h3>7.8 总结</h3>
<blockquote class="blockquote-normal">
                <p>未完待续</p></blockquote>
<h1>8.地理位置</h1>

<p>略,详情参见<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/geoloc.html">地理位置</a></p>

<h1>9.数据建模</h1>

<p>未完待续</p>

<h2>9.1 关联关系处理</h2>

<p>未完待续</p>

<h2>9.2 嵌套对象</h2>

<p>未完待续</p>

<h2>9.3 父-子关系文档</h2>

<p>未完待续</p>

<h2>9.4 扩容设计</h2>

<p>未完待续</p>

<h1>10.管理,监控,部署</h1>

<p>略, 详情参见<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/administration.html">管理,监控,部署-官方</a></p>

<p><a href="http://willdx.me/2017/05/21/ELK%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/">我写的线上部署过程, 可做参考, 如有错误, 以官方文档为准</a></p>

    </div>
    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic green button">打赏 <i class="red heart icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">MORE WORDS</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer code">
            <span>© 1994 - 2018 willdx</span><b>@</b><a class="code" href="https://github.com/willdx/willdx.github.io">blog.willdx.me</a>
            <br/>
            <span class="notprint">
                <span id="busuanzi_container_site_pv">
                    <i class="eye icon"></i><span id="busuanzi_value_site_pv" class="orange text"></span> pv
                </span>
                <b> | </b>
                <span id="busuanzi_container_site_uv">
                    <i class="user icon"></i><span id="busuanzi_value_site_uv" class="orange text"></span> uv
                </span>
                <br/>
            </span>
            <span>Power by <i class="github alternate icon"></i><a href="https://github.com/willdx/willdx.github.io">Github Page</a></span>
            <br/>
            <i class="green superpowers icon"></i>
        </div>
    </body>
    
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script src="/assets/js/web.js"></script>
    <script>
        // 统计代码
        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-68394485-1', 'auto');
        ga('send', 'pageview');

        var wrappers = ["cats-wrapper", "donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper"]

        window.onload = function () {
            useWechat();
        }
    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: 'de35601f0076c240632f',
        clientSecret: 'b44ba043a5af4818f53dc13d3b4e49b5a28a2a0c',
        repo: 'willdx.github.io',
        owner: 'willdx',
        admin: ['willdx'],
        id: 'Elasticsearch权威指南读书笔记',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: ['gitment'],
        pagerDirection: "last",
    })
      
    gitalk.render('comments')
    </script>


</html>